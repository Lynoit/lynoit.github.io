<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Regulatory Doc Finder — EuroNCAP • R79 • R171 • DCAS (Google CSE)</title>

<!-- PapaParse for CSV -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{
    --bg:#0e1220; --panel:#161a2b; --ink:#e8ecff; --muted:#9aa4cc; --accent:#6ea8fe;
    --ok:#32d296; --warn:#ffce54; --bad:#ff6b6b; --grid:14px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,Segoe UI,Roboto,system-ui,Arial}
  .wrap{display:grid;grid-template-columns:360px 1fr;gap:var(--grid);padding:var(--grid)}
  .card{background:var(--panel);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:16px}
  h1{font-size:18px;margin:0 0 10px}
  h2{font-size:16px;margin:0 0 12px;color:var(--muted)}
  label{display:block;font-size:13px;color:var(--muted);margin:8px 0 6px}
  input[type="text"],input[type="password"],select{
    width:100%;padding:10px 12px;border-radius:10px;background:#0e1326;border:1px solid #28304b;color:var(--ink);
  }
  input[type="file"]{width:100%}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  button{
    background:var(--accent);color:#081224;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;
    box-shadow:0 6px 16px rgba(110,168,254,.25)
  }
  button:disabled{opacity:.4;cursor:not-allowed}
  .muted{color:var(--muted);font-size:12px}
  .status{font-size:12px;color:var(--muted);margin-top:8px;white-space:pre-line}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th,td{vertical-align:top;text-align:left;padding:12px;border-top:1px solid #2a3351;border-bottom:1px solid #2a3351;background:#111735}
  th{position:sticky;top:0;background:#0c1230;z-index:2}
  tr td:first-child,tr th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tr td:last-child,tr th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .srcBlock{display:flex;flex-direction:column;gap:6px}
  .score{font-size:12px}
  .score b{padding:2px 8px;border-radius:999px;background:#0c1230}
  .score[data-q="high"] b{background:rgba(50,210,150,.18);color:var(--ok)}
  .score[data-q="mid"] b{background:rgba(255,206,84,.18);color:var(--warn)}
  .score[data-q="low"] b{background:rgba(255,107,107,.18);color:var(--bad)}
  .link{font-size:12px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0c1230;color:var(--muted);font-size:11px}
  .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  .help{font-size:12px;color:var(--muted);line-height:1.4}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0c1230;border:1px solid #28304b;padding:0 6px;border-radius:6px}
  .mini{font-size:11px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: Controls -->
    <div class="card">
      <h1>Regulatory Doc Finder</h1>
      <h2>Euro NCAP · UNECE R79 · UNECE R171 · DCAS</h2>

      <label>1) Load your query CSV (one column named <span class="kbd">Query</span>)</label>
      <input id="csvFile" type="file" accept=".csv"/>

      <div class="row" style="margin-top:10px">
        <div>
          <label>2) Google API Key</label>
          <input id="gKey" type="password" placeholder="Paste Custom Search API key"/>
          <div class="mini">Enable “Custom Search API” in Google Cloud → Credentials → API key.</div>
        </div>
        <div>
          <label>3) CSE Search engine ID (cx)</label>
          <input id="gCx" type="text" placeholder="Paste cx (Search engine ID)"/>
          <div class="mini">In CSE control panel → Basics → Search engine ID.</div>
        </div>
      </div>

      <label style="margin-top:12px;">Recency filter</label>
      <select id="dateRestrict">
        <option value="">None</option>
        <option value="d7">Last 7 days</option>
        <option value="m1" selected>Last month</option>
        <option value="y1">Last year</option>
      </select>

      <label style="margin-top:12px;">Source filters (editable)</label>
      <div class="grid2">
        <div>
          <div class="muted">Euro NCAP</div>
          <input id="srcEuroncap" type="text" value="site:euroncap.com OR site:cdn.euroncap.com OR site:assets.euroncap.com"/>
        </div>
        <div>
          <div class="muted">UNECE R79</div>
          <input id="srcR79" type="text" value="site:unece.org &quot;UN Regulation No. 79&quot; OR R79"/>
        </div>
        <div>
          <div class="muted">UNECE R171</div>
          <input id="srcR171" type="text" value="site:unece.org &quot;UN Regulation No. 171&quot; OR R171"/>
        </div>
        <div>
          <div class="muted">DCAS</div>
          <input id="srcDCAS" type="text" value="site:unece.org DCAS OR &quot;Driver Control Assistance&quot; OR site:ec.europa.eu DCAS"/>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="runBtn" disabled>Run Search</button>
        <button id="exportBtn" disabled title="Export results as CSV">Export Results</button>
      </div>

      <div class="status" id="status">Load a CSV to begin.</div>

      <details style="margin-top:12px">
        <summary class="pill">CSV format & tips</summary>
        <div class="help" style="margin-top:8px">
          • CSV must include a header column named <b>Query</b>.<br/>
          • Confidence is a text-similarity score between your query and the top snippet/title (0–100%).<br/>
          • Google CSE JSON API endpoint is used client-side, no server needed.
        </div>
      </details>
    </div>

    <!-- RIGHT: Results -->
    <div class="card">
      <h1>Results</h1>
      <div class="muted" style="margin-bottom:8px">Query → Answers per source, with confidence and link.</div>
      <div style="overflow:auto; max-height:70vh;">
        <table id="results">
          <thead>
            <tr>
              <th style="width:18%">Query</th>
              <th style="width:20%">Euro NCAP</th>
              <th style="width:20%">UNECE R79</th>
              <th style="width:20%">UNECE R171</th>
              <th style="width:22%">DCAS</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const $ = sel => document.querySelector(sel);

const els = {
  csvFile: $('#csvFile'),
  gKey:    $('#gKey'),
  gCx:     $('#gCx'),
  dateRestrict: $('#dateRestrict'),
  srcEuroncap: $('#srcEuroncap'),
  srcR79:      $('#srcR79'),
  srcR171:     $('#srcR171'),
  srcDCAS:     $('#srcDCAS'),
  runBtn: $('#runBtn'),
  exportBtn: $('#exportBtn'),
  status: $('#status'),
  tbody:  $('#tbody')
};

let queries = [];         // [{Query:"..."}, ...]
let resultsMatrix = [];   // [{query, euroncap:{ans,conf,url,title}, r79:..., r171:..., dcas:...}, ...]

const SOURCES = [
  { key:'euroncap', label:'Euro NCAP', getFilter:()=>els.srcEuroncap.value },
  { key:'r79',      label:'UNECE R79', getFilter:()=>els.srcR79.value },
  { key:'r171',     label:'UNECE R171',getFilter:()=>els.srcR171.value },
  { key:'dcas',     label:'DCAS',       getFilter:()=>els.srcDCAS.value }
];

els.csvFile.addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file){ return; }
  els.status.textContent = 'Parsing CSV…';
  const text = await file.text();
  const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
  if(!parsed.meta.fields.includes('Query')){
    els.status.textContent = 'CSV must contain a header column named "Query".';
    els.runBtn.disabled = true;
    return;
  }
  queries = parsed.data
    .map(r => (r.Query ?? '').toString().trim())
    .filter(q => q.length>0)
    .map(q => ({Query:q}));
  els.status.textContent = `Loaded ${queries.length} queries. Paste your Google API key + cx and click “Run Search”.`;
  updateRunState();
});

els.gKey.addEventListener('input', updateRunState);
els.gCx.addEventListener('input', updateRunState);

function updateRunState(){
  els.runBtn.disabled = !(queries.length > 0 && els.gKey.value && els.gCx.value);
}

els.runBtn.addEventListener('click', async ()=>{
  if(!els.gKey.value || !els.gCx.value){ alert('Paste your Google API key and cx.'); return; }
  resultsMatrix = [];
  els.tbody.innerHTML = '';
  els.exportBtn.disabled = true;

  let done = 0;
  const total = queries.length * SOURCES.length;
  const concurrency = 4;

  const tasks = [];
  for(const q of queries){
    for(const src of SOURCES){
      tasks.push(async ()=>{
        const ans = await searchOneCSE(q.Query, src.getFilter());
        addPartial(q.Query, src.key, ans);
        done++;
        els.status.textContent = `Searching… ${done}/${total} (${Math.round(100*done/total)}%)`;
      });
    }
  }

  await pooled(tasks, concurrency);

  renderTable();
  els.status.textContent = `Done. ${queries.length} queries × ${SOURCES.length} sources = ${total} lookups.`;
  els.exportBtn.disabled = resultsMatrix.length>0 ? false : true;
});

els.exportBtn.addEventListener('click', ()=>{
  const rows = [];
  rows.push(['Query','EuroNCAP Answer','EuroNCAP Confidence','EuroNCAP URL',
             'R79 Answer','R79 Confidence','R79 URL',
             'R171 Answer','R171 Confidence','R171 URL',
             'DCAS Answer','DCAS Confidence','DCAS URL']);
  for(const row of resultsMatrix){
    rows.push([
      row.query,
      row.euroncap.ans, Math.round(row.euroncap.conf), row.euroncap.url,
      row.r79.ans,      Math.round(row.r79.conf),      row.r79.url,
      row.r171.ans,     Math.round(row.r171.conf),     row.r171.url,
      row.dcas.ans,     Math.round(row.dcas.conf),     row.dcas.url
    ]);
  }
  const csv = Papa.unparse(rows);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'RegDoc_Search_Results.csv';
  a.click();
});

// ---- Rendering helpers ----
function findRow(query){
  let row = resultsMatrix.find(r => r.query===query);
  if(!row){
    row = { query,
      euroncap:blankAns(), r79:blankAns(), r171:blankAns(), dcas:blankAns()
    };
    resultsMatrix.push(row);
  }
  return row;
}
function blankAns(){ return { ans:'', conf:0, url:'', title:'' }; }

function addPartial(query, key, ans){
  const row = findRow(query);
  row[key] = ans;
  renderRow(row);
}

function renderRow(row){
  const existing = els.tbody.querySelector(`tr[data-q="${cssEscape(row.query)}"]`);
  if(existing){ existing.remove(); }

  const tr = document.createElement('tr');
  tr.setAttribute('data-q', row.query);

  const tdQ = document.createElement('td');
  tdQ.textContent = row.query;

  const makeCell = (o,label)=>{
    const td = document.createElement('td');
    const wrap = document.createElement('div');
    wrap.className = 'srcBlock';
    const t = document.createElement('div');
    t.innerHTML = `<span class="pill">${label}</span>`;
    const a = document.createElement('div');
    a.textContent = o.ans || '—';
    const s = document.createElement('div');
    const bucket = o.conf>=70?'high':(o.conf>=40?'mid':'low');
    s.className='score'; s.setAttribute('data-q',bucket);
    s.innerHTML = `<span class="muted">Confidence</span> <b>${Math.round(o.conf)}%</b>`;
    const l = document.createElement('div');
    l.className='link';
    if(o.url){
      const link = document.createElement('a');
      link.href = o.url; link.textContent = o.title || o.url; link.target='_blank'; link.rel='noopener';
      l.appendChild(link);
    } else {
      l.innerHTML = '<span class="muted">No link</span>';
    }
    wrap.append(t,a,s,l);
    td.appendChild(wrap);
    return td;
  };

  tr.append(tdQ,
            makeCell(row.euroncap,'Euro NCAP'),
            makeCell(row.r79,'UNECE R79'),
            makeCell(row.r171,'UNECE R171'),
            makeCell(row.dcas,'DCAS'));
  els.tbody.appendChild(tr);
}

function renderTable(){
  els.tbody.innerHTML = '';
  for(const row of resultsMatrix){ renderRow(row); }
}

async function pooled(tasks, limit=4){
  const q = tasks.slice();
  const run = async ()=>{
    while(q.length){
      const fn = q.shift();
      try{ await fn(); } catch(e){ console.warn(e); }
    }
  };
  await Promise.all(Array.from({length:limit}, run));
}
function cssEscape(s){ return s.replace(/"/g,'&quot;'); }

// ---- Google CSE search ----
async function searchOneCSE(query, siteFilter){
  const key = els.gKey.value.trim();
  const cx  = els.gCx.value.trim();
  const dateRestrict = els.dateRestrict.value; // "", d7, m1, y1
  const q = `${query} ${siteFilter}`.trim();
  const params = new URLSearchParams({
    key, cx, q, num:'5'
  });
  if(dateRestrict) params.set('dateRestrict', dateRestrict);

  try{
    const url = 'https://www.googleapis.com/customsearch/v1?' + params.toString();
    const resp = await fetch(url);
    if(!resp.ok){
      console.warn('CSE API error', resp.status, await resp.text());
      return failAns(`Search error (${resp.status})`);
    }
    const data = await resp.json();
    const items = data.items || [];
    if(items.length===0) return failAns('No results');

    // Pick best by simple relevance to title+snippet
    let best = null, bestScore = -1;
    for(const it of items){
      const title = it.title || '';
      const snippet = it.snippet || '';
      const link = it.link || '';
      const score = relevanceScore(query, title + ' ' + snippet);
      if(score > bestScore){
        bestScore = score;
        best = { title, snippet, url: link };
      }
    }
    const conf = clamp01(relevanceScore(query, (best.title||'')+' '+(best.snippet||''))) * 100;
    return { ans: best.snippet || '(no snippet)', conf, url: best.url, title: best.title };

  }catch(e){
    console.error(e);
    return failAns('Network or API error');
  }
}
function failAns(msg){ return { ans: msg, conf: 0, url:'', title:'' }; }

// ---- Text similarity scoring ----
function relevanceScore(query, text){
  const qTokens = tokenize(query);
  const tTokens = tokenize(text);
  if(qTokens.size===0 || tTokens.size===0) return 0;
  let intersect = 0;
  qTokens.forEach(tok => { if(tTokens.has(tok)) intersect++; });
  const jacc = intersect / (qTokens.size + tTokens.size - intersect);
  const lenBoost = Math.min(1, [...qTokens].reduce((acc,t)=>acc + (t.length>=4?0.02:0.0), 0));
  return Math.min(1, jacc*0.86 + lenBoost*0.14);
}
function tokenize(s){
  return new Set(
    (s||'').toLowerCase()
      .replace(/[^\p{L}\p{N}\-]+/gu,' ')
      .split(/\s+/)
      .filter(w => w && !STOP.has(w))
  );
}
const STOP = new Set('the a an of to for in and or on with without by from as be is are was were been being about into within at this that those these it its their there here what when how which who whom whose where why vs versus incl incl.'.split(/\s+/));
function clamp01(x){ return Math.max(0, Math.min(1, x)); }
</script>
</body>
</html>
