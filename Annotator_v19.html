<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annotator with Camera</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Chart.js core + Luxon adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>

  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-image/0.4.0/leaflet-image.js"></script>

  <style>
    html, body { height: 100%; margin: 0; overflow: hidden; padding: 0; font-family: Arial, sans-serif; }
    /* sidebar, buttons, tables styles unchanged... */
  </style>
</head>
<body>
  <button id="toggleSidebar" aria-expanded="false">☰</button>
  <div id="sidebar" class="collapsed">
    <!-- existing sidebar content -->
  </div>

  <div id="mainContent">
    <!-- Camera Capture Section -->
    <div id="cameraSection" class="section">
      <button id="startCamera" class="bigButton greyButton">Start Camera</button>
      <button id="takePhoto" class="bigButton greyButton" style="display:none;">Take Photo</button>
      <button id="stopCamera" class="bigButton greyButton" style="display:none;">Stop Camera</button>
      <video id="video" width="300" height="200" autoplay style="display:none; margin-top:10px; border:1px solid #ccc;"></video>
      <canvas id="photoCanvas" width="300" height="200" style="display:none;"></canvas>
    </div>

    <!-- Manual Annotation Section -->
    <div id="manualAnnotation" class="section">
      <textarea id="textBox" rows="2" placeholder="Enter your annotation here…"></textarea>
      <button class="blueButton bigButton" onclick="logButton('Manual annotation', false)">Manual annotation</button>
    </div>

    <!-- KPI Hot Keys, Issue list, snapshots, map, etc... -->
    <h3>Issue list</h3>
    <div id="logTableContainer" class="section"></div>

    <h3>Issue Snapshots</h3>
    <div id="snapshotTableContainer" class="section"></div>

    <!-- New Photo Table -->
    <h3>Captured Photos</h3>
    <div id="photoTableContainer" class="section"></div>

    <!-- other sections: maps, charts, tables... -->
    
    <footer style="text-align:center; padding:10px; font-size:12px; color:#666;">
      © Lynoit Tech 2025
    </footer>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Variables for camera
    let videoStream = null;
    let currentPhoto = null;

    const startBtn = document.getElementById('startCamera');
    const takeBtn  = document.getElementById('takePhoto');
    const stopBtn  = document.getElementById('stopCamera');
    const video    = document.getElementById('video');
    const canvas   = document.getElementById('photoCanvas');
    const ctx      = canvas.getContext('2d');

    startBtn.onclick = async () => {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = videoStream;
        video.style.display = 'block';
        takeBtn.style.display = 'inline-block';
        stopBtn.style.display = 'inline-block';
        startBtn.style.display = 'none';
      } catch (err) {
        console.error('Camera error', err);
        alert('Unable to access camera: ' + err.message);
      }
    };

    takeBtn.onclick = () => {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      currentPhoto = canvas.toDataURL('image/png');
      alert('Photo captured! It will be attached to the next log entry.');
    };

    stopBtn.onclick = () => {
      videoStream.getTracks().forEach(t => t.stop());
      video.style.display = 'none';
      takeBtn.style.display = 'none';
      stopBtn.style.display = 'none';
      startBtn.style.display = 'inline-block';
    };

    // Existing state
    let logTable = [];
    let redCounts = {};
    let totalDist = 0;
    // ... other variables

    function logButton(name, isRed) {
      // ... existing code capturing date, time, location, etc.
      const comment = document.getElementById('textBox').value;

      // Add row including currentPhoto
      logTable.push({
        issue: name,
        timestamp: new Date(),
        // ... other fields
        comment,
        photo: currentPhoto
      });

      // Reset photo so next entry doesn't reuse it
      currentPhoto = null;
      displayLogTable();
      displayPhotoTable();

      // ... existing marker code
      document.getElementById('textBox').value = '';
    }

    function displayLogTable() {
      let html = `<table><tr><th>No.</th><th>Issue</th><th>Date</th><th>Time</th><th>Comment</th></tr>`;
      logTable.forEach((entry, i) => {
        const d = entry.timestamp;
        html += `<tr><td>${i+1}</td>` +
                `<td>${entry.issue}</td>` +
                `<td>${d.toLocaleDateString()}</td>` +
                `<td>${d.toLocaleTimeString()}</td>` +
                `<td>${entry.comment || ''}</td>` +
                `</tr>`;
      });
      html += `</table>`;
      document.getElementById('logTableContainer').innerHTML = html;
    }

    function displayPhotoTable() {
      let html = `<table><tr><th>No.</th><th>Photo</th><th>Issue</th></tr>`;
      logTable.forEach((entry, i) => {
        html += `<tr><td>${i+1}</td>` +
                `<td>${entry.photo ? `<img src="${entry.photo}" width="100" alt="Photo ${i+1}">` : '—'}</td>` +
                `<td>${entry.issue}</td>` +
                `</tr>`;
      });
      html += `</table>`;
      document.getElementById('photoTableContainer').innerHTML = html;
    }

    // ... rest of existing code (maps, charts, etc.)
  </script>
</body>
</html>
