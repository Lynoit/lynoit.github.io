<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACC Cut-In Simulator</title>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#0f1220; --panel:#161a2b; --ink:#e8ecff; --muted:#a9b0d5; --accent:#7cc4ff; --ok:#7CFFB2; --warn:#ffd36b; --bad:#ff8a8a;
    --grid-gap:14px;
  }
  html,body{height:100%; margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,Segoe UI,Roboto,Inter,Arial;}
  .wrap{display:grid; grid-template-columns: 360px 660px 520px; gap:var(--grid-gap); padding:var(--grid-gap);}
  .card{background:var(--panel); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.35); padding:14px 16px;}
  h2{margin:0 0 10px 0; font-weight:600; letter-spacing:.2px}
  .row{display:grid; grid-template-columns: 1fr 110px; gap:10px; align-items:center; margin:8px 0}
  input[type="number"], input[type="range"], select{
    width:100%; box-sizing:border-box; background:#0f1325; color:var(--ink); border:1px solid #242948; border-radius:10px; padding:8px 10px;
  }
  .mini{font-size:12px; color:var(--muted)}
  .btnbar{display:flex; gap:8px; margin:12px 0}
  button{background:#1e2442; color:var(--ink); border:1px solid #2a315b; border-radius:12px; padding:8px 12px; cursor:pointer}
  button:hover{filter:brightness(1.1)}
  button:disabled{opacity:.5; cursor:not-allowed}
  table{width:100%; border-collapse:collapse; font-size:14px}
  th,td{border-bottom:1px solid #242948; padding:6px 8px; text-align:left}
  th{color:var(--muted); font-weight:600}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#1f274c; color:var(--ink)}
  #charts{display:grid; gap:10px}
  canvas{background:#0b0f1f; border:1px solid #242948; border-radius:12px}
  .hint{color:var(--muted); font-size:12px; margin-top:8px}
  .twocol{display:grid; grid-template-columns: 1fr 90px; gap:10px; align-items:center}
  .checkboxes{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:4px 0 8px}
  label.cb{display:flex; gap:6px; align-items:center; background:#101531; border:1px solid #242948; padding:6px 10px; border-radius:10px; cursor:pointer}
  .readout{display:grid; grid-template-columns: 1fr 1fr; gap:6px; font-size:13px; margin-top:8px}
  .readout div{background:#101531; border:1px solid #242948; border-radius:8px; padding:6px 8px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .tag{font-size:11px; color:var(--muted)}
  .unit{color:var(--muted); font-size:12px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
</style>
</head>
<body>
<div class="wrap">
  <!-- LEFT: Controls + Milestones -->
  <section class="card">
    <h2>Inputs &amp; Controls</h2>

    <div class="row"><div>Cut-in object speed <span class="unit">(km/h)</span></div>
      <input id="in_vCutKph" type="number" min="0" max="200" step="1" value="80">
    </div>
    <div class="row"><div>Cut-in initial gap <span class="unit">(m, front-to-front)</span></div>
      <input id="in_gap" type="number" min="-20" max="200" step="1" value="10">
    </div>
    <div class="row"><div>Cut-in lateral peak speed <span class="unit">(m/s)</span></div>
      <input id="in_vLat" type="number" min="0.1" max="5" step="0.1" value="1">
    </div>
    <div class="row"><div>Cut-in duration <span class="unit">(s)</span></div>
      <input id="in_tCut" type="number" min="0.5" max="8" step="0.1" value="3">
    </div>
    <div class="row"><div>ACC set speed <span class="unit">(km/h)</span></div>
      <input id="in_vSetKph" type="number" min="0" max="200" step="1" value="90">
    </div>
    <div class="row"><div>ACC time gap <span class="unit">(s)</span></div>
      <input id="in_headway" type="number" min="0.8" max="3" step="0.1" value="2">
    </div>

    <div style="margin-top:8px">
      <div class="mini">Detection method(s)</div>
      <div class="checkboxes">
        <label class="cb"><input id="cb_m1" type="checkbox" checked> Method 1: % inside lane</label>
        <label class="cb"><input id="cb_m2" type="checkbox"> Method 2: sustained lateral motion</label>
      </div>
      <div class="twocol">
        <div><span class="mini">M1 threshold (%)</span></div>
        <input id="in_m1pct" type="number" min="0" max="100" step="1" value="50">
      </div>
      <div class="twocol">
        <div><span class="mini">M2 window (ms)</span></div>
        <input id="in_m2ms" type="number" min="100" max="2000" step="50" value="500">
      </div>
      <div class="hint">If both are checked, detection fires when either method triggers.</div>
    </div>

    <div class="btnbar">
      <button id="btnStart">Start</button>
      <button id="btnPause" disabled>Pause</button>
      <button id="btnReset">Reset</button>
    </div>

    <div class="readout" id="readout">
      <div><b class="tag">Sim time</b><div class="mono" id="ro_t">0.0 s</div></div>
      <div><b class="tag">Gap</b><div class="mono" id="ro_gap">—</div></div>
      <div><b class="tag">Desired gap</b><div class="mono" id="ro_gdes">—</div></div>
      <div><b class="tag">v ego</b><div class="mono" id="ro_vego">—</div></div>
      <div><b class="tag">v cut-in</b><div class="mono" id="ro_vcut">—</div></div>
      <div><b class="tag">a ego</b><div class="mono" id="ro_aego">—</div></div>
    </div>

    <h2 style="margin-top:16px">Milestones</h2>
    <table id="milestones">
      <thead><tr><th style="width:110px">Time (s)</th><th>Event</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- MIDDLE: Charts -->
  <section class="card">
    <h2>Plots (fixed size)</h2>
    <div id="charts">
      <canvas id="chartSpeed" width="640" height="220"></canvas>
      <canvas id="chartAccel" width="640" height="180"></canvas>
    </div>
    <div class="hint">Time axis in seconds; historical data kept for the whole run. Speed shows ego and cut-in; acceleration is ego longitudinal.</div>
  </section>

  <!-- RIGHT: Birdview -->
  <section class="card">
    <h2>Bird-view</h2>
    <canvas id="bird" width="500" height="480"></canvas>
    <div class="hint">Straight road with two lanes. Cut-in comes from the left lane into ego lane; lane centering keeps the ego at lane center.</div>
  </section>
</div>

<script>
(() => {
  // ---------- Constants & helpers ----------
  const laneW = 3.5;
  const carLen = 4.5, carWid = 1.8;
  const dt = 0.02;
  const controlHz = 1/dt;
  const maxAccel = 1.5;
  const maxDecel = 3.0;
  const kCruise = 0.6;
  const kGap = 0.25, kRel = 0.8;
  const cutInStartTime = 1.0;
  const vyMinForM2 = 0.05;
  const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));
  const kph2mps = v=>v/3.6;

  // ---------- DOM ----------
  const el = id => document.getElementById(id);
  const in_vCutKph = el('in_vCutKph');
  const in_gap     = el('in_gap');
  const in_vLat    = el('in_vLat');
  const in_tCut    = el('in_tCut');
  const in_vSetKph = el('in_vSetKph');
  const in_headway = el('in_headway');
  const cb_m1 = el('cb_m1'), cb_m2 = el('cb_m2');
  const in_m1pct = el('in_m1pct'), in_m2ms = el('in_m2ms');
  const btnStart = el('btnStart'), btnPause = el('btnPause'), btnReset = el('btnReset');
  const ro_t = el('ro_t'), ro_gap = el('ro_gap'), ro_gdes = el('ro_gdes'), ro_vego = el('ro_vego'),
        ro_vcut = el('ro_vcut'), ro_aego = el('ro_aego');
  const msTableBody = document.querySelector('#milestones tbody');
  const bird = el('bird'), ctx = bird.getContext('2d');

  // ---------- Simulation state ----------
  let sim = null, timer = null, charts = null;

  function initSim() {
    const vSet = kph2mps(+in_vSetKph.value);
    const vCut = kph2mps(+in_vCutKph.value);
    const gap0 = +in_gap.value;
    const tCut = +in_tCut.value;
    const headway = +in_headway.value;

    sim = {
      t: 0,
      running: false,
      detected: false,
      detectTime: null,
      decelStarted: false,
      decelTime: null,
      gapReached: false,
      gapReachedTime: null,
      usedM1: false,
      usedM2: false,
      xE: 0, vE: vSet, aE: 0,
      xC: gap0, vC: vCut,
      yC: laneW,
      m2Timer: 0,
      logT: [], logVego: [], logVcut: [], logAego: [],
      vSet, vCut, tCut, headway,
    };
    resetMilestones();
    addMilestone(0, 'Simulation start');
    addMilestone(cutInStartTime, 'Start of lateral movement of the cut-in object');
  }

  function resetMilestones(){
    msTableBody.innerHTML = '';
  }

  function addMilestone(time, label){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="mono">${time.toFixed(2)}</td><td>${label}</td>`;
    const rows = [...msTableBody.querySelectorAll('tr')];
    let inserted = false;
    for (let i=0;i<rows.length;i++){
      const t = parseFloat(rows[i].children[0].textContent);
      if (time < t){ msTableBody.insertBefore(tr, rows[i]); inserted = true; break;}
    }
    if(!inserted) msTableBody.appendChild(tr);
  }

  // ---------- Detection logic ----------
  function percentInsideEgoLane(yCenter){
    const L = carWid;
    const y0 = yCenter - L/2, y1 = yCenter + L/2;
    const a = Math.max(y0, -laneW/2);
    const b = Math.min(y1,  laneW/2);
    const overlap = Math.max(0, b - a);
    return (overlap / L) * 100.0;
  }

  function updateDetection(sim){
    if (sim.detected) return;
    let fired = false;

    if (cb_m1.checked){
      const pct = percentInsideEgoLane(sim.yC);
      const thr = +in_m1pct.value;
      if (pct >= thr){
        sim.detected = true; sim.detectTime = sim.t; sim.usedM1 = true; fired = true;
      }
    }

    if (!fired && cb_m2.checked){
      const vy = vyCut(sim.t);
      const windowSec = (+in_m2ms.value) / 1000.0;
      if (vy < -vyMinForM2) sim.m2Timer += dt; else sim.m2Timer = 0;
      if (sim.m2Timer >= windowSec){
        sim.detected = true; sim.detectTime = sim.t; sim.usedM2 = true; fired = true;
      }
    }

    if (fired){
      addMilestone(sim.detectTime, `Detection of the cut-in object ${sim.usedM1 && sim.usedM2 ? '(M1+M2)' : (sim.usedM1? '(M1)':'(M2)')}`);
    }
  }

  // ---------- Lateral profile (smooth cosine S-curve) ----------
  function yCut(t){
    if (t < cutInStartTime) return laneW;
    const s = (t - cutInStartTime) / sim.tCut;
    if (s >= 1) return 0;
    const u = 0.5*(1 - Math.cos(Math.PI*s));
    return laneW * (1 - u);
  }
  function vyCut(t){
    if (t <= cutInStartTime || t >= cutInStartTime + sim.tCut) return 0;
    const s = (t - cutInStartTime) / sim.tCut;
    return - laneW * 0.5 * Math.sin(Math.PI*s) * (Math.PI / sim.tCut);
  }

  // ---------- Dynamics step ----------
  function step(){
    const s = sim;
    s.t += dt;
    s.yC = yCut(s.t);
    s.xC += s.vC * dt;

    updateDetection(s);

    const gap = s.xC - s.xE;
    const gDes = Math.max(0, s.headway * s.vE);

    let aCmd;
    if (!s.detected){
      aCmd = clamp(kCruise * (s.vSet - s.vE), -maxDecel, maxAccel);
    } else {
      const eGap = gap - gDes;
      const eVel = s.vC - s.vE;
      aCmd = kGap * eGap + kRel * eVel;
      aCmd = clamp(aCmd, -maxDecel, maxAccel);

      if (!s.decelStarted && aCmd < -0.01){
        s.decelStarted = true; s.decelTime = s.t;
        addMilestone(s.decelTime, 'Start of deceleration');
      }
      if (!s.gapReached && s.decelStarted && (gap >= gDes)){
        s.gapReached = true; s.gapReachedTime = s.t;
        addMilestone(s.gapReachedTime, 'ACC reaches desired time gap');
      }
    }

    s.aE = aCmd;
    s.vE = Math.max(0, s.vE + s.aE * dt);
    s.xE += s.vE * dt;

    s.logT.push(s.t);
    s.logVego.push(s.vE);
    s.logVcut.push(s.vC);
    s.logAego.push(s.aE);

    ro_t.textContent = `${s.t.toFixed(1)} s`;
    ro_gap.textContent = `${gap.toFixed(1)} m`;
    ro_gdes.textContent = `${gDes.toFixed(1)} m`;
    ro_vego.textContent = `${(s.vE*3.6).toFixed(1)} km/h`;
    ro_vcut.textContent = `${(s.vC*3.6).toFixed(1)} km/h`;
    ro_aego.textContent = `${s.aE.toFixed(2)} m/s²`;

    if ((s.t * controlHz) % 2 < 1e-6) updateCharts();
    drawBird();
  }

  // ---------- Charts ----------
  function initCharts(){
    const sp = new Chart(el('chartSpeed').getContext('2d'), {
      type:'line',
      data:{labels:[], datasets:[
        {label:'Ego speed (km/h)', data:[], borderWidth:2, tension:0.1},
        {label:'Cut-in speed (km/h)', data:[], borderWidth:2, borderDash:[6,4], tension:0.1}
      ]},
      options:{
        animation:false, responsive:false, maintainAspectRatio:false,
        scales:{
          x:{title:{display:true, text:'Time (s)'}},
          y:{title:{display:true, text:'Speed (km/h)'}}
        },
        plugins:{legend:{labels:{color:'#e8ecff'}}, tooltip:{mode:'index', intersect:false}}
      }
    });

    const ac = new Chart(el('chartAccel').getContext('2d'), {
      type:'line',
      data:{labels:[], datasets:[
        {label:'Ego accel (m/s²)', data:[], borderWidth:2, tension:0.1}
      ]},
      options:{
        animation:false, responsive:false, maintainAspectRatio:false,
        scales:{
          x:{title:{display:true, text:'Time (s)'}},
          y:{title:{display:true, text:'Accel (m/s²)'}}
        },
        plugins:{legend:{labels:{color:'#e8ecff'}}, tooltip:{mode:'index', intersect:false}}
      }
    });

    charts = {sp, ac};
  }

  function updateCharts(){
    const s = sim;
    const labels = s.logT.map(t=>t.toFixed(2));
    charts.sp.data.labels = labels;
    charts.ac.data.labels = labels;
    charts.sp.data.datasets[0].data = s.logVego.map(v=>v*3.6);
    charts.sp.data.datasets[1].data = s.logVcut.map(v=>v*3.6);
    charts.ac.data.datasets[0].data = s.logAego;
    charts.sp.update('none'); charts.ac.update('none');
  }

  // ---------- Birdview drawing ----------
  function drawBird(){
    const s = sim;
    const W = bird.width, H = bird.height;
    ctx.clearRect(0,0,W,H);

    const xMin = s.xE - 15, xMax = s.xE + 70;
    const yMin = -laneW*0.8, yMax = laneW*1.8;

    const toPix = (x,y)=>{
      const px = (x - xMin) / (xMax - xMin) * (W-30) + 15;
      const py = (1 - (y - yMin) / (yMax - yMin)) * (H-30) + 15;
      return [px,py];
    };

    ctx.lineWidth = 2;
    ctx.strokeStyle = '#2a315b';
    for (const y of [-laneW/2, laneW*1.5]){
      ctx.beginPath();
      let [px,py] = toPix(xMin, y);
      ctx.moveTo(px,py);
      [px,py] = toPix(xMax, y);
      ctx.lineTo(px,py); ctx.stroke();
    }
    ctx.setLineDash([6,6]); ctx.strokeStyle='#3f4778';
    for (const y of [0, laneW]){
      ctx.beginPath();
      let [px,py] = toPix(xMin, y);
      ctx.moveTo(px,py);
      [px,py] = toPix(xMax, y);
      ctx.lineTo(px,py); ctx.stroke();
    }
    ctx.setLineDash([]);

    // trajectory hint
    ctx.strokeStyle = '#7cc4ff'; ctx.globalAlpha = 0.35; ctx.lineWidth = 2;
    ctx.beginPath();
    for (let u=0; u<=1; u+=0.02){
      const t = cutInStartTime + u*sim.tCut;
      const xc = sim.xC - (sim.t - t) * sim.vC;
      const yc = yCut(t);
      const [px,py] = toPix(xc,yc);
      if (u===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
    }
    ctx.stroke();
    ctx.globalAlpha = 1;

    function drawCar(x,y,color,heading=0){
      const [px,py] = toPix(x,y);
      const scaleX = (W-30)/( (sim.xE+70) - (sim.xE-15) );
      const scaleY = (H-30)/( (laneW*1.8) - (-laneW*0.8) );
      const w = carLen*scaleX, h = carWid*scaleY;
      ctx.save();
      ctx.translate(px,py);
      ctx.rotate(-heading);
      ctx.fillStyle = color;
      roundRect(ctx, -w*0.5, -h*0.5, w, h, Math.min(w,h)*0.15);
      ctx.fill();
      ctx.restore();
    }
    function roundRect(ctx,x,y,w,h,r){
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      ctx.closePath();
    }

    drawCar(sim.xE, 0, '#7CFFB2');
    drawCar(sim.xC, sim.yC, sim.detected ? '#ffd36b' : '#a5c6ff');

    ctx.fillStyle = '#a9b0d5';
    ctx.font = '12px system-ui, Segoe UI';
    ctx.fillText('Ego lane', 10, 18);
    ctx.fillText('Left lane (cut-in origin)', 10, 34);
    if (sim.detected){
      ctx.fillStyle = '#ffd36b';
      ctx.fillText('Cut-in detected', 10, 50);
    }
  }

  // ---------- Controls ----------
  function start(){
    if (!sim) initSim();
    if (sim.running) return;
    sim.running = true;
    btnStart.disabled = true;
    btnPause.disabled = false;
    if (!charts) initCharts();
    updateCharts();
    timer = setInterval(step, dt*1000);
  }

  function pause(){
    if (!sim || !sim.running) return;
    sim.running = false;
    btnStart.disabled = false;
    btnPause.disabled = true;
    clearInterval(timer);
  }

  function reset(){
    if (timer){ clearInterval(timer); timer = null; }
    sim = null;
    btnStart.disabled = false;
    btnPause.disabled = true;
    if (!charts) initCharts();
    charts.sp.data.labels = []; charts.sp.data.datasets[0].data=[]; charts.sp.data.datasets[1].data=[];
    charts.ac.data.labels = []; charts.ac.data.datasets[0].data=[];
    charts.sp.update('none'); charts.ac.update('none');
    ctx.clearRect(0,0,bird.width,bird.height);
    ro_t.textContent='0.0 s'; ro_gap.textContent='—'; ro_gdes.textContent='—';
    ro_vego.textContent='—'; ro_vcut.textContent='—'; ro_aego.textContent='—';
    resetMilestones();
  }

  btnStart.addEventListener('click', start);
  btnPause.addEventListener('click', pause);
  btnReset.addEventListener('click', reset);

  // Initialize once
  initSim();
})();
</script>
</body>
</html>
