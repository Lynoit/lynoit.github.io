<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACC Simulator — Aggressive / Standard / Eco</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- SheetJS (optional; Excel) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root { --bg:#0f1116; --panel:#141822; --ink:#e9eef9; --muted:#9fb0d0; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--ink); }
  .grid { display:grid; grid-template-columns: 320px minmax(460px,1fr) 520px; gap:12px; height:100vh; padding:10px; }
  .panel { background:var(--panel); border:1px solid #232a3c; border-radius:16px; padding:12px; overflow:auto; }
  h2,h3{ margin:0.3rem 0 0.6rem; }
  label{ color:var(--muted); font-size:.9rem; }
  input{ width:100%; padding:6px 8px; border-radius:10px; border:1px solid #2a3243; background:#0d1118; color:var(--ink); }
  .row{ display:grid; grid-template-columns: 1fr 110px; gap:8px; align-items:center; margin-bottom:8px; }
  fieldset{ border:1px solid #24304a; border-radius:14px; padding:10px 12px; margin:10px 0 14px; }
  legend{ color:var(--muted); padding:0 6px; }
  button{ background:#1b2334; border:1px solid #2f3a56; color:var(--ink); padding:8px 10px; border-radius:12px; cursor:pointer; }
  button:hover{ filter:brightness(1.1); }
  .btnbar{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 8px; }
  .tiny{ color:var(--muted); font-size:.8rem; }
  .plots{ display:flex; flex-direction:column; gap:8px; }
  canvas.chart{ background:#0b0f17; border:1px solid #24304a; border-radius:12px; width:100%; }
  #bird{ background:#0b0f17; border:1px solid #24304a; border-radius:16px; width:100%; display:block; }
  .kpi{ display:grid; grid-template-columns: repeat(3,1fr); gap:8px; margin-top:6px; }
  .kpi div{ background:#0b0f17; border:1px solid #24304a; border-radius:12px; padding:8px; text-align:center; }
  .tag{ font-size:.75rem; color:var(--muted); }
</style>
</head>
<body>
<div class="grid">
  <!-- LEFT -->
  <div class="panel">
    <h2>ACC Simulator</h2>
    <div class="btnbar">
      <input type="file" id="file" accept=".xlsx,.xls"/>
      <button id="loadDemo">Load demo</button>
      <button id="run">Run</button>
      <button id="play">Play</button>
      <button id="pause">Pause</button>
    </div>

    <fieldset>
      <legend>Global</legend>
      <div class="row"><label>Set speed vSet (km/h)</label><input id="vSet" type="number" step="1" value="90"></div>
      <div class="row"><label>Max accel (m/s²)</label><input id="accMax" type="number" step="0.1" value="2"></div>
      <div class="row"><label>Max brake (m/s²)</label><input id="decMax" type="number" step="0.1" value="-4"></div>
      <div class="row"><label>Mass m (kg)</label><input id="mass" type="number" step="10" value="2400"></div>
      <div class="row"><label>CdA (m²)</label><input id="CdA" type="number" step="0.01" value="0.32"></div>
      <div class="row"><label>Rolling Cr</label><input id="Cr" type="number" step="0.001" value="0.012"></div>
    </fieldset>

    <fieldset>
      <legend>Headways</legend>
      <div class="row"><label>Aggressive T<sub>gap</sub> (s)</label><input id="Tgap_ag" type="number" step="0.1" value="1.0"></div>
      <div class="row"><label>Standard T<sub>gap</sub> (s)</label><input id="Tgap_st" type="number" step="0.1" value="2.0"></div>
      <div class="row"><label>Eco T<sub>gap</sub> (s)</label><input id="Tgap_ec" type="number" step="0.1" value="4.0"></div>
    </fieldset>

    <fieldset>
      <legend>Aggressiveness (gain scale ×)</legend>
      <div class="row"><label>Aggressive</label><input id="gain_ag" type="number" step="0.05" value="1.00"></div>
      <div class="row"><label>Standard</label><input id="gain_st" type="number" step="0.05" value="1.00"></div>
      <div class="row"><label>Eco</label><input id="gain_ec" type="number" step="0.05" value="1.00"></div>
    </fieldset>

    <fieldset>
      <legend>Cruise Assist strength</legend>
      <div class="row"><label>Aggressive (0–1)</label><input id="cruise_ag" type="number" min="0" max="1" step="0.05" value="0.50"></div>
      <div class="row"><label>Standard (0–1)</label><input id="cruise_st" type="number" min="0" max="1" step="0.05" value="0.50"></div>
      <div class="row"><label>Eco (0–1)</label><input id="cruise_ec" type="number" min="0" max="1" step="0.05" value="0.30"></div>
    </fieldset>

    <fieldset>
      <legend>Animation</legend>
      <div class="row"><label>Window back (m)</label><input id="winBack" type="number" step="5" value="125"></div>
      <div class="row"><label>Window ahead (m)</label><input id="winAhead" type="number" step="1" value="5"></div>
      <div class="row"><label>Frame skip</label><input id="frameSkip" type="number" min="1" step="1" value="5"></div>
      <div class="row"><label>Frame pause (s)</label><input id="pauseTime" type="number" step="0.01" value="0.05"></div>
    </fieldset>

    <div class="kpi">
      <div><div class="tag">Energy Aggressive</div><div id="kAgg">–</div></div>
      <div><div class="tag">Energy Standard</div><div id="kStd">–</div></div>
      <div><div class="tag">Energy Eco</div><div id="kEco">–</div></div>
    </div>

    <div id="status" class="tiny">Ready. Click <b>Load demo</b> then <b>Run</b>.</div>
  </div>

  <!-- MIDDLE -->
  <div class="panel">
    <h3>Plots</h3>
    <div class="plots">
      <canvas id="acc"  class="chart" width="800" height="170"></canvas>
      <canvas id="spd"  class="chart" width="800" height="170"></canvas>
      <canvas id="gap"  class="chart" width="800" height="170"></canvas>
      <canvas id="tgap" class="chart" width="800" height="170"></canvas>
      <canvas id="energy" class="chart" width="800" height="170"></canvas>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="panel">
    <h3>Bird-view</h3>
    <canvas id="bird" width="900" height="420"></canvas>
    <div class="tiny">Dashed rulers = headway from lead (0.5–5 s)</div>
  </div>
</div>

<script>
const statusEl = document.getElementById('status');
function status(msg){ statusEl.textContent = msg; console.log(msg); }
function clamp(x,lo,hi){ return Math.max(lo, Math.min(hi, x)); }

const rhoAir=1.225, g=9.81;
const colors = {
  lead: 'rgba(230,230,230,0.9)',
  ag: 'rgba(255, 76, 76, 0.95)',
  st: 'rgba(85,145,255,0.95)',
  ec: 'rgba(61,207,117,0.95)'
};

let scenario = { t:[], spdLead_kmh:[] };

function loadDemo(){
  // simple, clean profile
  const dt=0.1, T=160;
  const n=Math.floor(T/dt)+1;
  const t=new Array(n);
  const v=new Array(n);
  for(let k=0;k<n;k++){
    const ts = +(k*dt).toFixed(3); t[k]=ts;
    let s;
    if(ts<10) s=90;
    else if(ts<45) s=90 - (ts-10)*30/35;
    else if(ts<70) s=60 + 10*Math.sin((ts-45)/25*Math.PI*2);
    else if(ts<100) s=60 + (ts-70)*1.2;
    else s=90;
    v[k]= Math.max(10,s);
  }
  scenario.t=t; scenario.spdLead_kmh=v;
  status(`Demo loaded: ${n} rows, dt=${dt}s`);
}

async function loadXlsx(file){
  if(typeof XLSX==='undefined'){ throw new Error('XLSX library failed to load.'); }
  const ab = await file.arrayBuffer();
  const wb = XLSX.read(ab, {type:'array'});
  const ws = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:null});
  const t=[], v=[];
  for(const r of rows){
    if(!r || r.length<2) continue;
    if(typeof r[0]==='number' && typeof r[1]==='number'){ t.push(r[0]); v.push(Math.max(10, r[1])); }
  }
  if(t.length<3) throw new Error('Need at least 3 numeric rows with Time (s) & Speed (km/h).');
  if(t[1]-t[0] <= 0) throw new Error('Time must be strictly increasing.');
  scenario.t=t; scenario.spdLead_kmh=v;
  status(`Excel loaded: ${t.length} rows, dt=${(t[1]-t[0]).toFixed(3)}s`);
}

function gather(){
  return {
    vSet: +document.getElementById('vSet').value,
    accMax: +document.getElementById('accMax').value,
    decMax: +document.getElementById('decMax').value,
    m: +document.getElementById('mass').value,
    CdA: +document.getElementById('CdA').value,
    Cr: +document.getElementById('Cr').value,
    Tgap_ag: +document.getElementById('Tgap_ag').value,
    Tgap_st: +document.getElementById('Tgap_st').value,
    Tgap_ec: +document.getElementById('Tgap_ec').value,
    gain_ag: +document.getElementById('gain_ag').value,
    gain_st: +document.getElementById('gain_st').value,
    gain_ec: +document.getElementById('gain_ec').value,
    cruise_ag: +document.getElementById('cruise_ag').value,
    cruise_st: +document.getElementById('cruise_st').value,
    cruise_ec: +document.getElementById('cruise_ec').value
  };
}

/* ------------ Simulation ------------ */
function simulate(p){
  const t = scenario.t;
  if(!t || t.length<3) throw new Error('No scenario loaded.');
  const dt = t[1]-t[0];
  if(!(dt>0) || !isFinite(dt)) throw new Error('Invalid dt. Check Time column.');
  const kmh = scenario.spdLead_kmh;
  const N = t.length;
  const vLead = kmh.map(s=>s/3.6);
  const aLead = new Array(N);
  aLead[0]=0; for(let i=1;i<N;i++) aLead[i]=(vLead[i]-vLead[i-1])/dt;

  const base={
    ag:{Kp:1.75*p.gain_ag, Ki:1.00*p.gain_ag, Kd:1.00*p.gain_ag, Kff:0.75*p.gain_ag, T:p.Tgap_ag},
    st:{Kp:1.50*p.gain_st, Ki:1.00*p.gain_st, Kd:0.40*p.gain_st, Kff:0.05*p.gain_st, T:p.Tgap_st},
    ec:{Kp:0.50*p.gain_ec, Ki:0.08*p.gain_ec, Kd:0.60*p.gain_ec, Kff:0.00,            T:p.Tgap_ec}
  };
  const Fdrag = v=>0.5*rhoAir*p.CdA*v*v;
  const Froll = p.m*g*p.Cr;

  let vE={Aggressive:vLead[0], Standard:vLead[0], Eco:vLead[0]};
  let xE={Aggressive:-base.ag.T*vLead[0], Standard:-base.st.T*vLead[0], Eco:-base.ec.T*vLead[0]};
  let I={Aggressive:0, Standard:0, Eco:0};
  let xLead=0;

  const vLog={Aggressive:Array(N), Standard:Array(N), Eco:Array(N)};
  const aLog={Aggressive:Array(N), Standard:Array(N), Eco:Array(N)};
  const gLog={Aggressive:Array(N), Standard:Array(N), Eco:Array(N)};
  const tgLog={Aggressive:Array(N), Standard:Array(N), Eco:Array(N)};
  const eLog={Aggressive:Array(N).fill(0), Standard:Array(N).fill(0), Eco:Array(N).fill(0)};
  const xLog={Aggressive:Array(N), Standard:Array(N), Eco:Array(N)};
  const xLeadLog=Array(N); let eJ={Aggressive:0, Standard:0, Eco:0};

  for(let k=0;k<N;k++){
    xLead += vLead[k]*dt; xLeadLog[k]=xLead;

    for(const nm of ["Aggressive","Standard","Eco"]){
      const tag = nm==="Aggressive"?"ag":(nm==="Standard"?"st":"ec");
      const Kp=base[tag].Kp, Ki=base[tag].Ki, Kd=base[tag].Kd, Kff=base[tag].Kff, Tgap=base[tag].T;
      const v=vE[nm], gap=xLead - xE[nm], rel=vLead[k]-v;
      const eD = gap - Tgap*v;
      I[nm] += eD*dt;

      let aPID = Kp*eD + Ki*I[nm] + Kd*rel;
      let aFF = Kff*aLead[k];
      let aCmd;

      if(nm==="Aggressive"){
        if(gap > Tgap*v + 3){ aCmd = Math.min(p.accMax, p.cruise_ag*(p.vSet/3.6 - v)) + aFF; }
        else { aCmd = aPID + aFF; }

      } else if(nm==="Standard"){
        if(gap > Tgap*v + 3){ aCmd = Math.min(p.accMax, p.cruise_st*(p.vSet/3.6 - v)) + aFF; }
        else { aCmd = aPID + aFF; }

      } else {
        if(gap > Tgap*v + 5){ aCmd = Math.min(1.0, p.cruise_ec*(p.vSet/3.6 - v)); }
        else { aCmd = aPID; }
      }

      const aSat = clamp(aCmd, p.decMax, p.accMax);
      if(aSat!==aCmd) I[nm]-=eD*dt;

      const P = Math.max(0, (p.m*aSat + Fdrag(v) + Froll)*v);
      eJ[nm]+= P*dt; eLog[nm][k]= eJ[nm]/3.6e6;

      vLog[nm][k]=v; aLog[nm][k]=aSat; gLog[nm][k]=gap; tgLog[nm][k]= gap/Math.max(v,0.1); xLog[nm][k]=xE[nm];
      vE[nm]=Math.max(0, v + aSat*dt); xE[nm]+= vE[nm]*dt;
    }
  }
  const energy = {
    Aggressive: eLog.Aggressive[N-1],
    Standard:   eLog.Standard[N-1],
    Eco:        eLog.Eco[N-1]
  };
  return {t, dt, vLead, aLead, vLog, aLog, gLog, tgLog, eLog, xLeadLog, xLog, energy};
}

/* ------------ Charts ------------ */
let charts=null;
function makeChart(ctx, title, series){
  return new Chart(ctx, {
    type:'line',
    data:{ labels:[], datasets:series.map(s=>({
      label:s.label, data:[], borderColor:s.color, pointRadius:0, borderWidth:1.8, tension:0
    }))},
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{ mode:'index', intersect:false },
      scales:{
        x:{ title:{display:true, text:'Time [s]', color:'#9fb0d0'}, ticks:{color:'#c7d2e5'}, grid:{color:'#1f2433'} },
        y:{ ticks:{color:'#c7d2e5'}, grid:{color:'#1f2433'} }
      },
      plugins:{ legend:{ labels:{ color:'#e9eef9' }}, title:{ display:true, text:title, color:'#e9eef9' } }
    }
  });
}
function ensureCharts(){
  if(charts) return;
  charts = {
    acc:    makeChart(document.getElementById('acc'), 'Acceleration [m/s²]', [
              {label:'Lead', color:'rgba(220,220,220,0.8)'},
              {label:'Aggressive', color:colors.ag},
              {label:'Standard', color:colors.st},
              {label:'Eco', color:colors.ec},
            ]),
    spd:    makeChart(document.getElementById('spd'), 'Ego Speed [km/h]', [
              {label:'Lead (km/h)', color:'rgba(220,220,220,0.5)'},
              {label:'Aggressive', color:colors.ag},
              {label:'Standard', color:colors.st},
              {label:'Eco', color:colors.ec},
            ]),
    gap:    makeChart(document.getElementById('gap'), 'Distance Gap [m]', [
              {label:'Aggressive', color:colors.ag},
              {label:'Standard', color:colors.st},
              {label:'Eco', color:colors.ec},
            ]),
    tgap:   makeChart(document.getElementById('tgap'), 'Time Gap [s]', [
              {label:'Aggressive', color:colors.ag},
              {label:'Standard', color:colors.st},
              {label:'Eco', color:colors.ec},
            ]),
    energy: makeChart(document.getElementById('energy'), 'Cumulative Traction Energy [kWh]', [
              {label:'Aggressive', color:colors.ag},
              {label:'Standard', color:colors.st},
              {label:'Eco', color:colors.ec},
            ])
  };
}
function updateCharts(log){
  ensureCharts();
  const t=log.t;
  charts.acc.data.labels = t;
  charts.acc.data.datasets[0].data = log.aLead;
  charts.acc.data.datasets[1].data = log.aLog.Aggressive;
  charts.acc.data.datasets[2].data = log.aLog.Standard;
  charts.acc.data.datasets[3].data = log.aLog.Eco;
  charts.acc.update('none');

  charts.spd.data.labels = t;
  charts.spd.data.datasets[0].data = log.vLead.map(v=>v*3.6);
  charts.spd.data.datasets[1].data = log.vLog.Aggressive.map(v=>v*3.6);
  charts.spd.data.datasets[2].data = log.vLog.Standard.map(v=>v*3.6);
  charts.spd.data.datasets[3].data = log.vLog.Eco.map(v=>v*3.6);
  charts.spd.update('none');

  charts.gap.data.labels = t;
  charts.gap.data.datasets[0].data = log.gLog.Aggressive;
  charts.gap.data.datasets[1].data = log.gLog.Standard;
  charts.gap.data.datasets[2].data = log.gLog.Eco;
  charts.gap.update('none');

  charts.tgap.data.labels = t;
  charts.tgap.data.datasets[0].data = log.tgLog.Aggressive;
  charts.tgap.data.datasets[1].data = log.tgLog.Standard;
  charts.tgap.data.datasets[2].data = log.tgLog.Eco;
  charts.tgap.update('none');

  charts.energy.data.labels = t;
  charts.energy.data.datasets[0].data = log.eLog.Aggressive;
  charts.energy.data.datasets[1].data = log.eLog.Standard;
  charts.energy.data.datasets[2].data = log.eLog.Eco;
  charts.energy.update('none');

  const eA=log.energy.Aggressive, eS=log.energy.Standard, eE=log.energy.Eco;
  document.getElementById('kAgg').textContent = eS>0? (100*eA/eS).toFixed(1)+'%':'–';
  document.getElementById('kStd').textContent = '100%';
  document.getElementById('kEco').textContent = eS>0? (100*eE/eS).toFixed(1)+'%':'–';
}

/* ------------ Bird view ------------ */
let anim={ playing:false, k:0, frameSkip:5, pauseTime:0.05, timer:null };
function drawBird(log){
  const cvs=document.getElementById('bird'), ctx=cvs.getContext('2d',{alpha:false});
  const W=cvs.width, H=cvs.height;
  ctx.setTransform(1,0,0,1,0,0);
  ctx.fillStyle='#0b0f17'; ctx.fillRect(0,0,W,H);

  const winBack=+document.getElementById('winBack').value;
  const winAhead=+document.getElementById('winAhead').value;
  const k=anim.k, xCtr=log.xLeadLog[k];
  const xmin=xCtr-winBack, xmax=xCtr+winAhead;
  const x2px=x=> (x-xmin)/(xmax-xmin) * (W-40) + 20;

  const yLead=60, yAg=160, ySt=260, yEc=360;
  ctx.strokeStyle='#1f2433';
  for(const y of [yLead,yAg,ySt,yEc]){ ctx.beginPath(); ctx.moveTo(12,y); ctx.lineTo(W-12,y); ctx.stroke(); }

  const headways=[0.5,1,1.5,2.4,3,5];
  ctx.setLineDash([6,6]); ctx.strokeStyle='#62739b'; ctx.fillStyle='#8ea3cf'; ctx.font='12px system-ui';
  for(const hw of headways){
    const xH=x2px(log.xLeadLog[k] - log.vLead[k]*hw);
    ctx.beginPath(); ctx.moveTo(xH, 30); ctx.lineTo(xH, H-20); ctx.stroke();
    ctx.fillText(hw.toFixed(1)+' s', xH-14, 22);
  }
  ctx.setLineDash([]);

  function car(xm,y,fill,label,dx=6){
    const x=x2px(xm), Lpx=40, Hpx=24;
    ctx.fillStyle=fill;
    ctx.fillRect(x, y-Hpx/2, Lpx, Hpx);
    ctx.fillStyle='#dfe7f6';
    ctx.fillText(label, x+dx, y-12);
  }
  car(log.xLeadLog[k], yLead, colors.lead, 'Lead');
  car(log.xLog.Aggressive[k], yAg, colors.ag, 'Aggressive', 2);
  car(log.xLog.Standard[k],   ySt, colors.st, 'Standard', 2);
  car(log.xLog.Eco[k],        yEc, colors.ec, 'Eco', 2);

  ctx.strokeStyle='#24304a'; ctx.strokeRect(10,10,W-20,H-20);
}

function play(log){
  anim.playing=true;
  anim.frameSkip=+document.getElementById('frameSkip').value||5;
  anim.pauseTime=+document.getElementById('pauseTime').value||0.05;

  const tick = ()=>{
    if(!anim.playing) return;
    anim.k = Math.min(anim.k + anim.frameSkip, log.t.length-1);
    drawBird(log);
    if(anim.k >= log.t.length-1){ anim.playing=false; return; }
    anim.timer = setTimeout(()=>requestAnimationFrame(tick), anim.pauseTime*1000);
  };
  tick();
}
function pauseAnim(){ anim.playing=false; if(anim.timer){ clearTimeout(anim.timer); anim.timer=null; } }

/* ------------ Wiring ------------ */
let lastLog=null;

document.getElementById('loadDemo').onclick = ()=>{ try{ loadDemo(); status('Demo ready — click Run.'); }catch(e){ status('Demo failed: '+e.message); } };
document.getElementById('file').addEventListener('change', async (e)=>{
  try{ if(e.target.files[0]){ await loadXlsx(e.target.files[0]); status('Excel ready — click Run.'); } }
  catch(err){ status('Excel error: '+err.message); alert(err.message); }
});

document.getElementById('run').onclick = ()=>{
  try{
    if(!scenario.t.length) loadDemo();
    const p=gather();
    lastLog = simulate(p);
    updateCharts(lastLog);
    anim.k=0; drawBird(lastLog);
    status(`Simulated N=${lastLog.t.length} dt=${lastLog.dt.toFixed(3)}s | Energy (kWh): Agg=${lastLog.energy.Aggressive.toFixed(3)} Std=${lastLog.energy.Standard.toFixed(3)} Eco=${lastLog.energy.Eco.toFixed(3)}`);
  }catch(err){
    status('Run error: '+err.message);
    console.error(err);
    alert('Run error: '+err.message);
  }
};
document.getElementById('play').onclick = ()=>{ if(lastLog) play(lastLog); };
document.getElementById('pause').onclick = ()=> pauseAnim();

/* First layout, then create charts (prevents zero-size canvases) */
window.addEventListener('load', ()=>{
  try{
    ensureCharts(); // canvases now have size (we set width/height attributes)
    loadDemo();     // prepare demo
    status('Ready. Click Run.');
  }catch(e){ status('Init error: '+e.message); console.error(e); }
});
window.addEventListener('resize', ()=>{ if(lastLog) drawBird(lastLog); });
</script>
</body>
</html>
