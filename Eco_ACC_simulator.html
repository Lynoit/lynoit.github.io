<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACC Simulator — Aggressive / Standard / Eco</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- SheetJS (XLSX reader) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root { --bg:#0f1116; --panel:#141822; --ink:#e9eef9; --muted:#9fb0d0; --accent:#5aa9ff; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--ink); }
  h2,h3 { margin: 0.4rem 0; }
  label { font-size: 0.90rem; color:var(--muted); }
  input,select { background:#0d1118; color:var(--ink); border:1px solid #2a3243; border-radius:10px; padding:6px 8px; width:100%; }
  input[type="range"]{ width:100%; }
  .grid { display:grid; grid-template-columns: 320px minmax(420px,1fr) 520px; gap:12px; height:100vh;}
  .panel { background:var(--panel); border:1px solid #232a3c; border-radius:16px; padding:12px; overflow:auto; }
  .controls .row { display:grid; grid-template-columns: 1fr 100px; gap:8px; align-items:center; margin-bottom:10px; }
  .controls .row > span { text-align:right; color:var(--muted); font-variant-numeric: tabular-nums; }
  .controls fieldset { border:1px solid #24304a; border-radius:14px; padding:10px 12px; margin:10px 0 14px; }
  .controls legend { color:var(--muted); padding:0 6px; }
  .btnbar { display:flex; gap:10px; margin:8px 0 6px; }
  button { background:#1b2334; color:var(--ink); border:1px solid #2f3a56; border-radius:12px; padding:8px 10px; cursor:pointer; }
  button:hover { filter: brightness(1.1); }
  .plots { display:flex; flex-direction:column; gap:10px; }
  canvas.chart { background:#0b0f17; border:1px solid #24304a; border-radius:12px; height:170px; }
  .rightcol { display:flex; flex-direction:column; gap:10px; }
  #bird { background:#0b0f17; border:1px solid #24304a; border-radius:16px; width:100%; height:420px; }
  .tiny { font-size: 0.8rem; color: var(--muted); }
  .kpi { display:grid; grid-template-columns: repeat(3,1fr); gap:8px; margin-top:6px; }
  .kpi div { background:#0b0f17; border:1px solid #24304a; border-radius:12px; padding:8px; text-align:center; }
  .tag { font-size: 0.75rem; color:var(--muted); }
</style>
</head>
<body>
<div class="grid">
  <!-- LEFT: Controls -->
  <div class="panel controls">
    <h2>ACC Simulator</h2>
    <div class="tiny">Load a lead scenario (Excel) with columns <b>Time [s]</b> and <b>Speed [km/h]</b>, then tune parameters and Run.</div>
    <div class="btnbar">
      <label style="display:inline-block">
        <input type="file" id="file" accept=".xlsx,.xls" />
      </label>
      <button id="loadDemo">Load demo</button>
      <button id="run">Run</button>
    </div>

    <fieldset>
      <legend>Global</legend>
      <div class="row"><label>Set speed vSet (km/h)</label><input type="number" id="vSet" value="90" step="1"></div>
      <div class="row"><label>Max accel (m/s²)</label><input type="number" id="accMax" value="2" step="0.1"></div>
      <div class="row"><label>Max brake (m/s²)</label><input type="number" id="decMax" value="-4" step="0.1"></div>
      <div class="row"><label>Mass m (kg)</label><input type="number" id="mass" value="2400" step="10"></div>
      <div class="row"><label>CdA (m²)</label><input type="number" id="CdA" value="0.32" step="0.01"></div>
      <div class="row"><label>Rolling Cr</label><input type="number" id="Cr" value="0.012" step="0.001"></div>
    </fieldset>

    <fieldset>
      <legend>Headways</legend>
      <div class="row"><label>Aggressive T<sub>gap</sub> (s)</label><input type="number" id="Tgap_ag" value="1.0" step="0.1"></div>
      <div class="row"><label>Standard T<sub>gap</sub> (s)</label><input type="number" id="Tgap_st" value="2.0" step="0.1"></div>
      <div class="row"><label>Eco T<sub>gap</sub> (s)</label><input type="number" id="Tgap_ec" value="4.0" step="0.1"></div>
    </fieldset>

    <fieldset>
      <legend>Aggressiveness (gain scale ×)</legend>
      <div class="row"><label>Aggressive</label><input type="number" id="gain_ag" value="1.00" step="0.05"></div>
      <div class="row"><label>Standard</label><input type="number" id="gain_st" value="1.00" step="0.05"></div>
      <div class="row"><label>Eco</label><input type="number" id="gain_ec" value="1.00" step="0.05"></div>
    </fieldset>

    <fieldset>
      <legend>Cruise Assist strength</legend>
      <div class="row"><label>Aggressive (0–1)</label><input type="number" id="cruise_ag" value="0.50" step="0.05" min="0" max="1"></div>
      <div class="row"><label>Standard (0–1)</label><input type="number" id="cruise_st" value="0.50" step="0.05" min="0" max="1"></div>
      <div class="row"><label>Eco (0–1)</label><input type="number" id="cruise_ec" value="0.30" step="0.05" min="0" max="1"></div>
    </fieldset>

    <fieldset>
      <legend>Animation</legend>
      <div class="row"><label>Window back (m)</label><input type="number" id="winBack" value="125" step="5"></div>
      <div class="row"><label>Window ahead (m)</label><input type="number" id="winAhead" value="5" step="1"></div>
      <div class="row"><label>Frame skip (steps)</label><input type="number" id="frameSkip" value="5" step="1" min="1"></div>
      <div class="row"><label>Frame pause (s)</label><input type="number" id="pauseTime" value="0.05" step="0.01"></div>
    </fieldset>

    <div class="kpi">
      <div><div class="tag">Energy Aggressive</div><div id="kAgg">–</div></div>
      <div><div class="tag">Energy Standard</div><div id="kStd">–</div></div>
      <div><div class="tag">Energy Eco</div><div id="kEco">–</div></div>
    </div>

    <div class="tiny" id="status">Waiting for scenario…</div>
  </div>

  <!-- MIDDLE: Plots -->
  <div class="panel">
    <h3>Plots</h3>
    <div class="plots">
      <canvas id="acc" class="chart"></canvas>
      <canvas id="spd" class="chart"></canvas>
      <canvas id="gap" class="chart"></canvas>
      <canvas id="tgap" class="chart"></canvas>
      <canvas id="energy" class="chart"></canvas>
    </div>
  </div>

  <!-- RIGHT: Bird view -->
  <div class="panel rightcol">
    <h3>Bird-view</h3>
    <canvas id="bird"></canvas>
    <div class="btnbar">
      <button id="play">Play</button>
      <button id="pause">Pause</button>
      <span class="tiny">Dashed rulers = headway from lead (0.5–5 s)</span>
    </div>
  </div>
</div>

<script>
/* ----------------------------- Utilities ------------------------------ */
const colors = {
  lead: 'rgba(230,230,230,0.9)',
  ag: 'rgba(255, 76, 76, 0.95)',
  st: 'rgba(85, 145, 255, 0.95)',
  ec: 'rgba(61, 207, 117, 0.95)'
};
const rhoAir = 1.225; // kg/m^3
const g = 9.81;

function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }

/* ----------------------------- Scenario IO ---------------------------- */
let scenario = { t:[], spdLead_kmh:[] };

async function loadXlsx(file){
  const ab = await file.arrayBuffer();
  const wb = XLSX.read(ab, { type:'array' });
  const ws = wb.Sheets[wb.SheetNames[0]];
  const json = XLSX.utils.sheet_to_json(ws, { header:1, defval:null });
  // Expect Time [s], Speed [km/h] in first two columns (skip header if strings)
  let t=[], v=[];
  for(let i=0;i<json.length;i++){
    const r = json[i];
    if(r.length<2) continue;
    const a = r[0], b=r[1];
    if(typeof a === 'number' && typeof b === 'number'){
      t.push(a); v.push(b);
    }
  }
  if(t.length<3) throw new Error("Could not find numeric Time/Speed columns.");
  scenario.t = t;
  scenario.spdLead_kmh = v.map(s => Math.max(s,10)); // avoid zeros
  status(`Loaded Excel: ${t.length} rows, dt=${(t[1]-t[0]).toFixed(3)} s`);
}

function loadDemo(){
  // 0..160 s, dt=0.1
  const dt = 0.1, T = 160;
  const n = Math.floor(T/dt)+1;
  let t = Array.from({length:n}, (_,k)=> +(k*dt).toFixed(3));
  // Lead profile: 90 → 60 (gentle), stop&go wiggle, finish at 90
  let v = t.map(ts=>{
    if(ts<10) return 90;
    if(ts<45) return 90 - (ts-10)*30/35; // down to 60
    if(ts<70) return 60 + 10*Math.sin((ts-45)/25*Math.PI*2);
    if(ts<100) return 60 + (ts-70)*1.2;  // up to ~96
    return 90;
  });
  scenario.t = t;
  scenario.spdLead_kmh = v.map(x=>Math.max(x,10));
  status(`Loaded demo: ${n} rows, dt=${dt}s`);
}

/* ----------------------------- Simulation ---------------------------- */
function simulate(params){
  const { vSet, accMax, decMax, m, CdA, Cr,
          Tgap_ag, Tgap_st, Tgap_ec,
          gain_ag, gain_st, gain_ec,
          cruise_ag, cruise_st, cruise_ec } = params;

  const t = scenario.t.slice();
  const kmh = scenario.spdLead_kmh.slice();
  const N = t.length;
  const dt = t[1]-t[0];
  const vLead = kmh.map(s=>s/3.6);
  const aLead = vLead.map((v,i)=> i? (v - vLead[i-1])/dt : 0);

  // Base controller gains (as in your MATLAB)
  const base = {
    ag: { Kp:1.75, Ki:1.00, Kd:1.00, Kff:0.75, Tgap:Tgap_ag },
    st: { Kp:1.50, Ki:1.00, Kd:0.40, Kff:0.05, Tgap:Tgap_st },
    ec: { Kp:0.50, Ki:0.08, Kd:0.60, Kff:0.00, Tgap:Tgap_ec } // Eco: no FF
  };
  // Apply aggressiveness (gain scale)
  base.ag.Kp*=gain_ag; base.ag.Ki*=gain_ag; base.ag.Kd*=gain_ag; base.ag.Kff*=gain_ag;
  base.st.Kp*=gain_st; base.st.Ki*=gain_st; base.st.Kd*=gain_st; base.st.Kff*=gain_st;
  base.ec.Kp*=gain_ec; base.ec.Ki*=gain_ec; base.ec.Kd*=gain_ec; // Kff stays 0

  // Energy helpers
  const Fdrag = v => 0.5*rhoAir*CdA*v*v;
  const Froll = m*g*Cr;

  // States
  let vE = { Aggressive:vLead[0], Standard:vLead[0], Eco:vLead[0] };
  let xE = {
    Aggressive: -base.ag.Tgap * vLead[0],
    Standard:   -base.st.Tgap * vLead[0],
    Eco:        -base.ec.Tgap * vLead[0],
  };
  let intE = { Aggressive:0, Standard:0, Eco:0 };
  let xLead = 0;

  // Logs (arrays)
  const vLog = { Aggressive:new Array(N).fill(0), Standard:new Array(N).fill(0), Eco:new Array(N).fill(0) };
  const aLog = { Aggressive:new Array(N).fill(0), Standard:new Array(N).fill(0), Eco:new Array(N).fill(0) };
  const gLog = { Aggressive:new Array(N).fill(0), Standard:new Array(N).fill(0), Eco:new Array(N).fill(0) };
  const tgLog= { Aggressive:new Array(N).fill(0), Standard:new Array(N).fill(0), Eco:new Array(N).fill(0) };
  const eLog = { Aggressive:new Array(N).fill(0), Standard:new Array(N).fill(0), Eco:new Array(N).fill(0) };
  const xLog = { Aggressive:new Array(N).fill(0), Standard:new Array(N).fill(0), Eco:new Array(N).fill(0) };
  const xLeadLog = new Array(N).fill(0);
  let eCumJ = { Aggressive:0, Standard:0, Eco:0 };

  for(let k=0;k<N;k++){
    xLead += vLead[k]*dt;
    xLeadLog[k] = xLead;

    for(const nm of ["Aggressive","Standard","Eco"]){
      const tag = nm==="Aggressive"?"ag":(nm==="Standard"?"st":"ec");
      const Kp = base[tag].Kp, Ki=base[tag].Ki, Kd=base[tag].Kd, Kff=base[tag].Kff, Tgap=base[tag].Tgap;

      const vEgo = vE[nm];
      const gap = xLead - xE[nm];
      const relV = vLead[k] - vEgo;

      // Error + Integral
      const eD = gap - Tgap * vEgo;
      intE[nm] += eD*dt;

      // PID (+ optional FF)
      let aPID = Kp*eD + Ki*intE[nm] + Kd*relV;
      let aFF = Kff * aLead[k];
      let aCmd;

      if(nm==="Aggressive"){
        if(gap > Tgap*vEgo + 3){
          const aCruise = Math.min(accMax, cruise_ag*(vSet/3.6 - vEgo));
          aCmd = aCruise + aFF;
        } else aCmd = aPID + aFF;

      } else if(nm==="Standard"){
        if(gap > Tgap*vEgo + 3){
          const aCruise = Math.min(accMax, cruise_st*(vSet/3.6 - vEgo));
          aCmd = aCruise + aFF;
        } else aCmd = aPID + aFF;

      } else { // Eco
        if(gap > Tgap*vEgo + 5){
          const aCruise = Math.min(1.0, cruise_ec*(vSet/3.6 - vEgo));
          aCmd = aCruise;
        } else aCmd = aPID;
      }

      // Saturate and anti-windup
      const aSat = clamp(aCmd, decMax, accMax);
      if(aSat!==aCmd) intE[nm] -= eD*dt;

      // Energy (traction only, no regen)
      const P = Math.max(0, (m*aSat + Fdrag(vEgo) + Froll)*vEgo);
      eCumJ[nm] += P*dt;
      eLog[nm][k] = eCumJ[nm]/3.6e6;

      vLog[nm][k] = vEgo;
      aLog[nm][k] = aSat;
      gLog[nm][k] = gap;
      tgLog[nm][k]= gap/Math.max(vEgo,0.1);
      xLog[nm][k] = xE[nm];

      // Propagate ego
      vE[nm] = Math.max(0, vEgo + aSat*dt);
      xE[nm] += vE[nm]*dt;
    }
  }

  const energy = {
    Aggressive: eLog.Aggressive.at(-1),
    Standard:   eLog.Standard.at(-1),
    Eco:        eLog.Eco.at(-1)
  };

  return { t, dt, vLead, aLead, vLog, aLog, gLog, tgLog, eLog, xLeadLog, xLog, energy };
}

/* ----------------------------- Charts --------------------------------- */
let charts = {};
function makeChart(ctx, label, series){
  return new Chart(ctx, {
    type:'line',
    data: {
      labels: [], // set later
      datasets: series.map(s=>({
        label:s.label,
        data:[],
        borderColor:s.color,
        borderWidth:1.8,
        pointRadius:0,
        tension:0
      }))
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      interaction:{ mode:'index', intersect:false },
      scales:{
        x:{ ticks:{ color:'#c7d2e5' }, grid:{ color:'#1f2433' }, title:{ display:true, text:'Time [s]', color:'#9fb0d0' } },
        y:{ ticks:{ color:'#c7d2e5' }, grid:{ color:'#1f2433' } }
      },
      plugins:{
        legend:{ labels:{ color:'#dfe7f6' } },
        title:{ display:true, text:label, color:'#e9eef9' }
      }
    }
  });
}
function ensureCharts(){
  if(Object.keys(charts).length) return;
  charts.acc = makeChart(document.getElementById('acc'), 'Acceleration [m/s²]', [
    {label:'Lead', color:'rgba(220,220,220,0.8)'},
    {label:'Aggressive', color:colors.ag},
    {label:'Standard', color:colors.st},
    {label:'Eco', color:colors.ec},
  ]);
  charts.spd = makeChart(document.getElementById('spd'), 'Ego Speed [km/h]', [
    {label:'Lead (km/h)', color:'rgba(220,220,220,0.5)'},
    {label:'Aggressive', color:colors.ag},
    {label:'Standard', color:colors.st},
    {label:'Eco', color:colors.ec},
  ]);
  charts.gap = makeChart(document.getElementById('gap'), 'Distance Gap [m]', [
    {label:'Aggressive', color:colors.ag},
    {label:'Standard', color:colors.st},
    {label:'Eco', color:colors.ec},
  ]);
  charts.tgap = makeChart(document.getElementById('tgap'), 'Time Gap [s]', [
    {label:'Aggressive', color:colors.ag},
    {label:'Standard', color:colors.st},
    {label:'Eco', color:colors.ec},
  ]);
  charts.energy = makeChart(document.getElementById('energy'), 'Cumulative Traction Energy [kWh]', [
    {label:'Aggressive', color:colors.ag},
    {label:'Standard', color:colors.st},
    {label:'Eco', color:colors.ec},
  ]);
}
function updateCharts(log){
  ensureCharts();
  const t = log.t;
  charts.acc.data.labels = t;
  charts.acc.data.datasets[0].data = log.aLead;
  charts.acc.data.datasets[1].data = log.aLog.Aggressive;
  charts.acc.data.datasets[2].data = log.aLog.Standard;
  charts.acc.data.datasets[3].data = log.aLog.Eco;
  charts.acc.update('none');

  charts.spd.data.labels = t;
  charts.spd.data.datasets[0].data = log.vLead.map(v=>v*3.6);
  charts.spd.data.datasets[1].data = log.vLog.Aggressive.map(v=>v*3.6);
  charts.spd.data.datasets[2].data = log.vLog.Standard.map(v=>v*3.6);
  charts.spd.data.datasets[3].data = log.vLog.Eco.map(v=>v*3.6);
  charts.spd.update('none');

  charts.gap.data.labels = t;
  charts.gap.data.datasets[0].data = log.gLog.Aggressive;
  charts.gap.data.datasets[1].data = log.gLog.Standard;
  charts.gap.data.datasets[2].data = log.gLog.Eco;
  charts.gap.update('none');

  charts.tgap.data.labels = t;
  charts.tgap.data.datasets[0].data = log.tgLog.Aggressive;
  charts.tgap.data.datasets[1].data = log.tgLog.Standard;
  charts.tgap.data.datasets[2].data = log.tgLog.Eco;
  charts.tgap.update('none');

  charts.energy.data.labels = t;
  charts.energy.data.datasets[0].data = log.eLog.Aggressive;
  charts.energy.data.datasets[1].data = log.eLog.Standard;
  charts.energy.data.datasets[2].data = log.eLog.Eco;
  charts.energy.update('none');

  // Energy KPIs (relative to Standard)
  const eA = log.energy.Aggressive, eS = log.energy.Standard, eE = log.energy.Eco;
  document.getElementById('kAgg').textContent = eS>0 ? (100*eA/eS).toFixed(1)+'%' : '–';
  document.getElementById('kStd').textContent = '100%';
  document.getElementById('kEco').textContent = eS>0 ? (100*eE/eS).toFixed(1)+'%' : '–';
}

/* ----------------------------- Bird View ------------------------------ */
let anim = { playing:false, k:0, frameSkip:5, pauseTime:0.05, req:null };
function drawBird(log){
  const cvs = document.getElementById('bird');
  const ctx = cvs.getContext('2d');
  const W = cvs.clientWidth, H = cvs.clientHeight;
  // Handle hi-dpi
  const dpr = window.devicePixelRatio || 1;
  if(cvs.width !== Math.floor(W*dpr)){ cvs.width = Math.floor(W*dpr); cvs.height = Math.floor(H*dpr); }
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,W,H);

  // Axis mapping: x is meters, map to pixels
  const winBack = +document.getElementById('winBack').value;
  const winAhead = +document.getElementById('winAhead').value;
  const k = anim.k;
  const xCtr = log.xLeadLog[k];
  const xmin = xCtr - winBack, xmax = xCtr + winAhead;
  const x2px = x => (x - xmin)/(xmax-xmin) * (W-40) + 20;

  // Lanes (y levels)
  const yLead= 50, yAg= 150, ySt= 250, yEc= 350;
  // Cars
  const vehL = 5, vehW = 2.2; // meters
  const m2px = s => s * (W / (winBack+winAhead)); // horizontal only (visual)
  const carWpx = 24; // fixed height box

  // Background grid-ish
  ctx.strokeStyle = '#1f2433'; ctx.lineWidth = 1;
  for(let i=0;i<=5;i++){
    const y = 50 + i*70;
    ctx.beginPath(); ctx.moveTo(12,y); ctx.lineTo(W-12,y); ctx.stroke();
  }

  // Headway rulers (0.5..5 s) from lead
  const headways = [0.5,1,1.5,2.4,3,5];
  ctx.setLineDash([6,6]); ctx.strokeStyle='#62739b'; ctx.fillStyle='#8ea3cf';
  for(const hw of headways){
    const xH = x2px(log.xLeadLog[k] - log.vLead[k]*hw);
    ctx.beginPath(); ctx.moveTo(xH, 30); ctx.lineTo(xH, H-20); ctx.stroke();
    ctx.fillText(`${hw.toFixed(1)} s`, xH-14, 20);
  }
  ctx.setLineDash([]);

  // Draw cars as rectangles
  function drawCar(xm, y, fill, label, dxText=0){
    const x = x2px(xm);
    ctx.fillStyle = fill;
    const Lpx = m2px(vehL);
    ctx.fillRect(x, y- (carWpx/2), Lpx, carWpx);
    ctx.fillStyle = '#cfd7ea';
    ctx.fillText(label, x+dxText, y-12);
  }

  drawCar(log.xLeadLog[k], yLead, colors.lead, 'Lead', 6);
  drawCar(log.xLog.Aggressive[k], yAg, colors.ag, 'Aggressive', 4);
  drawCar(log.xLog.Standard[k],   ySt, colors.st, 'Standard', 4);
  drawCar(log.xLog.Eco[k],        yEc, colors.ec, 'Eco', 4);

  // Axes box
  ctx.strokeStyle = '#24304a'; ctx.strokeRect(10,10,W-20,H-20);
}

function play(log){
  anim.playing = true;
  anim.frameSkip = +document.getElementById('frameSkip').value;
  anim.pauseTime = +document.getElementById('pauseTime').value;
  const step = ()=>{
    if(!anim.playing) return;
    anim.k = Math.min(anim.k + anim.frameSkip, log.t.length-1);
    drawBird(log);
    if(anim.k >= log.t.length-1){ anim.playing=false; return; }
    anim.req = setTimeout(()=>requestAnimationFrame(step), anim.pauseTime*1000);
  };
  step();
}
function pauseAnim(){ anim.playing=false; if(anim.req){ clearTimeout(anim.req); anim.req=null; } }

/* ----------------------------- Wiring -------------------------------- */
function status(msg){ document.getElementById('status').textContent = msg; }

function gatherParams(){
  return {
    vSet: +document.getElementById('vSet').value,
    accMax: +document.getElementById('accMax').value,
    decMax: +document.getElementById('decMax').value,
    m: +document.getElementById('mass').value,
    CdA: +document.getElementById('CdA').value,
    Cr: +document.getElementById('Cr').value,
    Tgap_ag: +document.getElementById('Tgap_ag').value,
    Tgap_st: +document.getElementById('Tgap_st').value,
    Tgap_ec: +document.getElementById('Tgap_ec').value,
    gain_ag: +document.getElementById('gain_ag').value,
    gain_st: +document.getElementById('gain_st').value,
    gain_ec: +document.getElementById('gain_ec').value,
    cruise_ag: +document.getElementById('cruise_ag').value,
    cruise_st: +document.getElementById('cruise_st').value,
    cruise_ec: +document.getElementById('cruise_ec').value,
  };
}

let lastLog = null;

document.getElementById('file').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  try{ await loadXlsx(f); } catch(err){ alert(err.message); }
});

document.getElementById('loadDemo').addEventListener('click', ()=>{
  loadDemo();
});

document.getElementById('run').addEventListener('click', ()=>{
  if(!scenario.t.length){ loadDemo(); }
  const log = simulate(gatherParams());
  lastLog = log;
  updateCharts(log);
  anim.k = 0;
  drawBird(log);
  status(`Simulated N=${log.t.length} (dt=${log.dt.toFixed(3)} s) — energies: Agg=${log.energy.Aggressive.toFixed(3)} kWh, Std=${log.energy.Standard.toFixed(3)} kWh, Eco=${log.energy.Eco.toFixed(3)} kWh`);
});

document.getElementById('play').addEventListener('click', ()=>{ if(lastLog){ play(lastLog); } });
document.getElementById('pause').addEventListener('click', ()=> pauseAnim() );

// Auto init demo & first render
loadDemo();
const initRun = ()=>{ const log = simulate(gatherParams()); lastLog=log; updateCharts(log); drawBird(log); };
window.addEventListener('load', initRun);
window.addEventListener('resize', ()=>{ if(lastLog) drawBird(lastLog); });
</script>
</body>
</html>
