<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACC Simulator — User-Controlled</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root { --bg:#0f1116; --panel:#141822; --ink:#e9eef9; --muted:#9fb0d0; }
  * { box-sizing:border-box; }
  body { margin:0; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink); }
  .grid { display:grid; grid-template-columns: 360px 860px 540px; gap:10px; padding:10px; min-height:100vh; }
  .panel { background:var(--panel); border:1px solid #232a3c; border-radius:14px; padding:10px; overflow:auto; }
  h2,h3{ margin:.3rem 0 .6rem; }
  label{ color:var(--muted); font-size:.9rem; }
  input, textarea { width:100%; padding:8px 10px; border-radius:10px; border:1px solid #2a3243; background:#0d1118; color:var(--ink); }
  textarea { height:160px; resize:vertical; font-family:ui-monospace,Menlo,Consolas,monospace; }
  .row{ display:grid; grid-template-columns: 1fr 120px; gap:8px; align-items:center; margin-bottom:8px; }
  fieldset{ border:1px solid #24304a; border-radius:12px; padding:8px 10px; margin:8px 0 10px; }
  legend{ color:var(--muted); padding:0 6px; }
  button{ background:#1b2334; border:1px solid #2f3a56; color:var(--ink); padding:7px 10px; border-radius:10px; cursor:pointer; }
  button:hover{ filter:brightness(1.08); }
  .btnbar{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 8px; }
  .kpi{ display:grid; grid-template-columns: repeat(3,1fr); gap:8px; margin-top:6px; }
  .kpi div{ background:#0b0f17; border:1px solid #24304a; border-radius:10px; padding:8px; text-align:center; }
  .tag{ font-size:.75rem; color:var(--muted); }

  /* Fixed-size canvases for stability */
  canvas.chart { background:#0b0f17; border:1px solid #24304a; border-radius:10px; display:block; }
  #acc, #spd, #gap, #tgap, #energy { width:840px; height:160px; }
  #bird { background:#0b0f17; border:1px solid #24304a; border-radius:12px; width:520px; height:420px; display:block; }

  .diag { font-family:ui-monospace,Menlo,Consolas,monospace; background:#0b0f17; border:1px solid #24304a; border-radius:8px; padding:6px; color:#cfe4ff; white-space:pre-wrap; height:100px; overflow:auto; }
  .tiny{ color:var(--muted); font-size:.85rem; }
</style>
</head>
<body>
<div class="grid">
  <!-- LEFT: Controls -->
  <div class="panel">
    <h2>ACC Simulator</h2>

    <fieldset>
      <legend>Lead vehicle profile (paste here)</legend>
      <div class="tiny" style="margin-bottom:6px;">
        One pair per line: <code>time_seconds, speed_km/h</code> (comma, semicolon, or whitespace).<br/>
        Example:<br/>
        <code>0, 90</code><br/>
        <code>1, 90</code><br/>
        <code>2, 85</code>
      </div>
      <textarea id="profile" placeholder="0, 90
1, 90
2, 85
3, 70
4, 70
5, 75
..."></textarea>
      <div class="btnbar">
        <button id="run">Run</button>
        <button id="play">Play</button>
        <button id="pause">Pause</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>Global</legend>
      <div class="row"><label>Set speed vSet (km/h)</label><input id="vSet" type="number" step="1" value="90"></div>
      <div class="row"><label>Max accel (m/s²)</label><input id="accMax" type="number" step="0.1" value="2"></div>
      <div class="row"><label>Max brake (m/s²)</label><input id="decMax" type="number" step="0.1" value="-4"></div>
      <div class="row"><label>Mass m (kg)</label><input id="mass" type="number" step="10" value="2400"></div>
      <div class="row"><label>CdA (m²)</label><input id="CdA" type="number" step="0.01" value="0.32"></div>
      <div class="row"><label>Rolling Cr</label><input id="Cr" type="number" step="0.001" value="0.012"></div>
    </fieldset>

    <fieldset>
      <legend>Headways</legend>
      <div class="row"><label>Aggressive T<sub>gap</sub> (s)</label><input id="Tgap_ag" type="number" step="0.1" value="1.0"></div>
      <div class="row"><label>Standard T<sub>gap</sub> (s)</label><input id="Tgap_st" type="number" step="0.1" value="2.0"></div>
      <div class="row"><label>Eco T<sub>gap</sub> (s)</label><input id="Tgap_ec" type="number" step="0.1" value="4.0"></div>
    </fieldset>

    <fieldset>
      <legend>Aggressiveness (gain scale ×)</legend>
      <div class="row"><label>Aggressive</label><input id="gain_ag" type="number" step="0.05" value="1.00"></div>
      <div class="row"><label>Standard</label><input id="gain_st" type="number" step="0.05" value="1.00"></div>
      <div class="row"><label>Eco</label><input id="gain_ec" type="number" step="0.05" value="1.00"></div>
    </fieldset>

    <fieldset>
      <legend>Cruise Assist</legend>
      <div class="row"><label>Aggressive (0–1)</label><input id="cruise_ag" type="number" min="0" max="1" step="0.05" value="0.50"></div>
      <div class="row"><label>Standard (0–1)</label><input id="cruise_st" type="number" min="0" max="1" step="0.05" value="0.50"></div>
      <div class="row"><label>Eco (0–1)</label><input id="cruise_ec" type="number" min="0" max="1" step="0.05" value="0.30"></div>
    </fieldset>

    <fieldset>
      <legend>Animation</legend>
      <div class="row"><label>Window back (m)</label><input id="winBack" type="number" step="5" value="125"></div>
      <div class="row"><label>Window ahead (m)</label><input id="winAhead" type="number" step="1" value="5"></div>
      <div class="row"><label>Frame skip</label><input id="frameSkip" type="number" min="1" step="1" value="5"></div>
      <div class="row"><label>Frame pause (s)</label><input id="pauseTime" type="number" step="0.01" value="0.05"></div>
    </fieldset>

    <h3 style="margin-top:10px;">Diagnostics</h3>
    <div id="diag" class="diag"></div>
  </div>

  <!-- MIDDLE: Plots -->
  <div class="panel">
    <h3>Plots</h3>
    <canvas id="acc"  class="chart" width="840" height="160"></canvas>
    <canvas id="spd"  class="chart" width="840" height="160"></canvas>
    <canvas id="gap"  class="chart" width="840" height="160"></canvas>
    <canvas id="tgap" class="chart" width="840" height="160"></canvas>
    <canvas id="energy" class="chart" width="840" height="160"></canvas>
  </div>

  <!-- RIGHT: Bird-view -->
  <div class="panel">
    <h3>Bird-view</h3>
    <canvas id="bird" width="520" height="420"></canvas>
    <div class="tiny" style="margin-top:6px;">Dashed rulers = headway from lead (0.5–5 s)</div>
  </div>
</div>

<script>
/* ---------- diagnostics ---------- */
const diag = document.getElementById('diag');
function logd(msg){ diag.textContent += msg + "\n"; diag.scrollTop = diag.scrollHeight; }
window.onerror = (m,s,l,c,e)=>{ logd('Error: '+m); };
window.addEventListener('unhandledrejection', e=>{ logd('Promise rejection: '+e.reason); });

/* ---------- Chart.js stability ---------- */
if(window.Chart){
  Chart.defaults.responsive = false;
  Chart.defaults.animation = false;
  Chart.defaults.maintainAspectRatio = false;
  Chart.defaults.devicePixelRatio = 1;
}

/* ---------- constants/util ---------- */
const rhoAir=1.225, g=9.81;
const colors = {
  lead: 'rgba(230,230,230,0.9)',
  ag: 'rgba(255, 76, 76, 0.95)',
  st: 'rgba(85,145,255,0.95)',
  ec: 'rgba(61,207,117,0.95)'
};
function clamp(x,lo,hi){ return Math.max(lo, Math.min(hi, x)); }

/* ---------- parse textarea ---------- */
function parseProfile(text){
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(s=>s.length);
  const t=[], v=[];
  for(const line of lines){
    // split on comma/semicolon/space
    const parts = line.split(/[,\;\s]+/).filter(Boolean);
    if(parts.length<2) throw new Error(`Bad line: "${line}". Expect "time speed".`);
    const T = Number(parts[0]);
    const S = Number(parts[1]);
    if(!isFinite(T) || !isFinite(S)) throw new Error(`Non-numeric in line: "${line}"`);
    t.push(T);
    v.push(Math.max(10, S)); // clamp min 10 km/h like MATLAB
  }
  // sort by time if needed, and enforce unique times
  const idx = t.map((_,i)=>i).sort((a,b)=>t[a]-t[b]);
  const t2 = idx.map(i=>t[i]);
  const v2 = idx.map(i=>v[i]);
  for(let i=1;i<t2.length;i++){
    if(t2[i] <= t2[i-1]) throw new Error('Time must be strictly increasing.');
  }
  return { t:t2, spdLead_kmh:v2 };
}

/* ---------- inputs -> params ---------- */
function P(){
  return {
    vSet: +vSet.value, accMax:+accMax.value, decMax:+decMax.value,
    m:+mass.value, CdA:+CdA.value, Cr:+Cr.value,
    Tgap_ag:+Tgap_ag.value, Tgap_st:+Tgap_st.value, Tgap_ec:+Tgap_ec.value,
    gain_ag:+gain_ag.value, gain_st:+gain_st.value, gain_ec:+gain_ec.value,
    cruise_ag:+cruise_ag.value, cruise_st:+cruise_st.value, cruise_ec:+cruise_ec.value,
    winBack:+winBack.value, winAhead:+winAhead.value,
    frameSkip:+frameSkip.value||5, pauseTime:+pauseTime.value||0.05
  };
}

/* ---------- simulation ---------- */
function simulate(profile, p){
  const t = profile.t;
  if(!t || t.length<3) throw new Error('Need ≥3 rows in the profile.');
  const dt = t[1]-t[0]; if(!(dt>0)) throw new Error('Bad dt. Times must be strictly increasing with constant step.');
  // verify constant timestep (within tolerance)
  for(let i=2;i<t.length;i++){
    const d = t[i]-t[i-1];
    if(Math.abs(d - dt) > Math.max(1e-6, 1e-3*dt)) throw new Error('Time step must be constant.');
  }

  const N = t.length;
  const vLead = profile.spdLead_kmh.map(s=>s/3.6);
  const aLead = new Array(N); aLead[0]=0; for(let i=1;i<N;i++) aLead[i]=(vLead[i]-vLead[i-1])/dt;

  const base={
    ag:{Kp:1.75*p.gain_ag, Ki:1.00*p.gain_ag, Kd:1.00*p.gain_ag, Kff:0.75*p.gain_ag, T:p.Tgap_ag},
    st:{Kp:1.50*p.gain_st, Ki:1.00*p.gain_st, Kd:0.40*p.gain_st, Kff:0.05*p.gain_st, T:p.Tgap_st},
    ec:{Kp:0.50*p.gain_ec, Ki:0.08*p.gain_ec, Kd:0.60*p.gain_ec, Kff:0.00,            T:p.Tgap_ec}
  };
  const Fdrag=v=>0.5*rhoAir*p.CdA*v*v; const Froll=p.m*g*p.Cr;

  let vE={Aggressive:vLead[0], Standard:vLead[0], Eco:vLead[0]};
  let xE={Aggressive:-base.ag.T*vLead[0], Standard:-base.st.T*vLead[0], Eco:-base.ec.T*vLead[0]};
  let I={Aggressive:0, Standard:0, Eco:0}, xLead=0;

  const vLog={Aggressive:Array(N), Standard:Array(N), Eco:Array(N)};
  const aLog={Aggressive:Array(N), Standard:Array(N), Eco:Array(N)};
  const gLog={Aggressive:Array(N), Standard:Array(N), Eco:Array(N)};
  const tgLog={Aggressive:Array(N), Standard:Array(N), Eco:Array(N)};
  const eLog={Aggressive:Array(N).fill(0), Standard:Array(N).fill(0), Eco:Array(N).fill(0)};
  const xLog={Aggressive:Array(N), Standard:Array(N), Eco:Array(N)};
  const xLeadLog=Array(N); let eJ={Aggressive:0, Standard:0, Eco:0};

  for(let k=0;k<N;k++){
    xLead += vLead[k]*dt; xLeadLog[k]=xLead;
    for(const nm of ["Aggressive","Standard","Eco"]){
      const tag = nm==="Aggressive"?"ag":(nm==="Standard"?"st":"ec");
      const {Kp,Ki,Kd,Kff,T} = base[tag];
      const v=vE[nm], gap=xLead - xE[nm], rel=vLead[k]-v;
      const eD = gap - T*v;
      I[nm] += eD*dt;
      let aPID = Kp*eD + Ki*I[nm] + Kd*rel;
      let aFF = Kff*aLead[k];
      let aCmd;
      if(nm==="Aggressive"){
        aCmd = (gap > T*v + 3) ? Math.min(p.accMax, p.cruise_ag*(p.vSet/3.6 - v)) + aFF : aPID + aFF;
      } else if(nm==="Standard"){
        aCmd = (gap > T*v + 3) ? Math.min(p.accMax, p.cruise_st*(p.vSet/3.6 - v)) + aFF : aPID + aFF;
      } else {
        aCmd = (gap > T*v + 5) ? Math.min(1.0, p.cruise_ec*(p.vSet/3.6 - v)) : aPID;
      }
      const aSat = clamp(aCmd, p.decMax, p.accMax);
      if(aSat!==aCmd) I[nm]-=eD*dt;

      const P = Math.max(0, (p.m*aSat + Fdrag(v) + Froll)*v);
      eJ[nm]+= P*dt; eLog[nm][k]= eJ[nm]/3.6e6;

      vLog[nm][k]=v; aLog[nm][k]=aSat; gLog[nm][k]=gap; tgLog[nm][k]= gap/Math.max(v,0.1); xLog[nm][k]=xE[nm];
      vE[nm]=Math.max(0, v + aSat*dt); xE[nm]+= vE[nm]*dt;
    }
  }
  const energy = { Aggressive:eLog.Aggressive[N-1], Standard:eLog.Standard[N-1], Eco:eLog.Eco[N-1] };
  return {t, dt, vLead, aLead, vLog, aLog, gLog, tgLog, eLog, xLeadLog, xLog, energy};
}

/* ---------- charts ---------- */
let charts=null;
function makeChart(ctx, title, series){
  return new Chart(ctx, {
    type:'line',
    data:{ labels:[], datasets:series.map(s=>({
      label:s.label, data:[], borderColor:s.color, pointRadius:0, borderWidth:1.6, tension:0
    }))},
    options:{
      responsive:false, animation:false, maintainAspectRatio:false, devicePixelRatio:1,
      scales:{
        x:{ title:{display:true, text:'Time [s]', color:'#9fb0d0'}, ticks:{color:'#c7d2e5'}, grid:{color:'#1f2433'} },
        y:{ ticks:{color:'#c7d2e5'}, grid:{color:'#1f2433'} }
      },
      plugins:{ legend:{ labels:{ color:'#e9eef9' }}, title:{ display:true, text:title, color:'#e9eef9' } }
    }
  });
}
function ensureCharts(){
  if(charts) return;
  charts = {
    acc:    makeChart(document.getElementById('acc').getContext('2d'), 'Acceleration [m/s²]', [
              {label:'Lead', color:'rgba(220,220,220,0.8)'},
              {label:'Aggressive', color:colors.ag},
              {label:'Standard', color:colors.st},
              {label:'Eco', color:colors.ec},
            ]),
    spd:    makeChart(document.getElementById('spd').getContext('2d'), 'Ego Speed [km/h]', [
              {label:'Lead (km/h)', color:'rgba(220,220,220,0.5)'},
              {label:'Aggressive', color:colors.ag},
              {label:'Standard', color:colors.st},
              {label:'Eco', color:colors.ec},
            ]),
    gap:    makeChart(document.getElementById('gap').getContext('2d'), 'Distance Gap [m]', [
              {label:'Aggressive', color:colors.ag},
              {label:'Standard', color:colors.st},
              {label:'Eco', color:colors.ec},
            ]),
    tgap:   makeChart(document.getElementById('tgap').getContext('2d'), 'Time Gap [s]', [
              {label:'Aggressive', color:colors.ag},
              {label:'Standard', color:colors.st},
              {label:'Eco', color:colors.ec},
            ]),
    energy: makeChart(document.getElementById('energy').getContext('2d'), 'Cumulative Traction Energy [kWh]', [
              {label:'Aggressive', color:colors.ag},
              {label:'Standard', color:colors.st},
              {label:'Eco', color:colors.ec},
            ])
  };
}
function updateCharts(log){
  ensureCharts();
  const t=log.t;

  charts.acc.data.labels = t;
  charts.acc.data.datasets[0].data = log.aLead;
  charts.acc.data.datasets[1].data = log.aLog.Aggressive;
  charts.acc.data.datasets[2].data = log.aLog.Standard;
  charts.acc.data.datasets[3].data = log.aLog.Eco; charts.acc.update();

  charts.spd.data.labels = t;
  charts.spd.data.datasets[0].data = log.vLead.map(v=>v*3.6);
  charts.spd.data.datasets[1].data = log.vLog.Aggressive.map(v=>v*3.6);
  charts.spd.data.datasets[2].data = log.vLog.Standard.map(v=>v*3.6);
  charts.spd.data.datasets[3].data = log.vLog.Eco.map(v=>v*3.6); charts.spd.update();

  charts.gap.data.labels = t;
  charts.gap.data.datasets[0].data = log.gLog.Aggressive;
  charts.gap.data.datasets[1].data = log.gLog.Standard;
  charts.gap.data.datasets[2].data = log.gLog.Eco; charts.gap.update();

  charts.tgap.data.labels = t;
  charts.tgap.data.datasets[0].data = log.tgLog.Aggressive;
  charts.tgap.data.datasets[1].data = log.tgLog.Standard;
  charts.tgap.data.datasets[2].data = log.tgLog.Eco; charts.tgap.update();

  charts.energy.data.labels = t;
  charts.energy.data.datasets[0].data = log.eLog.Aggressive;
  charts.energy.data.datasets[1].data = log.eLog.Standard;
  charts.energy.data.datasets[2].data = log.eLog.Eco; charts.energy.update();

  const eA=log.energy.Aggressive, eS=log.energy.Standard, eE=log.energy.Eco;
  kAgg.textContent = eS>0? (100*eA/eS).toFixed(1)+'%':'–';
  kStd.textContent = '100%';
  kEco.textContent = eS>0? (100*eE/eS).toFixed(1)+'%':'–';
}

/* ---------- bird view ---------- */
let anim={ playing:false, k:0, timer:null, lastLog:null };
function drawBird(log){
  const cvs = document.getElementById('bird');
  const ctx = cvs.getContext('2d');
  const W=cvs.width, H=cvs.height;
  ctx.fillStyle='#0b0f17'; ctx.fillRect(0,0,W,H);

  const p=P();
  const k=anim.k;
  const xCtr=log.xLeadLog[k];
  const xmin=xCtr - p.winBack, xmax=xCtr + p.winAhead;
  const x2px=x=> (x - xmin)/(xmax-xmin) * (W-40) + 20;

  const yLead=60, yAg=160, ySt=260, yEc=360;
  ctx.strokeStyle='#1f2433';
  for(const y of [yLead,yAg,ySt,yEc]){ ctx.beginPath(); ctx.moveTo(12,y); ctx.lineTo(W-12,y); ctx.stroke(); }

  const headways=[0.5,1,1.5,2.4,3,5];
  ctx.setLineDash([6,6]); ctx.strokeStyle='#62739b'; ctx.fillStyle='#8ea3cf'; ctx.font='12px system-ui';
  for(const hw of headways){
    const xH=x2px(log.xLeadLog[k] - log.vLead[k]*hw);
    ctx.beginPath(); ctx.moveTo(xH, 30); ctx.lineTo(xH, H-20); ctx.stroke();
    ctx.fillText(hw.toFixed(1)+' s', xH-14, 22);
  }
  ctx.setLineDash([]);

  function car(xm,y,fill,label,dx=6){
    const x=x2px(xm), Lpx=40, Hpx=24;
    ctx.fillStyle=fill; ctx.fillRect(x, y-Hpx/2, Lpx, Hpx);
    ctx.fillStyle='#dfe7f6'; ctx.fillText(label, x+dx, y-12);
  }
  car(log.xLeadLog[k], yLead, colors.lead, 'Lead');
  car(log.xLog.Aggressive[k], yAg, colors.ag, 'Aggressive', 2);
  car(log.xLog.Standard[k],   ySt, colors.st, 'Standard', 2);
  car(log.xLog.Eco[k],        yEc, colors.ec, 'Eco', 2);

  ctx.strokeStyle='#24304a'; ctx.strokeRect(10,10,W-20,H-20);
}
function play(log){
  if(anim.playing) return;
  anim.playing=true;
  const step=()=>{
    if(!anim.playing) return;
    anim.k = Math.min(anim.k + P().frameSkip, log.t.length-1);
    drawBird(log);
    if(anim.k>=log.t.length-1){ anim.playing=false; return; }
    anim.timer = setTimeout(step, P().pauseTime*1000);
  };
  step();
}
function pauseAnim(){ anim.playing=false; if(anim.timer){ clearTimeout(anim.timer); anim.timer=null; } }

/* ---------- wiring ---------- */
ensureCharts();
logd('Paste your profile and click RUN.');

run.onclick = ()=>{
  try{
    const prof = parseProfile(profile.value);
    const log = simulate(prof, P());
    anim.lastLog = log;
    anim.k=0;
    updateCharts(log);
    drawBird(log);
    logd(`Sim ok. N=${log.t.length} dt=${log.dt.toFixed(3)}s | E[kWh] Agg=${log.energy.Aggressive.toFixed(3)} Std=${log.energy.Standard.toFixed(3)} Eco=${log.energy.Eco.toFixed(3)}`);
  }catch(err){
    logd('Run error: '+err.message);
    alert('Run error: '+err.message);
  }
};
play.onclick = ()=>{ if(anim.lastLog) play(anim.lastLog); };
pause.onclick = ()=> pauseAnim();
</script>
</body>
</html>
