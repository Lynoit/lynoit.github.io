<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Annotation Map App</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #map { height: 400px; margin-top: 10px; }
    #controls { margin-bottom: 10px; }
    #buttonsContainer { margin-top: 10px; }
    .button-row { margin-bottom: 10px; }
    .button-row button { margin: 5px; padding: 8px 12px; }
    #manualContainer { margin-top: 10px; }
    #annotationsTable { width: 100%; border-collapse: collapse; margin-top: 20px; }
    #annotationsTable th, #annotationsTable td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    /* Display photos at original size and resolution */
    #annotationsTable img { display: block; }
  </style>
</head>
<body>
  <h1>Annotation Map App</h1>

  <div id="controls">
    <label for="radiusInput">Radius (m): </label>
    <input type="number" id="radiusInput" value="100" min="0" />
    <label for="sampleInput" style="margin-left:20px;">Samples:</label>
    <input type="number" id="sampleInput" value="10" min="1" />
    <button id="loadMapBtn">Load Position & Plot</button>
  </div>

  <div id="map"></div>
  <!-- Buttons organized by rows -->
  <div id="buttonsContainer"></div>
  <div id="manualContainer">
    <input type="text" id="manualText" placeholder="Enter manual annotation" style="width: 300px;" />
    <button id="manualBtn">Manual annotation</button>
  </div>

  <table id="annotationsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Button Name</th>
        <th>Comment</th>
        <th>Photo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none" />

  <!-- Leaflet & XLSX libraries -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    function getSinglePosition(opts = {}) {
      return new Promise((res, rej) => {
        if (!navigator.geolocation) return rej(new Error('Geolocation not supported'));
        navigator.geolocation.getCurrentPosition(res, rej, opts);
      });
    }

    async function getAveragePosition(samples, maxAttempts) {
      const coords = [];
      let attempts = 0;
      while (coords.length < samples && attempts < maxAttempts) {
        attempts++;
        try {
          const pos = await getSinglePosition({ enableHighAccuracy: true, timeout: 3000 });
          coords.push(pos.coords);
        } catch (e) {
          console.warn('Retrying position:', e.message);
        }
      }
      if (coords.length === 0) throw new Error('No position samples');
      const latSum = coords.reduce((sum, c) => sum + c.latitude, 0);
      const lngSum = coords.reduce((sum, c) => sum + c.longitude, 0);
      return { latitude: latSum / coords.length, longitude: lngSum / coords.length };
    }

    async function loadConfig() {
      try {
        const resp = await fetch('gt_buttons.xlsx');
        if (!resp.ok) throw new Error('Could not fetch config');
        const data = await resp.arrayBuffer();
        const wb = XLSX.read(new Uint8Array(data), { type: 'array' });
        const rawRows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        const rows = rawRows.map(r => {
          const norm = {};
          Object.keys(r).forEach(key => { norm[key.trim().toLowerCase()] = r[key]; });
          return norm;
        });
        const ctr = document.getElementById('buttonsContainer');
        ctr.innerHTML = '';
        const rowMap = {};
        rows.forEach(r => {
          const rowNum = parseInt(r['row']) || 1;
          if (!rowMap[rowNum]) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'button-row';
            rowMap[rowNum] = rowDiv;
            ctr.appendChild(rowDiv);
          }
          const btn = document.createElement('button');
          const name = r['button name'] || '';
          const comment = r['first comment'] || r['comment'] || '';
          btn.textContent = name;
          btn.onclick = () => createAnnotation(name, comment);
          rowMap[rowNum].appendChild(btn);
        });
      } catch (e) {
        console.error('Config load error:', e);
        alert('Failed to load button configuration');
      }
    }

    async function loadAndPlot() {
      const btn = document.getElementById('loadMapBtn');
      btn.disabled = true;
      btn.textContent = 'Getting location...';

      const sampleInput = document.getElementById('sampleInput');
      const samples = Math.max(1, parseInt(sampleInput.value) || 10);
      const maxAttempts = samples * 3;

      try {
        const init = await getSinglePosition({ timeout: 5000 });
        const { latitude: iLat, longitude: iLng } = init.coords;
        if (!window._appMap) {
          window._appMap = L.map('map').setView([iLat, iLng], 16);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(window._appMap);
        } else {
          window._appMap.setView([iLat, iLng], 16);
        }
      } catch (e) {
        console.warn('Init pos failed:', e.message);
        alert('Enable location permissions.');
        btn.disabled = false;
        btn.textContent = 'Load Position & Plot';
        return;
      }

      btn.textContent = `Sampling ${samples} pts...`;
      let avgLat = 0, avgLng = 0;
      try {
        const avg = await getAveragePosition(samples, maxAttempts);
        avgLat = avg.latitude;
        avgLng = avg.longitude;
      } catch (e) {
        console.warn(e.message);
      }

      const radius = Number(document.getElementById('radiusInput').value);
      if (window._appCircle) window._appMap.removeLayer(window._appCircle);
      window._appCircle = L.circle([avgLat || window._appMap.getCenter().lat, avgLng || window._appMap.getCenter().lng], { radius }).addTo(window._appMap);

      if (window._appMarker) window._appMap.removeLayer(window._appMarker);
      window._appMarker = L.circleMarker([avgLat || window._appMap.getCenter().lat, avgLng || window._appMap.getCenter().lng], {
        radius: 10,
        color: 'red',
        fillColor: 'red',
        fillOpacity: 1
      }).addTo(window._appMap);

      btn.disabled = false;
      btn.textContent = 'Load Position & Plot';
    }

    let annotationCount = 0;
    let pendingAnnotation = null;
    function createAnnotation(name, comment) {
      pendingAnnotation = { name, comment };
      document.getElementById('photoInput').click();
    }

    document.getElementById('photoInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file || !pendingAnnotation) return;
      const reader = new FileReader();
      reader.onload = ev => {
        annotationCount++;
        const img = ev.target.result;
        const latlng = window._appCircle ? window._appCircle.getLatLng() : { lat: 0, lng: 0 };
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${annotationCount}</td>
          <td>${latlng.lat.toFixed(6)}</td>
          <td>${latlng.lng.toFixed(6)}</td>
          <td>${pendingAnnotation.name}</td>
          <td>${pendingAnnotation.comment}</td>
          <td><img src="${img}" /></td>
        `;
        document.querySelector('#annotationsTable tbody').appendChild(tr);
        pendingAnnotation = null;
        e.target.value = '';
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('manualBtn').addEventListener('click', () => {
      const txt = document.getElementById('manualText').value.trim();
      if (!txt) return alert('Enter annotation text');
      createAnnotation(txt, '');
    });

    document.getElementById('radiusInput').addEventListener('change', () => {
      if (window._appCircle) window._appCircle.setRadius(Number(document.getElementById('radiusInput').value));
    });

    window.addEventListener('DOMContentLoaded', loadConfig);
    document.getElementById('loadMapBtn').addEventListener('click', loadAndPlot);
  </script>
</body>
</html>
