<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Annotation Map App</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #map { height: 400px; margin-top: 10px; }
    #controls { margin-bottom: 10px; }
    #buttonsContainer button { margin: 5px; padding: 8px 12px; }
    #manualContainer { margin-top: 10px; }
    #annotationsTable { width: 100%; border-collapse: collapse; margin-top: 20px; }
    #annotationsTable th, #annotationsTable td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    #annotationsTable img { max-width: 100px; max-height: 100px; }
  </style>
</head>
<body>
  <h1>Annotation Map App</h1>

  <div id="controls">
    <label>Upload button config (XLSX): </label>
    <input type="file" id="xlsxInput" accept=".xlsx" />
    <br /><br />
    <label for="radiusInput">Radius (m): </label>
    <input type="number" id="radiusInput" value="100" />
    <button id="loadMapBtn">Load Position & Plot</button>
  </div>

  <div id="map"></div>
  <div id="buttonsContainer"></div>
  <div id="manualContainer">
    <input type="text" id="manualText" placeholder="Enter manual annotation" style="width: 300px;" />
    <button id="manualBtn">Manual annotation</button>
  </div>

  <table id="annotationsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Button Name</th>
        <th>First Comment</th>
        <th>Second Comment</th>
        <th>Photo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none" />

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    const SAMPLE_COUNT = 10; // Reduced for faster sampling
    let map, circle;
    let avgLat = 0, avgLng = 0;
    let annotationCount = 0;
    let pendingAnnotation = null;

    async function getAveragePosition(samples = SAMPLE_COUNT) {
      const coords = [];
      while (coords.length < samples) {
        try {
          const pos = await new Promise((res, rej) => {
            navigator.geolocation.getCurrentPosition(res, rej, {
              enableHighAccuracy: true,
              timeout: 5000
            });
          });
          coords.push(pos.coords);
        } catch (e) {
          console.warn('Position error, retrying:', e);
        }
      }
      const latSum = coords.reduce((sum, c) => sum + c.latitude, 0);
      const lngSum = coords.reduce((sum, c) => sum + c.longitude, 0);
      return {
        latitude: latSum / coords.length,
        longitude: lngSum / coords.length
      };
    }

    async function loadAndPlot() {
      const btn = document.getElementById('loadMapBtn');
      btn.disabled = true;
      btn.textContent = `Sampling ${SAMPLE_COUNT} points...`;

      const pos = await getAveragePosition();
      avgLat = pos.latitude;
      avgLng = pos.longitude;

      const radius = Number(document.getElementById('radiusInput').value);
      if (!map) {
        map = L.map('map').setView([avgLat, avgLng], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
      } else {
        map.setView([avgLat, avgLng], 16);
        if (circle) circle.remove();
      }

      circle = L.circle([avgLat, avgLng], { radius }).addTo(map);
      btn.disabled = false;
      btn.textContent = 'Load Position & Plot';
    }

    function createAnnotation(name, first, second) {
      pendingAnnotation = { name, first, second };
      document.getElementById('photoInput').click();
    }

    document.getElementById('photoInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file || !pendingAnnotation) return;
      const reader = new FileReader();
      reader.onload = function (ev) {
        annotationCount++;
        const imgURL = ev.target.result;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${annotationCount}</td>
          <td>${avgLat.toFixed(6)}</td>
          <td>${avgLng.toFixed(6)}</td>
          <td>${pendingAnnotation.name}</td>
          <td>${pendingAnnotation.first}</td>
          <td>${pendingAnnotation.second}</td>
          <td><img src="${imgURL}" /></td>
        `;
        document.querySelector('#annotationsTable tbody').appendChild(tr);
        pendingAnnotation = null;
        e.target.value = '';
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('xlsxInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (ev) {
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        const container = document.getElementById('buttonsContainer');
        container.innerHTML = '';
        rows.forEach(row => {
          const btn = document.createElement('button');
          const name = row['button name'] || row['Button Name'] || 'Unnamed';
          const first = row['first comment'] || row['First Comment'] || '';
          const second = row['second comment'] || row['Second Comment'] || '';
          btn.textContent = name;
          btn.addEventListener('click', () => createAnnotation(name, first, second));
          container.appendChild(btn);
        });
      };
      reader.readAsArrayBuffer(file);
    });

    document.getElementById('manualBtn').addEventListener('click', function () {
      const text = document.getElementById('manualText').value.trim();
      if (!text) return alert('Enter annotation text first');
      createAnnotation(text, '', '');
    });

    document.getElementById('radiusInput').addEventListener('change', function () {
      if (circle) circle.setRadius(Number(this.value));
    });

    document.getElementById('loadMapBtn').addEventListener('click', loadAndPlot);
  </script>
</body>
</html>
