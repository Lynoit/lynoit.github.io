<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Annotation Map App</title>
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #map { height: 400px; margin-top: 10px; }
    #controls { margin-bottom: 10px; }
    #buttonsContainer button { margin: 5px; padding: 8px 12px; }
    #manualContainer { margin-top: 10px; }
    #annotationsTable { width: 100%; border-collapse: collapse; margin-top: 20px; }
    #annotationsTable th, #annotationsTable td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    #annotationsTable img { max-width: 100px; max-height: 100px; }
  </style>
</head>
<body>
  <h1>Annotation Map App</h1>

  <!-- File input for XLSX configuration -->
  <div id="controls">
    <label>Upload button config (XLSX): </label>
    <input type="file" id="xlsxInput" accept=".xlsx" />
    <br /><br />
    <label for="radiusInput">Radius (m): </label>
    <input type="number" id="radiusInput" value="100" />
    <button id="loadMapBtn">Load Position & Plot</button>
  </div>

  <!-- Map container -->
  <div id="map"></div>

  <!-- Dynamically generated buttons -->
  <div id="buttonsContainer"></div>

  <!-- Manual annotation input -->
  <div id="manualContainer">
    <input
      type="text"
      id="manualText"
      placeholder="Enter manual annotation"
      style="width: 300px;"
    />
    <button id="manualBtn">Manual annotation</button>
  </div>

  <!-- Annotations table -->
  <table id="annotationsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Button Name</th>
        <th>First Comment</th>
        <th>Second Comment</th>
        <th>Photo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Hidden photo input to trigger camera -->
  <input
    type="file"
    id="photoInput"
    accept="image/*"
    capture="environment"
    style="display: none"
  />

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- SheetJS for XLSX parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    let map, circle;
    let avgLat = 0, avgLng = 0;
    let annotationCount = 0;
    let pendingAnnotation = null;

    // Compute average position over N samples
    async function getAveragePosition(samples = 100) {
      const coords = [];
      for (let i = 0; i < samples; i++) {
        try {
          const pos = await new Promise((res, rej) => {
            navigator.geolocation.getCurrentPosition(res, rej, {
              enableHighAccuracy: true,
              timeout: 10000
            });
          });
          coords.push(pos.coords);
        } catch (e) {
          console.warn('Position error:', e);
        }
      }
      const latSum = coords.reduce((sum, c) => sum + c.latitude, 0);
      const lngSum = coords.reduce((sum, c) => sum + c.longitude, 0);
      return {
        latitude: latSum / coords.length,
        longitude: lngSum / coords.length
      };
    }

    // Initialize or update map with average position and circle
    async function loadAndPlot() {
      document.getElementById('loadMapBtn').disabled = true;
      document.getElementById('loadMapBtn').textContent = 'Sampling...';
      const pos = await getAveragePosition(100);
      avgLat = pos.latitude;
      avgLng = pos.longitude;

      const radius = Number(document.getElementById('radiusInput').value);
      if (!map) {
        map = L.map('map').setView([avgLat, avgLng], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
      } else {
        map.setView([avgLat, avgLng], 16);
        if (circle) circle.remove();
      }

      circle = L.circle([avgLat, avgLng], { radius }).addTo(map);
      document.getElementById('loadMapBtn').disabled = false;
      document.getElementById('loadMapBtn').textContent = 'Load Position & Plot';
    }

    // Create annotation row after photo capture
    function createAnnotation(name, first, second) {
      pendingAnnotation = { name, first, second };
      document.getElementById('photoInput').click();
    }

    // Handle photo input change
    document.getElementById('photoInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file || !pendingAnnotation) return;

      const reader = new FileReader();
      reader.onload = function (ev) {
        annotationCount++;
        const imgURL = ev.target.result;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${annotationCount}</td>
          <td>${avgLat.toFixed(6)}</td>
          <td>${avgLng.toFixed(6)}</td>
          <td>${pendingAnnotation.name}</td>
          <td>${pendingAnnotation.first}</td>
          <td>${pendingAnnotation.second}</td>
          <td><img src="${imgURL}" /></td>
        `;
        document.querySelector('#annotationsTable tbody').appendChild(tr);
        // Reset
        pendingAnnotation = null;
        e.target.value = '';
      };
      reader.readAsDataURL(file);
    });

    // Load XLSX and generate buttons
    document.getElementById('xlsxInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (ev) {
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet);
        const container = document.getElementById('buttonsContainer');
        container.innerHTML = '';
        rows.forEach(row => {
          const btn = document.createElement('button');
          btn.textContent = row['button name'] || row['Button Name'];
          const first = row['first comment'] || row['First Comment'] || '';
          const second = row['second comment'] || row['Second Comment'] || '';
          btn.addEventListener('click', () => createAnnotation(btn.textContent, first, second));
          container.appendChild(btn);
        });
      };
      reader.readAsArrayBuffer(file);
    });

    // Manual annotation button
    document.getElementById('manualBtn').addEventListener('click', function () {
      const text = document.getElementById('manualText').value.trim();
      if (!text) return alert('Enter annotation text first');
      createAnnotation(text, '', '');
    });

    // Radius input change updates circle
    document.getElementById('radiusInput').addEventListener('change', function () {
      const r = Number(this.value);
      if (circle) circle.setRadius(r);
    });

    // Load & plot on button click
    document.getElementById('loadMapBtn').addEventListener('click', loadAndPlot);
  </script>
</body>
</html>
