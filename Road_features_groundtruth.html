<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Annotation Map App</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #map { height: 400px; margin-top: 10px; }
    #controls { margin-bottom: 10px; }
    #buttonsContainer button { margin: 5px; padding: 8px 12px; }
    #manualContainer { margin-top: 10px; }
    #annotationsTable { width: 100%; border-collapse: collapse; margin-top: 20px; }
    #annotationsTable th, #annotationsTable td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    #annotationsTable img { max-width: 100px; max-height: 100px; }
  </style>
</head>
<body>
  <h1>Annotation Map App</h1>

  <div id="controls">
    <label>Upload button config (XLSX): </label>
    <input type="file" id="xlsxInput" accept=".xlsx" />
    <br /><br />
    <label for="radiusInput">Radius (m): </label>
    <input type="number" id="radiusInput" value="100" />
    <button id="loadMapBtn">Load Position & Plot</button>
  </div>

  <div id="map"></div>
  <div id="buttonsContainer"></div>
  <div id="manualContainer">
    <input type="text" id="manualText" placeholder="Enter manual annotation" style="width: 300px;" />
    <button id="manualBtn">Manual annotation</button>
  </div>

  <table id="annotationsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Button Name</th>
        <th>First Comment</th>
        <th>Second Comment</th>
        <th>Photo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none" />

  <!-- Leaflet & XLSX libraries -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    const SAMPLE_COUNT = 5;
    const MAX_ATTEMPTS = SAMPLE_COUNT * 3;
    let map, circle, marker;
    let avgLat = 0, avgLng = 0;
    let annotationCount = 0;
    let pendingAnnotation = null;

    function getSinglePosition(opts = {}) {
      return new Promise((res, rej) => {
        if (!navigator.geolocation) return rej(new Error('Geolocation not supported'));
        navigator.geolocation.getCurrentPosition(res, rej, opts);
      });
    }

    async function getAveragePosition(samples = SAMPLE_COUNT) {
      const coords = [];
      let attempts = 0;
      while (coords.length < samples && attempts < MAX_ATTEMPTS) {
        attempts++;
        try {
          const pos = await getSinglePosition({ enableHighAccuracy: true, timeout: 3000 });
          coords.push(pos.coords);
        } catch (e) {
          console.warn('Retrying position:', e.message);
        }
      }
      if (coords.length === 0) throw new Error('No position samples');
      const latSum = coords.reduce((sum, c) => sum + c.latitude, 0);
      const lngSum = coords.reduce((sum, c) => sum + c.longitude, 0);
      return { latitude: latSum / coords.length, longitude: lngSum / coords.length };
    }

    async function loadAndPlot() {
      const btn = document.getElementById('loadMapBtn');
      btn.disabled = true;
      btn.textContent = 'Getting location...';

      // Initial map setup
      try {
        const init = await getSinglePosition({ timeout: 5000 });
        const { latitude: iLat, longitude: iLng } = init.coords;
        if (!map) {
          map = L.map('map').setView([iLat, iLng], 16);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
        } else {
          map.setView([iLat, iLng], 16);
        }
      } catch (e) {
        console.warn('Init pos failed:', e.message);
        alert('Enable location permissions.');
        resetButton(btn);
        return;
      }

      btn.textContent = `Sampling ${SAMPLE_COUNT} pts...`;
      try {
        const avg = await getAveragePosition();
        avgLat = avg.latitude;
        avgLng = avg.longitude;
      } catch (e) {
        console.warn(e.message);
        // fallback uses map center
      }

      // Draw circle
      const radius = Number(document.getElementById('radiusInput').value);
      if (circle) map.removeLayer(circle);
      circle = L.circle([avgLat || map.getCenter().lat, avgLng || map.getCenter().lng], { radius }).addTo(map);

      // Add red dot marker
      if (marker) map.removeLayer(marker);
      marker = L.circleMarker([avgLat || map.getCenter().lat, avgLng || map.getCenter().lng], {
        radius: 10,
        color: 'red',
        fillColor: 'red',
        fillOpacity: 1
      }).addTo(map);

      resetButton(btn);
    }

    function resetButton(btn) {
      btn.disabled = false;
      btn.textContent = 'Load Position & Plot';
    }

    function createAnnotation(name, first, second) {
      pendingAnnotation = { name, first, second };
      document.getElementById('photoInput').click();
    }

    document.getElementById('photoInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file || !pendingAnnotation) return;
      const reader = new FileReader();
      reader.onload = ev => {
        annotationCount++;
        const img = ev.target.result;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${annotationCount}</td>
          <td>${(avgLat || map.getCenter().lat).toFixed(6)}</td>
          <td>${(avgLng || map.getCenter().lng).toFixed(6)}</td>
          <td>${pendingAnnotation.name}</td>
          <td>${pendingAnnotation.first}</td>
          <td>${pendingAnnotation.second}</td>
          <td><img src="${img}" /></td>
        `;
        document.querySelector('#annotationsTable tbody').appendChild(tr);
        pendingAnnotation = null;
        e.target.value = '';
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('xlsxInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
        const rawRows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        const rows = rawRows.map(r => {
          const norm = {};
          Object.keys(r).forEach(key => { norm[key.trim().toLowerCase()] = r[key]; });
          return norm;
        });
        const ctr = document.getElementById('buttonsContainer');
        ctr.innerHTML = '';
        rows.forEach(r => {
          const name = r['button name'] || '';
          const first = r['first comment'] || '';
          const second = r['second comment'] || '';
          const btn = document.createElement('button');
          btn.textContent = name;
          btn.onclick = () => createAnnotation(name, first, second);
          ctr.appendChild(btn);
        });
      };
      reader.readAsArrayBuffer(file);
    });

    document.getElementById('manualBtn').addEventListener('click', () => {
      const txt = document.getElementById('manualText').value.trim();
      if (!txt) return alert('Enter annotation text');
      createAnnotation(txt, '', '');
    });

    document.getElementById('radiusInput').addEventListener('change', () => {
      if (circle) circle.setRadius(Number(document.getElementById('radiusInput').value));
    });

    document.getElementById('loadMapBtn').addEventListener('click', loadAndPlot);
  </script>
</body>
</html>
