<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annotator</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Chart.js core + Luxon adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; }

    /* Sidebar controls */
    #sidebar {
      position: fixed; top: 0; left: 0; height: 100%;
      width: 260px; transform: translateX(-230px);
      transition: transform .3s ease;
      background: #fff; box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      overflow-y: auto; padding: 50px 10px 10px;
      z-index: 1000;
    }
    #sidebar.collapsed { transform: translateX(-230px); }
    #sidebar.expanded  { transform: translateX(0); }
    #toggleSidebar {
      position: fixed; top: 10px; left: 10px;
      background: #007bff; border: none; color: #fff;
      font-size: 1.5em; padding: 4px 8px; cursor: pointer;
      border-radius: 4px; z-index: 1100;
    }

    /* Sticky header */
    #headerInfo {
      position: sticky; top: 0; background: #f9f9f9;
      padding: 10px; box-shadow: 0 2px 4px rgba(0,0,0,.1);
      z-index: 500;
      display: flex; justify-content: space-around;
      align-items: center;
    }

    /* Spinner */
    .spinner {
      border: 2px solid rgba(0,0,0,0.1);
      border-left-color: #333;
      border-radius: 50%; width: 16px; height: 16px;
      animation: spin .8s linear infinite; display: inline-block;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Highlight on update */
    #totalDistance.updated {
      transition: background .5s;
      background: yellow;
    }

    /* Controls styling adjustments */
    .bigButton { display: block; width: 80%; min-width: 80px; padding: 12px; font-size: 14px; border-radius: 4px; cursor: pointer; margin: 8px auto; }
    .orangeButton { background-color: orange; color: white; }
    .blueButton   { background-color: blue;   color: white; }
    .greyButton   { background-color: grey;   color: white; }
    .greenButton  { background-color: green;  color: white; }
    .redButton    { background-color: red;    color: white; }
    #textBox { width: 90%; margin: 0 auto; padding: 10px; font-size: 14px; resize: vertical; }

    /* Main content padding */
    #mainContent { margin-left: 280px; padding: 20px; box-sizing: border-box; }
    table { width: 100%; margin: 10px 0; border-collapse: collapse; }
    td, th { text-align: center; padding: 10px; }
    .center-groups { display: flex; justify-content: center; align-items: flex-start; }

    /* Sections */
    .section { margin-bottom: 30px; }
    .page-break { page-break-after: always; }

    /* Print adjustments */
    @media print {
      #sidebar, #toggleSidebar { display: none !important; }
      .page-break { display: block; }
    }
  </style>
</head>
<body>
  <!-- Sidebar Toggle -->
  <button id="toggleSidebar" aria-expanded="false">☰</button>

  <!-- Controls Sidebar -->
  <div id="sidebar" class="collapsed">
    <p id="dateTime"></p>
    <div class="weatherSection">
      <img id="weatherIcon" src="" alt="Weather">
      <p id="temperature">Temp: N/A</p>
    </div>
    <p id="streetCity">Street: N/A<br>City: N/A</p>
    <p id="location"></p>
    <p id="roadType">Road type: N/A</p>
    <p id="speed">Speed: N/A</p>
    <div class="distanceContainer">
      <p id="totalDistance">Distance: 0.0 km</p>
      <button type="button" class="bigButton orangeButton" onclick="resetDistance()">Reset distance</button>
    </div>
    <textarea id="textBox" rows="2" placeholder="Enter your annotation here..."></textarea>
    <button type="button" class="bigButton blueButton" onclick="logButton('Manual annotation', false)">Manual annotation</button>
    <button type="button" class="bigButton greenButton" onclick="saveAndPrint()">Save report to PDF</button>
    <div class="center-groups">
      <div>
        <button class="bigButton greyButton">ACC</button>
        <button class="bigButton redButton" onclick="logButton('ACC False brake', true)">False brake</button>
        <button class="bigButton redButton" onclick="logButton('ACC Target drop', true)">Target drop</button>
        <button class="bigButton redButton" onclick="logButton('ACC Longitudinal jerk', true)">Longitudinal jerk</button>
        <button class="bigButton redButton" onclick="logButton('ACC Accuracy in speed adaption', true)">Accuracy in speed adaption</button>
      </div>
      <div>
        <button class="bigButton greyButton">TSI Speed</button>
        <button class="bigButton greenButton" onclick="logButton('TSI Explicit correct speed detected', false)">Correct speed</button>
        <button class="bigButton redButton" onclick="logButton('TSI Explicit incorrect speed detected', true)">Incorrect speed</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent">
    <div id="logTableContainer" class="section"></div>
    <div class="page-break"></div>

    <div id="mapContainer" class="section">
      <h3>Route</h3>
      <div id="map" style="height:300px;width:100%;"></div>
    </div>
    <div class="page-break"></div>

    <div id="countContainer" class="section">
      <h3>KPI Calculation</h3>
      <table id="countTable">
        <tr><th>Issue</th><th>Total No of events</th><th>Events per 1000 km</th></tr>
        <tr><td colspan="3">&nbsp;</td></tr>
      </table>
    </div>
    <div class="page-break"></div>

    <div id="chartsContainer" class="section" style="display:flex; gap:10px;">
      <div class="chartBox" style="flex:1;">
        <h3>Distance vs Time</h3>
        <canvas id="distanceChart"></canvas>
      </div>
      <div class="chartBox" style="flex:1;">
        <h3>Speed vs Distance</h3>
        <canvas id="speedChart"></canvas>
      </div>
    </div>
    <div class="page-break"></div>

    <div id="streetsContainer" class="section">
      <h3>Road Types Encountered</h3>
      <table id="streetTable"><tr><th>Road type</th></tr></table>
    </div>

    <footer style="text-align:center; padding:10px; font-size:12px; color:#666;">
      © Lynoit Tech 2025
    </footer>
  </div>

  <!-- Dependencies -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let logTable = [], redCounts = {}, lastPosition = null, totalDistance = 0;
    let positions = [], timeData = [], distData = [], speedData = [];
    let map, trackLine, distanceChart, speedChart;
    let roadTypeSet = new Set();
    let lastUpdate = 0, chartNeedsUpdate = false;

    // Sidebar toggle
    document.getElementById('toggleSidebar').onclick = () => {
      const sb = document.getElementById('sidebar');
      const expanded = sb.classList.toggle('expanded');
      sb.classList.toggle('collapsed', !expanded);
      document.getElementById('toggleSidebar').setAttribute('aria-expanded', expanded);
    };

    function initMap() {
      map = L.map('map').setView([0,0],2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);
      trackLine = L.polyline([], { weight: 4 }).addTo(map);
    }

    function initCharts() {
      const ctx1 = document.getElementById('distanceChart').getContext('2d');
      distanceChart = new Chart(ctx1, {
        type: 'line', data: { labels: timeData, datasets:[{ label:'Distance (km)', data: distData, fill:false, tension:0.1 }] },
        options:{ responsive:true, scales:{ x:{ type:'time', time:{ unit:'minute', tooltipFormat:'HH:mm:ss' }}, y:{ beginAtZero:true }} }
      });
      const ctx2 = document.getElementById('speedChart').getContext('2d');
      speedChart = new Chart(ctx2, {
        type: 'line', data:{ labels: distData, datasets:[{ label:'Speed (km/h)', data: speedData, fill:false, tension:0.1 }] },
        options:{ responsive:true, scales:{ x:{ type:'linear', title:{ display:true, text:'Distance (km)' }}, y:{ beginAtZero:true, title:{ display:true, text:'Speed (km/h)' }}} }
      });
    }

    function updateMap() {
      trackLine.setLatLngs(positions);
      if (positions.length === 1) map.setView(positions[0], 15);
      else if (positions.length > 1) map.fitBounds(trackLine.getBounds().pad(0.2));
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000, toRad = Math.PI/180;
      const dLat = (lat2 - lat1)*toRad, dLon = (lon2 - lon1)*toRad;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*toRad)*Math.cos(lat2*toRad)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function queueChartUpdate() {
      if (!chartNeedsUpdate) {
        chartNeedsUpdate = true;
        requestAnimationFrame(() => {
          distanceChart.update(); speedChart.update(); chartNeedsUpdate = false;
        });
      }
    }

    function showPosition(position) {
      const lat = position.coords.latitude, lon = position.coords.longitude, t = position.timestamp;
      document.getElementById('location').innerHTML = `Lat: ${lat}<br>Lon: ${lon}`;

      if (lastPosition) {
        const d = calculateDistance(lastPosition.latitude, lastPosition.longitude, lat, lon);
        const dt = (t - lastPosition.timestamp)/1000;
        if (dt > 0) {
          const speedKmh = (d/dt)*3.6;
          document.getElementById('speed').innerHTML = `Speed: ${speedKmh.toFixed(1)} km/h`;
          totalDistance += d;
          const distEl = document.getElementById('totalDistance');
          distEl.innerHTML = `Distance: ${(totalDistance/1000).toFixed(1)} km`;
          distEl.classList.add('updated'); setTimeout(() => distEl.classList.remove('updated'), 500);
          timeData.push(new Date(t)); distData.push((totalDistance/1000).toFixed(3)); speedData.push(speedKmh.toFixed(1));
          queueChartUpdate(); updateCountTable();
        }
      }

      lastPosition = { latitude: lat, longitude: lon, timestamp: t };
      positions.push([lat, lon]); updateMap();

      // Reverse geocode + street & city update
      fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&extratags=1&lat=${lat}&lon=${lon}`)
        .then(r => r.json())
        .then(data => {
          // Road type
          const rt = (data.extratags && data.extratags.highway)
                    ? data.extratags.highway
                    : data.type || 'Unknown';
          document.getElementById('roadType').innerHTML = `Road type: ${rt}`;
          roadTypeSet.add(rt);
          updateStreetTable();

          // Street & City
          const street = data.address.road
                        || data.address.pedestrian
                        || data.address.footway
                        || 'Unknown street';
          const city   = data.address.city
                        || data.address.town
                        || data.address.village
                        || 'Unknown city';
          document.getElementById('streetCity').innerHTML =
            `Street: ${street}<br>City: ${city}`;

          // Weather lookup
          getWeather(city);
        })
        .catch(e => {
          document.getElementById('streetCity').innerHTML = 'Error: ' + e.message;
        });
    }

    function updateStreetTable() {
      const tbl = document.getElementById('streetTable'), types = Array.from(roadTypeSet);
      let html = '<tr><th>Road type</th></tr>';
      types.forEach(rt => html += `<tr><td>${rt}</td></tr>`);
      tbl.innerHTML = html;
    }

    function resetDistance() {
      totalDistance = 0; lastPosition = null;
      document.getElementById('totalDistance').innerHTML = 'Distance: 0.0 km';
      document.getElementById('speed').innerHTML = 'Speed: N/A';
      timeData = []; distData = []; speedData = [];
      roadTypeSet.clear(); updateStreetTable(); queueChartUpdate(); updateCountTable();
    }

    function saveAndPrint() {
      const btn = event.currentTarget;
      btn.disabled = true;
      const orig = btn.textContent;
      btn.innerHTML = '<span class="spinner"></span> Generating…';
      logButton('Save report to PDF', false);
      setTimeout(() => { window.print(); btn.disabled = false; btn.textContent = orig; }, 500);
    }

    function showError(e) {
      document.getElementById('location').innerHTML = 'Error: '+e.message;
      document.getElementById('speed').innerHTML = 'Speed: N/A';
    }

    function updateLocation() {
      const now = Date.now();
      if (now - lastUpdate < 5000) return;
      lastUpdate = now;
      navigator.geolocation.getCurrentPosition(showPosition, showError);
    }
    setInterval(updateLocation, 1000);

    // Updated weather fetch
    function getWeather(city) {
      fetch(
        `https://api.weatherapi.com/v1/current.json?key=YOUR_VALID_KEY&q=${encodeURIComponent(city)}`
      )
      .then(r => r.json())
      .then(d => {
        const iconPath = d.current.condition.icon;
        const iconUrl = iconPath.startsWith('//')
          ? 'https:' + iconPath
          : iconPath;
        const iconEl = document.getElementById('weatherIcon');
        iconEl.src = iconUrl;
        iconEl.alt = d.current.condition.text || 'weather';

        document.getElementById('temperature').innerHTML =
          `Temp: ${d.current.temp_c}°C`;
      })
      .catch(err => {
        console.error('Weather fetch error:', err);
        document.getElementById('temperature').innerHTML = 'Temp: N/A';
      });
    }

    function updateDateTime() {
      document.getElementById('dateTime').innerHTML = new Date().toLocaleString();
    }
    setInterval(updateDateTime, 1000);

    function logButton(name, isRed) {
      const dt = new Date(), date = dt.toLocaleDateString(), time = dt.toLocaleTimeString();
      const loc = document.getElementById('location').innerHTML.split('<br>'),
            lat = loc[0].split(': ')[1], lon = loc[1].split(': ')[1];
      const dist = (totalDistance/1000).toFixed(1),
            spd  = document.getElementById('speed').innerHTML.split(': ')[1].split(' ')[0];
      const rt   = document.getElementById('roadType').innerHTML.split(': ')[1];
      const comment = document.getElementById('textBox').value;
      logTable.push([name,date,time,document.getElementById('temperature').innerText,document.getElementById('weatherIcon').alt,lat,lon,dist,spd,rt,comment]);
      displayLogTable();
      const icon = L.divIcon({ className:'issue-label', html:`<strong>${name}</strong>`, iconSize:null });
      L.marker([parseFloat(lat),parseFloat(lon)],{ icon, keyboard:true, title:name }).addTo(map);
      if(isRed){ redCounts[name]=(redCounts[name]||0)+1; updateCountTable(); }
      document.getElementById('textBox').value='';
    }

    function displayLogTable() {
      let html = `<table><tr><th>No.</th><th>Issue</th><th>Date</th><th>Time</th><th>Temp</th><th>Weather</th><th>Lat</th><th>Lon</th><th>Dist (km)</th><th>Speed</th><th>Road</th><th>Comment</th></tr>`;
      logTable.forEach((row,i)=>{ html+=`<tr><td>${i+1}</td>${row.map(v=>`<td>${v}</td>`).join('')}</tr>`; });
      html+=`</table>`;
      document.getElementById('logTableContainer').innerHTML=html;
    }

    function updateCountTable() {
      const tbl=document.getElementById('countTable'); let rows=`<tr><th>Issue</th><th>Total No of events</th><th>Events per 1000 km</th></tr>`;
      const dkm=totalDistance/1000;
      for(const issue in redCounts){ const c=redCounts[issue]; const r=dkm>0?((c/dkm)*1000).toFixed(1):'—'; rows+=`<tr><td>${issue}</td><td>${c}</td><td>${r}</td></tr>`; }
      tbl.innerHTML=rows;
    }

    // Keyboard shortcut for manual annotation
    document.addEventListener('keydown', e => {
      if(e.key.toLowerCase()==='m') logButton('Manual annotation', false);
    });

    window.onload = () => { initMap(); initCharts(); updateDateTime(); };
  </script>
</body>
</html>
