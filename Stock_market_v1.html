<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Most Discussed — Stockholm/Nasdaq (Forums Live)</title>
  <style>
    :root { --bg:#0f1115; --card:#171923; --text:#e8eaf0; --muted:#9aa4b2; --accent:#83b6ff; --good:#4ade80; --warn:#facc15; --bad:#fb7185 }
    html,body{height:100%}
    body{margin:0; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text)}
    .wrap{max-width:1100px; margin:0 auto; padding:24px}
    .title{font-size:28px; font-weight:800}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:16px}
    .card{background:var(--card); border-radius:16px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.25)}
    table{width:100%; border-collapse:collapse; margin-top:8px}
    th,td{padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.06); font-size:14px}
    th{text-align:left; color:var(--muted)}
    .muted{color:var(--muted)}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.08); font-size:12px; margin:0 6px 6px 0}
    .footer{margin-top:16px; color:var(--muted); font-size:12px}
    .badgelive{display:inline-block; margin-left:8px; padding:4px 10px; border-radius:999px; background:rgba(76,175,80,.15); border:1px solid rgba(76,175,80,.35); font-size:12px}
    .spinner{display:inline-block; width:1em; height:1em; border:2px solid rgba(255,255,255,.2); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; vertical-align:-2px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      Most Discussed — Stockholm/Nasdaq (Forums only)
      <span id="liveBadge" class="badgelive">LIVE</span>
    </div>
    <div class="muted" id="stamp"><span class="spinner"></span> Scanning forums…</div>

    <div class="row">
      <div class="card">
        <h3>Stocks — Top 5 (Forums)</h3>
        <table id="tbl-stock-forums">
          <thead><tr><th>#</th><th>Ticker</th><th>Mentions</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="muted" id="forumStockMsg"></div>
      </div>

      <div class="card">
        <h3>Funds — Top 5 (Forums)</h3>
        <table id="tbl-fund-forums">
          <thead><tr><th>#</th><th>Fund</th><th>Mentions</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="muted" id="forumFundMsg"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>Sources (Forums)</h3>
      <div id="sources"></div>
      <div class="muted" style="margin-top:8px">
        Pulls hot posts from: <code>r/Aktier</code>, <code>r/Arktiemarknaden</code>, <code>r/PrivatEkonomi</code> (editable in code).
      </div>
    </div>

    <div class="footer">© Lynoit 2025</div>
  </div>

  <script>
    // ===== Subreddits to scan (edit if you like) =====
    const SUBREDDITS = ['Aktier','Aktiemarknaden','PrivatEkonomi'];

    // ===== Dictionaries =====
    const TICKERS = [
      'VOLV B','HM B','ERIC B','EVO','INVE B','ATCO A','ATCO B','SAND','SWED A','SEB A','SHB A','TELIA','TEL2 B',
      'SAAB B','BOL','ESSITY B','NIBE B','AZN','EQT','SSAB A','SSAB B','ALFA','SKF B','ASSA B','SCA B','KINV B',
      'SINCH','EMBRAC B','HUSQ B','KIND SDB','INDU C','INDU B','HEXATRONIC','MIPS','STORYTEL B'
    ];
    const FUNDS = [
      'Avanza Zero','Spiltan Aktiefond Investmentbolag','Länsförsäkringar Global Indexnära',
      'Swedbank Robur Ny Teknik','Tin Ny Teknik','Handelsbanken Sverige Index','SEB Sverige Index',
      'AMF Aktiefond Småbolag','Nordnet Indexfond Sverige','XACT OMXS30','XACT Norden','Spiltan Räntefond Sverige'
    ];

    // ===== Helpers =====
    const dom = id => document.getElementById(id);
    function escapeRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    // Smart boundaries: A–Z and 0–9 treated as word chars; others as boundaries.
    function buildSmartRegex(keyUpper){
      const core = escapeRegex(keyUpper);
      return new RegExp(`(^|[^A-Z0-9])${core}($|[^A-Z0-9])`, 'g');
    }
    function countMentionsSmart(text, list){
      const counts = new Map();
      if(!text) return counts;
      const hay = text.toUpperCase();
      for(const key of list){
        const re = buildSmartRegex(key.toUpperCase());
        let n = 0, m;
        while((m = re.exec(hay)) !== null){ n++; }
        if(n) counts.set(key, (counts.get(key)||0) + n);
      }
      return counts;
    }
    function topN(map, n=5){ return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,n); }
    function fillTable(id, rows){
      const tbody = document.querySelector(`#${id} tbody`);
      tbody.innerHTML = '';
      (rows||[]).forEach(([label,count],i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${label}</td><td>${count}</td>`;
        tbody.appendChild(tr);
      });
    }

    // ===== Forums (live in-browser) =====
    async function fetchReddit(sub){
      const url = `https://www.reddit.com/r/${sub}/hot.json?limit=75&raw_json=1`;
      const ac = new AbortController();
      const timeout = setTimeout(()=>ac.abort(), 9000);
      try{
        const r = await fetch(url, {cache:'no-cache', signal: ac.signal});
        if(!r.ok) throw new Error(`${sub} HTTP ${r.status}`);
        const j = await r.json();
        const posts = (j.data?.children||[]).map(c=>c.data||{});
        // title, selftext, outbound link, and comments permalink as text
        return posts.map(p => [p.title, p.selftext, p.url_overridden_by_dest, p.permalink].filter(Boolean).join(' '));
      } finally {
        clearTimeout(timeout);
      }
    }

    async function runForumsScan(){
      dom('forumStockMsg').textContent = 'Scanning forums…';
      dom('forumFundMsg').textContent  = '';
      dom('sources').innerHTML = SUBREDDITS.map(s=>`<span class="pill">r/${s}</span>`).join(' ');

      let combined = '';
      let okCount = 0;
      const pills = [];

      for(const s of SUBREDDITS){
        try{
          const posts = await fetchReddit(s);
          combined += ' ' + posts.join(' ');
          okCount++;
          pills.push(`<span class="pill">r/${s}</span>`);
          console.log(`Fetched ${posts.length} from r/${s}`);
        } catch(e){
          pills.push(`<span class="pill">r/${s} (error)</span>`);
          console.warn('Reddit fail', s, e);
        }
      }

      dom('sources').innerHTML = pills.join(' ');
      dom('stamp').textContent = okCount
        ? `Scanned ${okCount}/${SUBREDDITS.length} subreddits at ${new Date().toLocaleString()}`
        : `No forum data (Reddit blocked or rate limited).`;

      if(!combined){
        fillTable('tbl-stock-forums', []);
        fillTable('tbl-fund-forums',  []);
        dom('forumStockMsg').textContent = 'No forum data. Try reloading in a minute.';
        dom('forumFundMsg').textContent  = '';
        return;
      }

      const stockCounts = countMentionsSmart(combined, TICKERS);
      const fundCounts  = countMentionsSmart(combined, FUNDS);

      fillTable('tbl-stock-forums', topN(stockCounts));
      fillTable('tbl-fund-forums',  topN(fundCounts));

      dom('forumStockMsg').textContent = `Loaded from ${okCount}/${SUBREDDITS.length} subreddits.`;
      dom('forumFundMsg').textContent  = '';
    }

    // ===== Boot =====
    (async function init(){
      try { await runForumsScan(); }
      catch(e){
        dom('stamp').textContent = 'Error: ' + e.message;
        console.error(e);
      }
    })();
  </script>
</body>
</html>
