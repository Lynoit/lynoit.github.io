<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reseräkning – skapa PDF med underlag</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 16px; background:#fafafa; }
    h1 { margin: 0 0 12px; }
    .grid { display: grid; gap: 12px; }
    .card { background:#fff; border:1px solid #ddd; border-radius: 10px; padding: 12px; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; }
    label { display:flex; flex-direction: column; font-size: 12px; gap: 6px; }
    input, textarea, select, button { font: inherit; }
    input, textarea, select { padding: 8px; border:1px solid #ccc; border-radius:8px; min-width: 220px; }
    textarea { min-height: 60px; min-width: 320px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
    th { background:#f3f3f3; }
    .muted { color:#666; font-size: 12px; }
    .right { text-align: right; }
    .actions { display:flex; gap: 10px; flex-wrap: wrap; align-items:center; }
    .btn { padding: 10px 14px; border-radius: 10px; border:1px solid #222; background:#222; color:#fff; cursor:pointer; }
    .btn.secondary { background:#fff; color:#222; }
    .btn.danger { background:#b00020; border-color:#b00020; }
    .totals { display:flex; gap: 20px; flex-wrap: wrap; justify-content: flex-end; }
    .totals .box { min-width: 260px; border:1px solid #ddd; border-radius: 10px; padding: 10px; background:#fff; }
    .totals .box div { display:flex; justify-content: space-between; padding: 4px 0; }
    .small { font-size: 12px; }
    .item-controls { display:flex; gap: 8px; flex-wrap: wrap; }
    .preview { display:flex; gap:10px; flex-wrap:wrap; }
    .pill { display:inline-flex; gap:6px; align-items:center; border:1px solid #ddd; background:#fff; border-radius: 999px; padding: 6px 10px; font-size: 12px; }
    .mini { padding: 6px 10px; border-radius: 10px; border:1px solid #222; background:#fff; cursor:pointer; }
    .divider { height: 1px; background: #eee; margin: 10px 0; width: 100%; }
    .note { background:#fff7d6; border:1px solid #f0d98a; padding:10px; border-radius:10px; font-size:12px; color:#5a4a00; }
    code { background:#f5f5f5; padding: 1px 4px; border-radius: 6px; }

    .company-profile-hidden { display: none; }
    .profile-actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
  </style>

  <!-- jsPDF + autotable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- pdf.js -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.min.js"></script>
</head>

<body>
  <h1>Reseräkning</h1>

  <div class="grid" style="margin-top:12px;">

    <div class="card">
      <h2 style="margin:0 0 10px;">1) Uppgifter</h2>

      <div class="row">
        <label style="flex:1; min-width:320px;">Namn på reseräkningen
          <input id="expenseName" placeholder='t.ex. "Tyskland Tuning event 2025w42"'>
        </label>
        <label style="min-width:260px;">Ditt namn
          <input id="personName" placeholder='t.ex. "Per Persson"'>
        </label>
        <label>Faktura nr
          <input id="fakturaNr" placeholder="t.ex. 0079">
        </label>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px;">Sök traktamente</h3>
      <div class="row">
        <label>Sök land
          <input id="traktSearch" placeholder="Sök land…">
        </label>

        <label>Välj land
          <select id="traktCountry"></select>
        </label>

        <div style="align-self:flex-end;">
          <div class="muted small">Normalbelopp / dag (exkl logi)</div>
          <div style="font-size:18px; font-weight:700;" id="traktAmount">—</div>
        </div>
      </div>

      <div id="traktNote" class="note" style="margin-top:10px; display:none;"></div>

      <div class="profile-actions">
        <button class="btn secondary" id="showProfileBtn" type="button">Visa företags profil</button>
        <button class="btn secondary" id="hideProfileBtn" type="button" style="display:none;">Göm företagsprofil</button>
        <span class="muted small" id="profileStatus"></span>
      </div>

      <div id="companyProfileBlock" class="company-profile-hidden" style="margin-top:10px;">

        <div class="divider"></div>

        <div class="row">
          <label style="min-width:320px;">Company setup
            <select id="companySetupSelect"></select>
          </label>
          <div style="align-self:flex-end;">
            <button class="btn secondary" id="loadCompanySetupBtn" type="button">Ladda setup</button>
          </div>
          <div class="muted small" style="align-self:flex-end;" id="companySetupStatus"></div>
        </div>

        <div id="companySetupNote" class="note" style="margin-top:10px; display:none;"></div>

        <div class="row" style="margin-top:10px;">
          <label>Datum
            <input id="date" type="date">
          </label>
          <label>Kund nr
            <input id="kundNr" placeholder="t.ex. 2">
          </label>
          <label>Betalningsvillkor (dagar)
            <input id="betalningsvillkor" type="number" value="45" min="0">
          </label>
          <label>Moms (%)
            <input id="vatRate" type="number" value="25" min="0" step="0.1">
          </label>
        </div>

        <div class="row" style="margin-top:10px;">
          <label style="flex:1; min-width:320px;">Kund (namn + adress)
            <textarea id="kundAdress"></textarea>
          </label>
          <label style="min-width:260px;">Er referens
            <input id="erRef">
          </label>
          <label style="min-width:260px;">Vår referens
            <input id="varRef">
          </label>
          <label style="min-width:260px;">Personnummer / ID
            <input id="pnr">
          </label>
        </div>

        <div class="row" style="margin-top:10px;">
          <label>Projekt / uppdragsgivare (nr)
            <input id="projektNr">
          </label>
          <label>Projekt / uppdragsgivare (namn)
            <input id="projektNamn">
          </label>
        </div>

        <div class="row" style="margin-top:10px;">
          <label style="flex:1; min-width:320px;">Avsändare (företag + adress)
            <textarea id="avsandareAdress"></textarea>
          </label>
          <label>Org.nr
            <input id="orgNr">
          </label>
          <label>Moms/regnr
            <input id="momsRegnr">
          </label>
          <label>E-post
            <input id="email">
          </label>
          <label>Telefon
            <input id="telefon">
          </label>
          <label>Bankgiro
            <input id="bankgiro">
          </label>
        </div>

        <div class="row" style="margin-top:10px;">
          <label>Logotyp (valfritt, PNG/JPG)
            <input id="logo" type="file" accept="image/*">
          </label>
          <div class="muted small" style="align-self:flex-end;">
            (Om du laddar upp en logga här så ersätter den setup-loggan.)
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;">2) Utgiftsposter</h2>

      <div class="row">
        <label>Produktbeskrivning
          <input id="newDesc" placeholder="t.ex. Hotel Karlatornet">
        </label>
        <label>Antal
          <input id="newQty" type="number" value="1" min="0" step="1">
        </label>
        <label>Pris (kr)
          <input id="newUnit" type="number" value="0" min="0" step="0.01">
        </label>
        <label>Underlag (valfritt)
          <input id="newReceipt" type="file" accept="image/*,application/pdf">
        </label>
        <div style="align-self:flex-end;">
          <button class="btn secondary" id="addItemBtn" type="button">Lägg till post</button>
        </div>
      </div>

      <div class="muted small" style="margin-top:8px;">
        Underlag är valfritt. Om du laddar upp underlag hamnar de som separata sidor efter reseräkningen.
      </div>

      <div style="margin-top:12px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="min-width:260px;">Produktbeskrivning</th>
              <th style="width:90px;">Antal</th>
              <th style="width:120px;">Pris</th>
              <th style="width:120px;">Belopp</th>
              <th style="min-width:260px;">Underlag</th>
              <th style="width:200px;">Åtgärder</th>
            </tr>
          </thead>
          <tbody id="itemsTbody"></tbody>
        </table>
      </div>

      <div class="totals" style="margin-top:12px;">
        <div class="box">
          <div><span>Summa:</span><b id="summaOut">0 kr</b></div>
          <div><span>Moms:</span><b id="momsOut">0 kr</b></div>
          <div style="border-top:1px solid #eee; margin-top:6px; padding-top:6px;">
            <span>Att betala:</span><b id="attBetalaOut">0 kr</b>
          </div>
        </div>
      </div>

      <div class="actions" style="margin-top:12px;">
        <button class="btn" id="createPdfBtn" type="button">Skapa PDF</button>
        <button class="btn secondary" id="clearLocalBtn" type="button">Rensa lokalt sparat</button>
        <span class="muted small" id="status"></span>
      </div>

      <div class="muted small" style="margin-top:8px;">
        Vid PDF-export skapas även en intern version (filnamn + <code>- intern.pdf</code>).
      </div>
    </div>

  </div>

<script>
  // ---- pdf.js worker ----
  if (window.pdfjsLib) {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.worker.min.js";
  }

  const STORAGE = {
    headerCsv: "reserakning_header_csv_v6_setup_logo",
    itemsCsv: "reserakning_items_csv_v1",
    logoDataUrl: "reserakning_logo_dataurl_v1",
    companySetupSelected: "reserakning_company_setup_selected_v1",
    profileVisible: "reserakning_profile_visible_v1",
    logoSource: "reserakning_logo_source_v1" // "setup:<csv>" eller "manual"
  };

  // Viktigt: ange logo per setup (eller låt den auto-deriveras)
  const COMPANY_SETUPS = [
    { label: "Lynoit / Sigma / Zeekr (default)", file: "company_setup_lynoit.csv", logo: "company_setup_lynoit_logo.png" },
    { label: "Example setup", file: "company_setup_example.csv", logo: "company_setup_example_logo.png" }
  ];

  const state = { items: [], logoDataUrl: null };
  const TRAKT = { data: [] };
  const TRAKT_FALLBACK = [{ country: "Tyskland", amount: 760, year: "2026" }];

  const $ = (id) => document.getElementById(id);
  function setStatus(msg) { $("status").textContent = msg || ""; }

  function formatKr(n) {
    const v = Number(n || 0);
    const rounded = Math.round(v * 100) / 100;
    return rounded.toLocaleString("sv-SE", { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + " kr";
  }

  function sanitizeFilenamePart(s) {
    return String(s || "")
      .trim()
      .replace(/\s+/g, " ")
      .replace(/[\/\\:*?"<>|]/g, "_");
  }

  function csvEscape(v) {
    const s = String(v ?? "");
    if (/[;"\n\r]/.test(s)) return `"${s.replaceAll('"', '""')}"`;
    return s;
  }
  function csvJoinRow(arr) { return arr.map(csvEscape).join(";") + "\n"; }

  function parseCsvSemicolon(csv) {
    const rows = [];
    let row = [];
    let cur = "";
    let inQ = false;

    for (let i = 0; i < csv.length; i++) {
      const ch = csv[i];
      const next = csv[i + 1];

      if (inQ) {
        if (ch === '"' && next === '"') { cur += '"'; i++; }
        else if (ch === '"') inQ = false;
        else cur += ch;
      } else {
        if (ch === '"') inQ = true;
        else if (ch === ";") { row.push(cur); cur = ""; }
        else if (ch === "\n") { row.push(cur); rows.push(row); row = []; cur = ""; }
        else if (ch === "\r") { /* ignore */ }
        else cur += ch;
      }
    }
    if (cur.length || row.length) { row.push(cur); rows.push(row); }
    return rows.filter(r => r.some(c => String(c).length));
  }

  function headerToCsv(headerObj) {
    const keys = Object.keys(headerObj);
    return csvJoinRow(keys) + csvJoinRow(keys.map(k => headerObj[k]));
  }

  function headerFromCsv(csv) {
    const rows = parseCsvSemicolon(csv);
    if (rows.length < 2) return null;
    const keys = rows[0];
    const vals = rows[1];
    const obj = {};
    keys.forEach((k, i) => obj[k] = vals[i] ?? "");
    return obj;
  }

  function itemsToCsv(items) {
    let csv = "";
    csv += csvJoinRow(["desc","qty","unit","receiptName","receiptType"]);
    for (const it of items) {
      csv += csvJoinRow([
        it.desc ?? "",
        it.qty ?? "",
        it.unit ?? "",
        it.receiptFile?.name ?? "",
        it.receiptFile?.type ?? ""
      ]);
    }
    return csv;
  }

  function itemsFromCsv(csv) {
    const rows = parseCsvSemicolon(csv);
    if (!rows.length) return [];
    const header = rows[0].map(x => x.trim());
    const idx = (name) => header.indexOf(name);
    const out = [];
    for (let r = 1; r < rows.length; r++) {
      const cols = rows[r];
      out.push({
        desc: cols[idx("desc")] ?? "",
        qty: Number(cols[idx("qty")] ?? 0),
        unit: Number(cols[idx("unit")] ?? 0),
        receiptFile: null
      });
    }
    return out;
  }

  function debounce(fn, ms=400) {
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
  }

  function readHeader() {
    return {
      expenseName: $("expenseName").value.trim(),
      personName: $("personName").value.trim(),
      fakturaNr: $("fakturaNr").value.trim(),

      date: $("date")?.value || "",
      kundNr: $("kundNr")?.value.trim() || "",
      betalningsvillkor: $("betalningsvillkor")?.value.trim() || "",
      vatRate: $("vatRate")?.value.trim() || "25",
      kundAdress: $("kundAdress")?.value || "",
      erRef: $("erRef")?.value.trim() || "",
      varRef: $("varRef")?.value.trim() || "",
      pnr: $("pnr")?.value.trim() || "",
      projektNr: $("projektNr")?.value.trim() || "",
      projektNamn: $("projektNamn")?.value.trim() || "",
      avsandareAdress: $("avsandareAdress")?.value || "",
      orgNr: $("orgNr")?.value.trim() || "",
      momsRegnr: $("momsRegnr")?.value.trim() || "",
      email: $("email")?.value.trim() || "",
      telefon: $("telefon")?.value.trim() || "",
      bankgiro: $("bankgiro")?.value.trim() || "",
    };
  }

  function writeHeader(h) {
    $("expenseName").value = h.expenseName || "";
    $("personName").value = h.personName || "";
    $("fakturaNr").value = h.fakturaNr || "";

    if ($("date")) $("date").value = h.date || $("date").value || "";
    if ($("kundNr")) $("kundNr").value = h.kundNr || "";
    if ($("betalningsvillkor")) $("betalningsvillkor").value = h.betalningsvillkor || "45";
    if ($("vatRate")) $("vatRate").value = h.vatRate || "25";
    if ($("kundAdress")) $("kundAdress").value = h.kundAdress || "";
    if ($("erRef")) $("erRef").value = h.erRef || "";
    if ($("varRef")) $("varRef").value = h.varRef || "";
    if ($("pnr")) $("pnr").value = h.pnr || "";
    if ($("projektNr")) $("projektNr").value = h.projektNr || "";
    if ($("projektNamn")) $("projektNamn").value = h.projektNamn || "";
    if ($("avsandareAdress")) $("avsandareAdress").value = h.avsandareAdress || "";
    if ($("orgNr")) $("orgNr").value = h.orgNr || "";
    if ($("momsRegnr")) $("momsRegnr").value = h.momsRegnr || "";
    if ($("email")) $("email").value = h.email || "";
    if ($("telefon")) $("telefon").value = h.telefon || "";
    if ($("bankgiro")) $("bankgiro").value = h.bankgiro || "";
  }

  function saveAllToStorage() {
    const header = readHeader();
    localStorage.setItem(STORAGE.headerCsv, headerToCsv(header));
    localStorage.setItem(STORAGE.itemsCsv, itemsToCsv(state.items));
    setStatus("Autosparat.");
  }

  function loadAllFromStorage() {
    const hCsv = localStorage.getItem(STORAGE.headerCsv);
    const iCsv = localStorage.getItem(STORAGE.itemsCsv);
    const logo = localStorage.getItem(STORAGE.logoDataUrl);

    if (hCsv) {
      const h = headerFromCsv(hCsv);
      if (h) writeHeader(h);
    }
    if (iCsv) state.items = itemsFromCsv(iCsv);
    if (logo) state.logoDataUrl = logo;
  }

  function recalcTotals() {
    const vatPct = Number($("vatRate")?.value || 25);
    const sum = state.items.reduce((acc, it) => acc + (Number(it.qty)||0) * (Number(it.unit)||0), 0);
    const moms = sum * (vatPct / 100);
    const total = sum + moms;
    $("summaOut").textContent = formatKr(sum);
    $("momsOut").textContent = formatKr(moms);
    $("attBetalaOut").textContent = formatKr(total);
    return { sum, moms, total, vatPct };
  }
  function recalcTotalsNoVat() {
    const sum = state.items.reduce((acc, it) => acc + (Number(it.qty)||0) * (Number(it.unit)||0), 0);
    return { sum, moms: 0, total: sum, vatPct: 0 };
  }

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function renderItemsTable() {
    const tbody = $("itemsTbody");
    tbody.innerHTML = "";

    state.items.forEach((it, idx) => {
      const amount = (Number(it.qty)||0) * (Number(it.unit)||0);
      const receiptName = it.receiptFile?.name || "—";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(it.desc)}</td>
        <td class="right">${escapeHtml(String(it.qty))}</td>
        <td class="right">${escapeHtml(formatKr(it.unit))}</td>
        <td class="right"><b>${escapeHtml(formatKr(amount))}</b></td>
        <td>
          <div class="preview">
            <span class="pill">${escapeHtml(receiptName)}</span>
            ${it.receiptFile ? `<span class="pill">${escapeHtml(it.receiptFile.type || "")}</span>` : ""}
          </div>
          <div style="margin-top:8px;">
            <label class="small">Byt/lägg till underlag (valfritt)
              <input type="file" class="receiptInline" data-idx="${idx}" accept="image/*,application/pdf">
            </label>
          </div>
        </td>
        <td>
          <div class="item-controls">
            <button class="mini" data-action="up" data-idx="${idx}" type="button">↑</button>
            <button class="mini" data-action="down" data-idx="${idx}" type="button">↓</button>
            <button class="mini" data-action="clearReceipt" data-idx="${idx}" type="button">Ta bort underlag</button>
            <button class="btn danger" data-action="del" data-idx="${idx}" type="button">Ta bort post</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });

    recalcTotals();
  }

  // ---- Företagsprofil show/hide ----
  function setProfileVisible(visible) {
    const block = $("companyProfileBlock");
    const showBtn = $("showProfileBtn");
    const hideBtn = $("hideProfileBtn");
    const status = $("profileStatus");

    if (visible) {
      block.classList.remove("company-profile-hidden");
      showBtn.style.display = "none";
      hideBtn.style.display = "inline-block";
      status.textContent = "Företagsprofil visas.";
    } else {
      block.classList.add("company-profile-hidden");
      showBtn.style.display = "inline-block";
      hideBtn.style.display = "none";
      status.textContent = "Företagsprofil dold.";
    }
    localStorage.setItem(STORAGE.profileVisible, visible ? "1" : "0");
  }

  // -------------------------
  // Company setup
  // -------------------------
  function showCompanySetupNote(msg) {
    const el = $("companySetupNote");
    if (!msg) { el.style.display = "none"; el.textContent = ""; return; }
    el.style.display = "block";
    el.textContent = msg;
  }
  function setCompanySetupStatus(msg) { $("companySetupStatus").textContent = msg || ""; }

  function parseSingleRowCsvObject(csvText) {
    const rows = parseCsvSemicolon(csvText);
    if (rows.length < 2) return null;
    const keys = rows[0].map(s => (s || "").trim());
    const vals = rows[1];
    const obj = {};
    keys.forEach((k, i) => obj[k] = vals[i] ?? "");
    return obj;
  }

  function applyCompanySetup(setupObj) {
    if (!setupObj) return;
    const get = (...keys) => {
      for (const k of keys) if (setupObj[k] !== undefined && setupObj[k] !== null) return String(setupObj[k]);
      return "";
    };

    if ($("kundNr")) $("kundNr").value = get("kundNr","Kund nr");
    if ($("kundAdress")) $("kundAdress").value = get("kundAdress","Kund (namn + adress)");
    if ($("erRef")) $("erRef").value = get("erRef","Er referens");
    if ($("varRef")) $("varRef").value = get("varRef","Vår referens");
    if ($("projektNr")) $("projektNr").value = get("projektNr","Projekt / uppdragsgivare (nr)");
    if ($("projektNamn")) $("projektNamn").value = get("projektNamn","Projekt / uppdragsgivare (namn)");
    if ($("avsandareAdress")) $("avsandareAdress").value = get("avsandareAdress","Avsändare (företag + adress)");
    if ($("orgNr")) $("orgNr").value = get("orgNr","Org.nr");
    if ($("momsRegnr")) $("momsRegnr").value = get("momsRegnr","Moms/regnr");
    if ($("email")) $("email").value = get("email","E-post");
    if ($("telefon")) $("telefon").value = get("telefon","Telefon");
    if ($("bankgiro")) $("bankgiro").value = get("bankgiro","Bankgiro");
  }

  function inferLogoFromSetupCsv(fileName) {
    const base = String(fileName || "").replace(/\.csv$/i, "");
    return `${base}_logo.png`;
  }

  async function fetchImageAsDataUrl(path) {
    const res = await fetch("./" + path, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const blob = await res.blob();
    if (!blob.type.startsWith("image/")) throw new Error("Inte en bild.");
    return await new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(blob);
    });
  }

  async function applySetupLogo(setupFileName) {
    const setup = COMPANY_SETUPS.find(s => s.file === setupFileName);
    const logoFile = setup?.logo || inferLogoFromSetupCsv(setupFileName);

    try {
      const dataUrl = await fetchImageAsDataUrl(logoFile);
      state.logoDataUrl = dataUrl;
      localStorage.setItem(STORAGE.logoDataUrl, dataUrl);
      localStorage.setItem(STORAGE.logoSource, `setup:${setupFileName}`);
      setCompanySetupStatus(`Laddad: ${setupFileName} (+ logga)`);
    } catch (e) {
      showCompanySetupNote(`Setup laddades, men loggan kunde inte hittas: "${logoFile}".`);
    }
  }

  async function loadAndApplyCompanySetupCsv(fileName) {
    try {
      setCompanySetupStatus("Läser setup…");
      const res = await fetch("./" + fileName, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const txt = await res.text();
      const obj = parseSingleRowCsvObject(txt);
      if (!obj) throw new Error("CSV kunde inte tolkas (behöver headerrad + en datarad).");

      applyCompanySetup(obj);
      await applySetupLogo(fileName);

      saveAllToStorage();
      showCompanySetupNote("");
      if (!state.logoDataUrl) setCompanySetupStatus(`Laddad: ${fileName}`);
    } catch (e) {
      showCompanySetupNote(`Kunde inte läsa "${fileName}". (${e.message})`);
      setCompanySetupStatus("Misslyckades.");
    }
  }

  function initCompanySetupDropdown() {
    const sel = $("companySetupSelect");
    if (!sel) return;
    sel.innerHTML = "";
    for (const s of COMPANY_SETUPS) {
      const opt = document.createElement("option");
      opt.value = s.file;
      opt.textContent = s.label;
      sel.appendChild(opt);
    }
    const saved = localStorage.getItem(STORAGE.companySetupSelected);
    if (saved && COMPANY_SETUPS.some(x => x.file === saved)) sel.value = saved;
    else sel.value = COMPANY_SETUPS[0]?.file || "";
  }

  // ---- Traktamente ----
  function parseTraktCsv(csvText) {
    const rows = parseCsvSemicolon(csvText);
    if (rows.length < 2) return [];

    const head = rows[0].map(h => h.trim().toLowerCase());
    const findCol = (...alts) => head.findIndex(h => alts.includes(h));

    const cLand = findCol("land", "land eller område", "country", "destination");
    const cBelopp = findCol("normalbelopp", "belopp", "amount", "normalbelopp (exklusive logi per dag)");
    const cYear = findCol("år", "year", "inkomstår");

    if (cLand < 0 || cBelopp < 0) return [];

    const out = [];
    for (let i = 1; i < rows.length; i++) {
      const r = rows[i];
      const country = (r[cLand] || "").trim();
      if (!country) continue;

      const rawAmt = String(r[cBelopp] ?? "").replace(/\s/g,"").replace(",", ".");
      const amount = Number(rawAmt);
      if (!Number.isFinite(amount)) continue;

      out.push({ country, amount, year: cYear >= 0 ? (r[cYear] || "").trim() : "" });
    }
    return out;
  }

  function setTraktData(list) {
    TRAKT.data = list.slice().sort((a,b) => a.country.localeCompare(b.country, "sv"));
    renderTraktDropdown($("traktSearch").value || "");
  }

  function renderTraktDropdown(filter="") {
    const sel = $("traktCountry");
    const q = (filter || "").trim().toLowerCase();

    const rows = (TRAKT.data.length ? TRAKT.data : TRAKT_FALLBACK)
      .filter(r => !q || r.country.toLowerCase().includes(q));

    sel.innerHTML = "";
    for (const r of rows) {
      const opt = document.createElement("option");
      opt.value = r.country;
      opt.textContent = r.year ? `${r.country} (${r.year})` : r.country;
      opt.dataset.amount = String(r.amount);
      sel.appendChild(opt);
    }
    if (!sel.options.length) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Inga träffar";
      sel.appendChild(opt);
    }
    updateTraktAmount();
  }

  function updateTraktAmount() {
    const sel = $("traktCountry");
    const opt = sel.selectedOptions?.[0];
    const amt = opt?.dataset?.amount;
    $("traktAmount").textContent = amt ? `${amt} kr` : "—";
  }

  function showTraktNote(msg) {
    const el = $("traktNote");
    if (!msg) { el.style.display = "none"; el.textContent = ""; return; }
    el.style.display = "block";
    el.textContent = msg;
  }

  async function loadTraktamenteFromSidecarCsv() {
    try {
      const res = await fetch("./traktamente.csv", { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const txt = await res.text();
      const parsed = parseTraktCsv(txt);
      if (!parsed.length) throw new Error("CSV tolkades men gav 0 rader.");
      setTraktData(parsed);
      showTraktNote("");
    } catch (e) {
      setTraktData(TRAKT_FALLBACK);
      showTraktNote("Kunde inte läsa traktamente.csv.");
    }
  }

  // ---- PDF helpers ----
  async function fileToDataUrl(file) {
    const buf = await file.arrayBuffer();
    const blob = new Blob([buf], { type: file.type });
    return await new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(blob);
    });
  }

  function splitLines(text) {
    const t = String(text || "").trim();
    return t ? t.split(/\r?\n/).map(s => s.trim()).filter(Boolean) : [];
  }

  function guessImageFormat(mime) {
    if ((mime || "").includes("png")) return "PNG";
    if ((mime || "").includes("webp")) return "WEBP";
    return "JPEG";
  }

  function isPdfFile(file) {
    const t = (file?.type || "").toLowerCase();
    const n = (file?.name || "").toLowerCase();
    return t.includes("pdf") || n.endsWith(".pdf");
  }

  function isImageFile(file) {
    const t = (file?.type || "").toLowerCase();
    return t.startsWith("image/");
  }

  async function appendImageUnderlag(doc, file, margin, pageW, pageH, title) {
    const dataUrl = await fileToDataUrl(file);
    doc.addPage();
    doc.setFontSize(12);
    doc.text(title, margin, margin);

    const imgProps = doc.getImageProperties(dataUrl);
    const maxW = pageW - 2 * margin;
    const maxH = pageH - 2 * margin - 8;
    const ratio = Math.min(maxW / imgProps.width, maxH / imgProps.height);

    const w = imgProps.width * ratio;
    const h = imgProps.height * ratio;

    const x = (pageW - w) / 2;
    const y = margin + 6 + (maxH - h) / 2;

    doc.addImage(dataUrl, guessImageFormat(file.type), x, y, w, h, undefined, "FAST");
  }

  async function appendPdfUnderlag(doc, file, margin, pageW, pageH, title) {
    if (!window.pdfjsLib) {
      doc.addPage();
      doc.setFontSize(12);
      doc.text("pdf.js saknas – kan inte rendera PDF-underlag.", margin, margin + 10);
      return;
    }

    const data = new Uint8Array(await file.arrayBuffer());
    const pdf = await pdfjsLib.getDocument({ data }).promise;

    for (let p = 1; p <= pdf.numPages; p++) {
      const page = await pdf.getPage(p);

      const viewport = page.getViewport({ scale: 2.0 });
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = viewport.width;
      canvas.height = viewport.height;

      await page.render({ canvasContext: ctx, viewport }).promise;
      const dataUrl = canvas.toDataURL("image/jpeg", 0.92);

      doc.addPage();
      doc.setFontSize(12);
      doc.text(`${title} (PDF sida ${p}/${pdf.numPages})`, margin, margin);

      const maxW = pageW - 2 * margin;
      const maxH = pageH - 2 * margin - 8;

      const imgW = canvas.width;
      const imgH = canvas.height;

      const ratio = Math.min(maxW / imgW, maxH / imgH);
      const w = imgW * ratio;
      const h = imgH * ratio;

      const x = (pageW - w) / 2;
      const y = margin + 6 + (maxH - h) / 2;

      doc.addImage(dataUrl, "JPEG", x, y, w, h, undefined, "FAST");
    }
  }

  async function drawFirstPage(doc, h, margin, pageW, pageH, options = { internal:false }) {
    const internal = !!options.internal;
    const totals = internal ? recalcTotalsNoVat() : recalcTotals();
    const vatPct = internal ? 0 : Number(h.vatRate || 25);

    if (state.logoDataUrl) {
      doc.addImage(state.logoDataUrl, "PNG", margin, margin, 55, 22, undefined, "FAST");
    }

    doc.setFontSize(18);
    const titleName = h.expenseName ? `Reseräkning - ${h.expenseName}` : "Reseräkning";
    doc.text(titleName, pageW - margin, margin + 6, { align: "right" });

    doc.setFontSize(11);
    if (h.personName) doc.text(`Namn: ${h.personName}`, pageW - margin, margin + 13, { align: "right" });

    doc.setFontSize(10);
    const rightX = pageW - margin;
    const topY = margin + 18;
    doc.text(`Datum: ${h.date}`, rightX, topY, { align: "right" });
    doc.text(`Kund nr: ${h.kundNr || ""}`, rightX, topY + 5, { align: "right" });
    doc.text(`Faktura nr: ${h.fakturaNr || ""}`, rightX, topY + 10, { align: "right" });

    if (!internal) {
      doc.setFontSize(11);
      doc.text(splitLines(h.kundAdress || ""), margin, margin + 34);

      doc.setFontSize(10);
      const refY = margin + 58;

      doc.text("Er referens", margin, refY);
      doc.text(h.erRef || "", margin, refY + 5);

      doc.text("Vår referens", margin + 55, refY);
      doc.text(h.varRef || "", margin + 55, refY + 5);
      doc.text(h.pnr || "", margin + 55, refY + 10);

      doc.text("Projekt / uppdragsgivare", margin + 110, refY);
      doc.text(h.projektNr || "", margin + 110, refY + 5);
      doc.text(h.projektNamn || "", margin + 110, refY + 10);

      doc.text("Betalningsvillkor", pageW - margin, refY, { align: "right" });
      doc.text(`${h.betalningsvillkor || ""} dagar`, pageW - margin, refY + 5, { align: "right" });
    }

    const tableStartY = internal ? (margin + 45) : (margin + 78);

    const bodyRows = state.items.map(it => {
      const qty = Number(it.qty||0);
      const unit = Number(it.unit||0);
      const amount = qty * unit;
      return [ it.desc, String(qty), formatKr(unit), formatKr(amount) ];
    });

    doc.autoTable({
      startY: tableStartY,
      head: [["Produktbeskrivning", "Antal", "Pris", "Belopp"]],
      body: bodyRows,
      styles: { fontSize: 10, cellPadding: 2.2 },
      headStyles: { fillColor: [240, 240, 240], textColor: 20 },
      columnStyles: {
        0: { cellWidth: 100 }, // <-- FIX: lite smalare för att undvika "could not fit page"
        1: { halign: "right", cellWidth: 18 },
        2: { halign: "right", cellWidth: 28 },
        3: { halign: "right", cellWidth: 28 }
      },
      margin: { left: margin, right: margin }
    });

    const tableEndY = doc.lastAutoTable.finalY || (tableStartY + 40);

    const boxW = 70;
    const boxH = internal ? 18 : 28;
    const boxX = pageW - margin - boxW;
    const boxY = Math.min(pageH - margin - boxH - 10, tableEndY + 10);

    doc.setDrawColor(60);
    doc.rect(boxX, boxY, boxW, boxH);

    doc.setFontSize(10);
    doc.text("Summa:", boxX + 4, boxY + 8);
    doc.text(formatKr(totals.sum), boxX + boxW - 4, boxY + 8, { align: "right" });

    if (!internal) {
      doc.text(`Moms ${vatPct}%:`, boxX + 4, boxY + 16);
      doc.text(formatKr(totals.moms), boxX + boxW - 4, boxY + 16, { align: "right" });

      doc.setFontSize(11);
      doc.text("Att betala:", boxX + 4, boxY + 25);
      doc.text(formatKr(totals.total), boxX + boxW - 4, boxY + 25, { align: "right" });
    } else {
      doc.setFontSize(11);
      doc.text("Att betala:", boxX + 4, boxY + 16);
      doc.text(formatKr(totals.total), boxX + boxW - 4, boxY + 16, { align: "right" });
    }

    if (!internal) {
      doc.setFontSize(9);

      const leftFooterLines = splitLines(h.avsandareAdress || "");
      const rightFooterLines = [
        `Org: ${h.orgNr || ""}`,
        `Moms/regnr: ${h.momsRegnr || ""}`,
        `E-post: ${h.email || ""}`,
        `Telefon: ${h.telefon || ""}`,
        `Bankgiro: ${h.bankgiro || ""}`,
        "Innehar F-skatt"
      ].filter(s => String(s).trim().length);

      const lineH = 4.2;
      const maxLines = Math.max(leftFooterLines.length || 1, rightFooterLines.length || 1);
      const footerStartY = pageH - margin - (maxLines - 1) * lineH;

      doc.text(leftFooterLines.length ? leftFooterLines : [""], margin, footerStartY);
      doc.text(rightFooterLines, pageW - margin, footerStartY, { align: "right" });
    }
  }

  // ---- Autosave ----
  const autosave = debounce(saveAllToStorage, 500);

  [
    "expenseName","personName","fakturaNr",
    "date","kundNr","betalningsvillkor","vatRate",
    "kundAdress","erRef","varRef","pnr","projektNr","projektNamn",
    "avsandareAdress","orgNr","momsRegnr","email","telefon","bankgiro"
  ].forEach(id => {
    const el = $(id);
    if (!el) return;
    el.addEventListener("input", autosave);
    el.addEventListener("change", autosave);
  });

  // ---- Items events ----
  $("addItemBtn").addEventListener("click", () => {
    const desc = $("newDesc").value.trim();
    const qty = Number($("newQty").value || 0);
    const unit = Number($("newUnit").value || 0);
    const receipt = $("newReceipt").files?.[0] || null;

    if (!desc) return alert("Skriv en produktbeskrivning.");

    state.items.push({ desc, qty, unit, receiptFile: receipt });

    $("newDesc").value = "";
    $("newQty").value = 1;
    $("newUnit").value = 0;
    $("newReceipt").value = "";

    renderItemsTable();
    autosave();
  });

  $("itemsTbody").addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const idx = Number(btn.dataset.idx);
    const action = btn.dataset.action;
    if (!Number.isFinite(idx)) return;

    if (action === "del") state.items.splice(idx, 1);
    else if (action === "up" && idx > 0) [state.items[idx-1], state.items[idx]] = [state.items[idx], state.items[idx-1]];
    else if (action === "down" && idx < state.items.length - 1) [state.items[idx+1], state.items[idx]] = [state.items[idx], state.items[idx+1]];
    else if (action === "clearReceipt") state.items[idx].receiptFile = null;

    renderItemsTable();
    autosave();
  });

  $("itemsTbody").addEventListener("change", (e) => {
    const inp = e.target.closest("input.receiptInline");
    if (!inp) return;
    const idx = Number(inp.dataset.idx);
    const f = inp.files?.[0] || null;
    if (!Number.isFinite(idx)) return;
    state.items[idx].receiptFile = f;
    renderItemsTable();
    autosave();
  });

  // ---- Logo (manual override) ----
  $("logo")?.addEventListener("change", async () => {
    const f = $("logo").files?.[0] || null;
    if (!f) return;
    if (f.type.startsWith("image/")) {
      const dataUrl = await fileToDataUrl(f);
      state.logoDataUrl = dataUrl;
      localStorage.setItem(STORAGE.logoDataUrl, dataUrl);
      localStorage.setItem(STORAGE.logoSource, "manual");
      autosave();
    }
  });

  // ---- Clear ----
  $("clearLocalBtn").addEventListener("click", () => {
    if (!confirm("Rensa lokalt sparade värden?")) return;
    localStorage.removeItem(STORAGE.headerCsv);
    localStorage.removeItem(STORAGE.itemsCsv);
    localStorage.removeItem(STORAGE.logoDataUrl);
    localStorage.removeItem(STORAGE.companySetupSelected);
    localStorage.removeItem(STORAGE.profileVisible);
    localStorage.removeItem(STORAGE.logoSource);
    setStatus("Rensat. Ladda om sidan för att börja om.");
  });

  // ---- Företagsprofil show/hide ----
  $("showProfileBtn").addEventListener("click", () => setProfileVisible(true));
  $("hideProfileBtn").addEventListener("click", () => setProfileVisible(false));

  // ---- Company setup events ----
  $("loadCompanySetupBtn")?.addEventListener("click", async () => {
    const file = $("companySetupSelect").value;
    if (!file) return;
    localStorage.setItem(STORAGE.companySetupSelected, file);
    await loadAndApplyCompanySetupCsv(file);
  });

  $("companySetupSelect")?.addEventListener("change", async () => {
    const file = $("companySetupSelect").value;
    localStorage.setItem(STORAGE.companySetupSelected, file || "");
    setCompanySetupStatus(file ? `Vald: ${file}` : "");

    const src = localStorage.getItem(STORAGE.logoSource) || "";
    if (!src.startsWith("manual") && file) {
      await applySetupLogo(file);
    }
  });

  // ---- Trakt events ----
  $("traktSearch").addEventListener("input", (e) => renderTraktDropdown(e.target.value));
  $("traktCountry").addEventListener("change", updateTraktAmount);

  // ---- PDF export ----
  $("createPdfBtn").addEventListener("click", async () => {
    setStatus("");
    const header = readHeader();

    if (!header.expenseName) return alert("Fyll i 'Namn på reseräkningen'.");
    if (!header.personName) return alert('Fyll i ditt namn (t.ex. "Per Persson").');
    if (!header.date) return alert("Fyll i datum (under företagsprofil).");
    if (state.items.length === 0) return alert("Lägg till minst en post.");

    const safeDate = (header.date || "datum").replaceAll(":", "-");
    const safeName = sanitizeFilenamePart(header.expenseName);

    const baseFileName = `Reseräkning_${safeName}_${safeDate}.pdf`;
    const internalFileName = `Reseräkning_${safeName}_${safeDate} - intern.pdf`;

    const { jsPDF } = window.jspdf;
    setStatus("Skapar PDF…");
    const margin = 12;

    // extern
    const doc = new jsPDF({ unit: "mm", format: "a4" });
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    await drawFirstPage(doc, header, margin, pageW, pageH, { internal:false });

    for (const it of state.items) {
      const file = it.receiptFile;
      if (!file) continue;

      if (isPdfFile(file)) {
        await appendPdfUnderlag(doc, file, margin, pageW, pageH, `Underlag: ${it.desc}`);
      } else if (isImageFile(file)) {
        await appendImageUnderlag(doc, file, margin, pageW, pageH, `Underlag: ${it.desc}`);
      } else {
        doc.addPage();
        doc.setFontSize(12);
        doc.text(`Underlag kunde inte tolkas: ${file.name}`, margin, margin + 10);
      }
    }

    // intern
    const docInternal = new jsPDF({ unit: "mm", format: "a4" });
    const pageW2 = docInternal.internal.pageSize.getWidth();
    const pageH2 = docInternal.internal.pageSize.getHeight();
    await drawFirstPage(docInternal, header, margin, pageW2, pageH2, { internal:true });

    for (const it of state.items) {
      const file = it.receiptFile;
      if (!file) continue;

      if (isPdfFile(file)) {
        await appendPdfUnderlag(docInternal, file, margin, pageW2, pageH2, `Underlag: ${it.desc}`);
      } else if (isImageFile(file)) {
        await appendImageUnderlag(docInternal, file, margin, pageW2, pageH2, `Underlag: ${it.desc}`);
      } else {
        docInternal.addPage();
        docInternal.setFontSize(12);
        docInternal.text(`Underlag kunde inte tolkas: ${file.name}`, margin, margin + 10);
      }
    }

    // ✅ Spara båda
    doc.save(baseFileName);
    docInternal.save(internalFileName);

    setStatus(`Klart! Skapade: ${baseFileName} + ${internalFileName}`);
  });

  // ---- Init ----
  (function init() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,"0");
    const dd = String(today.getDate()).padStart(2,"0");
    if ($("date")) $("date").value = `${yyyy}-${mm}-${dd}`;

    initCompanySetupDropdown();
    loadAllFromStorage();
    renderItemsTable();
    recalcTotals();
    loadTraktamenteFromSidecarCsv();

    const vis = localStorage.getItem(STORAGE.profileVisible);
    setProfileVisible(vis === "1");

    const selected = localStorage.getItem(STORAGE.companySetupSelected) || $("companySetupSelect")?.value || "";
    const src = localStorage.getItem(STORAGE.logoSource) || "";
    if (selected && !src.startsWith("manual")) {
      applySetupLogo(selected);
    }

    const hasHeader = !!localStorage.getItem(STORAGE.headerCsv);
    if (!hasHeader) {
      const file = $("companySetupSelect")?.value;
      if (file) loadAndApplyCompanySetupCsv(file);
    }

    setStatus("Redo.");
  })();
</script>
</body>
</html>
