<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Faktura – skapa PDF</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 16px; background:#fafafa; }
    h1 { margin: 0 0 12px; }
    .grid { display: grid; gap: 12px; }
    .card { background:#fff; border:1px solid #ddd; border-radius: 10px; padding: 12px; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; }
    label { display:flex; flex-direction: column; font-size: 12px; gap: 6px; }
    input, textarea, select, button { font: inherit; }
    input, textarea, select { padding: 8px; border:1px solid #ccc; border-radius:8px; min-width: 220px; }
    textarea { min-height: 60px; min-width: 320px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
    th { background:#f3f3f3; }
    .muted { color:#666; font-size: 12px; }
    .right { text-align: right; }
    .actions { display:flex; gap: 10px; flex-wrap: wrap; align-items:center; }
    .btn { padding: 10px 14px; border-radius: 10px; border:1px solid #222; background:#222; color:#fff; cursor:pointer; }
    .btn.secondary { background:#fff; color:#222; }
    .btn.danger { background:#b00020; border-color:#b00020; }
    .totals { display:flex; gap: 20px; flex-wrap: wrap; justify-content: flex-end; }
    .totals .box { min-width: 260px; border:1px solid #ddd; border-radius: 10px; padding: 10px; background:#fff; }
    .totals .box div { display:flex; justify-content: space-between; padding: 4px 0; }
    .item-controls { display:flex; gap: 8px; flex-wrap: wrap; }
    .divider { height: 1px; background: #eee; margin: 10px 0; width: 100%; }
    .note { background:#fff7d6; border:1px solid #f0d98a; padding:10px; border-radius:10px; font-size:12px; color:#5a4a00; white-space: pre-wrap; }

    .company-profile-hidden { display: none; }
    .profile-actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }

    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom: 12px; }
    .lang-switch { display:flex; gap:8px; }
    .flag-btn{
      border:1px solid #ddd; background:#fff; border-radius:10px;
      padding:6px 10px; cursor:pointer; font-size:18px; line-height:1;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    .flag-btn.active { border-color:#222; box-shadow: 0 0 0 2px rgba(0,0,0,.06); }
    .flag { width: 26px; height: 18px; display:block; border-radius: 3px; }
    .sr-only{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    .invoice-label-row{ display:flex; align-items: baseline; gap:8px; line-height: 1; }
    label > span, .invoice-label-row{
      display:flex; align-items:center; min-height: 18px; line-height: 18px;
    }
    .invoice-link{
      display:inline-flex; align-items:center; height: 18px;
      padding: 0 10px; font-size: 12px; line-height: 18px;
      text-decoration: none; border: 1px solid #ddd; background: #fff;
      border-radius: 999px; color: #222; white-space: nowrap; box-sizing: border-box;
    }
    .invoice-link:hover { border-color:#222; }

    /* Optional: hide date input in UI (date is automatic and used in PDF) */
    .date-hidden { display:none; }
.mini{
  padding: 6px 10px;
  border-radius: 10px;
  border:1px solid #222;
  background:#fff;
  cursor:pointer;
}    
  </style>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
  <div class="topbar">
    <h1 id="pageTitle" style="margin:0;">Faktura</h1>

    <div class="lang-switch" role="group" aria-label="Language">
      <button id="langSv" class="flag-btn" type="button" title="Svenska" aria-label="Svenska">
        <svg class="flag" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 12" aria-hidden="true">
          <rect width="16" height="12" fill="#006AA7"/>
          <rect x="5" width="2" height="12" fill="#FECC00"/>
          <rect y="5" width="16" height="2" fill="#FECC00"/>
        </svg>
        <span class="sr-only">Svenska</span>
      </button>

      <button id="langEn" class="flag-btn" type="button" title="English" aria-label="English">
        <svg class="flag" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" aria-hidden="true">
          <clipPath id="uk-clip"><path d="M0,0 v30 h60 v-30 z"/></clipPath>
          <g clip-path="url(#uk-clip)">
            <path d="M0,0 v30 h60 v-30 z" fill="#012169"/>
            <path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/>
            <path d="M0,0 L60,30 M60,0 L0,30" stroke="#C8102E" stroke-width="4"/>
            <path d="M30,0 v30 M0,15 h60" stroke="#fff" stroke-width="10"/>
            <path d="M30,0 v30 M0,15 h60" stroke="#C8102E" stroke-width="6"/>
          </g>
        </svg>
        <span class="sr-only">English</span>
      </button>
    </div>
  </div>

  <div class="grid" style="margin-top:12px;">

    <div class="card">
      <h2 style="margin:0 0 10px;" data-i18n="sec1_title">1) Uppgifter</h2>

      <div class="row">
        <label>
          <span class="invoice-label-row">
            <span data-i18n="lbl_invoiceNo">Faktura nr</span>
            <a class="invoice-link"
               href="https://lynoit.github.io/Lynoit_invoice_number.html"
               target="_blank" rel="noopener noreferrer"
               data-i18n="lnk_createInvoiceNo">Skapa faktura nr</a>
          </span>
          <input id="fakturaNr" data-i18n-ph="ph_invoiceNo" placeholder="t.ex. 0079">
        </label>
      </div>

      <div class="divider"></div>

      <div class="profile-actions">
        <button class="btn secondary" id="showProfileBtn" type="button" data-i18n="btn_showProfile">Visa företags profil</button>
        <button class="btn secondary" id="hideProfileBtn" type="button" style="display:none;" data-i18n="btn_hideProfile">Göm företagsprofil</button>
        <span class="muted small" id="profileStatus"></span>
      </div>

      <div class="divider"></div>

      <div id="companyProfileBlock" class="company-profile-hidden" style="margin-top:10px;">
        <div class="row">
          <label style="min-width:320px;">
            <span>Company setup</span>
            <select id="companySetupSelect"></select>
          </label>
          <div style="align-self:flex-end;">
            <button class="btn secondary" id="loadCompanySetupBtn" type="button">Ladda setup</button>
          </div>
          <div class="muted small" style="align-self:flex-end;" id="companySetupStatus"></div>
        </div>

        <div id="companySetupNote" class="note" style="margin-top:10px; display:none;"></div>

        <div class="row" style="margin-top:10px;">
          <!-- Date is automatic; hidden by default. Remove class date-hidden if you want to show it. -->
          <label class="date-hidden">
            <span data-i18n="lbl_date">Datum</span>
            <input id="date" type="date" readonly>
          </label>

          <label>
            <span data-i18n="lbl_customerNo">Kund nr</span>
            <input id="kundNr" placeholder="t.ex. 2">
          </label>

          <label>
            <span data-i18n="lbl_terms">Betalningsvillkor (dagar)</span>
            <input id="betalningsvillkor" type="number" value="45" min="0">
          </label>

          <label>
            <span data-i18n="lbl_vat">Moms (%)</span>
            <input id="vatRate" type="number" value="25" min="0" step="0.1">
          </label>
        </div>

        <div class="row" style="margin-top:10px;">
          <label style="flex:1; min-width:320px;">
            <span data-i18n="lbl_customerAddress">Kund (namn + adress)</span>
            <textarea id="kundAdress"></textarea>
          </label>

          <label style="min-width:260px;">
            <span data-i18n="lbl_yourRef">Er referens</span>
            <input id="erRef">
          </label>

          <label style="min-width:260px;">
            <span data-i18n="lbl_ourRef">Vår referens</span>
            <input id="varRef">
          </label>

          <label style="min-width:260px;">
            <span data-i18n="lbl_id">Personnummer / ID</span>
            <input id="pnr">
          </label>
        </div>

        <div class="row" style="margin-top:10px;">
          <label>
            <span data-i18n="lbl_projectNo">Projekt / uppdragsgivare (nr)</span>
            <input id="projektNr">
          </label>

          <label>
            <span data-i18n="lbl_projectName">Projekt / uppdragsgivare (namn)</span>
            <input id="projektNamn">
          </label>
        </div>

        <div class="row" style="margin-top:10px;">
          <label style="flex:1; min-width:320px;">
            <span data-i18n="lbl_sender">Avsändare (företag + adress)</span>
            <textarea id="avsandareAdress"></textarea>
          </label>

          <label>
            <span data-i18n="lbl_org">Org.nr</span>
            <input id="orgNr">
          </label>

          <label>
            <span data-i18n="lbl_vatReg">Moms/regnr</span>
            <input id="momsRegnr">
          </label>

          <label>
            <span data-i18n="lbl_email">E-post</span>
            <input id="email">
          </label>

          <label>
            <span data-i18n="lbl_phone">Telefon</span>
            <input id="telefon">
          </label>

          <label>
            <span data-i18n="lbl_bg">Bankgiro</span>
            <input id="bankgiro">
          </label>
        </div>

        <div class="row" style="margin-top:10px;">
          <label>
            <span data-i18n="lbl_logo">Logotyp (valfritt, PNG/JPG)</span>
            <input id="logo" type="file" accept="image/*">
          </label>
          <div class="muted small" style="align-self:flex-end;">
            <span data-i18n="txt_logoHint">(Om du laddar upp en logga här så ersätter den setup-loggan.)</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;" data-i18n="sec2_title">2) Fakturarader</h2>

      <div class="row">
        <label style="flex:1; min-width:320px;">
          <span data-i18n="lbl_desc">Beskrivning</span>
          <input id="newDesc" data-i18n-ph="ph_desc" placeholder="t.ex. Konsulting, utveckling, test…">
        </label>
        <label>
          <span data-i18n="lbl_hours">Timmar</span>
          <input id="newHours" type="number" value="0" min="0" step="0.25">
        </label>
        <label>
          <span data-i18n="lbl_hourlyRate">Timpris (kr)</span>
          <input id="newRate" type="number" value="0" min="0" step="0.01">
        </label>

        <div style="align-self:flex-end;">
          <button class="btn secondary" id="addItemBtn" type="button" data-i18n="btn_addItem">Lägg till rad</button>
        </div>
      </div>

      <div style="margin-top:12px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="min-width:260px;" data-i18n="th_desc">Beskrivning</th>
              <th style="width:90px;" data-i18n="th_hours">Timmar</th>
              <th style="width:140px;" data-i18n="th_rate">Timpris</th>
              <th style="width:140px;" data-i18n="th_amount">Belopp</th>
              <th style="width:220px;" data-i18n="th_actions">Åtgärder</th>
            </tr>
          </thead>
          <tbody id="itemsTbody"></tbody>
        </table>
      </div>

      <div class="totals" style="margin-top:12px;">
        <div class="box">
          <div><span data-i18n="total_sum">Summa:</span><b id="summaOut">0 kr</b></div>
          <div><span data-i18n="total_vat">Moms:</span><b id="momsOut">0 kr</b></div>
          <div style="border-top:1px solid #eee; margin-top:6px; padding-top:6px;">
            <span data-i18n="total_pay">Att betala:</span><b id="attBetalaOut">0 kr</b>
          </div>
        </div>
      </div>

      <div class="actions" style="margin-top:12px;">
        <button class="btn" id="createPdfBtn" type="button" data-i18n="btn_createPdf">Skapa PDF</button>
        <button class="btn secondary" id="clearLocalBtn" type="button" data-i18n="btn_clearLocal">Rensa lokalt sparat</button>
        <span class="muted small" id="status"></span>
      </div>
    </div>

  </div>

<script>
  // If CSV/PNG are in a subfolder, set e.g. "./assets/"
  const SETUP_BASE_PATH = "./";

  const STORAGE = {
    headerCsv: "invoice_header_csv_v4",
    itemsCsv: "invoice_items_csv_v4",
    logoDataUrl: "invoice_logo_dataurl_v4",
    companySetupSelected: "invoice_company_setup_selected_v4",
    profileVisible: "invoice_profile_visible_v4",
    logoSource: "invoice_logo_source_v4"
  };

  const COMPANY_SETUPS = [
    { label: "Lynoit / Sigma / Zeekr (default)", file: "company_setup_lynoit.csv", logo: "company_setup_lynoit_logo.png" },
    { label: "Example setup", file: "company_setup_example.csv", logo: "company_setup_example_logo.png" }
  ];

  const state = { items: [], logoDataUrl: null };
  const $ = (id) => document.getElementById(id);

  // -------------------------
  // i18n (SAFE: does not wipe inputs because data-i18n lives on spans/headers)
  // -------------------------
  const I18N_STORAGE_KEY = "invoice_lang_v4";
  let LANG = localStorage.getItem(I18N_STORAGE_KEY) || "sv";

  const I18N = {
    sv: {
      pageTitle: "Faktura",
      sec1_title: "1) Uppgifter",
      sec2_title: "2) Fakturarader",

      lbl_invoiceNo: "Faktura nr",
      lnk_createInvoiceNo: "Skapa faktura nr",
      ph_invoiceNo: "t.ex. 0079",

      btn_showProfile: "Visa företags profil",
      btn_hideProfile: "Göm företagsprofil",

      lbl_date: "Datum",
      lbl_customerNo: "Kund nr",
      lbl_terms: "Betalningsvillkor (dagar)",
      lbl_vat: "Moms (%)",
      lbl_customerAddress: "Kund (namn + adress)",
      lbl_yourRef: "Er referens",
      lbl_ourRef: "Vår referens",
      lbl_id: "Personnummer / ID",
      lbl_projectNo: "Projekt / uppdragsgivare (nr)",
      lbl_projectName: "Projekt / uppdragsgivare (namn)",
      lbl_sender: "Avsändare (företag + adress)",
      lbl_org: "Org.nr",
      lbl_vatReg: "Moms/regnr",
      lbl_email: "E-post",
      lbl_phone: "Telefon",
      lbl_bg: "Bankgiro",
      lbl_logo: "Logotyp (valfritt, PNG/JPG)",
      txt_logoHint: "(Om du laddar upp en logga här så ersätter den setup-loggan.)",

      lbl_desc: "Beskrivning",
      ph_desc: "t.ex. Konsulting, utveckling, test…",
      lbl_hours: "Timmar",
      lbl_hourlyRate: "Timpris (kr)",
      btn_addItem: "Lägg till rad",

      th_desc: "Beskrivning",
      th_hours: "Timmar",
      th_rate: "Timpris",
      th_amount: "Belopp",
      th_actions: "Åtgärder",

      total_sum: "Summa:",
      total_vat: "Moms:",
      total_pay: "Att betala:",

      btn_createPdf: "Skapa PDF",
      btn_clearLocal: "Rensa lokalt sparat",

      confirm_clear: "Rensa lokalt sparade värden?",
      status_autosaved: "Autosparat.",
      status_ready: "Redo.",
      status_creating_pdf: "Skapar PDF…",
      status_done_prefix: "Klart! Skapade: ",
      status_cleared: "Rensat. Ladda om sidan för att börja om.",

      alert_need_item: "Lägg till minst en rad.",
      alert_need_desc: "Fyll i beskrivning.",
      alert_need_hours_rate: "Fyll i timmar och timpris (större än 0).",

      pdf_title: "Faktura",
      pdf_date: "Datum",
      pdf_customerNo: "Kund nr",
      pdf_invoiceNo: "Faktura nr",
      pdf_yourRef: "Er referens",
      pdf_ourRef: "Vår referens",
      pdf_project: "Projekt / uppdragsgivare",
      pdf_terms: "Betalningsvillkor",
      pdf_days: "dagar",
      pdf_table_head: ["Beskrivning", "Timmar", "Timpris", "Belopp"],
      pdf_sum: "Summa:",
      pdf_vat: "Moms",
      pdf_pay: "Att betala:",
      pdf_has_f_tax: "Innehar F-skatt",

      profile_visible: "Företagsprofil visas.",
      profile_hidden: "Företagsprofil dold.",

      setup_applied_prefix: "Setup applicerad. Fyllde i: ",
      setup_no_match: "Setup tolkad, men inga fält matchade dina CSV-rubriker.",
      setup_headers: "Hittade rubriker:"
    },

    en: {
      pageTitle: "Invoice",
      sec1_title: "1) Details",
      sec2_title: "2) Invoice lines",

      lbl_invoiceNo: "Invoice no.",
      lnk_createInvoiceNo: "Create invoice no",
      ph_invoiceNo: "e.g. 0079",

      btn_showProfile: "Show company profile",
      btn_hideProfile: "Hide company profile",

      lbl_date: "Date",
      lbl_customerNo: "Customer no.",
      lbl_terms: "Payment terms (days)",
      lbl_vat: "VAT (%)",
      lbl_customerAddress: "Customer (name + address)",
      lbl_yourRef: "Your reference",
      lbl_ourRef: "Our reference",
      lbl_id: "Personal ID / ID",
      lbl_projectNo: "Project / client (no.)",
      lbl_projectName: "Project / client (name)",
      lbl_sender: "Sender (company + address)",
      lbl_org: "Company reg. no.",
      lbl_vatReg: "VAT reg. no.",
      lbl_email: "Email",
      lbl_phone: "Phone",
      lbl_bg: "Bankgiro",
      lbl_logo: "Logo (optional, PNG/JPG)",
      txt_logoHint: "(If you upload a logo here, it replaces the setup logo.)",

      lbl_desc: "Description",
      ph_desc: "e.g. Consulting, development, testing…",
      lbl_hours: "Hours",
      lbl_hourlyRate: "Hourly rate (SEK)",
      btn_addItem: "Add line",

      th_desc: "Description",
      th_hours: "Hours",
      th_rate: "Rate",
      th_amount: "Amount",
      th_actions: "Actions",

      total_sum: "Subtotal:",
      total_vat: "VAT:",
      total_pay: "Total:",

      btn_createPdf: "Create PDF",
      btn_clearLocal: "Clear local data",

      confirm_clear: "Clear locally saved values?",
      status_autosaved: "Auto-saved.",
      status_ready: "Ready.",
      status_creating_pdf: "Creating PDF…",
      status_done_prefix: "Done! Created: ",
      status_cleared: "Cleared. Reload the page to start over.",

      alert_need_item: "Please add at least one line.",
      alert_need_desc: "Please enter a description.",
      alert_need_hours_rate: "Please fill in hours and rate (greater than 0).",

      pdf_title: "Invoice",
      pdf_date: "Date",
      pdf_customerNo: "Customer no.",
      pdf_invoiceNo: "Invoice no.",
      pdf_yourRef: "Your reference",
      pdf_ourRef: "Our reference",
      pdf_project: "Project / client",
      pdf_terms: "Payment terms",
      pdf_days: "days",
      pdf_table_head: ["Description", "Hours", "Rate", "Amount"],
      pdf_sum: "Subtotal:",
      pdf_vat: "VAT",
      pdf_pay: "Total:",
      pdf_has_f_tax: "Registered for F-tax",

      profile_visible: "Company profile visible.",
      profile_hidden: "Company profile hidden.",

      setup_applied_prefix: "Setup applied. Filled: ",
      setup_no_match: "Setup parsed, but no fields matched your CSV headers.",
      setup_headers: "Found headers:"
    }
  };

  const t = (key) => I18N[LANG]?.[key] ?? I18N.sv[key] ?? key;

  function applyLang() {
    $("langSv")?.classList.toggle("active", LANG === "sv");
    $("langEn")?.classList.toggle("active", LANG === "en");
    document.documentElement.lang = LANG;
    document.title = (LANG === "en") ? "Invoice – create PDF" : "Faktura – skapa PDF";
    $("pageTitle").textContent = t("pageTitle");

    document.querySelectorAll("[data-i18n]").forEach(el => {
      const key = el.getAttribute("data-i18n");
      if (!key) return;
      el.textContent = t(key);
    });
    document.querySelectorAll("[data-i18n-ph]").forEach(el => {
      const key = el.getAttribute("data-i18n-ph");
      if (!key) return;
      el.setAttribute("placeholder", t(key));
    });

    renderItemsTable();
  }

  function setLang(newLang) {
    LANG = (newLang === "en") ? "en" : "sv";
    localStorage.setItem(I18N_STORAGE_KEY, LANG);
    applyLang();
  }

  $("langSv")?.addEventListener("click", () => setLang("sv"));
  $("langEn")?.addEventListener("click", () => setLang("en"));

  function setStatus(msg) { $("status").textContent = msg || ""; }

  function todayISO() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function formatKr(n) {
    const v = Number(n || 0);
    const rounded = Math.round(v * 100) / 100;
    const num = rounded.toLocaleString(LANG === "en" ? "en-US" : "sv-SE", {
      minimumFractionDigits: 0, maximumFractionDigits: 2
    });
    return (LANG === "en") ? `${num} SEK` : `${num} kr`;
  }

  function sanitizeFilenamePart(s) {
    return String(s || "").trim().replace(/\s+/g, " ").replace(/[\/\\:*?"<>|]/g, "_");
  }

  // -------------------------
  // Robust CSV parsing (; , or tab), BOM, comment rows, first data row
  // -------------------------
  function stripBom(s) { return String(s || "").replace(/^\uFEFF/, ""); }

  function guessDelimiter(text) {
    const s = stripBom(text);
    const firstLine = (s.split(/\r?\n/).find(l => l.trim().length && !l.trim().startsWith("#")) || "");
    const semis = (firstLine.match(/;/g) || []).length;
    const commas = (firstLine.match(/,/g) || []).length;
    const tabs  = (firstLine.match(/\t/g) || []).length;
    if (tabs > semis && tabs > commas) return "\t";
    return (semis >= commas) ? ";" : ",";
  }

  function parseDelimitedRows(text, delim) {
    const csv = stripBom(text);
    const rows = [];
    let row = [], cur = "", inQ = false;

    for (let i = 0; i < csv.length; i++) {
      const ch = csv[i], next = csv[i+1];
      if (inQ) {
        if (ch === '"' && next === '"') { cur += '"'; i++; }
        else if (ch === '"') inQ = false;
        else cur += ch;
      } else {
        if (ch === '"') inQ = true;
        else if (ch === delim) { row.push(cur); cur = ""; }
        else if (ch === "\n") { row.push(cur); rows.push(row); row = []; cur = ""; }
        else if (ch === "\r") {}
        else cur += ch;
      }
    }
    if (cur.length || row.length) { row.push(cur); rows.push(row); }

    return rows
      .map(r => r.map(c => String(c ?? "").trim()))
      .filter(r => r.some(c => c.length) && !(String(r[0]||"").trim().startsWith("#")));
  }

  function parseSingleRowCsvObjectAny(csvText) {
    const delim = guessDelimiter(csvText);
    const rows = parseDelimitedRows(csvText, delim);
    if (rows.length < 2) return null;

    const header = rows[0];
    const dataRow = rows.slice(1).find(r => r.some(c => c.length)) || null;
    if (!dataRow) return null;

    const obj = {};
    for (let i = 0; i < header.length; i++) obj[header[i]] = (dataRow[i] ?? "");
    return obj;
  }

  function normalizeKey(k) {
    return String(k || "")
      .toLowerCase()
      .replace(/\u00a0/g, " ")
      .trim()
      .replace(/\s+/g, " ")
      .replace(/[().:/]/g, "")
      .replace(/\+/g, "plus")
      .replace(/-/g, " ")
      .replace(/\s+/g, "");
  }

  function toNormalizedMap(obj) {
    const m = new Map();
    for (const k of Object.keys(obj || {})) m.set(normalizeKey(k), String(obj[k] ?? "").trim());
    return m;
  }

  function getAny(map, ...keys) {
    for (const k of keys) {
      const nk = normalizeKey(k);
      if (map.has(nk)) return map.get(nk);
    }
    return "";
  }

  // -------------------------
  // Storage (date is NOT stored; date is always today)
  // -------------------------
  function csvEscape(v) {
    const s = String(v ?? "");
    if (/[;"\n\r]/.test(s)) return `"${s.replaceAll('"', '""')}"`;
    return s;
  }
  function csvJoinRow(arr) { return arr.map(csvEscape).join(";") + "\n"; }

  function headerToCsv(headerObj) {
    const keys = Object.keys(headerObj);
    return csvJoinRow(keys) + csvJoinRow(keys.map(k => headerObj[k]));
  }

  function headerFromCsv(csv) {
    const rows = parseDelimitedRows(csv, ";"); // our own saved format is semicolon
    if (rows.length < 2) return null;
    const keys = rows[0], vals = rows[1];
    const obj = {};
    keys.forEach((k, i) => obj[k] = vals[i] ?? "");
    return obj;
  }

  function itemsToCsv(items) {
    let csv = "";
    csv += csvJoinRow(["desc","hours","rate"]);
    for (const it of items) csv += csvJoinRow([it.desc ?? "", it.hours ?? "", it.rate ?? ""]);
    return csv;
  }

  function itemsFromCsv(csv) {
    const rows = parseDelimitedRows(csv, ";");
    if (!rows.length) return [];
    const header = rows[0].map(x => x.trim());
    const idx = (name) => header.indexOf(name);
    const out = [];
    for (let r = 1; r < rows.length; r++) {
      const cols = rows[r];
      out.push({
        desc: cols[idx("desc")] ?? "",
        hours: Number(cols[idx("hours")] ?? 0),
        rate: Number(cols[idx("rate")] ?? 0)
      });
    }
    return out;
  }

  function debounce(fn, ms=400) {
    let tmr;
    return (...args) => { clearTimeout(tmr); tmr = setTimeout(() => fn(...args), ms); };
  }

  function readHeader() {
    return {
      fakturaNr: $("fakturaNr").value.trim(),
      kundNr: $("kundNr")?.value.trim() || "",
      betalningsvillkor: $("betalningsvillkor")?.value.trim() || "",
      vatRate: $("vatRate")?.value.trim() || "25",
      kundAdress: $("kundAdress")?.value || "",
      erRef: $("erRef")?.value.trim() || "",
      varRef: $("varRef")?.value.trim() || "",
      pnr: $("pnr")?.value.trim() || "",
      projektNr: $("projektNr")?.value.trim() || "",
      projektNamn: $("projektNamn")?.value.trim() || "",
      avsandareAdress: $("avsandareAdress")?.value || "",
      orgNr: $("orgNr")?.value.trim() || "",
      momsRegnr: $("momsRegnr")?.value.trim() || "",
      email: $("email")?.value.trim() || "",
      telefon: $("telefon")?.value.trim() || "",
      bankgiro: $("bankgiro")?.value.trim() || ""
    };
  }

  function writeHeader(h) {
    $("fakturaNr").value = h.fakturaNr || "";
    if ($("kundNr")) $("kundNr").value = h.kundNr || "";
    if ($("betalningsvillkor")) $("betalningsvillkor").value = h.betalningsvillkor || "45";
    if ($("vatRate")) $("vatRate").value = h.vatRate || "25";
    if ($("kundAdress")) $("kundAdress").value = h.kundAdress || "";
    if ($("erRef")) $("erRef").value = h.erRef || "";
    if ($("varRef")) $("varRef").value = h.varRef || "";
    if ($("pnr")) $("pnr").value = h.pnr || "";
    if ($("projektNr")) $("projektNr").value = h.projektNr || "";
    if ($("projektNamn")) $("projektNamn").value = h.projektNamn || "";
    if ($("avsandareAdress")) $("avsandareAdress").value = h.avsandareAdress || "";
    if ($("orgNr")) $("orgNr").value = h.orgNr || "";
    if ($("momsRegnr")) $("momsRegnr").value = h.momsRegnr || "";
    if ($("email")) $("email").value = h.email || "";
    if ($("telefon")) $("telefon").value = h.telefon || "";
    if ($("bankgiro")) $("bankgiro").value = h.bankgiro || "";
  }

  function saveAllToStorage() {
    const header = readHeader();
    localStorage.setItem(STORAGE.headerCsv, headerToCsv(header));
    localStorage.setItem(STORAGE.itemsCsv, itemsToCsv(state.items));
    localStorage.setItem(STORAGE.logoDataUrl, state.logoDataUrl || "");
    setStatus(t("status_autosaved"));
  }

  function loadAllFromStorage() {
    const hCsv = localStorage.getItem(STORAGE.headerCsv);
    const iCsv = localStorage.getItem(STORAGE.itemsCsv);
    const logo = localStorage.getItem(STORAGE.logoDataUrl);

    if (hCsv) {
      const h = headerFromCsv(hCsv);
      if (h) writeHeader(h);
    }
    if (iCsv) state.items = itemsFromCsv(iCsv);
    if (logo) state.logoDataUrl = logo || null;
  }

  function recalcTotals() {
    const vatPct = Number($("vatRate")?.value || 25);
    const sum = state.items.reduce((acc, it) => acc + (Number(it.hours)||0) * (Number(it.rate)||0), 0);
    const moms = sum * (vatPct / 100);
    const total = sum + moms;
    $("summaOut").textContent = formatKr(sum);
    $("momsOut").textContent = formatKr(moms);
    $("attBetalaOut").textContent = formatKr(total);
    return { sum, moms, total, vatPct };
  }

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function renderItemsTable() {
    const tbody = $("itemsTbody");
    tbody.innerHTML = "";
    state.items.forEach((it, idx) => {
      const amount = (Number(it.hours)||0) * (Number(it.rate)||0);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(it.desc || "")}</td>
        <td class="right">${escapeHtml(String(it.hours))}</td>
        <td class="right">${escapeHtml(formatKr(it.rate))}</td>
        <td class="right"><b>${escapeHtml(formatKr(amount))}</b></td>
        <td>
          <div class="item-controls">
            <button class="mini" data-action="up" data-idx="${idx}" type="button">↑</button>
            <button class="mini" data-action="down" data-idx="${idx}" type="button">↓</button>
            <button class="btn danger" data-action="del" data-idx="${idx}" type="button">${LANG === "en" ? "Delete line" : "Ta bort rad"}</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
    recalcTotals();
  }

  // -------------------------
  // Company profile show/hide
  // -------------------------
  function setProfileVisible(visible) {
    const block = $("companyProfileBlock");
    const showBtn = $("showProfileBtn");
    const hideBtn = $("hideProfileBtn");
    const status = $("profileStatus");

    if (visible) {
      block.classList.remove("company-profile-hidden");
      showBtn.style.display = "none";
      hideBtn.style.display = "inline-block";
      status.textContent = t("profile_visible");
    } else {
      block.classList.add("company-profile-hidden");
      showBtn.style.display = "inline-block";
      hideBtn.style.display = "none";
      status.textContent = t("profile_hidden");
    }
    localStorage.setItem(STORAGE.profileVisible, visible ? "1" : "0");
  }

  // -------------------------
  // Company setup load + mapping
  // -------------------------
  function showCompanySetupNote(msg) {
    const el = $("companySetupNote");
    if (!msg) { el.style.display = "none"; el.textContent = ""; return; }
    el.style.display = "block";
    el.textContent = msg;
  }
  function setCompanySetupStatus(msg) { $("companySetupStatus").textContent = msg || ""; }

  function applyCompanySetup(setupObj) {
    const m = toNormalizedMap(setupObj);
    const filled = [];

    function setVal(id, val) {
      const el = $(id);
      if (!el) return;
      const v = String(val || "").trim();
      if (!v) return;
      el.value = v;
      filled.push(id);
    }

    // Map common columns (add more aliases if needed)
    setVal("kundNr", getAny(m, "kundNr", "Kund nr", "Customer no", "Customer number"));
    setVal("kundAdress", getAny(m, "kundAdress", "Kund (namn + adress)", "Customer address", "Customer (name + address)"));
    setVal("erRef", getAny(m, "erRef", "Er referens", "Your reference"));
    setVal("varRef", getAny(m, "varRef", "Vår referens", "Our reference"));
    setVal("pnr", getAny(m, "pnr", "Personnummer / ID", "Personal ID", "ID"));

    setVal("projektNr", getAny(m, "projektNr", "Projekt / uppdragsgivare (nr)", "Project no", "Project number"));
    setVal("projektNamn", getAny(m, "projektNamn", "Projekt / uppdragsgivare (namn)", "Project name", "Project"));

    setVal("avsandareAdress", getAny(m, "avsandareAdress", "Avsändare (företag + adress)", "Sender address", "Sender (company + address)"));
    setVal("orgNr", getAny(m, "orgNr", "Org.nr", "Org nr", "Company reg no", "Company registration number"));
    setVal("momsRegnr", getAny(m, "momsRegnr", "Moms/regnr", "VAT reg no", "VAT registration number"));
    setVal("email", getAny(m, "email", "E-post", "Epost"));
    setVal("telefon", getAny(m, "telefon", "Phone"));
    setVal("bankgiro", getAny(m, "bankgiro", "BG"));

    // Optional overrides from setup
    const bt = getAny(m, "betalningsvillkor", "Betalningsvillkor", "Payment terms", "betalningsvillkor (dagar)");
    if (bt) setVal("betalningsvillkor", bt);
    const vr = getAny(m, "vatRate", "moms", "moms (%)", "vat", "vat (%)");
    if (vr) setVal("vatRate", vr);

    const headers = Object.keys(setupObj || {});
    if (filled.length) {
      showCompanySetupNote(t("setup_applied_prefix") + filled.join(", "));
    } else {
      showCompanySetupNote(
        t("setup_no_match") + "\n\n" +
        t("setup_headers") + "\n- " + headers.join("\n- ")
      );
    }
  }

  async function fetchImageAsDataUrl(path) {
    const res = await fetch(path, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const blob = await res.blob();
    if (!blob.type.startsWith("image/")) throw new Error("Not an image.");
    return await new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(blob);
    });
  }

  async function applySetupLogo(setupFileName) {
    const setup = COMPANY_SETUPS.find(s => s.file === setupFileName);
    const logoFile = setup?.logo || String(setupFileName).replace(/\.csv$/i,"_logo.png");

    try {
      const dataUrl = await fetchImageAsDataUrl(SETUP_BASE_PATH + logoFile);
      state.logoDataUrl = dataUrl;
      localStorage.setItem(STORAGE.logoDataUrl, dataUrl);
      localStorage.setItem(STORAGE.logoSource, `setup:${setupFileName}`);
    } catch (e) {
      // not fatal
    }
  }

  async function loadAndApplyCompanySetupCsv(fileName) {
    try {
      const url = SETUP_BASE_PATH + fileName;
      setCompanySetupStatus((LANG === "en" ? "Fetching: " : "Hämtar: ") + url);

      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Could not fetch CSV (${res.status})`);

      const txt = await res.text();
      const obj = parseSingleRowCsvObjectAny(txt);
      if (!obj) throw new Error("CSV parsed as empty/invalid (need header + a data row)");

      applyCompanySetup(obj);
      await applySetupLogo(fileName);

      saveAllToStorage();
      setCompanySetupStatus((LANG === "en" ? "Setup loaded: " : "Setup laddad: ") + fileName);
    } catch (e) {
      setCompanySetupStatus(LANG === "en" ? "Failed." : "Misslyckades.");
      showCompanySetupNote((LANG === "en" ? "Company setup load failed: " : "Kunde inte ladda company setup: ") + e.message);
    }
  }

  function initCompanySetupDropdown() {
    const sel = $("companySetupSelect");
    sel.innerHTML = "";
    for (const s of COMPANY_SETUPS) {
      const opt = document.createElement("option");
      opt.value = s.file;
      opt.textContent = s.label;
      sel.appendChild(opt);
    }
    const saved = localStorage.getItem(STORAGE.companySetupSelected);
    sel.value = (saved && COMPANY_SETUPS.some(x => x.file === saved)) ? saved : (COMPANY_SETUPS[0]?.file || "");
  }

  // ---- Manual logo override ----
  async function fileToDataUrl(file) {
    const buf = await file.arrayBuffer();
    const blob = new Blob([buf], { type: file.type });
    return await new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(blob);
    });
  }
  $("logo")?.addEventListener("change", async () => {
    const f = $("logo").files?.[0] || null;
    if (!f) return;
    if (f.type.startsWith("image/")) {
      const dataUrl = await fileToDataUrl(f);
      state.logoDataUrl = dataUrl;
      localStorage.setItem(STORAGE.logoDataUrl, dataUrl);
      localStorage.setItem(STORAGE.logoSource, "manual");
      autosave();
    }
  });

  // ---- Autosave ----
  const autosave = debounce(saveAllToStorage, 500);
  [
    "fakturaNr","kundNr","betalningsvillkor","vatRate",
    "kundAdress","erRef","varRef","pnr","projektNr","projektNamn",
    "avsandareAdress","orgNr","momsRegnr","email","telefon","bankgiro"
  ].forEach(id => {
    const el = $(id);
    if (!el) return;
    el.addEventListener("input", autosave);
    el.addEventListener("change", autosave);
  });

  // ---- Items ----
  $("addItemBtn").addEventListener("click", () => {
    const desc = $("newDesc").value.trim();
    const hours = Number($("newHours").value || 0);
    const rate = Number($("newRate").value || 0);

    if (!desc) return alert(t("alert_need_desc"));
    if (!(hours > 0) || !(rate > 0)) return alert(t("alert_need_hours_rate"));

    state.items.push({ desc, hours, rate });

    $("newDesc").value = "";
    $("newHours").value = 0;
    $("newRate").value = 0;

    renderItemsTable();
    autosave();
  });

  $("itemsTbody").addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const idx = Number(btn.dataset.idx);
    const action = btn.dataset.action;
    if (!Number.isFinite(idx)) return;

    if (action === "del") state.items.splice(idx, 1);
    else if (action === "up" && idx > 0) [state.items[idx-1], state.items[idx]] = [state.items[idx], state.items[idx-1]];
    else if (action === "down" && idx < state.items.length - 1) [state.items[idx+1], state.items[idx]] = [state.items[idx], state.items[idx+1]];

    renderItemsTable();
    autosave();
  });

  // ---- Clear ----
  $("clearLocalBtn").addEventListener("click", () => {
    if (!confirm(t("confirm_clear"))) return;
    localStorage.removeItem(STORAGE.headerCsv);
    localStorage.removeItem(STORAGE.itemsCsv);
    localStorage.removeItem(STORAGE.logoDataUrl);
    localStorage.removeItem(STORAGE.companySetupSelected);
    localStorage.removeItem(STORAGE.profileVisible);
    localStorage.removeItem(STORAGE.logoSource);
    setStatus(t("status_cleared"));
  });

  // ---- Profile show/hide ----
  $("showProfileBtn").addEventListener("click", () => setProfileVisible(true));
  $("hideProfileBtn").addEventListener("click", () => setProfileVisible(false));

  // ---- Company setup events ----
  $("loadCompanySetupBtn")?.addEventListener("click", async () => {
    const file = $("companySetupSelect").value;
    if (!file) return;
    localStorage.setItem(STORAGE.companySetupSelected, file);
    await loadAndApplyCompanySetupCsv(file);
  });

// -------------------------
// PDF
// -------------------------
function splitLines(text) {
  const t0 = String(text || "").trim();
  return t0 ? t0.split(/\r?\n/).map(s => s.trim()).filter(Boolean) : [];
}

async function drawInvoiceFirstPage(doc, h, margin, pageW, pageH) {
  const totals = recalcTotals();
  const vatPct = Number($("vatRate")?.value || 25);

  // --- Layout knobs
  const logoY = margin;
  const rightBlockY = margin + 8;     // Datum/Kund nr/Faktura nr (higher)
  const customerInfoY = margin + 52;  // Kund address (lower)
  const refsStartY = margin + 78;     // refs/project/terms

  // Logo
  if (state.logoDataUrl) {
    doc.addImage(state.logoDataUrl, "PNG", margin, logoY, 55, 22, undefined, "FAST");
  }

  // Right-side info
  const dateStr = todayISO();
  doc.setFontSize(10);
  const rightX = pageW - margin;

  doc.setFont(undefined, "normal");
  doc.text(`${t("pdf_date")}: ${dateStr}`, rightX, rightBlockY, { align: "right" });
  doc.text(`${t("pdf_customerNo")}: ${h.kundNr || ""}`, rightX, rightBlockY + 5, { align: "right" });
  doc.text(`${t("pdf_invoiceNo")}: ${h.fakturaNr || ""}`, rightX, rightBlockY + 10, { align: "right" });

  // Customer info
  doc.setFontSize(11);
  doc.setFont(undefined, "normal");
  doc.text(splitLines(h.kundAdress || ""), margin, customerInfoY);

  // Refs / Project / Terms headings bold
  doc.setFontSize(10);
  const refY = refsStartY;

  doc.setFont(undefined, "bold");
  doc.text(t("pdf_yourRef"), margin, refY);
  doc.setFont(undefined, "normal");
  doc.text(h.erRef || "", margin, refY + 5);

  doc.setFont(undefined, "bold");
  doc.text(t("pdf_ourRef"), margin + 55, refY);
  doc.setFont(undefined, "normal");
  doc.text(h.varRef || "", margin + 55, refY + 5);
  doc.text(h.pnr || "", margin + 55, refY + 10);

  doc.setFont(undefined, "bold");
  doc.text(t("pdf_project"), margin + 110, refY);
  doc.setFont(undefined, "normal");
  doc.text(h.projektNr || "", margin + 110, refY + 5);
  doc.text(h.projektNamn || "", margin + 110, refY + 10);

  doc.setFont(undefined, "bold");
  doc.text(t("pdf_terms"), rightX, refY, { align: "right" });
  doc.setFont(undefined, "normal");
  doc.text(`${h.betalningsvillkor || ""} ${t("pdf_days")}`, rightX, refY + 5, { align: "right" });

  // Table
  const tableStartY = refsStartY + 20;

  const bodyRows = state.items.map(it => {
    const hours = Number(it.hours || 0);
    const rate = Number(it.rate || 0);
    const amount = hours * rate;
    return [it.desc || "", String(hours), formatKr(rate), formatKr(amount)];
  });

  doc.autoTable({
    startY: tableStartY,
    head: [t("pdf_table_head")],
    body: bodyRows,
    styles: { fontSize: 10, cellPadding: 2.2 },
    headStyles: { fillColor: [240, 240, 240], textColor: 20 },
    columnStyles: {
      0: { cellWidth: 105 },
      1: { halign: "right", cellWidth: 18 },
      2: { halign: "right", cellWidth: 30 },
      3: { halign: "right", cellWidth: 30 }
    },
    margin: { left: margin, right: margin }
  });

  const tableEndY = doc.lastAutoTable.finalY || (tableStartY + 40);

  // Totals box
  const boxW = 72, boxH = 28;
  const boxX = pageW - margin - boxW;
  const boxY = Math.min(pageH - margin - boxH - 10, tableEndY + 10);

  doc.setDrawColor(60);
  doc.rect(boxX, boxY, boxW, boxH);

  doc.setFont(undefined, "normal");
  doc.setFontSize(10);
  doc.text(t("pdf_sum"), boxX + 4, boxY + 8);
  doc.text(formatKr(totals.sum), boxX + boxW - 4, boxY + 8, { align: "right" });

  doc.text(`${t("pdf_vat")} ${vatPct}%:`, boxX + 4, boxY + 16);
  doc.text(formatKr(totals.moms), boxX + boxW - 4, boxY + 16, { align: "right" });

  doc.setFontSize(11);
  doc.text(t("pdf_pay"), boxX + 4, boxY + 25);
  doc.text(formatKr(totals.total), boxX + boxW - 4, boxY + 25, { align: "right" });

  // -------------------------
  // Footer (labels bold, values normal)
  // -------------------------
  doc.setFontSize(9);

  const leftFooterLines = splitLines(h.avsandareAdress || "");
  const leftFooterLines = splitLines(h.avsandareAdress || "");

// ... rightFooterPairs etc ...
const footerStartY = pageH - margin - (maxLines - 1) * lineH;

// Left footer: bigger text
doc.setFont(undefined, "normal");
doc.setFontSize(10); // ✅ increase left footer size here (try 10 or 11)
doc.text(leftFooterLines.length ? leftFooterLines : [""], margin, footerStartY);

// Right footer: keep at 9
doc.setFontSize(9);

  const rightFooterPairs = [
    { label: "Org:", value: (h.orgNr || "") },
    { label: (LANG === "en" ? "VAT reg. no.:" : "Moms/regnr:"), value: (h.momsRegnr || "") },
    { label: (LANG === "en" ? "Email:" : "E-post:"), value: (h.email || "") },
    { label: (LANG === "en" ? "Phone:" : "Telefon:"), value: (h.telefon || "") },
    { label: "Bankgiro:", value: (h.bankgiro || "") },
  ].filter(p => String(p.value).trim().length);

  const lineH = 4.2;
  const rightLineCount = rightFooterPairs.length + 1; // + F-tax line
  const maxLines = Math.max(leftFooterLines.length || 1, rightLineCount || 1);

  const footerStartY = pageH - margin - (maxLines - 1) * lineH;

  // Left footer normal
  doc.setFont(undefined, "normal");
  doc.text(leftFooterLines.length ? leftFooterLines : [""], margin, footerStartY);

  function drawRightLabelValue(doc, rightEdgeX, y, label, value) {
    const labelText = `${label} `;
    const valueText = String(value ?? "");

    doc.setFont(undefined, "bold");
    const wLabel = doc.getTextWidth(labelText);
    doc.setFont(undefined, "normal");
    const wValue = doc.getTextWidth(valueText);

    const startX = rightEdgeX - (wLabel + wValue);

    doc.setFont(undefined, "bold");
    doc.text(labelText, startX, y);

    doc.setFont(undefined, "normal");
    doc.text(valueText, startX + wLabel, y);
  }

  let yR = footerStartY;
  for (const p of rightFooterPairs) {
    drawRightLabelValue(doc, rightX, yR, p.label, p.value);
    yR += lineH;
  }

  // F-tax line bold
  doc.setFont(undefined, "bold");
  doc.text(t("pdf_has_f_tax"), rightX, yR, { align: "right" });
  doc.setFont(undefined, "normal");
} // ✅ IMPORTANT: function ends here


// -------------------------
// PDF button handler (must be OUTSIDE the drawInvoiceFirstPage function)
// -------------------------
$("createPdfBtn").addEventListener("click", async () => {
  try {
    setStatus("");

    if (!window.jspdf || !window.jspdf.jsPDF) {
      alert("jsPDF saknas. Kontrollera att CDN-länken laddas.");
      return;
    }
    if (state.items.length === 0) {
      alert(t("alert_need_item"));
      return;
    }

    setStatus(t("status_creating_pdf"));

    const header = readHeader();
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "mm", format: "a4" });

    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const margin = 12;

    await drawInvoiceFirstPage(doc, header, margin, pageW, pageH);

    const safeDate = todayISO();
    const safeInv = sanitizeFilenamePart(header.fakturaNr || (LANG === "en" ? "invoice" : "faktura"));

    const COMPANY_NAME_FOR_FILENAME = "Lynoit";
    const baseFileName = `${COMPANY_NAME_FOR_FILENAME}_${safeInv}_${safeDate}.pdf`;

    doc.save(baseFileName);
    setStatus(`${t("status_done_prefix")}${baseFileName}`);
  } catch (err) {
    console.error(err);
    setStatus("PDF-fel: " + (err?.message || String(err)));
    alert("Kunde inte skapa PDF. Öppna konsolen (F12) för detaljer.\n\n" + (err?.message || err));
  }
});

  // ---- Init ----
  function initCompanySetupDropdown() {
    const sel = $("companySetupSelect");
    sel.innerHTML = "";
    for (const s of COMPANY_SETUPS) {
      const opt = document.createElement("option");
      opt.value = s.file;
      opt.textContent = s.label;
      sel.appendChild(opt);
    }
    const saved = localStorage.getItem(STORAGE.companySetupSelected);
    sel.value = (saved && COMPANY_SETUPS.some(x => x.file === saved)) ? saved : (COMPANY_SETUPS[0]?.file || "");
  }

  (function init() {
    // Set date input (even if hidden). Not stored; always today.
    if ($("date")) $("date").value = todayISO();

    initCompanySetupDropdown();
    loadAllFromStorage();

    // Ensure date remains today even after loading stored header
    if ($("date")) $("date").value = todayISO();

    applyLang();
    renderItemsTable();
    recalcTotals();

    const vis = localStorage.getItem(STORAGE.profileVisible);
    setProfileVisible(vis === "1");

    // Auto-load company setup on startup (and also load logo)
    const selected = localStorage.getItem(STORAGE.companySetupSelected) || $("companySetupSelect")?.value || "";
    if (selected) loadAndApplyCompanySetupCsv(selected);

    setStatus(t("status_ready"));
  })();
</script>
</body>
</html>
