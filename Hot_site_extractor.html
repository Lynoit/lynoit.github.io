<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Nearby Places Explorer (With Upcoming Events via CORS Proxy)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family:Arial,sans-serif }
    #map { height:60vh; width:100% }
    table { width:100%; border-collapse:collapse; margin-top:1rem }
    th, td { border:1px solid #ccc; padding:0.5rem; vertical-align:top }
    th { background:#f4f4f4 }
    .num-label {
      display:inline-block; width:1.8em; height:1.8em;
      line-height:1.8em; text-align:center;
      color:#fff; font-weight:bold; border-radius:50%;
      margin-right:4px; border:2px solid #000;
      font-size:0.9em;
    }
    .radius-100   { background:#e6194b; }
    .radius-500   { background:#3cb44b; }
    .radius-1000  { background:#4363d8; }
    .radius-5000  { background:#f58231; }
    .radius-10000 { background:#911eb4; }
    .radius-circle {
      stroke-opacity:1!important; stroke-width:4!important;
      fill-opacity:0.1!important;
    }
    .radius-label {
      background: transparent!important;
      border: none!important;
      white-space: nowrap;
      font-size: 1.1em;
      padding: 0;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <table id="places-table">
    <thead>
      <tr>
        <th>Radius</th>
        <th>Most Reviewed<br><small>1–10 (OSM tags)</small></th>
        <th>Most Visited<br><small>1–10 (Wiki pageviews)</small></th>
        <th>Most Linked<br><small>1–10 (Wiki links)</small></th>
        <th>Tourism<br><small>1–10 (OSM tourism)</small></th>
        <th>Upcoming Events<br><small>1–10</small></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // configuration
    const radii = [100, 500, 1000, 5000, 10000];
    const circleColors = ['#e6194b','#3cb44b','#4363d8','#f58231','#911eb4'];
    const TIMEOUT = 8000;
    const TM_API_KEY = 'Rq1qDipyjm6G1YNyV0OyIE89Dr5vaQcl'; // ← your key

    // helper to timeout fetch
    function fetchTimeout(url, opts={}, t=TIMEOUT) {
      return Promise.race([
        fetch(url, opts),
        new Promise((_, rej) => setTimeout(() => rej(new Error('Timeout')), t))
      ]);
    }
    function formatDate(d){ return d.toISOString().slice(0,10).replace(/-/g,''); }
    function distanceMeters(a,b){
      const toRad=x=>x*Math.PI/180;
      const dLat=toRad(b[0]-a[0]), dLon=toRad(b[1]-a[1]);
      const la1=toRad(a[0]), la2=toRad(b[0]);
      const A=Math.sin(dLat/2)**2+Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
      const C=2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));
      return 6371000*C;
    }

    let map, userPos, circlesLayer, markersLayer;
    const plotted = new Set();

    window.onload = () => {
      if (!navigator.geolocation) return alert('Geolocation not supported');
      navigator.geolocation.getCurrentPosition(initMap, e=>{
        alert('Location error: '+e.message);
      });
    };

    function initMap(pos) {
      userPos = [pos.coords.latitude,pos.coords.longitude];
      map = L.map('map').setView(userPos,14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'&copy; OpenStreetMap contributors'
      }).addTo(map);

      circlesLayer = L.layerGroup().addTo(map);
      markersLayer = L.layerGroup().addTo(map);

      L.marker(userPos).addTo(map);
      drawEverything();

      navigator.geolocation.watchPosition(updatePos,null,{
        enableHighAccuracy:true,maximumAge:5000,timeout:8000
      });
    }

    function updatePos(pos) {
      const newPos=[pos.coords.latitude,pos.coords.longitude];
      if(distanceMeters(userPos,newPos)>50){
        userPos=newPos;
        drawEverything();
      }
    }

    async function drawEverything(){
      circlesLayer.clearLayers();
      markersLayer.clearLayers();
      plotted.clear();

      radii.forEach((r,i)=>{
        L.circle(userPos,{ radius:r, color:circleColors[i],
          className:'radius-circle', fill:true,fillColor:circleColors[i]
        }).addTo(circlesLayer);
        const latOff = r/111111;
        L.marker([userPos[0]+latOff,userPos[1]],{
          icon:L.divIcon({
            className:'radius-label',
            html:`${r.toLocaleString()} m`,
            iconAnchor:['50%','100%']
          }),
          interactive:false
        }).addTo(circlesLayer);
      });

      await processAllRadii();
    }

    async function processAllRadii(){
      const tbody=document.querySelector('#places-table tbody');
      tbody.innerHTML='';
      for(let r of radii){
        const [reviewed,pages,tourism,events]=await Promise.all([
          getOSMReviewed(r),
          wikiGeoSearch(r),
          getOSMTourism(r),
          getUpcomingEvents(r)
        ]);
        const visited = await getWikiVisited(pages);
        const linked  = await getWikiLinked(pages);

        render(r,reviewed);
        render(r,visited);
        render(r,linked);
        render(r,tourism);
        render(r,events);

        const mk=arr=>arr.length
          ? arr.map((p,i)=>`${i+1}. ${p.name||p.title}`).join('<br>')
          : 'N/A';
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${r.toLocaleString()} m</td>
          <td>${mk(reviewed)}</td>
          <td>${mk(visited)}</td>
          <td>${mk(linked)}</td>
          <td>${mk(tourism)}</td>
          <td>${mk(events)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function render(r,list){
      list.forEach((p,i)=>{
        const key=`${p.lat.toFixed(6)},${p.lng.toFixed(6)}`;
        if(plotted.has(key)) return;
        plotted.add(key);
        L.marker([p.lat,p.lng],{
          icon:L.divIcon({
            className:`num-label radius-${r}`,
            html:String(i+1)
          })
        }).addTo(markersLayer)
          .bindPopup(`<strong>${i+1}. ${p.name||p.title}</strong>`);
      });
    }

    // … [other fetchers unchanged] …

    // 4) getUpcomingEvents via AllOrigins `/get?url=…`
    async function getUpcomingEvents(r){
      const [lat,lon]=userPos;
      const miles=(r/1609.34).toFixed(2);
      const params=new URLSearchParams({
        apikey:TM_API_KEY,
        latlong:`${lat},${lon}`,
        radius:miles,unit:'miles',
        size:'10',sort:'date,asc',
        classificationName:'music,arts,sports',
        locale:'*'
      });
      const tmUrl=`https://app.ticketmaster.com/discovery/v2/events.json?${params}`;
      const proxy=`https://api.allorigins.win/get?url=${encodeURIComponent(tmUrl)}`;
      try{
        const wrapped=await (await fetchTimeout(proxy)).json();
        const data=JSON.parse(wrapped.contents);
        const ev=(data._embedded?.events||[]).slice(0,10);
        return ev.map(e=>{
          const v=e._embedded?.venues?.[0];
          return {
            name:e.name,
            lat:parseFloat(v.location.latitude),
            lng:parseFloat(v.location.longitude)
          };
        });
      }catch{
        return [];
      }
    }
  </script>
</body>
</html>
