<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Retro Weather & News Dashboard</title>
 <link rel="preconnect" href="https://fonts.googleapis.com">
 <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
 <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
 <style>
   :root {
    --bg: #0d0d0d;
    --text: #00ff9d;
    --accent: #ff007c;
   }
   body {
     margin: 0;
     height: 100vh;
     display: flex;
     flex-direction: column;
     align-items: center;
     justify-content: start;
     background: var(--bg);
     color: var(--text);
     font-family: 'Press Start 2P', monospace;
     overflow: hidden;
   }
   /* CRT scan‑line effect */
   body::before {
     content: "";
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background-image: repeating-linear-gradient(
       0deg,
       rgba(255,255,255,0.05),
       rgba(255,255,255,0.05) 2px,
       transparent 2px,
       transparent 4px
     );
     pointer-events: none;
     mix-blend-mode: overlay;
   }
   h1 {
     font-size: 1.2rem;
     margin-top: 1rem;
   }
   #location {
     margin-top: 0.5rem;
     font-size: 0.8rem;
     color: var(--accent);
   }
   /* flip clock styles */
   .clock {
     display: flex;
     margin-top: 2rem;
   }
   .digit {
     perspective: 1000px;
     margin: 0 2px;
   }
   .digit .card {
     position: relative;
     width: 48px;
     height: 60px;
     background: #222;
     border-radius: 4px;
     overflow: hidden;
     box-shadow: 0 2px 8px rgba(0,0,0,0.8);
   }
   .digit .card div {
     height: 50%;
     display: flex;
     align-items: center;
     justify-content: center;
     font-size: 1.5rem;
   }
   .digit .upper {
     border-bottom: 1px solid #000;
   }
   .digit .lower {
     position: absolute;
     top: 50%;
     left: 0;
     right: 0;
     transform-origin: top;
   }
   /* animate flip */
   .flip .upper {
     animation: fold 0.5s ease-in forwards;
   }
   .flip .lower {
     animation: unfold 0.5s 0.5s ease-out forwards;
   }
   @keyframes fold {
     0% {transform: rotateX(0deg);} 100% {transform: rotateX(-90deg);} }
   @keyframes unfold {
     0% {transform: rotateX(90deg);} 100% {transform: rotateX(0deg);} }
   /* info sections */
   #weather, #forecast, #pollen, #news {
     margin-top: 1.5rem;
     text-align: center;
     font-size: 0.8rem;
   }
   .small { font-size: 0.7rem; opacity: 0.8; }
   a { color: var(--accent); text-decoration: none; }
   a:hover { text-decoration: underline; }
 </style>
</head>
<body>
  <h1>Retro Dashboard</h1>
  <div id="location">Locating...</div>

  <div id="clock" class="clock"></div>

  <div id="weather">
    <h2>Current Weather</h2>
    <div id="weatherData">Loading...</div>
  </div>

  <div id="forecast">
    <h2>Next 48 h Forecast</h2>
    <div id="forecastData">Loading...</div>
  </div>

  <div id="pollen">
    <h2>Pollen</h2>
    <div id="pollenData">Loading...</div>
  </div>

  <div id="news">
    <h2>Top News (SE)</h2>
    <div id="newsData">Loading...</div>
  </div>

<script>
/*****************************
 *        Flip Clock         *
 *****************************/
function createDigit(value){
  const digit = document.createElement('div');
  digit.className = 'digit';
  digit.innerHTML = `\n    <div class="card" data-value="${value}">\n      <div class="upper">${value}</div>\n      <div class="lower">${value}</div>\n    </div>`;
  return digit;
}
function updateCard(card,newValue){
  const currentValue = card.dataset.value;
  if(currentValue === newValue) return;
  const upper = card.querySelector('.upper');
  const lower = card.querySelector('.lower');
  lower.textContent = newValue;
  card.classList.add('flip');
  setTimeout(()=>{
    card.dataset.value = newValue;
    upper.textContent = newValue;
    card.classList.remove('flip');
  },900);
}
function setupClock(){
  const clockElem = document.getElementById('clock');
  for(let i=0;i<6;i++){
    clockElem.appendChild(createDigit('0'));
    if(i===1 || i===3) clockElem.appendChild(document.createTextNode(':'));
  }
  tick();
  setInterval(tick,1000);
}
function tick(){
  const now = new Date();
  const timeStr = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
  const cards = document.querySelectorAll('.digit .card');
  let j=0;
  for(let i=0;i<timeStr.length;i++){
    const ch = timeStr[i];
    if(ch!==':'){
      updateCard(cards[j], ch);
      j++;
    }
  }
}

/*****************************
 *          Geoloc           *
 *****************************/
let lat, lon;
window.onload = function(){
  setupClock();
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      lat = pos.coords.latitude.toFixed(2);
      lon = pos.coords.longitude.toFixed(2);
      document.getElementById('location').textContent = `${lat}, ${lon}`;
      getWeather();
      getPollen();
    }, ()=>{
      document.getElementById('location').textContent = 'Location denied';
    });
  }
  getNews();
};

/*****************************
 *       SMHI Weather        *
 *****************************/
async function getWeather(){
  const url = `https://opendata.smhi.se/api/category/pmp3g/version/2/geotype/point/lon/${lon}/lat/${lat}/data.json`;
  try{
    const res = await fetch(url);
    const data = await res.json();
    const now = data.timeSeries[0].parameters;
    const temp = now.find(p=>p.name==='t').values[0];
    const windDir = now.find(p=>p.name==='wd').values[0];
    const windSpeed = now.find(p=>p.name==='ws').values[0];
    const precip = now.find(p=>p.name==='pmean').values[0];
    document.getElementById('weatherData').innerHTML =
      `<div>${temp} °C</div>`+
      `<div>Wind: ${windDir}° / ${windSpeed} m/s</div>`+
      `<div>Precip: ${precip} mm</div>`;
    let forecastHtml='';
    for(let i=1;i<=16;i+=4){ // every 12 h (pmp3g = 3 h steps)
      const entry = data.timeSeries[i];
      const time = new Date(entry.validTime).toLocaleString([], {weekday:'short', hour:'2-digit'});
      const t = entry.parameters.find(p=>p.name==='t').values[0];
      const p = entry.parameters.find(p=>p.name==='pmean').values[0];
      forecastHtml += `<div class="small">${time}: ${t}°C, ${p} mm</div>`;
    }
    document.getElementById('forecastData').innerHTML = forecastHtml;
  }catch(e){
    document.getElementById('weatherData').textContent = 'Weather unavailable';
  }
}

/*****************************
 *      SMHI Pollen (β)      *
 *****************************/
async function getPollen(){
  const url = 'https://opendata.smhi.se/api/category/pollen/version/1/station/latest';
  try{
    const res = await fetch(url);
    const data = await res.json();
    /* Example structure { "referenceTime":"2025-06-09...", "value":"Låg" } */
    const value = data.value || 'n/a';
    const date = new Date(data.referenceTime || Date.now()).toLocaleDateString();
    document.getElementById('pollenData').textContent = `${value} (updated ${date})`;
  }catch(e){
    document.getElementById('pollenData').textContent = 'Pollen data unavailable';
  }
}

/*****************************
 *          NewsAPI          *
 *****************************/
const NEWS_KEY = 'YOUR_NEWSAPI_KEY';
async function getNews(){
  if(!NEWS_KEY){
    document.getElementById('newsData').textContent = 'Add NewsAPI key';
    return;
  }
  const url = `https://newsapi.org/v2/top-headlines?country=se&pageSize=1&apiKey=${NEWS_KEY}`;
  try{
    const res = await fetch(url);
    const data = await res.json();
    if(data.articles && data.articles.length){
      const article = data.articles[0];
      document.getElementById('newsData').innerHTML = `<a href="${article.url}" target="_blank">${article.title}</a>`;
    }
  }catch(e){
    document.getElementById('newsData').textContent = 'News unavailable';
  }
}
</script>
</body>
</html>
