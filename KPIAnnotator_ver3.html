<!DOCTYPE html>
<html>
<head>
    <title>KPI -- Annotator</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet/dist/leaflet.css"
    />

    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        table { width: 100%; border-collapse: collapse; }
        td, th { text-align: center; padding: 10px; }
        #leftColumn1, #leftColumn2, #leftColumn3, #leftColumn4 { vertical-align: top; }
        .bigButton {
            display: block;
            width: 50%;
            padding: 1px;
            font-size: 12px;
            border-radius: 1px;
            cursor: pointer;
            margin: 5px auto;
        }
        .orangeButton { background-color: orange; color: white; }
        .blueButton   { background-color: blue;   color: white; }
        .greyButton   { background-color: grey;   color: white; }
        .greenButton  { background-color: green;  color: white; }
        .redButton    { background-color: red;    color: white; }
        #textBox {
            width: 90%;
            margin: 0 auto;
            padding: 10px;
            font-size: 12px;
            resize: vertical;
        }
        .distanceContainer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .weatherSection {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .weatherSection img {
            width: 24px;
            height: 24px;
            margin-right: 5px;
        }
        /* Centered map container */
        #map {
            height: 300px;
            width: 80%;
            max-width: 800px;
            margin: 10px auto 0;
        }
        /* DivIcon styling for issue labels */
        .issue-label {
            background: rgba(255,255,255,0.8);
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
            color: #333;
            white-space: nowrap;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <table>
        <tr>
            <td>
                <p id="dateTime"></p>
                <div class="weatherSection">
                    <img id="weatherIcon" src="" alt="Weather icon">
                    <p id="temperature">Temp: N/A</p>
                </div>
            </td>
            <td><p id="streetCity">Street: N/A<br>City: N/A</p></td>
            <td><p id="location"></p></td>
            <td><p id="roadType">Road type: N/A</p></td>
            <td><p id="speed">Speed: N/A</p></td>
            <td>
                <div class="distanceContainer">
                    <p id="totalDistance">Distance: 0.0 km</p>
                    <button class="bigButton orangeButton" onclick="resetDistance()">Reset distance</button>
                </div>
            </td>
        </tr>
        <tr>
            <td><textarea id="textBox" rows="1" placeholder="Enter your annotation here..."></textarea></td>
            <td><button class="bigButton blueButton" onclick="logButton('Manual annotation')">Manual annotation</button></td>
            <td colspan="4"></td>
        </tr>
        <tr>
            <td id="leftColumn1">
                <button class="bigButton greyButton">ACC</button>
                <button class="bigButton redButton" onclick="logButton('ACC False brake')">False brake</button>
                <button class="bigButton blueButton" onclick="logButton('ACC Target drop')">Target drop</button>
                <button class="bigButton blueButton" onclick="logButton('ACC Longitudinal jerk')">Longitudinal jerk</button>
                <button class="bigButton blueButton" onclick="logButton('ACC Accuracy in speed adaption')">Accuracy in speed adaption</button>
                <!-- … add more buttons as needed … -->
            </td>
            <td colspan="5"></td>
        </tr>
    </table>

    <!-- Container for your log table -->
    <div id="logTableContainer"></div>

    <!-- Centered map at the very bottom -->
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // --- Globals ---
        var logTable = [];
        var lastPosition = null;
        var totalDistance = 0;
        var speedHistory = [];
        var currentTemp = 'N/A';
        var currentCondition = 'N/A';
        const HISTORY_SIZE = 5;

        // --- Map tracking ---
        var positions = [];
        var map, trackLine;

        function initMap() {
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            trackLine = L.polyline([], { weight: 4 }).addTo(map);
        }

        function updateMap() {
            trackLine.setLatLngs(positions);
            if (positions.length === 1) {
                map.setView(positions[0], 15);
            } else if (positions.length > 1) {
                map.fitBounds(trackLine.getBounds().pad(0.2));
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000, toRad = Math.PI/180;
            const dLat = (lat2-lat1)*toRad, dLon = (lon2-lon1)*toRad;
            const a = Math.sin(dLat/2)**2
                    + Math.cos(lat1*toRad)*Math.cos(lat2*toRad)
                      * Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function showPosition(position) {
            var lat = position.coords.latitude;
            var lon = position.coords.longitude;
            var t = position.timestamp;
            document.getElementById("location").innerHTML =
                `Latitude: ${lat}<br>Longitude: ${lon}`;

            // update history & map
            positions.push([lat, lon]);
            updateMap();

            if (lastPosition) {
                var dist = calculateDistance(
                    lastPosition.latitude, lastPosition.longitude,
                    lat, lon
                );
                var dt = (t - lastPosition.timestamp) / 1000;
                if (dt > 0) {
                    var rawSpeed = (dist / dt) * 3.6;
                    speedHistory.push(rawSpeed);
                    if (speedHistory.length > HISTORY_SIZE) speedHistory.shift();
                    var avg = speedHistory.reduce((a, b) => a + b, 0)
                              / speedHistory.length;
                    document.getElementById("speed").innerHTML =
                        `Speed: ${Math.round(avg)} km/h`;
                }
                totalDistance += dist;
                document.getElementById("totalDistance").innerHTML =
                    `Distance: ${(totalDistance/1000).toFixed(1)} km`;
            }
            lastPosition = { latitude: lat, longitude: lon, timestamp: t };

            // reverse geocode + weather
            fetch(
                `https://nominatim.openstreetmap.org/reverse?format=jsonv2&extratags=1&lat=${lat}&lon=${lon}`
            )
            .then(r => r.json())
            .then(data => {
                document.getElementById('streetCity').innerHTML =
                    `Street: ${data.address.road || 'N/A'}<br>` +
                    `City: ${data.address.city || data.address.town || data.address.village || 'N/A'}`;
                var rt = data.extratags && data.extratags.highway
                         ? data.extratags.highway
                         : 'Unknown';
                document.getElementById('roadType').innerHTML =
                    `Road type: ${rt}`;
                var cityName = data.address.city
                              || data.address.town
                              || data.address.village;
                if (cityName) getWeather(cityName);
            })
            .catch(err =>
                document.getElementById('streetCity').innerHTML =
                    'Error: ' + err.message
            );
        }

        function resetDistance() {
            totalDistance = 0;
            speedHistory = [];
            lastPosition = null;
            document.getElementById("totalDistance").innerHTML =
                'Distance: 0.0 km';
            document.getElementById("speed").innerHTML =
                'Speed: N/A';
        }

        function showError(err) {
            document.getElementById("location").innerHTML =
                'Error: ' + err.message;
            document.getElementById("speed").innerHTML =
                'Speed: N/A';
        }

        function updateLocation() {
            navigator.geolocation.getCurrentPosition(
                showPosition,
                showError
            );
        }
        setInterval(updateLocation, 1000);

        function getWeather(city) {
            fetch(
                `https://api.weatherapi.com/v1/current.json?` +
                `key=ad8caecea06c43d1912181938230407&q=${encodeURIComponent(city)}`
            )
            .then(r => r.json())
            .then(d => {
                document.getElementById("weatherIcon").src =
                    'https:' + d.current.condition.icon;
                currentTemp = d.current.temp_c + '°C';
                currentCondition = d.current.condition.text;
                document.getElementById("temperature").innerHTML =
                    'Temp: ' + currentTemp;
            });
        }

        function updateDateTime() {
            document.getElementById("dateTime").innerHTML =
                new Date().toLocaleString();
        }
        setInterval(updateDateTime, 1000);

        function logButton(name) {
            var dt = new Date();
            var date = dt.toLocaleDateString(),
                time = dt.toLocaleTimeString();
            var loc = document.getElementById("location").innerHTML
                      .split('<br>');
            var lat = loc[0].split(': ')[1],
                lon = loc[1].split(': ')[1];
            var dist = (totalDistance/1000).toFixed(1);
            var spd = document.getElementById("speed").innerHTML
                      .split(': ')[1].split(' ')[0];
            var rt = document.getElementById("roadType").innerHTML
                     .split(': ')[1];
            var comment = document.getElementById("textBox").value;

            logTable.push([
                name, date, time,
                currentTemp, currentCondition,
                lat, lon, dist, spd, rt, comment
            ]);
            displayLogTable();

            // add issue text label instead of pin
            var latNum = parseFloat(lat),
                lonNum = parseFloat(lon);

            var labelIcon = L.divIcon({
                className: 'issue-label',
                html: `<strong>${name}</strong>`,
                iconSize: null
            });

            L.marker([latNum, lonNum], { icon: labelIcon }).addTo(map);
        }

        function displayLogTable() {
            var html =
                `<table><tr>` +
                `<th>No.</th><th>Issue</th><th>Date</th><th>Time</th>` +
                `<th>Temp</th><th>Weather</th><th>Latitude</th>` +
                `<th>Longitude</th><th>Distance (km)</th>` +
                `<th>Speed (km/h)</th><th>Road type</th>` +
                `<th>Comment</th></tr>`;
            logTable.slice().reverse().forEach((row, i) => {
                html += `<tr><td>${i+1}</td>`;
                row.forEach(v => html += `<td>${v}</td>`);
                html += `</tr>`;
            });
            html += `</table>`;
            document.getElementById("logTableContainer").innerHTML = html;
        }

        // kick things off
        window.onload = initMap;
    </script>
</body>
</html>
