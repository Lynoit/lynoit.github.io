<!DOCTYPE html>
<html>
<head>
    <title>KPI -- Annotator</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        table { width: 100%; margin: 10px 0; }
        td, th { text-align: center; padding: 10px; }
        #leftColumn1, #leftColumn2 { vertical-align: top; }
        .bigButton { display: block; width: 50%; padding: 1px; font-size: 12px; border-radius: 3px; cursor: pointer; margin: 5px auto; }
        .orangeButton { background-color: orange; color: white; }
        .blueButton   { background-color: blue;   color: white; }
        .greyButton   { background-color: grey;   color: white; }
        .greenButton  { background-color: green;  color: white; }
        .redButton    { background-color: red;    color: white; }
        #textBox { width: 90%; margin: 0 auto; padding: 10px; font-size: 12px; resize: vertical; }
        .distanceContainer { display: flex; justify-content: space-between; align-items: center; }
        .weatherSection { display: flex; align-items: center; justify-content: center; }
        .weatherSection img { width: 24px; height: 24px; margin-right: 5px; }
        #map { height: 300px; width: 100%; }
        @media print { .bigButton, #textBox { display: none !important; } }
        .issue-label { background: rgba(255,255,255,0.8); padding: 2px 4px; border-radius: 3px; font-size: 12px; color: #333; white-space: nowrap; pointer-events: none; }
        #countContainer { width: 80%; max-width: 800px; margin: 20px auto; text-align: center; }
        #countTable { width: 100%; border: 1px solid #333; border-collapse: collapse; margin: 0 auto; }
        #countTable td, #countTable th { border: 1px solid #333; }
        /* Layout for map and charts and table */
        #mapContainer { width: 100%; padding: 0; box-sizing: border-box; }
        #chartsContainer { display: flex; width: 100%; box-sizing: border-box; margin-top: 20px; }
        .chartBox, .tableBox { flex: 1; padding: 0 10px; }
        .chartBox canvas { width: 100%; height: 300px; }
        #streetTable { width: 100%; border: 1px solid #333; border-collapse: collapse; margin-top: 10px; }
        #streetTable td, #streetTable th { border: 1px solid #333; }
    </style>
</head>
<body>
    <table>
        <tr>
            <td>
                <p id="dateTime"></p>
                <div class="weatherSection">
                    <img id="weatherIcon" src="" alt="Weather icon">
                    <p id="temperature">Temp: N/A</p>
                </div>
            </td>
            <td><p id="streetCity">Street: N/A<br>City: N/A</p></td>
            <td><p id="location"></p></td>
            <td><p id="roadType">Road type: N/A</p></td>
            <td><p id="speed">Speed: N/A</p></td>
            <td>
                <div class="distanceContainer">
                    <p id="totalDistance">Distance: 0.0 km</p>
                    <button class="bigButton orangeButton" onclick="resetDistance()">Reset distance</button>
                </div>
            </td>
        </tr>
        <tr>
            <td><textarea id="textBox" rows="1" placeholder="Enter your annotation here..."></textarea></td>
            <td><button class="bigButton blueButton" onclick="logButton('Manual annotation', false)">Manual annotation</button></td>
            <td><button class="bigButton greenButton" onclick="saveAndPrint()">Save report to pdf</button></td>
            <td colspan="3"></td>
        </tr>
        <tr>
            <td id="leftColumn1">
                <button class="bigButton greyButton">ACC</button>
                <button class="bigButton redButton" onclick="logButton('ACC False brake', true)">False brake</button>
                <button class="bigButton redButton" onclick="logButton('ACC Target drop', true)">Target drop</button>
                <button class="bigButton redButton" onclick="logButton('ACC Longitudinal jerk', true)">Longitudinal jerk</button>
                <button class="bigButton redButton" onclick="logButton('ACC Accuracy in speed adaption', true)">Accuracy in speed adaption</button>
            </td>
            <td colspan="5"></td>
            <td id="leftColumn2">
                <button class="bigButton greyButton">TSI Speed</button>
                <button class="bigButton greenButton" onclick="logButton('TSI Explicit correct speed detected', false)">Correct explicit speed detected</button>
                <button class="bigButton redButton" onclick="logButton('TSI Explicit incorrect speed detected', true)">Incorrect explicit speed detected</button>
            </td>
        </tr>
    </table>

    <div id="logTableContainer"></div>

    <br><hr><br>
    <div id="mapContainer">
        <h3 style="text-align:center;">Route</h3>
        <div id="map"></div>
    </div>
    <br><hr><br>
    <div id="chartsContainer">
        <div class="chartBox">
            <h3 style="text-align:center;">Distance vs Time</h3>
            <canvas id="distanceChart"></canvas>
        </div>
        <div class="chartBox">
            <h3 style="text-align:center;">Speed vs Distance</h3>
            <canvas id="speedChart"></canvas>
        </div>
        <div class="tableBox">
            <h3 style="text-align:center;">Streets Encountered</h3>
            <table id="streetTable">
                <tr><th>Street</th><th>Distance (km)</th></tr>
            </table>
        </div>
    </div>
    <br><hr><br>

    <div id="countContainer">
        <h3>KPI Calculation</h3>
        <table id="countTable">
            <tr><th>Issue</th><th>Total No of events</th><th>Events per 1000 km</th></tr>
            <tr><td colspan="3">&nbsp;</td></tr>
        </table>
    </div>

    <!-- Dependencies -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // --- Globals ---
        var logTable = [];
        var redCounts = {};
        var lastPosition = null;
        var totalDistance = 0;
        var currentTemp = 'N/A', currentCondition = 'N/A';
        var positions = [];
        var map, trackLine;
        var timeData = [], distData = [], speedData = [];
        var streetDistances = {};
        var distanceChart, speedChart;

        function initMap() {
            map = L.map('map').setView([0,0],2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap contributors'}).addTo(map);
            trackLine = L.polyline([], { weight: 4 }).addTo(map);
        }

        function initCharts() {
            var ctx1 = document.getElementById('distanceChart').getContext('2d');
            distanceChart = new Chart(ctx1, { type: 'line', data: { labels: timeData, datasets:[{ label:'Distance (km)', data: distData, fill:false, tension:0.1 }] }, options:{ responsive:true, scales:{ x:{ type:'time', time:{ unit:'minute', tooltipFormat:'HH:mm:ss' }}, y:{ beginAtZero:true } } } });
            var ctx2 = document.getElementById('speedChart').getContext('2d');
            speedChart = new Chart(ctx2, { type: 'line', data:{ labels: distData, datasets:[{ label:'Speed (km/h)', data: speedData, fill:false, tension:0.1 }] }, options:{ responsive:true, scales:{ x:{ type:'linear', title:{ display:true, text:'Distance (km)' }}, y:{ beginAtZero:true, title:{ display:true, text:'Speed (km/h)' } } } } });
        }

        function updateMap() {
            trackLine.setLatLngs(positions);
            if (positions.length===1) map.setView(positions[0],15);
            else if (positions.length>1) map.fitBounds(trackLine.getBounds().pad(0.2));
        }

        function calculateDistance(lat1,lon1,lat2,lon2) {
            const R=6371000,toRad=Math.PI/180;
            const dLat=(lat2-lat1)*toRad, dLon=(lon2-lon1)*toRad;
            const a=Math.sin(dLat/2)**2 + Math.cos(lat1*toRad)*Math.cos(lat2*toRad)*Math.sin(dLon/2)**2;
            return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
        }

        function showPosition(position) {
            var lat = position.coords.latitude, lon = position.coords.longitude, t = position.timestamp;
            document.getElementById('location').innerHTML = `Lat: ${lat}<br>Lon: ${lon}`;
            var prevPos = lastPosition;
            var d = prevPos ? calculateDistance(prevPos.latitude, prevPos.longitude, lat, lon) : 0;
            positions.push([lat, lon]); updateMap();
            if (prevPos && d >= 0) {
                var dt = (t - prevPos.timestamp) / 1000;
                if (dt > 0) {
                    var instSpeed = (d / dt) * 3.6;
                    document.getElementById('speed').innerHTML = `Speed: ${instSpeed.toFixed(1)} km/h`;
                    timeData.push(new Date(t)); distData.push((totalDistance/1000).toFixed(3)); speedData.push(instSpeed.toFixed(1));
                    if (distanceChart) distanceChart.update(); if (speedChart) speedChart.update();
                }
                totalDistance += d;
                document.getElementById('totalDistance').innerHTML = `Distance: ${(totalDistance/1000).toFixed(1)} km`;
            }
            lastPosition = { latitude: lat, longitude: lon, timestamp: t };
            fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&extratags=1&lat=${lat}&lon=${lon}`)
                .then(r => r.json())
                .then(data => {
                    var road = data.address.road || 'Unknown';
                    // accumulate road distance
                    if (!streetDistances[road]) streetDistances[road] = 0;
                    streetDistances[road] += d/1000;
                    updateStreetTable();
                    document.getElementById('streetCity').innerHTML = `Street: ${road}<br>City: ${data.address.city || data.address.town || data.address.village || 'N/A'}`;
                    document.getElementById('roadType').innerHTML = `Road type: ${data.extratags && data.extratags.highway ? data.extratags.highway : 'Unknown'}`;
                    var c = data.address.city || data.address.town || data.address.village; if (c) getWeather(c);
                }).catch(e => document.getElementById('streetCity').innerHTML = 'Error: ' + e.message);
        }

        function updateStreetTable() {
            var tbl = document.getElementById('streetTable'), rows = '<tr><th>Street</th><th>Distance (km)</th></tr>';
            for (var road in streetDistances) {
                rows += `<tr><td>${road}</td><td>${streetDistances[road].toFixed(2)}</td></tr>`;
            }
            tbl.innerHTML = rows;
        }() {
            var tbl=document.getElementById('streetTable'), rows='';
            for(var road in streetDistances) {
                rows+=`<tr><td>${road}</td><td>${streetDistances[road].toFixed(2)} km</td></tr>`;
            }
            tbl.innerHTML=rows;
        }

        function resetDistance(){ totalDistance=0; lastPosition=null; document.getElementById('totalDistance').innerHTML='Distance: 0.0 km'; document.getElementById('speed').innerHTML='Speed: N/A'; timeData=[]; distData=[]; speedData=[]; streetDistances={}; updateStreetTable(); if(distanceChart) distanceChart.update(); if(speedChart) speedChart.update(); }
        function saveAndPrint(){ logButton('Save report to PDF',false); window.print(); }
        function showError(e){ document.getElementById('location').innerHTML='Error: '+e.message; document.getElementById('speed').innerHTML='Speed: N/A'; }
        function updateLocation(){ navigator.geolocation.getCurrentPosition(showPosition,showError); }
        setInterval(updateLocation,1000);

        function getWeather(city){ fetch(`https://api.weatherapi.com/v1/current.json?key=ad8caecea06c43d1912181938230407&q=${encodeURIComponent(city)}`)
            .then(r=>r.json()).then(d=>{ document.getElementById('weatherIcon').src='https:'+d.current.condition.icon; currentTemp=d.current.temp_c+'°C'; currentCondition=d.current.condition.text; document.getElementById('temperature').innerHTML='Temp: '+currentTemp; }); }

        function updateDateTime(){ document.getElementById('dateTime').innerHTML=new Date().toLocaleString(); }
        setInterval(updateDateTime,1000);

        function logButton(name,isRed){ var dt=new Date(),date=dt.toLocaleDateString(),time=dt.toLocaleTimeString(); var loc=document.getElementById('location').innerHTML.split('<br>'),lat=loc[0].split(': ')[1],lon=loc[1].split(': ')[1]; var dist=(totalDistance/1000).toFixed(1),spd=document.getElementById('speed').innerHTML.split(': ')[1].split(' ')[0],rt=document.getElementById('roadType').innerHTML.split(': ')[1],comment=document.getElementById('textBox').value; logTable.push([name,date,time,currentTemp,currentCondition,lat,lon,dist,spd,rt,comment]); displayLogTable(); var icon=L.divIcon({className:'issue-label',html:`<strong>${name}</strong>`,iconSize:null}); L.marker([parseFloat(lat),parseFloat(lon)],{icon:icon}).addTo(map); if(isRed){ redCounts[name]=(redCounts[name]||0)+1; updateCountTable(); } document.getElementById('textBox').value=''; }

        function displayLogTable(){ var html=`<table><tr><th>No.</th><th>Issue</th><th>Date</th><th>Time</th><th>Temp</th><th>Weather</th><th>Latitude</th><th>Longitude</th><th>Distance (km)</th><th>Speed (km/h)</th><th>Road type</th><th>Comment</th></tr>'; logTable.forEach((row,i)=>{ html+=`<tr><td>${i+1}</td>`;row.forEach(v=>html+=`<td>${v}</td>`);html+='</tr>';}); html+='</table>'; document.getElementById('logTableContainer').innerHTML=html; }

        function updateCountTable(){ var tbl=document.getElementById('countTable'),rows='<tr><th>Issue</th><th>Total No of events</th><th>Events per 1000 km</th></tr>',dkm=totalDistance/1000; for(var issue in redCounts){ var c=redCounts[issue],r=''; if(dkm>10) r=(c/dkm*1000).toFixed(1); rows+=`<tr><td>${issue}</td><td>${c}</td><td>${r}</td></tr>`; } tbl.innerHTML=rows; }

        window.onload = function(){ initMap(); initCharts(); };
    </script>
</body>
</html>
