<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Road Features Map with KMZ Route</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { position: relative; width: 100%; height: 60%; }
    #controls { padding: 10px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .feature-label { background: white; border: 1px solid #333; border-radius: 4px; padding: 2px 4px; }
    .leaflet-tooltip.feature-label:after { background: white; }
    #results, #seqResults { height: 20%; overflow: auto; margin-top: 5px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 4px; text-align: left; }
    #searchOverlay {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 1.5em; z-index: 1000; pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="controls">
    <strong>Upload Route (KMZ):</strong>
    <input type="file" id="kmzInput" accept=".kmz" />
    <button id="loadRouteBtn">Load Route</button>
    <button id="searchBtn">Sequential Search</button>
    <label style="margin-left:10px;">Radius (m):
      <input type="number" id="range" value="5" min="1" step="1" style="width:80px;" />
    </label>
    <div style="margin-top:4px; font-size:0.8em;">Double-click map to toggle manual point.</div>
  </div>

  <div id="map">
    <div id="searchOverlay" style="display: none;">Searching for road featuresâ€¦</div>
  </div>

  <div id="results">
    <h4>Features by Type</h4>
    <table>
      <thead><tr><th>Feature</th><th>Lat</th><th>Lon</th></tr></thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>
  <div id="seqResults">
    <h4>Features by Route Coordinate</h4>
    <table>
      <thead><tr><th>#</th><th>Lat</th><th>Lon</th><th>Features</th></tr></thead>
      <tbody id="seqBody"></tbody>
    </table>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script>
    const RANGE = () => parseInt(document.getElementById('range').value,10) || 5;
    function showOverlay(){document.getElementById('searchOverlay').style.display='flex';}
    function hideOverlay(){document.getElementById('searchOverlay').style.display='none';}

    const map = L.map('map').setView([0,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    const routeLayer = L.geoJSON(null,{style:{color:'blue',weight:4}}).addTo(map);

    const featureSettings=[
      ['man_made','bridge','Bridge'],['tunnel','yes','Tunnel'],
      ['amenity','toll_booth','Toll Station'],['junction','roundabout','Roundabout'],
      ['highway','stop','Stop Sign'],['highway','traffic_signals','Traffic Light'],
      ['junction','yes','Intersection'],['traffic_calming','speed_bump','Speed Bump'],
      ['maxspeed','20','20 kph'],['maxspeed','30','30 kph'],['maxspeed','40','40 kph'],
      ['maxspeed','50','50 kph'],['maxspeed','60','60 kph'],['maxspeed','70','70 kph'],
      ['maxspeed','80','80 kph'],['maxspeed','90','90 kph'],['maxspeed','100','100 kph'],
      ['maxspeed','110','110 kph'],['maxspeed','120','120 kph'],['maxspeed','130','130 kph'],
      ['maxspeed','140','140 kph'],['maxspeed','none','Unlimited']
    ];
    const featureLayers = {};
    featureSettings.forEach(([, ,label])=> featureLayers[label]=L.layerGroup().addTo(map));

    function addMarker(label, coord){
      L.circleMarker(coord,{radius:6, color:'blue', fillColor:'blue', fillOpacity:1, weight:1, interactive:false})
        .addTo(featureLayers[label])
        .bindTooltip(label,{permanent:true,direction:'right',offset:[10,0],className:'feature-label'});
    }
    function clearAll(){
      Object.values(featureLayers).forEach(l=>l.clearLayers());
      ['resultsBody','seqBody'].forEach(id=>document.getElementById(id).innerHTML='');
    }

    function onKMZ(file){
      JSZip.loadAsync(file).then(zip=>{
        const k=Object.keys(zip.files).find(n=>n.toLowerCase().endsWith('.kml'));
        return zip.file(k).async('string');
      }).then(txt=>{
        const gj=toGeoJSON.kml(new DOMParser().parseFromString(txt,'application/xml'));
        routeLayer.clearLayers().addData(gj);
        map.fitBounds(routeLayer.getBounds());
      }).catch(e=>alert('KMZ load failed:'+e));
    }
    document.getElementById('loadRouteBtn').onclick=()=>{
      const f=document.getElementById('kmzInput').files[0];if(!f)return alert('Select KMZ');onKMZ(f);
    };

    document.getElementById('searchBtn').onclick=async()=>{
      clearAll();showOverlay();
      const gj=routeLayer.toGeoJSON();if(!gj.features.length){hideOverlay();return alert('Load route first');}

      // build bbox
      const bbox=turf.bbox(gj);
      const bboxStr=`${bbox[1]},${bbox[0]},${bbox[3]},${bbox[2]}`;

      // single Overpass query for all features
      let overpassParts=[];
      featureSettings.forEach(([k,v])=>{
        overpassParts.push(`node["${k}"="${v}"](${bboxStr});`);
        overpassParts.push(`way["${k}"="${v}"](${bboxStr});`);
      });
      const combinedQuery=`[out:json][timeout:60];(${overpassParts.join('')});out center;`;
      let elements=[];
      try{
        const resp=await fetch('https://overpass-api.de/api/interpreter',{
          method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:combinedQuery
        });
        const data=await resp.json();elements=data.elements;
        // plot aggregate table
        elements.forEach(el=>{
          const label=featureSettings.find(([k,v,l])=>
            (el.tags&&el.tags[k]===v)
          )[2];
          const lat=el.lat!=null?el.lat:el.center.lat;
          const lon=el.lon!=null?el.lon:el.center.lon;
          document.getElementById('resultsBody').insertAdjacentHTML('beforeend',
            `<tr><td>${label}</td><td>${lat.toFixed(6)}</td><td>${lon.toFixed(6)}</td></tr>`);
        });
      }catch(e){console.warn('Overpass bulk fetch error',e);}      

      // sequential per-coordinate check
      // extract coords
      let coords=[];
      gj.features.forEach(f=>{
        const g=f.geometry;
        if(g.type==='LineString')coords.push(...g.coordinates);
        else if(g.type==='MultiLineString')g.coordinates.forEach(c=>coords.push(...c));
      });

      for(let i=0;i<coords.length;i++){
        const [lng,lat]=coords[i];
        const found=new Set();
        elements.forEach(el=>{
          const elLat=el.lat!=null?el.lat:el.center.lat;
          const elLon=el.lon!=null?el.lon:el.center.lon;
          const pt=turf.point([elLon,elLat]);
          // distance to this coord
          const d=turf.distance(pt,turf.point([lng,lat]),{units:'meters'});
          if(d<=RANGE()){
            const label=featureSettings.find(([k,v,l])=>el.tags&&el.tags[k]===v)[2];
            found.add(label);
            addMarker(label,[elLat,elLon]);
          }
        });
        const list=Array.from(found).join(', ');
        document.getElementById('seqBody').insertAdjacentHTML('beforeend',
          `<tr><td>${i+1}</td><td>${lat.toFixed(6)}</td><td>${lng.toFixed(6)}</td><td>${list}</td></tr>`);
      }

      hideOverlay();console.log('Search complete');
    };
  </script>
</body>
</html>
