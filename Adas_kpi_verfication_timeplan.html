<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">
  <title>ADAS Verification Plan â€“ Interactive Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    :root{ --bg:#0b0c10; --card:#15161b; --muted:#8b93a2; --fg:#e9eef7; --accent:#0ea5e9; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    h1{font-weight:700;letter-spacing:.2px;margin:16px 0 10px}
    h2{font-weight:600;font-size:16px;color:var(--muted);margin:0 0 8px}
    .wrap{max-width:1680px;margin:0 auto;padding:18px}

    /* Two-column layout: inputs | plots */
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:1100px){
      .grid{grid-template-columns:0.9fr 1.6fr; align-items:start}
    }

    .card{background:var(--card);border:1px solid #252833;border-radius:16px;padding:14px 16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .controls{display:grid;gap:10px;grid-template-columns:repeat(6,1fr)}
    .controls .field{display:flex;flex-direction:column;gap:6px;background:#101218;border:1px solid #222634;border-radius:12px;padding:8px}
    .controls label{font-size:12px;color:var(--muted)}
    .controls input,.controls select,.controls textarea{background:#0f1218;color:var(--fg);border:1px solid #2a2f3c;border-radius:8px;padding:6px 8px}
    .btn{cursor:pointer;background:#1e293b;border:1px solid #2f3846;color:#e9eef7;padding:8px 10px;border-radius:10px}
    .btn.accent{background:var(--accent);border-color:#38bdf8}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .note{color:var(--muted);font-size:12px;margin-top:8px}

    /* Plots: white background for clean export */
    svg{width:100%;height:auto;display:block;background:#fff}
    .axis path,.axis line{stroke:#c4c7cf}
    .major-grid{stroke:#e5e7eb;stroke-dasharray:4 6}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th,td{padding:6px 8px;font-size:12px}
    tbody tr{background:#0f1218;border:1px solid #222634}
    tbody td:first-child{border-radius:8px 0 0 8px}
    tbody td:last-child{border-radius:0 8px 8px 0}

    /* Easier date pickers with a button */
    .field.date .date-wrap{position:relative; display:flex; align-items:center}
    .field.date input[type=date]{padding-right:40px}
    .date-btn{position:absolute; right:6px; width:30px; height:30px; border-radius:6px; border:1px solid #2a2f3c; background:#0f1218; color:#e9eef7; cursor:pointer; display:flex; align-items:center; justify-content:center}
    .date-btn:hover{border-color:#38bdf8}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ADAS Verification Plan â€“ Interactive Dashboard</h1>

  <!-- Export / Import toolbar -->
  <div class="row" style="margin-bottom:12px;gap:12px">
    <button class="btn accent" id="btn-export-combo">Export combined PNG (5 subplots)</button>
    <label class="note">Scale <input type="number" id="exp-scale" value="2" min="1" max="4" style="width:56px;margin-left:6px"></label>
    <span style="flex:1"></span>
    <button class="btn" id="btn-export-csv">Export events (CSV)</button>
    <button class="btn" id="btn-export-json">Export events (JSON)</button>
    <button class="btn" id="btn-import">Import events (CSV/JSON)</button>
    <input type="file" id="file-input" accept=".csv,.json" style="display:none">
  </div>

  <div class="grid">
    <!-- COLUMN 1: INPUTS -->
    <div class="card">
      <h2>Inputs</h2>
      <div class="controls" style="margin-bottom:12px">
        <div class="field date" data-target="inp-start"><label>Campaign start</label><div class="date-wrap"><input type="date" id="inp-start" value="2025-09-01"><button class="date-btn" data-target="inp-start" title="Open calendar">ðŸ“…</button></div></div>
        <div class="field date" data-target="inp-end"><label>Campaign end</label><div class="date-wrap"><input type="date" id="inp-end" value="2026-06-30"><button class="date-btn" data-target="inp-end" title="Open calendar">ðŸ“…</button></div></div>
        <div class="field"><label>Show week numbers in Gantt</label><select id="inp-weeks"><option value="0">No</option><option value="1">Yes</option></select></div>
        <div class="field"><label>Daylight %</label><input type="number" id="inp-day" min="0" max="100" step="1" value="85"></div>
        <div class="field"><label>Twilight/Night %</label><input type="number" id="inp-night" min="0" max="100" step="1" value="15"></div>
      </div>

      <h2>Type weights (editable)</h2>
      <div class="controls" style="margin-bottom:12px">
        <div class="field"><label>XS km / KPI %</label><div class="row"><input type="number" id="km-XS" value="150" style="width:90px"><input type="number" id="kpi-XS" value="7.5" style="width:90px"></div></div>
        <div class="field"><label>S km / KPI %</label><div class="row"><input type="number" id="km-S" value="1000" style="width:90px"><input type="number" id="kpi-S" value="50" style="width:90px"></div></div>
        <div class="field"><label>M km / KPI %</label><div class="row"><input type="number" id="km-M" value="2500" style="width:90px"><input type="number" id="kpi-M" value="100" style="width:90px"></div></div>
        <div class="field"><label>L km / KPI %</label><div class="row"><input type="number" id="km-L" value="5000" style="width:90px"><input type="number" id="kpi-L" value="250" style="width:90px"></div></div>
        <div class="field"><label>XL km / KPI %</label><div class="row"><input type="number" id="km-XL" value="10000" style="width:90px"><input type="number" id="kpi-XL" value="500" style="width:90px"></div></div>
      </div>

      <h2>Generate XS (weekly)</h2>
      <div class="controls" style="grid-template-columns:repeat(5,1fr);margin-bottom:12px">
        <div class="field date" data-target="xs-from"><label>From</label><div class="date-wrap"><input type="date" id="xs-from" value="2025-09-01"><button class="date-btn" data-target="xs-from" title="Open calendar">ðŸ“…</button></div></div>
        <div class="field date" data-target="xs-to"><label>To</label><div class="date-wrap"><input type="date" id="xs-to" value="2026-06-30"><button class="date-btn" data-target="xs-to" title="Open calendar">ðŸ“…</button></div></div>
        <div class="field"><label>Duration (days)</label><input type="number" id="xs-days" value="1" min="1" max="14"></div>
        <div class="field"><label>Country</label><input id="xs-country" value="Sweden"></div>
        <div class="field"><label>&nbsp;</label><button class="btn" id="btn-add-xs">Add weekly XS</button></div>
      </div>

      <!-- Weekly Software updates -->
      <h2>Generate Software updates (weekly)</h2>
      <div class="controls" style="grid-template-columns:repeat(6,1fr);margin-bottom:12px">
        <div class="field date" data-target="sw-from">
          <label>From</label>
          <div class="date-wrap">
            <input type="date" id="sw-from" value="2025-09-01">
            <button class="date-btn" data-target="sw-from" title="Open calendar">ðŸ“…</button>
          </div>
        </div>
        <div class="field date" data-target="sw-to">
          <label>To</label>
          <div class="date-wrap">
            <input type="date" id="sw-to" value="2026-06-30">
            <button class="date-btn" data-target="sw-to" title="Open calendar">ðŸ“…</button>
          </div>
        </div>
        <div class="field">
          <label>Drop per update (%)</label>
          <input type="number" id="sw-drop" value="10" min="0" max="100">
        </div>
        <div class="field">
          <label>Mileage drop per update (km)</label>
          <input type="number" id="sw-dropkm" value="0" min="0" step="1">
        </div>
        <div class="field">
          <label>Name prefix</label>
          <input id="sw-prefix" value="SW update">
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button class="btn" id="btn-add-sw-weekly">Add weekly SW updates</button>
        </div>
      </div>

      <h2>Add single event</h2>
      <div class="controls" style="grid-template-columns:repeat(6,1fr);margin-bottom:8px">
        <div class="field"><label>Name</label><input id="ev-name" placeholder="e.g., L EU Expedition"></div>
        <div class="field"><label>Type</label>
          <select id="ev-type">
            <option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option><option>Software update</option>
          </select>
        </div>
        <div class="field date" data-target="ev-start"><label>Start date</label><div class="date-wrap"><input type="date" id="ev-start" value="2025-12-05"><button class="date-btn" data-target="ev-start" title="Open calendar">ðŸ“…</button></div></div>
        <div class="field"><label>Duration (days)</label><input type="number" id="ev-days" value="7" min="0" max="60"></div>
        <div class="field"><label>Countries (comma separated)</label><input id="ev-countries" placeholder="Sweden, Germany"></div>
        <div class="field"><label>&nbsp;</label><button class="btn" id="btn-add-one">Add event</button></div>
      </div>
      <div class="controls" style="grid-template-columns:repeat(4,1fr);margin-bottom:12px">
        <div class="field"><label>Override km / Drop km (for SW)</label><input type="number" id="ev-km" placeholder="(auto by type or km drop for SW)"></div>
        <div class="field"><label>Override KPI % / Drop % (for SW)</label><input type="number" id="ev-kpi" placeholder="(auto by type or % drop for SW)"></div>
        <div class="field"><label>&nbsp;</label><button class="btn" id="btn-clear">Clear all events</button></div>
        <div class="field"><label>&nbsp;</label><button class="btn accent" id="btn-render">Update plots</button></div>
      </div>

      <h2>Events</h2>
      <div id="events-table"></div>
      <p class="note">Need a quick start? <button class="btn" id="btn-load-example">Load example from earlier spec</button></p>
    </div>

    <!-- COLUMN 2: PLOTS -->
    <div>
      <div class="card"><h2>1) Gantt timeline</h2><svg id="gantt"   viewBox="0 0 1600 440"></svg></div>
      <div class="card"><h2>2) Cumulative mileage</h2><svg id="mileage" viewBox="0 0 1600 320"></svg></div>
      <div class="card"><h2>3) Cumulative KPI coverage</h2><svg id="kpi"     viewBox="0 0 1600 320"></svg></div>
      <div class="card"><h2>4) Distribution (whole campaign)</h2><svg id="dist"    viewBox="0 0 1600 360"></svg></div>
      <div class="card"><h2>5) Campaign exposure by country (tile map)</h2><svg id="tilemap" viewBox="0 0 1600 560"></svg></div>
    </div>
  </div>
</div>

<script>
// ======= State =======
const state = {
  start: new Date(document.getElementById('inp-start').value),
  end:   new Date(document.getElementById('inp-end').value),
  types: {
    XS: { km: +document.getElementById('km-XS').value, kpi: +document.getElementById('kpi-XS').value },
    S:  { km: +document.getElementById('km-S').value,  kpi: +document.getElementById('kpi-S').value  },
    M:  { km: +document.getElementById('km-M').value,  kpi: +document.getElementById('kpi-M').value  },
    L:  { km: +document.getElementById('km-L').value,  kpi: +document.getElementById('kpi-L').value  },
    XL: { km: +document.getElementById('km-XL').value, kpi: +document.getElementById('kpi-XL').value }
  },
  dayPhase: { day:+document.getElementById('inp-day').value, night:+document.getElementById('inp-night').value },
  showWeeks: document.getElementById('inp-weeks').value === '1',
  events: []
};

// ======= Helpers =======
const DAY = 24*3600*1000;
const fmtMonth = d3.timeFormat('%b-%Y');
const fmtDate  = d3.timeFormat('%Y-%m-%d');
function addDays(d, n){ return new Date(d.getTime()+n*DAY); }
function parseCountries(s){ return s.split(',').map(x=>x.trim()).filter(Boolean); }
function toEvent(obj){ return { ...obj, end: addDays(obj.start, obj.days) }; }

function cumulative(events, field, start, end){
  const series = [{date:start, value:0}];
  let cum = 0;
  const sorted = events.slice().sort((a,b)=>a.start-b.start);
  for(const e of sorted){
    const eEnd = (e.end!=null ? e.end : e.start);
    if (e.start>end || eEnd<start) continue;
    const d = new Date(Math.max(e.start, start));
    if (series.at(-1).date.getTime() !== d.getTime()) series.push({date:d, value:cum});

    if(field==='kpi'){
      if(e.type==='SW'){
        const drop = Math.max(0, +((e.drop!=null)?e.drop:(e.kpi||0)));
        cum = Math.max(0, cum * (1 - drop/100));          // relative KPI drop
      } else {
        cum += (e.kpi||0);
      }
    } else if(field==='km'){
      if(e.type==='SW'){
        const dk = Math.max(0, +(e.dropKm||0));
        cum = Math.max(0, cum - dk);                      // absolute km drop
      } else {
        cum += (e.km||0);
      }
    }

    series.push({date:addDays(d,1), value:cum});
  }
  if (series.at(-1).date < end) series.push({date:end, value:cum});
  return series;
}

// ======= UI actions =======
function refreshTypeWeights(){
  state.types.XS.km  = +document.getElementById('km-XS').value; state.types.XS.kpi = +document.getElementById('kpi-XS').value;
  state.types.S.km   = +document.getElementById('km-S').value;  state.types.S.kpi  = +document.getElementById('kpi-S').value;
  state.types.M.km   = +document.getElementById('km-M').value;  state.types.M.kpi  = +document.getElementById('kpi-M').value;
  state.types.L.km   = +document.getElementById('km-L').value;  state.types.L.kpi  = +document.getElementById('kpi-L').value;
  state.types.XL.km  = +document.getElementById('km-XL').value; state.types.XL.kpi = +document.getElementById('kpi-XL').value;
}
function refreshGlobals(){
  state.start = new Date(document.getElementById('inp-start').value);
  state.end   = new Date(document.getElementById('inp-end').value);
  state.dayPhase.day   = +document.getElementById('inp-day').value;
  state.dayPhase.night = +document.getElementById('inp-night').value;
  state.showWeeks = document.getElementById('inp-weeks').value==='1';
}

function addWeeklyXS(){
  refreshTypeWeights(); refreshGlobals();
  const from = new Date(document.getElementById('xs-from').value);
  const to   = new Date(document.getElementById('xs-to').value);
  const days = +document.getElementById('xs-days').value;
  const country = document.getElementById('xs-country').value || 'Sweden';
  let i=1;
  for(let d=new Date(from); d<=to; d=addDays(d,7)){
    state.events.push({ name:`XS ${i++}`, type:'XS', start:new Date(d), days, countries:[country], km:state.types.XS.km, kpi:state.types.XS.kpi, end:addDays(d,days) });
  }
  renderEventsTable(); renderAll();
}

function addWeeklySW(){
  refreshGlobals();
  const from = new Date(document.getElementById('sw-from').value);
  const to   = new Date(document.getElementById('sw-to').value);
  let drop   = +document.getElementById('sw-drop').value;   drop   = Math.max(0, Math.min(100, isFinite(drop) ? drop : 0));
  let dropKm = +document.getElementById('sw-dropkm').value; dropKm = Math.max(0, isFinite(dropKm) ? dropKm : 0);
  const prefix = document.getElementById('sw-prefix').value || 'SW update';

  let i = 1;
  for(let d = new Date(from); d <= to; d = addDays(d, 7)){
    state.events.push({
      name: `${prefix} ${i++}`,
      type: 'SW',
      start: new Date(d),
      days: 0,
      end: new Date(d),
      km: 0,
      kpi: 0,
      drop,
      dropKm,
      countries: []
    });
  }
  renderEventsTable(); renderAll();
}

function addSingleEvent(){
  refreshTypeWeights(); refreshGlobals();
  const name0 = document.getElementById('ev-name').value || 'Unnamed';
  const typeSel = document.getElementById('ev-type').value;
  const isSW = typeSel.toLowerCase().includes('software');
  const type = isSW ? 'SW' : typeSel;
  const start = new Date(document.getElementById('ev-start').value);
  const days  = isSW ? 0 : (+document.getElementById('ev-days').value || 7);
  const countries = isSW ? [] : parseCountries(document.getElementById('ev-countries').value || 'Sweden');
  let km=0, kpi=0, drop=0, dropKm=0;

  if(isSW){
    drop   = +document.getElementById('ev-kpi').value || 0; // KPI drop %
    dropKm = +document.getElementById('ev-km').value || 0;  // mileage drop km
  } else {
    km  = +document.getElementById('ev-km').value || state.types[type].km;
    kpi = +document.getElementById('ev-kpi').value || state.types[type].kpi;
  }

  const name = isSW ? (name0 || 'Software update') : name0;
  state.events.push({ name, type, start, days, end:addDays(start,days), km, kpi, drop, dropKm, countries });
  renderEventsTable(); renderAll();
}

function clearEvents(){ state.events=[]; renderEventsTable(); renderAll(); }
function deleteEvent(idx){ state.events.splice(idx,1); renderEventsTable(); renderAll(); }

function renderEventsTable(){
  const container = document.getElementById('events-table');
  if (!state.events.length){ container.innerHTML = '<div class="note">No events yet.</div>'; return; }
  let html = '<table><thead><tr><th>#</th><th>Name</th><th>Type</th><th>Start</th><th>Days</th><th>KM</th><th>KPI %</th><th>Countries</th><th></th></tr></thead><tbody>';
  state.events.sort((a,b)=>a.start-b.start).forEach((e,i)=>{
    const kmDisp  = (e.type==='SW') ? ((e.dropKm && e.dropKm>0) ? ('âˆ’'+e.dropKm+' km') : 'â€”') : (e.km||0);
    const kpiDisp = (e.type==='SW') ? ((e.drop && e.drop>0) ? ('âˆ’'+e.drop+'%') : 'â€”') : (e.kpi||0);
    const ctyDisp = (e.countries && e.countries.length) ? e.countries.join(', ') : ((e.type==='SW') ? 'â€”' : '');
    html += `<tr><td>${i+1}</td><td>${e.name}</td><td>${e.type}</td><td>${fmtDate(e.start)}</td><td>${e.days}</td><td>${kmDisp}</td><td>${kpiDisp}</td><td>${ctyDisp}</td><td><button class="btn" onclick="deleteEvent(${i})">Delete</button></td></tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

// Example loader
function loadExample(){
  clearEvents(); refreshTypeWeights(); refreshGlobals();
  const add = (o)=>state.events.push(toEvent(o));
  for(let d=new Date('2025-09-01'); d<=new Date('2026-06-30'); d=addDays(d,7)){
    add({ name:`XS`, type:'XS', start:new Date(d), days:1, countries:['Sweden'], km:state.types.XS.km, kpi:state.types.XS.kpi });
  }
  add({ name:'M Abstatt', type:'M', start:new Date('2025-09-01'), days:7, countries:['Germany','Sweden'], km:state.types.M.km, kpi:state.types.M.kpi });
  add({ name:'S Stockholm', type:'S', start:new Date('2025-10-20'), days:7, countries:['Sweden'], km:state.types.S.km, kpi:state.types.S.kpi });
  add({ name:'XL EU expedition 1', type:'XL', start:new Date('2025-11-03'), days:21, countries:['Sweden','Denmark','Germany','Netherlands','Belgium','Switzerland','France','Italy','Spain','Austria','Luxembourg','Greece','Romania','Bulgaria','Slovenia','Croatia','Poland'], km:state.types.XL.km, kpi:state.types.XL.kpi });
  state.events.push({ name:'SW firmware v1.3', type:'SW', start:new Date('2026-02-01'), days:0, end:new Date('2026-02-01'), km:0, kpi:0, drop:20, dropKm:0, countries:[] });
  renderEventsTable(); renderAll();
}

// ======= Rendering (bigger & responsive) =======
function renderAll(){
  refreshTypeWeights(); refreshGlobals();
  const events = state.events.slice().sort((a,b)=>a.start-b.start);

  // Shared X scale from Gantt viewBox
  const ganttVB = d3.select('#gantt').attr('viewBox').split(' ');
  const W = +ganttVB[2];
  const X_L = 80, X_R = 40;
  const x = d3.scaleTime().domain([state.start, state.end]).range([X_L, W - X_R]);

  // 1) Gantt
  (function(){
    const svg = d3.select('#gantt'); svg.selectAll('*').remove();
    const H = +svg.attr('viewBox').split(' ')[3];

    // monthly grid
    const months = d3.timeMonth.range(d3.timeMonth.floor(state.start), state.end);
    svg.append('g').selectAll('line').data(months).join('line')
      .attr('x1', d=>x(d)).attr('x2', d=>x(d)).attr('y1', 16).attr('y2', H-36).attr('class','major-grid');

    const xs = events.filter(e=>e.type==='XS');
    const sw = events.filter(e=>e.type==='SW');
    const named = events.filter(e=>e.type!=='XS' && e.type!=='SW');

    const widthXS = d => Math.max(1, x(d.end) - x(d.start));
    const widthSW = d => {
      const end = (d.days && d.days>0) ? d.end : addDays(d.start, 1);
      return Math.max(1, x(end) - x(d.start));
    };

    function drawRow(arr, y0, fill, label, widthFn, titleFn){
      svg.append('g').selectAll('rect').data(arr).join('rect')
        .attr('x', d=>x(d.start))
        .attr('y', y0-8)
        .attr('width', d=>widthFn(d))
        .attr('height', 16)
        .attr('fill', fill)
        .attr('stroke', '#000')
        .attr('stroke-width', .6)
        .append('title').text(titleFn);
      svg.append('text')
        .attr('x', 10).attr('y', y0+4)
        .attr('fill', '#111').text(label);
    }

    const xsY = 70;
    drawRow(xs, xsY, '#d2d6df', 'XS weekly', widthXS,
            d=>`${d.name} â€” ${fmtDate(d.start)} (${d.km||0} km)`);

    const swY = xsY + 26;
    drawRow(sw, swY, '#9333ea', 'SW updates', widthSW,
            d=>`${d.name} â€” ${fmtDate(d.start)} (KPI âˆ’${d.drop||0}%, km âˆ’${d.dropKm||0})`);

    const colorByType = t => ({S:'#19b6ff', M:'#f4c542', L:'#f59e0b', XL:'#ff4b4b'})[t] || '#8ad';
    const rowHeight=24, rowGap=14; let rowStartY = swY + 26 + 8;

    named.forEach((e,i)=>{
      const y = rowStartY + i*(rowHeight+rowGap);
      svg.append('rect')
        .attr('x', x(e.start))
        .attr('y', y-11)
        .attr('width', Math.max(4, x(e.end)-x(e.start)))
        .attr('height', 22)
        .attr('rx', 4)
        .attr('fill', colorByType(e.type))
        .attr('stroke', '#000')
        .attr('stroke-width', .6)
        .append('title')
        .text(`${e.name} â€¢ ${e.km||0} km (${fmtDate(e.start)} â†’ ${fmtDate(e.end)})\nCountries: ${(e.countries||[]).join(', ')}`);

      const week = d3.utcFormat('W%V')(e.start);
      svg.append('text').attr('x', x(e.end)+6).attr('y', y+4).attr('fill','#111')
        .text(state.showWeeks ? `${e.name} (${week})` : e.name);
    });

    const axis = d3.axisBottom(x).ticks(d3.timeMonth.every(1)).tickFormat(fmtMonth);
    svg.append('g').attr('transform',`translate(0,${H-30})`).attr('class','axis').call(axis)
      .selectAll('text').attr('transform','rotate(45)').attr('text-anchor','start');
  })();

  // 2) Mileage
  (function(){
    const svg = d3.select('#mileage'); svg.selectAll('*').remove();
    const H = +svg.attr('viewBox').split(' ')[3];
    const series = cumulative(events,'km',state.start,state.end);
    const y = d3.scaleLinear().domain([0, d3.max(series, d=>d.value)]).nice().range([H-36, 24]);
    const line = d3.line().x(d=>x(d.date)).y(d=>y(d.value)).curve(d3.curveStepAfter);
    svg.append('path').datum(series).attr('d', line).attr('fill','none').attr('stroke','#111').attr('stroke-width',2);
    svg.append('g').attr('transform',`translate(0,${H-30})`).attr('class','axis').call(d3.axisBottom(x).tickFormat(()=>'')); // share x
    svg.append('g').attr('transform','translate(72,0)').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    svg.append('text').attr('transform', 'translate(30,' + (H/2) + ') rotate(-90)').attr('text-anchor','middle').attr('fill','#111').text('Cumulative mileage (km)');
  })();

  // 3) KPI
  (function(){
    const svg = d3.select('#kpi'); svg.selectAll('*').remove();
    const H = +svg.attr('viewBox').split(' ')[3];
    const series = cumulative(events,'kpi',state.start,state.end);
    const y = d3.scaleLinear().domain([0, Math.max(100, d3.max(series,d=>d.value))]).nice().range([H-36,24]);
    const line = d3.line().x(d=>x(d.date)).y(d=>y(d.value)).curve(d3.curveStepAfter);
    svg.append('path').datum(series).attr('d', line).attr('fill','none').attr('stroke','#1d4ed8').attr('stroke-width',2);
    svg.append('line').attr('x1',X_L).attr('x2',W-X_R).attr('y1',y(100)).attr('y2',y(100)).attr('stroke','#aaa').attr('stroke-dasharray','4 6');
    svg.append('g').attr('transform',`translate(0,${H-30})`).attr('class','axis').call(d3.axisBottom(x).tickFormat(()=>'')); // share x
    svg.append('g').attr('transform','translate(72,0)').attr('class','axis').call(d3.axisLeft(y).ticks(6));
    svg.append('text').attr('transform', 'translate(30,' + (H/2) + ') rotate(-90)').attr('text-anchor','middle').attr('fill','#111').text('Cumulative KPI (%)');
  })();

  // 4) Distribution (whole campaign) with legend (adjusted for SW km drops)
  (function(){
    const svg = d3.select('#dist'); svg.selectAll('*').remove();
    const vb = svg.attr('viewBox').split(' '); const Wd = +vb[2], Hd = +vb[3];

    // Sum km by country from NON-SW events
    const kmByCountry = new Map();
    events.forEach(e=>{
      if(e.type==='SW') return;
      const share=(e.km||0)/((e.countries&&e.countries.length)||1);
      (e.countries||[]).forEach(c=>kmByCountry.set(c,(kmByCountry.get(c)||0)+share));
    });

    // Apply SW mileage drop proportionally
    const totalKmBefore = Array.from(kmByCountry.values()).reduce((a,b)=>a+b,0) || 0;
    const totalDropKm   = events.filter(e=>e.type==='SW').reduce((s,e)=>s + (+(e.dropKm||0)), 0);
    const totalKmAfter  = Math.max(0, totalKmBefore - totalDropKm);
    if(totalKmBefore > 0){
      const scale = (totalKmAfter / totalKmBefore);
      for(const [cty,km] of kmByCountry.entries()){
        kmByCountry.set(cty, km * scale);
      }
    }
    const totalKm = Math.max(1, totalKmAfter);

    const pct = Array.from(kmByCountry, ([name,km])=>({name,pct:100*km/totalKm})).sort((a,b)=>b.pct-a.pct);
    const top6 = pct.slice(0,6); const otherPct = Math.max(0,100-top6.reduce((s,d)=>s+d.pct,0));

    const day = +state.dayPhase.day, night = +state.dayPhase.night;
    const temps = [{label:'Cold (<5Â°C)',v:30,c:'#000'},{label:'Mild (5â€“15Â°C)',v:50,c:'#ff9800'},{label:'Warm (>15Â°C)',v:20,c:'#58c4ff'}];

    const legendWidth = 320;
    const legendX = Wd - legendWidth - 40;
    const groupX = d3.scaleBand().domain(['Countries','Day phase','Temperature']).range([120, legendX - 40]).padding(0.4);
    const y = d3.scaleLinear().domain([0,100]).range([Hd-40, 30]);

    const colorsCountry = {'Sweden':'#f2a900','Denmark':'#00a8a8','Norway':'#2ecc71','Germany':'#00bcd4','Netherlands':'#ffd166','Belgium':'#e74c3c','Other EU':'#c27ba0'};
    const countriesData = [...top6.map(d=>({label:d.name, v:d.pct, c:colorsCountry[d.name]||'#6aa3ff'})), {label:'Other EU', v:otherPct, c:colorsCountry['Other EU']}];
    const dayData = [{label:'Daylight', v:day, c:'#e6b800'},{label:'Twilight/Night', v:night, c:'#0a2a6b'}];
    const tempData = temps;

    stack('Countries', countriesData);
    stack('Day phase', dayData);
    stack('Temperature', tempData);

    svg.append('g').attr('transform','translate(95,0)').attr('class','axis').call(d3.axisLeft(y).ticks(6).tickFormat(d=>d+'%'));
    svg.append('text').attr('transform', 'translate(30,' + (Hd/2) + ') rotate(-90)').attr('text-anchor','middle').attr('fill','#111').text('Share (%)');

    function stack(group, arr){
      const x0 = groupX(group); let bottom = 0;
      arr.forEach(d=>{
        svg.append('rect').attr('x',x0).attr('y',y(bottom+d.v)).attr('width',groupX.bandwidth()).attr('height', y(bottom)-y(bottom+d.v))
          .attr('fill', d.c).attr('stroke','#000').attr('stroke-width',.6)
          .append('title').text(`${group}: ${d.label} â€“ ${d.v.toFixed(1)}%`);
        bottom += d.v;
      });
      svg.append('text').attr('x', x0 + groupX.bandwidth()/2).attr('y', 20).attr('text-anchor','middle').text(group).style('font-weight',600).attr('fill','#111');
    }

    let ly = 36; const lineH = 18;
    const legendG = svg.append('g').attr('class','legend-svg');
    drawSection('Countries', countriesData);
    drawSection('Day phase', dayData);
    drawSection('Temperature', tempData);

    const bbox = legendG.node().getBBox();
    svg.insert('rect', '.legend-svg')
      .attr('x', bbox.x - 8).attr('y', bbox.y - 8)
      .attr('width', bbox.width + 16).attr('height', bbox.height + 16)
      .attr('fill', '#fff').attr('stroke', '#cbd5e1').attr('rx', 8);

    function drawSection(title, items){
      legendG.append('text').attr('x', legendX).attr('y', ly).text(title).attr('fill','#111').style('font-weight',600);
      ly += 14;
      items.forEach(it=>{
        legendG.append('rect').attr('x', legendX).attr('y', ly-11).attr('width', 12).attr('height', 12).attr('rx', 2).attr('fill', it.c).attr('stroke','#000').attr('stroke-width',.6);
        legendG.append('text').attr('x', legendX+16).attr('y', ly).text(it.label).attr('fill', '#111');
        ly += lineH;
      });
      ly += 8;
    }
  })();

  // 5) Tile map (centered; includes SW km drops proportionally)
  (function(){
    const svg = d3.select('#tilemap'); svg.selectAll('*').remove();
    const vb = svg.attr('viewBox').split(' '); const width = +vb[2], height = +vb[3];
    const g = svg.append('g');
    const tiles = new Map([
      [[0,3],['NO','Norway']], [[1,3],['SE','Sweden']], [[2,3],['DK','Denmark']],
      [[3,3],['DE','Germany']], [[4,3],['AT','Austria']], [[5,3],['SI','Slovenia']],
      [[5,4],['HR','Croatia']], [[4,4],['HU','Hungary']], [[3,4],['CZ','Czechia']],
      [[2,4],['NL','Netherlands']], [[2,5],['BE','Belgium']], [[3,5],['PL','Poland']],
      [[4,5],['SK','Slovakia']], [[5,5],['RO','Romania']], [[6,5],['BG','Bulgaria']],
      [[2,6],['LU','Luxembourg']], [[3,6],['FR','France']], [[4,6],['IT','Italy']],
      [[5,6],['GR','Greece']], [[3,7],['CH','Switzerland']], [[3,8],['ES','Spain']], [[2,8],['PT','Portugal']],
      [[4,7],['BA','Bosnia and Herzegovina']], [[4,8],['RS','Serbia']], [[5,7],['AL','Albania']], [[5,8],['MK','North Macedonia']],
      [[2,2],['FI','Finland']], [[1,2],['EE','Estonia']], [[1,1],['IS','Iceland']], [[1,4],['LT','Lithuania']], [[1,5],['LV','Latvia']],
      [[4,2],['UA','Ukraine']]
    ]);

    // Sum non-SW km by country
    const kmByCountry = new Map();
    events.forEach(e=>{
      if(e.type==='SW') return;
      const share=(e.km||0)/((e.countries&&e.countries.length)||1);
      (e.countries||[]).forEach(c=>kmByCountry.set(c,(kmByCountry.get(c)||0)+share));
    });
    // Apply SW mileage drop proportionally
    const totalKmBefore = Array.from(kmByCountry.values()).reduce((a,b)=>a+b,0) || 0;
    const totalDropKm   = events.filter(e=>e.type==='SW').reduce((s,e)=>s + (+(e.dropKm||0)), 0);
    const totalKmAfter  = Math.max(0, totalKmBefore - totalDropKm);
    if(totalKmBefore > 0){
      const scale = (totalKmAfter / totalKmBefore);
      for(const [cty,km] of kmByCountry.entries()){
        kmByCountry.set(cty, km * scale);
      }
    }
    const totalKm = Math.max(1, totalKmAfter);

    // Fill grid with percentages
    const rows=7, cols=10;
    const grid=Array.from({length:rows},()=>Array(cols).fill(NaN));
    const labels=Array.from({length:rows},()=>Array(cols).fill(''));
    tiles.forEach(([lab,name],[r,c])=>{
      grid[r][c]= (kmByCountry.get(name)||0)/totalKm*100;
      labels[r][c]=lab;
    });

    let rmin=rows, rmax=-1, cmin=cols, cmax=-1;
    for(let r=0;r<rows;r++)for(let c=0;c<cols;c++) if(!Number.isNaN(grid[r][c])){rmin=Math.min(rmin,r);rmax=Math.max(rmax,r);cmin=Math.min(cmin,c);cmax=Math.max(cmax,c);}
    const crop = grid.slice(rmin,rmax+1).map(row=>row.slice(cmin,cmax+1));
    const cropL= labels.slice(rmin,rmax+1).map(row=>row.slice(cmin,cmax+1));

    const nR=crop.length, nC=crop[0].length, cell=42, pad=6;
    const gridW=nC*cell, gridH=nR*cell; const originX=(width-gridW)/2, originY=40;
    const maxPct = Math.max(1, d3.max(crop.flat().filter(v=>!Number.isNaN(v)))||1);
    const color = d3.scaleSequential(d3.interpolateOrRd).domain([0,maxPct]);
    const tileG = g.append('g').attr('transform',`translate(${originX},${originY})`);

    for(let r=0;r<nR;r++) for(let c=0;c<nC;c++) if(!Number.isNaN(crop[r][c])){
      const x0=c*cell, y0=r*cell, v=crop[r][c];
      tileG.append('rect').attr('x',x0).attr('y',y0).attr('rx',6).attr('width',cell-pad).attr('height',cell-pad).attr('fill',color(v)).attr('stroke','#111');
      tileG.append('text').attr('x',x0+(cell-pad)/2).attr('y',y0+(cell-pad)/2+5).attr('text-anchor','middle').attr('fill','#111').attr('font-size',13).text(cropL[r][c]);
      tileG.append('title').text(`${cropL[r][c]} â€“ ${v.toFixed(2)}% of km`);
    }

    const legendW=520, legendH=10; const lx=(width-legendW)/2, ly=originY+gridH+48; const legend=g.append('g').attr('transform',`translate(${lx},${ly})`);
    legend.selectAll('rect').data(d3.range(legendW)).join('rect').attr('x',d=>d).attr('y',0).attr('width',1).attr('height',legendH).attr('fill',d=>color(d/legendW*maxPct));
    legend.append('rect').attr('x',0).attr('y',-1).attr('width',legendW).attr('height',legendH+2).attr('fill','none').attr('stroke','#333');
    legend.append('text').attr('x',0).attr('y',legendH+16).text('0%').attr('fill','#111');
    legend.append('text').attr('x',legendW).attr('y',legendH+16).attr('text-anchor','end').text(`${maxPct.toFixed(1)}%`).attr('fill','#111');
    legend.append('text').attr('x',legendW/2).attr('y',legendH+32).attr('text-anchor','middle').text('Share of total campaign km').attr('fill','#111');
  })();
}

// ======= Import / Export helpers =======
function serializeEvent(e){
  return {
    name: e.name || '',
    type: e.type === 'SW' ? 'Software update' : e.type,
    start: fmtDate(e.start),
    days: e.days || 0,
    km: e.type === 'SW' ? 0 : (e.km || 0),
    kpi: e.type === 'SW' ? 0 : (e.kpi || 0),
    drop: e.type === 'SW' ? (e.drop || 0) : 0,
    dropKm: e.type === 'SW' ? (e.dropKm || 0) : 0,
    countries: (e.countries || []).slice()
  };
}

function eventsToCSV(events){
  const rows = [];
  const header = ['name','type','start','days','km','kpi','drop','dropKm','countries'];
  rows.push(header.join(','));
  const esc = v => {
    const s = String(v==null?'':v);
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  for(const e of events){
    const o = serializeEvent(e);
    const cty = o.countries.join('; ');
    rows.push([o.name,o.type,o.start,o.days,o.km,o.kpi,o.drop,o.dropKm,cty].map(esc).join(','));
  }
  return rows.join('\n');
}

function downloadBlob(text, filename, mime='text/plain'){
  const blob = new Blob([text],{type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function splitCSVLine(line){
  const out=[]; let cur=''; let q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(q){
      if(ch==='"' && line[i+1]==='"'){ cur+='"'; i++; }
      else if(ch==='"'){ q=false; }
      else cur+=ch;
    } else {
      if(ch===','){ out.push(cur); cur=''; }
      else if(ch==='"'){ q=true; }
      else cur+=ch;
    }
  }
  out.push(cur);
  return out;
}

function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim()!=='');
  if(!lines.length) return [];
  const header = splitCSVLine(lines[0]).map(h=>h.trim().toLowerCase());
  const idx = k => header.indexOf(k);
  const recs=[];
  for(let i=1;i<lines.length;i++){
    const cols = splitCSVLine(lines[i]);
    const get = k => cols[idx(k)] ?? '';
    const typeRaw = (get('type')||'').trim();
    const type = /software/i.test(typeRaw) ? 'SW' : typeRaw.toUpperCase();
    const start = new Date(get('start'));
    const days  = +get('days') || 0;

    let km    = +get('km')  || 0;
    const kpi = +get('kpi') || 0;
    const drop  = +get('drop')   || 0;
    let dropKm  = (idx('dropkm')>=0) ? (+get('dropkm')||0) : 0;

    // Back-compat: if SW and dropKm missing but km>0, treat km as dropKm
    if(type==='SW'){
      if(dropKm<=0 && km>0){ dropKm = km; }
      km = 0;
    }

    const countries = (get('countries')||'').split(';').map(s=>s.trim()).filter(Boolean);
    recs.push({ name:get('name')||'Imported', type, start, days, end:addDays(start,days), km, kpi, drop, dropKm, countries });
  }
  return recs;
}

function parseMaybeJSON(text){
  try{
    const data = JSON.parse(text);
    if(Array.isArray(data)){
      return data.map(o=>{
        const typeRaw = (o.type||'').toString();
        const type = /software/i.test(typeRaw) ? 'SW' : typeRaw.toUpperCase();
        const start = new Date(o.start||o.date||o.begin||Date.now());
        const days  = +o.days || 0;
        let km    = +o.km  || 0;
        const kpi = +o.kpi || 0;
        const drop   = +o.drop   || 0;
        let dropKm   = +o.dropKm || 0;
        if(type==='SW'){
          if(dropKm<=0 && km>0){ dropKm = km; }
          km = 0;
        }
        const countries = Array.isArray(o.countries) ? o.countries : (typeof o.countries==='string' ? o.countries.split(';').map(s=>s.trim()) : []);
        return { name:o.name||'Imported', type, start, days, end:addDays(start,days), km, kpi, drop, dropKm, countries };
      });
    }
  }catch(e){}
  return null;
}

// ======= Bind UI =======
function openDate(id){ const el=document.getElementById(id); if(!el) return; try{ if(typeof el.showPicker==='function'){ el.showPicker(); } else { el.focus(); el.click(); } } catch(e){ el.focus(); el.click(); } }
document.querySelectorAll('.date-btn').forEach(btn=>btn.addEventListener('click', (ev)=>{ ev.preventDefault(); ev.stopPropagation(); openDate(btn.dataset.target); }));
document.querySelectorAll('.field.date').forEach(div=>div.addEventListener('click', (ev)=>{ if(ev.target.tagName.toLowerCase()!=='input' && !ev.target.classList.contains('date-btn')) openDate(div.dataset.target); }));

document.getElementById('btn-add-xs').addEventListener('click', addWeeklyXS);
document.getElementById('btn-add-sw-weekly').addEventListener('click', addWeeklySW);
document.getElementById('btn-add-one').addEventListener('click', addSingleEvent);
document.getElementById('btn-clear').addEventListener('click', clearEvents);
document.getElementById('btn-render').addEventListener('click', renderAll);
document.getElementById('btn-load-example').addEventListener('click', loadExample);

// Re-render on global changes
;['inp-start','inp-end','inp-day','inp-night','inp-weeks','km-XS','kpi-XS','km-S','kpi-S','km-M','kpi-M','km-L','kpi-L','km-XL','kpi-XL']
  .forEach(id=>document.getElementById(id).addEventListener('change',()=>{
    if(id.startsWith('km-')||id.startsWith('kpi-')) refreshTypeWeights();
    refreshGlobals(); renderAll();
  }));

// ---- Export combined PNG (5 subplots) ----
const SVG_IDS = ['gantt','mileage','kpi','dist','tilemap'];
function getSVGClone(svg){
  const clone = svg.cloneNode(true);
  const style = document.createElement('style');
  style.textContent = '.axis path,.axis line{stroke:#c4c7cf}.major-grid{stroke:#e5e7eb;stroke-dasharray:4 6}';
  clone.insertBefore(style, clone.firstChild);
  clone.setAttribute('xmlns','http://www.w3.org/2000/svg');
  clone.setAttribute('xmlns:xlink','http://www.w3.org/1999/xlink');
  return clone;
}
function svgToBlobURL(svg){
  const clone = getSVGClone(svg);
  const svgStr = new XMLSerializer().serializeToString(clone);
  const blob = new Blob([svgStr], {type:'image/svg+xml;charset=utf-8'});
  return URL.createObjectURL(blob);
}
function parseViewBox(svg){
  const vb = svg.getAttribute('viewBox');
  if(vb){ const parts = vb.trim().split(/\s+/).map(Number); return {w:parts[2], h:parts[3]}; }
  return {w: svg.clientWidth||1200, h: svg.clientHeight||400};
}
async function svgToPNGDataURL(svg, scale=2){
  const {w,h} = parseViewBox(svg);
  const url = svgToBlobURL(svg);
  const img = new Image(); img.crossOrigin='anonymous';
  await new Promise(res=>{ img.onload=res; img.src=url; });
  const canvas = document.createElement('canvas'); canvas.width=w*scale; canvas.height=h*scale;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
  URL.revokeObjectURL(url);
  return {dataUrl: canvas.toDataURL('image/png'), w: w*scale, h: h*scale};
}
function download(href, filename){ const a=document.createElement('a'); a.href=href; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); }
async function exportCombinedPNG(){
  const scale = Math.max(1, +document.getElementById('exp-scale').value || 2);
  const parts = [];
  for(const id of SVG_IDS){
    const svg = document.getElementById(id);
    const {dataUrl, w, h} = await svgToPNGDataURL(svg, scale);
    parts.push({id, dataUrl, w, h});
  }
  const gap = 28*scale; const width = Math.max(...parts.map(p=>p.w)); const height = parts.reduce((s,p)=>s+p.h, 0) + gap*(parts.length-1);
  const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#fff'; ctx.fillRect(0,0,width,height);
  let y=0; for(const p of parts){
    const img = new Image(); await new Promise(res=>{ img.onload=res; img.src=p.dataUrl; });
    const x = (width - p.w)/2; ctx.drawImage(img, x, y, p.w, p.h); y += p.h + gap;
  }
  download(canvas.toDataURL('image/png'), 'ADAS_combined_5_subplots.png');
}
document.getElementById('btn-export-combo').addEventListener('click', exportCombinedPNG);

// ---- Export / Import events ----
document.getElementById('btn-export-csv').addEventListener('click', ()=>{
  const csv = eventsToCSV(state.events.slice().sort((a,b)=>a.start-b.start));
  downloadBlob(csv, 'ADAS_events.csv', 'text/csv;charset=utf-8');
});
document.getElementById('btn-export-json').addEventListener('click', ()=>{
  const json = JSON.stringify(state.events.slice().sort((a,b)=>a.start-b.start).map(serializeEvent), null, 2);
  downloadBlob(json, 'ADAS_events.json', 'application/json;charset=utf-8');
});
document.getElementById('btn-import').addEventListener('click', ()=>{
  document.getElementById('file-input').value = '';
  document.getElementById('file-input').click();
});
document.getElementById('file-input').addEventListener('change', (ev)=>{
  const file = ev.target.files && ev.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    const text = reader.result || '';
    const json = parseMaybeJSON(text);
    let recs = [];
    if(json){ recs = json; }
    else { recs = parseCSV(text); }
    if(!recs.length){ alert('No events found in file. Make sure it is CSV with header: name,type,start,days,km,kpi,drop,dropKm,countries or a JSON array.'); return; }
    state.events.push(...recs);
    renderEventsTable(); renderAll();
  };
  reader.readAsText(file);
});

// initial render
renderAll();
</script>
</body>
</html>
