<!DOCTYPE html>
<html>
<head>
    <title>KPI -- Annotator</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <!-- Chart.js core + Luxon adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>

    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        table { width: 100%; margin: 10px 0; }
        td, th { text-align: center; padding: 10px; }
        .center-groups { display: flex; justify-content: center; align-items: flex-start; }
        #leftColumn2 { margin-left: 20px; }
        .bigButton { display: block; width: 50%; padding: 1px; font-size: 12px; border-radius: 3px; cursor: pointer; margin: 5px auto; }
        .orangeButton { background-color: orange; color: white; }
        .blueButton   { background-color: blue;   color: white; }
        .greyButton   { background-color: grey;   color: white; }
        .greenButton  { background-color: green;  color: white; }
        .redButton    { background-color: red;    color: white; }
        #textBox { width: 90%; margin: 0 auto; padding: 10px; font-size: 12px; resize: vertical; }
        .distanceContainer { display: flex; justify-content: space-between; align-items: center; }
        .weatherSection { display: flex; align-items: center; justify-content: center; }
        .weatherSection img { width: 24px; height: 24px; margin-right: 5px; }
        #map { height: 300px; width: 100%; }
        @media print { .bigButton, #textBox { display: none !important; } }
        .issue-label { background: rgba(255,255,255,0.8); padding: 2px 4px; border-radius: 3px; font-size: 12px; color: #333; white-space: nowrap; pointer-events: none; }
        #countContainer { width: 80%; max-width: 800px; margin: 20px auto; text-align: center; }
        #countTable { width: 100%; border: 1px solid #333; border-collapse: collapse; margin: 0 auto; }
        #countTable td, #countTable th { border: 1px solid #333; }
        #mapContainer { width: 100%; padding: 0; box-sizing: border-box; }
        #chartsContainer { display: flex; width: 100%; box-sizing: border-box; margin-top: 20px; }
        .chartBox { flex: 1; padding: 0 10px; }
        .chartBox canvas { width: 100%; height: 300px; }
        #streetTable { width: 100%; border: 1px solid #333; border-collapse: collapse; margin: 20px auto; }
        #streetTable td, #streetTable th { border: 1px solid #333; padding: 8px; }
        footer { text-align: center; padding: 10px; font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <table>
        <tr>
            <td>
                <p id="dateTime"></p>
                <div class="weatherSection">
                    <img id="weatherIcon" src="" alt="Weather icon">
                    <p id="temperature">Temp: N/A</p>
                </div>
            </td>
            <td><p id="streetCity">Street: N/A<br>City: N/A</p></td>
            <td><p id="location"></p></td>
            <td><p id="roadType">Road type: N/A</p></td>
            <td><p id="speed">Speed: N/A</p></td>
            <td>
                <div class="distanceContainer">
                    <p id="totalDistance">Distance: 0.0 km</p>
                    <button class="bigButton orangeButton" onclick="resetDistance()">Reset distance</button>
                </div>
            </td>
        </tr>
        <tr>
            <td><textarea id="textBox" rows="1" placeholder="Enter your annotation here..."></textarea></td>
            <td><button class="bigButton blueButton" onclick="logButton('Manual annotation', false)">Manual annotation</button></td>
            <td><button class="bigButton greenButton" onclick="saveAndPrint()">Save report to PDF</button></td>
            <td colspan="3"></td>
        </tr>
        <tr>
            <td colspan="6">
                <div class="center-groups">
                    <div id="leftColumn1">
                        <button class="bigButton greyButton">ACC</button>
                        <button class="bigButton redButton" onclick="logButton('ACC False brake', true)">False brake</button>
                        <button class="bigButton redButton" onclick="logButton('ACC Target drop', true)">Target drop</button>
                        <button class="bigButton redButton" onclick="logButton('ACC Longitudinal jerk', true)">Longitudinal jerk</button>
                        <button class="bigButton redButton" onclick="logButton('ACC Accuracy in speed adaption', true)">Accuracy in speed adaption</button>
                    </div>
                    <div id="leftColumn2">
                        <button class="bigButton greyButton">TSI Speed</button>
                        <button class="bigButton greenButton" onclick="logButton('TSI Explicit correct speed detected', false)">Correct explicit speed detected</button>
                        <button class="bigButton redButton" onclick="logButton('TSI Explicit incorrect speed detected', true)">Incorrect explicit speed detected</button>
                    </div>
                </div>
            </td>
        </tr>
    </table>

    <div id="logTableContainer"></div>

    <br><hr><br>
    <div id="mapContainer">
        <h3 style="text-align:center;">Route</h3>
        <div id="map"></div>
    </div>

    <br><hr><br>
    <div id="countContainer">
        <h3>KPI Calculation</h3>
        <table id="countTable">
            <tr><th>Issue</th><th>Total No of events</th><th>Events per 1000 km</th></tr>
            <tr><td colspan="3">&nbsp;</td></tr>
        </table>
    </div>

    <br><hr><br>
    <div id="chartsContainer">
        <div class="chartBox">
            <h3 style="text-align:center;">Distance vs Time</h3>
            <canvas id="distanceChart"></canvas>
        </div>
        <div class="chartBox">
            <h3 style="text-align:center;">Speed vs Distance</h3>
            <canvas id="speedChart"></canvas>
        </div>
    </div>

    <br><hr><br>
    <div id="streetsContainer">
        <h3 style="text-align:center;">Road Types Encountered</h3>
        <table id="streetTable">
            <tr><th>Road type</th><th>Cumulative distance (km)</th></tr>
        </table>
    </div>

    <!-- Dependencies -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var logTable      = [];
        var redCounts     = {};
        var lastPosition  = null;
        var totalDistance = 0;
        var currentTemp   = 'N/A', currentCondition = 'N/A';
        var positions     = [];
        var map, trackLine;
        var timeData      = [], distData = [], speedData = [];
        var roadTypeSet   = new Set();
        var roadDistance  = {}; // cumulative km per road type
        var distanceChart, speedChart;

        function initMap() {
            map = L.map('map').setView([0,0],2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            trackLine = L.polyline([], { weight: 4 }).addTo(map);
        }

        function initCharts() {
            var ctx1 = document.getElementById('distanceChart').getContext('2d');
            distanceChart = new Chart(ctx1, {
                type: 'line',
                data: { labels: timeData, datasets:[{ label:'Distance (km)', data: distData, fill:false, tension:0.1 }] },
                options:{
                    responsive:true,
                    scales:{
                        x:{ type:'time', time:{ unit:'minute', tooltipFormat:'HH:mm:ss' }},
                        y:{ beginAtZero:true }
                    }
                }
            });
            var ctx2 = document.getElementById('speedChart').getContext('2d');
            speedChart = new Chart(ctx2, {
                type: 'line',
                data:{ labels: distData, datasets:[{ label:'Speed (km/h)', data: speedData, fill:false, tension:0.1 }] },
                options:{
                    responsive:true,
                    scales:{
                        x:{ type:'linear', title:{ display:true, text:'Distance (km)' }},
                        y:{ beginAtZero:true, title:{ display:true, text:'Speed (km/h)' }}
                    }
                }
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000, toRad = Math.PI/180;
            const dLat = (lat2 - lat1) * toRad, dLon = (lon2 - lon1) * toRad;
            const a = Math.sin(dLat/2)**2 +
                      Math.cos(lat1*toRad)*Math.cos(lat2*toRad)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function showPosition(pos) {
            const lat = pos.coords.latitude, lon = pos.coords.longitude, t = pos.timestamp;
            let segmentKm = 0, moved = false;

            if (lastPosition) {
                const d = calculateDistance(lastPosition.latitude, lastPosition.longitude, lat, lon),
                      dt = (t - lastPosition.timestamp)/1000;
                if (dt>0) {
                    moved = true;
                    segmentKm = d/1000;
                    const speedKmh = (d/dt)*3.6;
                    document.getElementById('speed').innerHTML = `Speed: ${speedKmh.toFixed(1)} km/h`;
                    totalDistance += d;
                    document.getElementById('totalDistance').innerHTML = `Distance: ${(totalDistance/1000).toFixed(1)} km`;
                    timeData.push(new Date(t));
                    distData.push((totalDistance/1000).toFixed(3));
                    speedData.push(speedKmh.toFixed(1));
                    distanceChart.update();
                    speedChart.update();
                    updateCountTable();
                }
            }

            lastPosition = { latitude: lat, longitude: lon, timestamp: t };
            positions.push([lat, lon]);
            trackLine.setLatLngs(positions);
            if (positions.length>1) map.fitBounds(trackLine.getBounds().pad(0.2));

            fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&extratags=1&lat=${lat}&lon=${lon}`)
                .then(r=>r.json())
                .then(data=>{
                    const rt = (data.extratags&&data.extratags.highway)?data.extratags.highway:data.type||'Unknown';
                    document.getElementById('roadType').innerHTML = `Road type: ${rt}`;
                    roadTypeSet.add(rt);
                    if (moved) roadDistance[rt] = (roadDistance[rt]||0)+segmentKm;
                    updateStreetTable();
                    const city = data.address.city||data.address.town||data.address.village;
                    if (city) getWeather(city);
                })
                .catch(e=> document.getElementById('streetCity').innerText = 'Error: '+e.message);
        }

        function updateStreetTable() {
            const tbl = document.getElementById('streetTable'),
                  header = '<tr><th>Road type</th><th>Cumulative distance (km)</th></tr>',
                  rows = Array.from(roadTypeSet).map(rt=>{
                    return `<tr><td>${rt}</td><td>${(roadDistance[rt]||0).toFixed(3)}</td></tr>`;
                  }).join('');
            tbl.innerHTML = header + rows;
        }

        function resetDistance() {
            totalDistance = 0;
            lastPosition  = null;
            document.getElementById('totalDistance').innerHTML = 'Distance: 0.0 km';
            document.getElementById('speed').innerHTML = 'Speed: N/A';
            timeData.length = distData.length = speedData.length = 0;
            roadTypeSet.clear();
            roadDistance = {};
            distanceChart.update();
            speedChart.update();
            updateCountTable();
            updateStreetTable();
        }

        function saveAndPrint() {
            logButton('Save report to PDF', false);
            window.print();
        }

        function logButton(name, isRed) {
            const dt = new Date(),
                  date = dt.toLocaleDateString(),
                  time = dt.toLocaleTimeString(),
                  loc = document.getElementById('location').innerHTML.split('<br>'),
                  lat = loc[0].split(': ')[1],
                  lon = loc[1].split(': ')[1],
                  dist = (totalDistance/1000).toFixed(1),
                  spd = document.getElementById('speed').innerText.split(' ')[1],
                  rt  = document.getElementById('roadType').innerText.split(': ')[1],
                  comment = document.getElementById('textBox').value;
            logTable.push([name,date,time,currentTemp,currentCondition,lat,lon,dist,spd,rt,comment]);
            displayLogTable();
            L.marker([+lat,+lon],{icon:L.divIcon({className:'issue-label',html:`<strong>${name}</strong>`})}).addTo(map);
            if (isRed) {
                redCounts[name] = (redCounts[name]||0)+1;
                updateCountTable();
            }
            document.getElementById('textBox').value = '';
        }

        function displayLogTable() {
            let html = `<table><tr>
                <th>No.</th><th>Issue</th><th>Date</th><th>Time</th>
                <th>Temp</th><th>Weather</th><th>Latitude</th><th>Longitude</th>
                <th>Distance (km)</th><th>Speed (km/h)</th><th>Road type</th><th>Comment</th>
            </tr>`;
            logTable.forEach((row,i)=>{
                html += `<tr><td>${i+1}</td>${row.map(v=>`<td>${v}</td>`).join('')}</tr>`;
            });
            html += '</table>';
            document.getElementById('logTableContainer').innerHTML = html;
        }

        function updateCountTable() {
            const tbl = document.getElementById('countTable'),
                  dkm = totalDistance/1000;
            let rows = `<tr><th>Issue</th><th>Total No of events</th><th>Events per 1000 km</th></tr>`;
            for (let issue in redCounts) {
                const c = redCounts[issue],
                      r = dkm>0 ? ((c/dkm)*1000).toFixed(1) : '—';
                rows += `<tr><td>${issue}</td><td>${c}</td><td>${r}</td></tr>`;
            }
            tbl.innerHTML = rows;
        }

        function showError(e) {
            document.getElementById('location').innerText = 'Error: ' + e.message;
            document.getElementById('speed').innerText = 'Speed: N/A';
        }

        function getWeather(city) {
            fetch(`https://api.weatherapi.com/v1/current.json?key=ad8caecea06c43d1912181930407&q=${encodeURIComponent(city)}`)
                .then(r=>r.json()).then(d=>{
                    document.getElementById('weatherIcon').src = 'https:' + d.current.condition.icon;
                    currentTemp      = d.current.temp_c + '°C';
                    currentCondition = d.current.condition.text;
                    document.getElementById('temperature').innerText = 'Temp: ' + currentTemp;
                });
        }

        function updateDateTime() {
            document.getElementById('dateTime').innerText = new Date().toLocaleString();
        }

        window.onload = function() {
            initMap();
            initCharts();
            setInterval(updateLocation, 1000);
            setInterval(updateDateTime, 1000);
        };

        function updateLocation() {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        }
    </script>

    <footer>
      © Lynoit Tech 2025
    </footer>
</body>
</html>
