<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annotator</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Chart.js core + Luxon adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>

  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #sidebar {
      position: fixed; top: 0; left: 0; height: 100%; width: 260px;
      transform: translateX(-230px); transition: transform .3s ease;
      background: #fff; box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      overflow-y: auto; padding: 50px 10px 10px; z-index: 1000;
    }
    #sidebar.collapsed { transform: translateX(-230px); }
    #sidebar.expanded  { transform: translateX(0); }
    #toggleSidebar {
      position: fixed; top: 10px; left: 10px;
      background: #007bff; border: none; color: #fff;
      font-size: 1.5em; padding: 4px 8px; cursor: pointer;
      border-radius: 4px; z-index: 1100;
    }

    .spinner {
      border: 2px solid rgba(0,0,0,0.1);
      border-left-color: #333;
      border-radius: 50%; width: 16px; height: 16px;
      animation: spin .8s linear infinite; display: inline-block;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #totalDistance.updated { transition: background .5s; background: yellow; }

    .bigButton { display: block; width: 80%; min-width: 80px; padding: 12px; font-size: 14px; border-radius: 4px; cursor: pointer; margin: 8px auto; }
    .orangeButton { background-color: orange; color: white; }
    .blueButton   { background-color: blue;   color: white; }
    .greyButton   { background-color: grey;   color: white; }
    .greenButton  { background-color: green;  color: white; }
    .redButton    { background-color: red;    color: white; }

    #mainContent { margin-left: 280px; padding: 20px; box-sizing: border-box; }

    /* ── Manual Annotation Layout ── */
    #manualAnnotation {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      margin-bottom: 20px;
    }
    #manualAnnotation textarea {
      flex: 1;
      resize: vertical;
      font-size: 14px;
      padding: 8px;
    }
    #manualAnnotation button {
      display: inline-block;
      width: auto;
      padding: 6px 10px;
      font-size: 12px;
      margin: 0;
      white-space: nowrap;
    }

    table { width: 100%; margin: 10px 0; border-collapse: collapse; }
    td, th { text-align: center; padding: 10px; }
    .center-groups { display: flex; justify-content: center; align-items: flex-start; gap: 20px; }

    .section { margin-bottom: 30px; }
    .page-break { page-break-after: always; }

    @media print {
      #sidebar, #toggleSidebar { display: none !important; }
      .page-break { display: block; }
    }
  </style>
</head>
<body>
  <button id="toggleSidebar" aria-expanded="false">☰</button>
  <div id="sidebar" class="collapsed">
    <p id="dateTime"></p>
    <div class="weatherSection">
      <img id="weatherIcon" src="" alt="Weather">
      <p id="temperature">Temp: N/A</p>
    </div>
    <p id="streetCity">Street: N/A<br>City: N/A</p>
    <p id="location"></p>
    <p id="roadType">Road type: N/A</p>
    <p id="speed">Speed: N/A</p>
    <div class="distanceContainer">
      <p id="totalDistance">Distance: 0.0 km</p>
      <button class="bigButton orangeButton" onclick="resetDistance()">Reset distance</button>
    </div>
    <button class="bigButton greenButton" onclick="saveAndPrint()">Save report to PDF</button>
  </div>

  <div id="mainContent">
    <!-- ── Manual Annotation Section (moved & resized) ── -->
    <div id="manualAnnotation" class="section">
      <textarea id="textBox" rows="2" placeholder="Enter your annotation here…"></textarea>
      <button class="blueButton" onclick="logButton('Manual annotation', false)">
        Manual annotation
      </button>
    </div>
    
    <div style="margin-bottom:10px; display:flex; align-items:center; gap:6px;">
      <input type="checkbox" id="showButtons" checked>
      <label for="showButtons">Show buttons</label>
      <div id="buttonGroups" class="center-groups"></div>
    </div>
    
    <div id="logTableContainer" class="section"></div>
    <div class="page-break"></div>

    <div id="mapContainer" class="section">
      <h3>Route</h3>
      <div id="map" style="height:300px;width:100%;"></div>
    </div>
    <div class="page-break"></div>

    <div id="countContainer" class="section">
      <h3>KPI Calculation</h3>
      <table id="countTable">
        <tr><th>Issue</th><th>Total No of events</th><th>Events per 1000 km</th></tr>
        <tr><td colspan="3">&nbsp;</td></tr>
      </table>
    </div>
    <div class="page-break"></div>

    <div id="chartsContainer" class="section" style="display:flex; gap:10px;">
      <div class="chartBox" style="flex:1;">
        <h3>Distance vs Time</h3>
        <canvas id="distanceChart"></canvas>
      </div>
      <div class="chartBox" style="flex:1;">
        <h3>Speed vs Distance</h3>
        <canvas id="speedChart"></canvas>
      </div>
    </div>
    <div class="page-break"></div>

    <div id="streetsContainer" class="section">
      <h3>Road Types Encountered</h3>
      <table id="streetTable"><tr><th>Road type</th></tr></table>
    </div>

    <footer style="text-align:center; padding:10px; font-size:12px; color:#666;">
      © Lynoit Tech 2025
    </footer>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // DOM refs
    const toggleBtn = document.getElementById('toggleSidebar');
    const sidebar   = document.getElementById('sidebar');
    const locEl     = document.getElementById('location');
    const roadTypeEl= document.getElementById('roadType');
    const streetCityEl=document.getElementById('streetCity');
    const tempEl    = document.getElementById('temperature');
    const iconEl    = document.getElementById('weatherIcon');
    const distEl    = document.getElementById('totalDistance');
    const speedEl   = document.getElementById('speed');
    const countTbl  = document.getElementById('countTable');
    const streetTbl = document.getElementById('streetTable');
    const logContainer = document.getElementById('logTableContainer');
    const buttonGroups = document.getElementById('buttonGroups');

    let logTable=[], redCounts={}, lastPos=null, totalDist=0;
    let positions=[], timeData=[], distData=[], speedData=[];
    let map, trackLine, distanceChart, speedChart;
    let roadTypes=new Set(), lastChartTs=0, posCount=0, lastCity=null;

    toggleBtn.onclick = () => {
      const exp = sidebar.classList.toggle('expanded');
      sidebar.classList.toggle('collapsed', !exp);
      toggleBtn.setAttribute('aria-expanded', exp);
    };

    window.onload = () => {
      initMap(); initCharts(); updateDateTime(); setInterval(updateDateTime,1000);
      navigator.geolocation.watchPosition(showPosition,showError,{enableHighAccuracy:true,maximumAge:5000,timeout:10000});
      buildButtons();
    };

    function initMap(){
      map=L.map('map').setView([0,0],2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap contributors'}).addTo(map);
      trackLine=L.polyline([],{weight:4}).addTo(map);
    }
    function initCharts(){
      distanceChart=new Chart(document.getElementById('distanceChart').getContext('2d'),{type:'line',data:{labels:timeData,datasets:[{label:'Distance (km)',data:distData,fill:false,tension:0.1}]},options:{responsive:true,scales:{x:{type:'time',time:{unit:'minute',tooltipFormat:'HH:mm:ss'}},y:{beginAtZero:true}}}});
      speedChart=new Chart(document.getElementById('speedChart').getContext('2d'),{type:'line',data:{labels:distData,datasets:[{label:'Speed (km/h)',data:speedData,fill:false,tension:0.1}]},options:{responsive:true,scales:{x:{type:'linear',title:{display:true,text:'Distance (km)'}},y:{beginAtZero:true,title:{display:true,text:'Speed (km/h)'}}}}});
    }

    function showPosition(pos){
      const {latitude:lat,longitude:lon}=pos.coords,ts=pos.timestamp;
      if(lastPos){const d=calculateDistance(lastPos.lat,lastPos.lon,lat,lon);if(d<10)return;totalDist+=d;}
      const prev=lastPos; lastPos={lat,lon,ts}; posCount++;
      trackLine.addLatLng([lat,lon]); if(positions.length===0)map.setView([lat,lon],15);else if(posCount%20===0)map.fitBounds(trackLine.getBounds().pad(0.2)); positions.push([lat,lon]);
      if(prev){const dt=(ts-prev.ts)/1000;const speedKmh=dt>0?(totalDist/dt)*3.6:0;speedEl.textContent=`Speed: ${speedKmh.toFixed(1)} km/h`;}
      distEl.textContent=`Distance: ${(totalDist/1000).toFixed(1)} km`;distEl.classList.add('updated');setTimeout(()=>distEl.classList.remove('updated'),500);
      if(Date.now()-lastChartTs>5000){timeData.push(new Date(ts));distData.push((totalDist/1000).toFixed(3));speedData.push(speedEl.textContent.split(' ')[1]);requestAnimationFrame(()=>{distanceChart.update();speedChart.update();});lastChartTs=Date.now();}
      locEl.innerHTML=`Lat: ${lat}<br>Lon: ${lon}`;
      fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`)
        .then(r=>r.json())
        .then(data=>{
          const rt=data.extratags?.highway||data.type||'Unknown'; roadTypes.add(rt); updateStreetTable();
          const st=data.address.road||data.address.pedestrian||data.address.footway||'Unknown street';
          const ct=data.address.city||data.address.town||data.address.village||'Unknown city'; streetCityEl.innerHTML=`Street: ${st}<br>City: ${ct}`;
          if(ct!==lastCity){lastCity=ct;getWeather(ct);}
        })
        .catch(err=>{streetCityEl.textContent='Error: '+err.message;});
    }
    
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6_371_000;          // earth’s radius in meters
      const toRad = Math.PI / 180;
      const φ1 = lat1 * toRad;
      const φ2 = lat2 * toRad;
      const dφ = (lat2 - lat1) * toRad;
      const dλ = (lon2 - lon1) * toRad;

      const a = Math.sin(dφ/2)**2
          + Math.cos(φ1) * Math.cos(φ2) * Math.sin(dλ/2)**2;

      // clamp (1 - a) to [0,1] to avoid small floating‑point overshoot
      const oneMinusA = Math.max(0, 1 - a);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(oneMinusA));
      return R * c;  // distance in meters
    }
    
    function updateStreetTable(){let html='<tr><th>Road type</th></tr>';[...roadTypes].forEach(rt=>html+=`<tr><td>${rt}</td></tr>`);streetTbl.innerHTML=html;}
    function resetDistance(){totalDist=0;lastPos=null;positions=[];roadTypes.clear();distEl.textContent='Distance: 0.0 km';speedEl.textContent='Speed: N/A';timeData=[];distData=[];speedData=[];trackLine.setLatLngs([]);map.setView([0,0],2);updateStreetTable();updateCountTable();}
    function saveAndPrint(){const btn=event.currentTarget;btn.disabled=true;const orig=btn.textContent;btn.innerHTML='<span class="spinner"></span> Generating…';logButton('Save report to PDF',false);setTimeout(()=>{window.print();btn.disabled=false;btn.textContent=orig;},500);}
    function showError(e){locEl.textContent='Error: '+e.message;speedEl.textContent='Speed: N/A';}
    function getWeather(city){fetch(`https://api.weatherapi.com/v1/current.json?key=ad8caecea06c43d1912181938230407&q=${encodeURIComponent(city)}`)
        .then(r=>r.json()).then(d=>{const iconPath=d.current.condition.icon||'';const iconUrl=iconPath.startsWith('//')?'https:'+iconPath:iconPath;iconEl.src=iconUrl;iconEl.alt=d.current.condition.text||'weather';tempEl.textContent=`Temp: ${d.current.temp_c}°C`;}).catch(err=>{tempEl.textContent='Temp: N/A';console.error('Weather error',err);});}
    function logButton(name,isRed){const dt=new Date(),date=dt.toLocaleDateString(),time=dt.toLocaleTimeString();const [lat,lon]=locEl.innerHTML.split('<br>').map(l=>l.split(': ')[1]);const dist=(totalDist/1000).toFixed(1),spd=speedEl.textContent.split(' ')[1];const rt=roadTypeEl.textContent.split(': ')[1];const comment=document.getElementById('textBox').value;logTable.push([name,date,time,tempEl.textContent,iconEl.alt,lat,lon,dist,spd,rt,comment]);displayLogTable();L.marker([+lat,+lon],{icon:L.divIcon({className:'issue-label',html:`<strong>${name}</strong>`})}).addTo(map);if(isRed){redCounts[name]=(redCounts[name]||0)+1;updateCountTable();}document.getElementById('textBox').value='';}
    function displayLogTable(){let html=`<table><tr><th>No.</th><th>Issue</th><th>Date</th><th>Time</th><th>Temp</th><th>Weather</th><th>Lat</th><th>Lon</th><th>Dist (km)</th><th>Speed</th><th>Road</th><th>Comment</th></tr>`;logTable.forEach((row,i)=>{html+=`<tr><td>${i+1}</td>`+row.map(v=>`<td>${v}</td>`).join('')+'</tr>';});html+='</table>';logContainer.innerHTML=html;}
    function updateCountTable(){let html='<tr><th>Issue</th><th>Total No of events</th><th>Events per 1000 km</th></tr>';const km=totalDist/1000;for(let issue in redCounts){const c=redCounts[issue];const per=km>0?((c/km)*1000).toFixed(1):'—';html+=`<tr><td>${issue}</td><td>${c}</td><td>${per}</td></tr>`;}countTbl.innerHTML=html;}

    // Build buttons from CSV using fetch + PapaParse
    function buildButtons() {
      fetch('buttons.csv')
        .then(response => {
          if (!response.ok) throw new Error('Failed to load buttons.csv');
          return response.text();
        })
        .then(csv => {
          const { data, errors } = Papa.parse(csv, { header: true, skipEmptyLines: true });
          if (errors.length) console.error('CSV parse errors', errors);
          const groups = {};
          data.forEach(({ group, label, cssClass, logName, isRed }) => {
            if (!group || !label) return;
            if (!groups[group]) {
              const div = document.createElement('div');
              div.className = 'button-group';
              groups[group] = div;
              buttonGroups.appendChild(div);
            }
            const btn = document.createElement('button');
            btn.textContent = label;
            btn.classList.add('bigButton', cssClass);
            btn.onclick = () => logButton(logName, isRed === 'true');
            groups[group].appendChild(btn);
          });
        })
        .catch(err => console.error(err));
    }

    function updateDateTime() { document.getElementById('dateTime').textContent = new Date().toLocaleString(); }
  </script>
</body>
</html>
