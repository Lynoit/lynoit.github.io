<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lynoit Invoice No Tool (Azure)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; margin-bottom: 12px; }
    label { display: grid; gap: 6px; font-size: 14px; }
    input { padding: 8px; font-size: 14px; min-width: 220px; }
    input[readonly] { background: #f3f3f3; }
    button { padding: 10px 14px; font-size: 14px; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    table { border-collapse: collapse; margin-top: 12px; width: 100%; max-width: 900px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f7f7f7; }
    .status { margin-top: 10px; font-size: 14px; }
    .ok { color: #0a7a0a; }
    .err { color: #b00020; }
    .hint { color: #666; font-size: 13px; margin-top: 8px; line-height: 1.35; }
    code { background: #f4f4f4; padding: 1px 4px; border-radius: 4px; }
  </style>
</head>
<body>
  <h2>Lynoit Invoice No Tool (Azure)</h2>

  <div class="row">
    <button id="reload">Reload from Azure</button>
    <button id="saveClose" disabled>Save and close</button>
  </div>

  <div class="row">
    <label>
      Date
      <input id="date" type="date" />
    </label>

    <label>
      Description
      <input id="desc" type="text" placeholder="e.g., Thomas Stuttgart" />
    </label>

    <label>
      New Invoice No
      <input id="no" type="number" readonly />
    </label>

    <button id="add" disabled>Add row</button>
  </div>

  <div class="hint">
    Reads/writes <code>Lynoit_invoice_no.csv</code> from Azure Blob Storage via SAS URL.
  </div>

  <div class="status" id="status"></div>

  <table id="table">
    <thead>
      <tr><th>Date</th><th>Description</th><th>No</th></tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
(() => {
  // === CONFIG ===
  // Paste your FULL Azure Blob SAS URL here (blob URL + ?sv=... token)
  //const BLOB_SAS_URL = "https://lynoit.blob.core.windows.net/?sv=2024-11-04&ss=bfqt&srt=sco&sp=rwdlacupiytfx&se=2028-01-08T15:13:58Z&st=2026-02-19T06:58:58Z&spr=https&sig=9%2B6OIVAP9QbNV51XT4BzqijTeJc0ZpdOVK9egP48AN0%3D";
  //const BLOB_SAS_URL = "https://lynoit.blob.core.windows.net/lynoit/Lynoit_invoice_no.csv?sv=2024-11-04&ss=bfqt&srt=sco&sp=rwdlacupiytfx&se=2028-01-08T15:13:58Z&st=2026-02-19T06:58:58Z&spr=https&sig=9%2B6OIVAP9QbNV51XT4BzqijTeJc0ZpdOVK9egP48AN0%3D";

  //     const SAS_TOKEN = 'sv=2024-11-04&ss=bfqt&srt=co&sp=rwdlacupiytfx&se=2026-12-31T14:25:22Z&st=2026-01-02T06:10:22Z&spr=https&sig=EYJzJkVswHh9jljAsy506gTIQ7fQMGuF6kJUCSIx%2BZQ%3D';    

  //const BLOB_SAS_URL = 'https://lynoit.blob.core.windows.net/lynoit/Lynoit_invoice_no.csv?sv=2024-11-04&ss=bfqt&srt=sco&sp=rwdlacupiytfx&se=2028-01-08T15:13:58Z&st=2026-02-19T06:58:58Z&spr=https&sig=9%2B6OIVAP9QbNV51XT4BzqijTeJc0ZpdOVK9egP48AN0%3D';

  //const BLOB_SAS_URL = 'https://lynoit.blob.core.windows.net/lynoit/Lynoit_invoice_no.csv?sp=r&st=2026-02-19T10:02:01Z&se=2027-02-25T18:17:01Z&spr=https&sv=2024-11-04&sr=c&sig=SEH%2FJheQ5S8ff2StvXcup4Xta9UP746%2Fe1mgGtJE4JI%3D';

  const BLOB_SAS_URL = "https://lynoit.blob.core.windows.net/lynoit/Lynoit_invoice_no.csv?sp=rcw&st=2026-02-18T10:00:00Z&se=2027-07-21T17:31:28Z&spr=https&sv=2024-11-04&sr=b&sig=eXv89EpwbEkIp%2FIZwP9tWLxttLdADZENeDvM%2FwcMa%2Bs%3D";
  
  // === UI ===
  const statusEl = document.getElementById("status");
  const tbody = document.querySelector("#table tbody");
  const reloadBtn = document.getElementById("reload");
  const saveCloseBtn = document.getElementById("saveClose");
  const addBtn = document.getElementById("add");
  const dateEl = document.getElementById("date");
  const descEl = document.getElementById("desc");
  const noEl   = document.getElementById("no");

  // === STATE ===
  let delimiter = ",";
  let rows = [];
  let pendingAdded = false;

  function setStatus(msg, kind="") {
    statusEl.className = "status " + (kind || "");
    statusEl.textContent = msg;
  }

  function detectDelimiter(text) {
    const firstLine = (text.split(/\r?\n/).find(l => l.trim().length) || "");
    return firstLine.includes("\t") ? "\t" : ",";
  }

  function parseDelimited(text, delim) {
    const lines = text.split(/\r?\n/).filter(l => l.length > 0);
    if (lines.length === 0) return { headers: ["Date","Description","No"], rows: [] };

    const parseLine = (line) => {
      const out = [];
      let cur = "", inQ = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQ && line[i+1] === '"') { cur += '"'; i++; }
          else inQ = !inQ;
        } else if (!inQ && ch === delim) {
          out.push(cur); cur = "";
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out;
    };

    const hdr = parseLine(lines[0]).map(s => s.trim());
    const data = [];
    for (let i = 1; i < lines.length; i++) {
      const vals = parseLine(lines[i]);
      if (vals.every(v => String(v).trim() === "")) continue;
      const obj = {};
      hdr.forEach((h, idx) => obj[h] = (vals[idx] ?? "").trim());
      data.push(obj);
    }
    return { headers: hdr, rows: data };
  }

  function escapeField(v, delim) {
    const s = String(v ?? "");
    const mustQuote = s.includes('"') || s.includes("\n") || s.includes("\r") || s.includes(delim) || s.includes("\t");
    if (!mustQuote) return s;
    return '"' + s.replaceAll('"', '""') + '"';
  }

  function toDelimited(data, delim) {
    const hdr = ["Date","Description","No"];
    const head = hdr.join(delim);
    const body = data.map(r => hdr.map(h => escapeField(r[h], delim)).join(delim)).join("\n");
    return head + "\n" + (body ? body + "\n" : "");
  }

  function renderTable() {
    tbody.innerHTML = "";
    for (const r of rows) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.Date ?? ""}</td><td>${r.Description ?? ""}</td><td>${r.No ?? ""}</td>`;
      tbody.appendChild(tr);
    }
  }

  function computeNextNo() {
    let maxNo = 0;
    for (const r of rows) {
      const n = parseInt(r.No, 10);
      if (!Number.isNaN(n)) maxNo = Math.max(maxNo, n);
    }
    return maxNo + 1;
  }

  function initDefaults() {
    const today = new Date();
    dateEl.value = today.toISOString().slice(0, 10);
    noEl.value = computeNextNo();
    pendingAdded = false;
    saveCloseBtn.disabled = true;
    addBtn.disabled = false;
  }

  function normalizeRows(parsedRows) {
    return parsedRows.map(r => ({
      Date: r.Date ?? r["date"] ?? r["DATE"] ?? "",
      Description: r.Description ?? r["Desc"] ?? r["description"] ?? "",
      No: r.No ?? r["no"] ?? r["NO"] ?? ""
    }));
  }

  async function loadCsvFromAzure() {
  setStatus("Loading CSV from Azure...", "");
  try {
    // Helpful: show which origin the browser is using
    // If you opened the HTML as file:// it will be "null"
    console.log("Page origin:", window.location.origin);

    const resp = await fetch(BLOB_SAS_URL, {
      cache: "no-store",
      // credentials: "omit" // default; keep simple
    });

    if (!resp.ok) {
      const t = await resp.text().catch(() => "");
      throw new Error(`HTTP ${resp.status} ${resp.statusText} — ${t.slice(0,200)}`);
    }

    const text = await resp.text();

    delimiter = detectDelimiter(text);
    const parsed = parseDelimited(text, delimiter);
    rows = normalizeRows(parsed.rows);

    renderTable();
    initDefaults();

    setStatus(`Loaded ${rows.length} row(s) from Azure.`, "ok");
  } catch (e) {
    // This typically triggers on CORS/network; browsers hide details.
    setStatus("Load failed: " + (e?.message || e), "err");
    console.error("Fetch error:", e);

    // A hint to you in the UI about the common cause:
    if (window.location.origin === "null") {
      setStatus("Load failed: likely CORS. You opened this as file:// (Origin is null). Serve the HTML via http(s) OR allow Origin: null in Azure CORS.", "err");
    } else {
      setStatus("Load failed: likely CORS. Check Azure Storage CORS for Blob service (allow your site origin, GET/PUT, and headers).", "err");
    }

    addBtn.disabled = true;
    saveCloseBtn.disabled = true;
  }
}

  async function saveCsvToAzure(csvText) {
    // Azure Blob overwrite via PUT requires these headers.
    // We use x-ms-blob-type: BlockBlob for a normal blob.
    const resp = await fetch(BLOB_SAS_URL, {
      method: "PUT",
      headers: {
        "x-ms-blob-type": "BlockBlob",
        "Content-Type": "text/csv; charset=utf-8"
      },
      body: csvText
    });

    if (!resp.ok) {
      const msg = await resp.text().catch(() => "");
      throw new Error(`Azure save failed (HTTP ${resp.status}). ${msg}`.trim());
    }
  }

  addBtn.addEventListener("click", () => {
    const d = dateEl.value?.trim();
    const desc = descEl.value?.trim();

    if (!d) return setStatus("Please select a date.", "err");
    if (!desc) return setStatus("Please enter a description.", "err");

    const newNo = computeNextNo();
    const newRow = { Date: d, Description: desc, No: String(newNo) };

    rows.push(newRow);
    renderTable();

    noEl.value = computeNextNo();
    descEl.value = "";

    pendingAdded = true;
    saveCloseBtn.disabled = false;
    setStatus(`Added row with invoice no ${newRow.No}. Click “Save and close” to write to Azure.`, "ok");
  });

  saveCloseBtn.addEventListener("click", async () => {
    if (!pendingAdded) return setStatus("Nothing new to save (add a row first).", "err");

    const csvText = toDelimited(rows, delimiter);
    setStatus("Saving to Azure...", "");

    try {
      await saveCsvToAzure(csvText);
      setStatus("Saved to Azure. Closing window...", "ok");
      window.close();
    } catch (e) {
      setStatus("Save failed: " + (e?.message || e), "err");
      console.error(e);
    }
  });

  reloadBtn.addEventListener("click", loadCsvFromAzure);

  // Auto-load on startup
  loadCsvFromAzure();
})();
</script>
</body>
</html>
