<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Road Features Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 90%; }
    #controls { padding: 10px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    #controls label { margin-right: 10px; font-size: 0.9em; }
    .feature-label { background: white; border: 1px solid #333; border-radius: 4px; padding: 2px 4px; }
    .leaflet-tooltip.feature-label:after { background: white; }
    .invisible-icon { width: 0; height: 0; }
  </style>
</head>
<body>
  <div id="controls">
    <!-- Road features -->
    <label><input type="checkbox" id="bridge" /> Bridges</label>
    <label><input type="checkbox" id="tunnel" /> Tunnels</label>
    <label><input type="checkbox" id="toll_station" /> Toll Stations</label>
    <label><input type="checkbox" id="roundabout" /> Roundabouts</label>
    <label><input type="checkbox" id="stop_sign" /> Stop Signs</label>
    <label><input type="checkbox" id="red_light" /> Red Lights</label>
    <label><input type="checkbox" id="intersection" /> Intersections</label>
    <label><input type="checkbox" id="speed_bump" /> Speed Bumps</label>
    <!-- Speed limit signs -->
    <div style="margin-top:8px;">
      <strong>Speed Limits:</strong>
      <label><input type="checkbox" id="speed_20" /> 20 kph</label>
      <label><input type="checkbox" id="speed_30" /> 30 kph</label>
      <label><input type="checkbox" id="speed_40" /> 40 kph</label>
      <label><input type="checkbox" id="speed_50" /> 50 kph</label>
      <label><input type="checkbox" id="speed_60" /> 60 kph</label>
      <label><input type="checkbox" id="speed_70" /> 70 kph</label>
      <label><input type="checkbox" id="speed_80" /> 80 kph</label>
      <label><input type="checkbox" id="speed_90" /> 90 kph</label>
      <label><input type="checkbox" id="speed_100" /> 100 kph</label>
      <label><input type="checkbox" id="speed_110" /> 110 kph</label>
      <label><input type="checkbox" id="speed_120" /> 120 kph</label>
      <label><input type="checkbox" id="speed_130" /> 130 kph</label>
      <label><input type="checkbox" id="speed_140" /> 140 kph</label>
      <label><input type="checkbox" id="speed_none" /> Unlimited</label>
    </div>
    <!-- Range and search -->
    <div style="margin-top:8px;">
      <label>Range (m): <input type="number" id="range" value="1000" min="100" step="100" style="width:80px;" /></label>
      <button id="searchBtn">Search</button>
    </div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map');
    // Feature layers
    const layers = {
      bridge: L.layerGroup().addTo(map),
      tunnel: L.layerGroup().addTo(map),
      toll_station: L.layerGroup().addTo(map),
      roundabout: L.layerGroup().addTo(map),
      stop_sign: L.layerGroup().addTo(map),
      red_light: L.layerGroup().addTo(map),
      intersection: L.layerGroup().addTo(map),
      speed_bump: L.layerGroup().addTo(map),
      // speed limit layers
      speed_20: L.layerGroup().addTo(map), speed_30: L.layerGroup().addTo(map),
      speed_40: L.layerGroup().addTo(map), speed_50: L.layerGroup().addTo(map),
      speed_60: L.layerGroup().addTo(map), speed_70: L.layerGroup().addTo(map),
      speed_80: L.layerGroup().addTo(map), speed_90: L.layerGroup().addTo(map),
      speed_100: L.layerGroup().addTo(map), speed_110: L.layerGroup().addTo(map), speed_120: L.layerGroup().addTo(map),
      speed_130: L.layerGroup().addTo(map), speed_140: L.layerGroup().addTo(map), speed_none: L.layerGroup().addTo(map)
    };
    // Trace and position layers
    const traceLayer = L.layerGroup().addTo(map);
    const positionLayer = L.layerGroup().addTo(map);

    let pathCoords = [];
    let pathLine = L.polyline(pathCoords, { color: 'blue', weight: 4 }).addTo(traceLayer);
    let lastSearchPos = null;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    function distanceMeters(a, b) {
      const toRad = x => x * Math.PI / 180;
      const R = 6371000;
      const dLat = toRad(b[0] - a[0]), dLon = toRad(b[1] - a[1]);
      const lat1 = toRad(a[0]), lat2 = toRad(b[0]);
      const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*(Math.sin(dLon/2)**2);
      return R * 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1-h));
    }

    function updateView(latlng) {
      const range = parseInt(document.getElementById('range').value, 10) || 1000;
      const R = 6371000;
      const lat = latlng[0], lon = latlng[1];
      const dLat = (range / R) * (180 / Math.PI);
      const dLon = (range / (R * Math.cos(lat * Math.PI/180))) * (180 / Math.PI);
      map.fitBounds([[lat - dLat, lon - dLon], [lat + dLat, lon + dLon]]);
    }

    function fetchFeature(tagKey, tagVal, layerGroup, label) {
      const { lat, lng } = map.getCenter();
      const radius = parseInt(document.getElementById('range').value, 10) || 1000;
      const q1 = `node["${tagKey}"="${tagVal}"](around:${radius},${lat},${lng});`;
      const q2 = `way["${tagKey}"="${tagVal}"](around:${radius},${lat},${lng});`;
      const query = `[out:json][timeout:25];(${q1}${q2});out center;`;
      fetch('https://overpass-api.de/api/interpreter', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:query })
        .then(r => r.json()).then(data => {
          layerGroup.clearLayers();
          data.elements.forEach(el => {
            const coords = el.lat && el.lon ? [el.lat, el.lon] : [el.center.lat, el.center.lon];
            const marker = L.marker(coords, { icon: L.divIcon({ className:'invisible-icon' }), interactive: false });
            marker.addTo(layerGroup)
                  .bindTooltip(label, { permanent: true, direction: 'right', offset: [10, 0], className: 'feature-label' });
          });
        }).catch(console.error);
    }

    function performSearch() {
      // New road features
      if (document.getElementById('bridge').checked) fetchFeature('man_made','bridge', layers.bridge, 'Bridge'); else layers.bridge.clearLayers();
      if (document.getElementById('tunnel').checked) fetchFeature('tunnel','yes', layers.tunnel, 'Tunnel'); else layers.tunnel.clearLayers();
      if (document.getElementById('toll_station').checked) fetchFeature('amenity','toll_booth', layers.toll_station, 'Toll Station'); else layers.toll_station.clearLayers();
      // Existing features
      if (document.getElementById('roundabout').checked) fetchFeature('junction','roundabout', layers.roundabout, 'Roundabout'); else layers.roundabout.clearLayers();
      if (document.getElementById('stop_sign').checked) fetchFeature('highway','stop', layers.stop_sign, 'Stop Sign'); else layers.stop_sign.clearLayers();
      if (document.getElementById('red_light').checked) fetchFeature('highway','traffic_signals', layers.red_light, 'Red Light'); else layers.red_light.clearLayers();
      if (document.getElementById('intersection').checked) fetchFeature('junction','yes', layers.intersection, 'Intersection'); else layers.intersection.clearLayers();
      if (document.getElementById('speed_bump').checked) fetchFeature('traffic_calming','speed_bump', layers.speed_bump, 'Speed Bump'); else layers.speed_bump.clearLayers();
      // Speed limits
      ['20','30','40','50','60','70','80','90','100','110','120','130','140','none'].forEach(v => {
        const id = 'speed_' + v;
        const layer = layers[id];
        if (document.getElementById(id).checked) {
          const label = v==='none' ? 'Unlimited' : v + ' kph';
          fetchFeature('maxspeed', v, layer, label);
        } else layer.clearLayers();
      });
      lastSearchPos = [map.getCenter().lat, map.getCenter().lng];
    }

    document.getElementById('searchBtn').addEventListener('click', performSearch);
    // Attach change listeners
    ['bridge','tunnel','toll_station','roundabout','stop_sign','red_light','intersection','speed_bump',
     'speed_20','speed_30','speed_40','speed_50','speed_60','speed_70','speed_80','speed_90','speed_100','speed_110','speed_120','speed_130','speed_140','speed_none']
      .forEach(id => document.getElementById(id).addEventListener('change', performSearch));

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        const latlng = [pos.coords.latitude, pos.coords.longitude];
        updateView(latlng);
        pathCoords.push(latlng);
        pathLine.setLatLngs(pathCoords);
        positionLayer.clearLayers();
        L.circleMarker(latlng, { radius: 8, fillColor: 'red', color: 'red', fillOpacity: 1, weight: 0 }).addTo(positionLayer);
        if (!lastSearchPos || distanceMeters(lastSearchPos, latlng) > 100) performSearch();
      }, err => { console.error(err); map.setView([0, 0], 2); }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
    } else map.setView([0, 0], 2);
  </script>
</body>
</html>
