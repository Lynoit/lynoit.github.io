<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Drag‑and‑Drop KPI Builder</title>
<style>
  :root{
    --bg:#0f1115;--ink:#e6e7eb;--muted:#9aa4b2;--panel:#151922;--panel2:#0e121a;--border:#232836;--brand:#4f7cff;
    --red:#ef4444;--blue:#2563eb;--green:#16a34a;--orange:#f59e0b;--grey:#6b7280
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
  aside{background:var(--panel);border-right:1px solid var(--border);padding:14px;position:sticky;top:0;height:100vh}
  main{padding:18px}
  h1{font-size:16px;margin:0 0 14px 0}
  h2{font-size:13px;margin:14px 0 8px;color:var(--muted)}
  .palette{display:grid;grid-template-columns:1fr;gap:8px}
  .badge{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center}
  input,select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--panel2);color:var(--ink)}
  input:focus,select:focus,textarea:focus{outline:2px solid #2a56ff33}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 12px}
  button{border:1px solid var(--border);background:#1b2030;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  button:hover{border-color:#2a3144}
  .primary{background:var(--brand);border-color:transparent}
  .ghost{background:transparent}
  .danger{background:var(--red)}

  /* Card (canvas) */
  .boardWrap{display:grid;gap:10px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;min-height:220px;position:relative}
  .cardHeader{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px}
  .dropHint{color:var(--muted);font-size:13px}
  .grid{display:flex;flex-wrap:wrap;gap:8px}

  /* Button look (mimics your app) */
  .bigButton{display:inline-flex;align-items:center;justify-content:center;min-width:80px;padding:10px 14px;border-radius:8px;border:none;color:#fff;cursor:grab;user-select:none}
  .bigButton:active{cursor:grabbing}
  .blueButton{background:var(--blue)}
  .redButton{background:var(--red)}
  .greenButton{background:var(--green)}
  .orangeButton{background:var(--orange)}
  .greyButton{background:var(--grey)}

  /* Drag styles */
  .dropping{outline:2px dashed #7aa2ff;outline-offset:6px}
  .ghostBtn{opacity:.6}

  /* Editor popover */
  dialog{border:1px solid var(--border);background:var(--panel);color:var(--ink);border-radius:12px;padding:14px;max-width:420px}
  dialog::backdrop{background:rgba(0,0,0,.45)}
  .grid2{display:grid;grid-template-columns:1fr;gap:10px}
  .right{display:flex;gap:8px;justify-content:flex-end}

  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}

  .groupbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  .help{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="app">
  <aside>
    <h1>Palette</h1>
    <p class="badge">Drag a color into the card</p>

    <h2>Buttons</h2>
    <div class="palette" id="palette">
      <button class="bigButton blueButton"   draggable="true" data-css="blueButton">Blue</button>
      <button class="bigButton redButton"    draggable="true" data-css="redButton">Red</button>
      <button class="bigButton greenButton"  draggable="true" data-css="greenButton">Green</button>
      <button class="bigButton orangeButton" draggable="true" data-css="orangeButton">Orange</button>
      <button class="bigButton greyButton"   draggable="true" data-css="greyButton">Grey</button>
    </div>

    <h2>CSV</h2>
    <div class="row">
      <button id="importBtn" class="ghost">Import CSV</button>
      <input id="file" type="file" accept=".csv" hidden>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="exportBtn" class="primary">Download CSV</button>
    </div>

    <h2>Actions</h2>
    <div class="row">
      <button id="clearBtn" class="danger">Clear card</button>
    </div>
  </aside>

  <main>
    <div class="toolbar">
      <div class="groupbar">
        <label class="pill">Group</label>
        <input id="groupName" placeholder="e.g. ADAS KPI" value="Default" style="max-width:260px">
      </div>
      <span class="help">Tip: Click a button in the card to rename label & its annotation string.</span>
    </div>

    <section class="boardWrap">
      <div class="card" id="card">
        <div class="cardHeader">
          <div class="dropHint">Drop buttons here. Drag to reorder. Click to edit.</div>
          <div><span class="pill" id="countPill">0 buttons</span></div>
        </div>
        <div class="grid" id="canvas"></div>
      </div>
    </section>
  </main>
</div>

<!-- Editor dialog -->
<dialog id="editor">
  <form method="dialog" class="grid2">
    <h3 style="margin:0">Edit Button</h3>
    <div>
      <label class="badge">Label (what user sees)</label>
      <input id="editLabel" placeholder="Button label">
    </div>
    <div>
      <label class="badge">Annotation string (logName)</label>
      <input id="editLog" placeholder="Defaults to label if empty">
    </div>
    <div>
      <label class="badge">Color</label>
      <select id="editCss">
        <option value="blueButton">blueButton</option>
        <option value="redButton">redButton</option>
        <option value="greenButton">greenButton</option>
        <option value="orangeButton">orangeButton</option>
        <option value="greyButton">greyButton</option>
      </select>
    </div>
    <div class="right">
      <button value="delete" class="danger">Delete</button>
      <button value="cancel" class="ghost">Cancel</button>
      <button value="ok" class="primary">Save</button>
    </div>
  </form>
</dialog>

<script>
  // ===== Model =====
  // We keep a simple array of {label, logName, cssClass}
  let items = [];

  const palette = document.getElementById('palette');
  const card = document.getElementById('card');
  const canvas = document.getElementById('canvas');
  const countPill = document.getElementById('countPill');
  const groupNameEl = document.getElementById('groupName');

  // Drag from palette
  palette.addEventListener('dragstart', (e)=>{
    const css = e.target?.dataset?.css;
    if(!css) return;
    e.dataTransfer.setData('text/plain', JSON.stringify({ cssClass: css }));
    e.dataTransfer.effectAllowed = 'copy';
  });

  // Drag within canvas (reorder)
  canvas.addEventListener('dragstart', (e)=>{
    const idx = e.target?.dataset?.idx;
    if(idx==null) return;
    e.dataTransfer.setData('text/plain', JSON.stringify({ moveIndex:Number(idx) }));
    e.dataTransfer.effectAllowed = 'move';
    e.target.classList.add('ghostBtn');
  });
  canvas.addEventListener('dragend', (e)=>{
    e.target.classList.remove('ghostBtn');
  });

  // Allow drop on the whole card
  ;[card, canvas].forEach(el=>{
    el.addEventListener('dragover',(e)=>{ e.preventDefault(); card.classList.add('dropping'); });
    el.addEventListener('dragleave',()=> card.classList.remove('dropping'));
    el.addEventListener('drop', onDrop);
  });

  function onDrop(e){
    e.preventDefault();
    card.classList.remove('dropping');
    const data = JSON.parse(e.dataTransfer.getData('text/plain')||'{}');

    // Position calc: find index where we dropped between buttons
    const afterIdx = indexFromPoint(e.clientX, e.clientY);

    if(data.cssClass){
      // Create a new item from palette
      const newItem = { label: 'New Button', logName: '', cssClass: data.cssClass };
      if(afterIdx < 0 || afterIdx >= items.length){ items.push(newItem); }
      else { items.splice(afterIdx, 0, newItem); }
      render();
      return;
    }
    if(typeof data.moveIndex === 'number'){
      // Reorder existing
      const from = data.moveIndex;
      let to = afterIdx;
      if(to === from || to === from+1) return; // no-op
      const [moved] = items.splice(from,1);
      // Recompute target after removal
      if(to > from) to -= 1;
      if(to < 0 || to > items.length) items.push(moved); else items.splice(to,0,moved);
      render();
    }
  }

  // Determine insertion index based on mouse position
  function indexFromPoint(clientX, clientY){
    const children = [...canvas.children];
    for(let i=0;i<children.length;i++){
      const r = children[i].getBoundingClientRect();
      const mid = r.left + r.width/2;
      if(clientX < mid && clientY > r.top && clientY < r.bottom) return i; // before i
    }
    return children.length; // append
  }

  // Render buttons in canvas
  function render(){
    canvas.innerHTML = '';
    items.forEach((it, idx)=>{
      const btn = document.createElement('button');
      btn.className = `bigButton ${it.cssClass}`;
      btn.textContent = it.label || '';
      btn.title = it.logName ? `logName: ${it.logName}` : 'Click to edit';
      btn.draggable = true;
      btn.dataset.idx = idx;
      btn.addEventListener('click', ()=> edit(idx));
      canvas.appendChild(btn);
    });
    countPill.textContent = `${items.length} button${items.length===1?'':'s'}`;
  }

  // Editor dialog
  const dialog = document.getElementById('editor');
  const editLabel = document.getElementById('editLabel');
  const editLog = document.getElementById('editLog');
  const editCss = document.getElementById('editCss');
  let editing = -1;

  function edit(idx){
    editing = idx;
    const it = items[idx];
    editLabel.value = it.label || '';
    editLog.value = it.logName || '';
    editCss.value = it.cssClass || 'blueButton';
    dialog.showModal();
  }

  dialog.addEventListener('close', ()=>{
    const action = dialog.returnValue; // ok | cancel | delete
    if(action === 'delete' && editing>=0){ items.splice(editing,1); editing=-1; render(); return; }
    if(action !== 'ok' || editing<0) { editing=-1; return; }
    const it = items[editing];
    it.label = editLabel.value.trim() || 'Button';
    it.logName = editLog.value.trim();
    it.cssClass = editCss.value;
    editing = -1; render();
  });

  // CSV helpers (group,label,cssClass,logName)
  function toCSV(){
    const rows = [["group","label","cssClass","logName"]];
    const g = groupNameEl.value.trim() || 'Default';
    for(const it of items){ rows.push([g, it.label||'', it.cssClass||'blueButton', it.logName||it.label||'']); }
    return rows.map(r=>r.map(cell=>/[",\n]/.test(cell)?'"'+cell.replace(/"/g,'""')+'"':cell).join(',')).join('\n');
  }

  function fromCSV(text){
    const rows = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(line=>{
      const out=[]; let s='', q=false; for(let i=0;i<line.length;i++){ const c=line[i],n=line[i+1]; if(q){ if(c==='"'&&n==='"'){s+='"'; i++;} else if(c==='"'){q=false;} else s+=c; } else { if(c==='"'){q=true;} else if(c===','){out.push(s); s='';} else s+=c; } } out.push(s); return out; });
    if(!rows.length) return;
    let start=0; const hdr = rows[0].map(x=>x.toLowerCase());
    if(hdr.includes('group')&&hdr.includes('label')&&hdr.includes('cssclass')) start=1;
    items = [];
    for(let i=start;i<rows.length;i++){
      const [g,l,c,n] = rows[i];
      if(!l && !c) continue;
      if(i===start && g) groupNameEl.value = g;
      items.push({ label:l||'', cssClass:(c||'blueButton'), logName:(n||'') });
    }
    render();
  }

  // Wire import/export/clear
  document.getElementById('exportBtn').onclick = ()=>{
    const csv = toCSV();
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const ts = new Date().toISOString().slice(0,10);
    a.download = `kpi_buttons_${ts}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 3000);
  };

  const file = document.getElementById('file');
  document.getElementById('importBtn').onclick = ()=> file.click();
  file.addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=> fromCSV(reader.result);
    reader.readAsText(f);
    file.value='';
  });

  document.getElementById('clearBtn').onclick = ()=>{ items = []; render(); };

  // Seed empty state
  render();
</script>
</body>
</html>
