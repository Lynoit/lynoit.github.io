<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KPI Button CSV Builder</title>
<style>
  :root{
    --bg:#0f1115;--panel:#151922;--ink:#e6e7eb;--muted:#9aa4b2;--brand:#4f7cff;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444;--blue:#2563eb;--grey:#6b7280;
    --border:#232836;--focus:#7aa2ff
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  header{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:linear-gradient(180deg,var(--panel),rgba(21,25,34,.9));backdrop-filter:saturate(1.1) blur(6px)}
  header h1{font-size:16px;margin:0;font-weight:600}
  .badge{font-size:12px;color:var(--muted)}
  .toolbar{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  button,.btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#1b2030;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  button:hover{border-color:#2a3144}
  .primary{background:var(--brand);border-color:transparent}
  .ghost{background:transparent}
  .danger{background:var(--err)}
  .ok{background:var(--ok)}
  .grid{display:grid;grid-template-columns:1.2fr .9fr 1fr 1fr auto;gap:8px;align-items:center}
  .pane{padding:16px;border-bottom:1px solid var(--border)}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px}
  .row{display:contents}
  input,select{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#0e121a;color:var(--ink)}
  input:focus,select:focus,textarea:focus{outline:2px solid var(--focus);outline-offset:2px}
  table{width:100%;border-collapse:collapse}
  .controls{display:flex;gap:6px}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .muted{color:var(--muted)}
  footer{padding:16px;color:var(--muted);text-align:center}
  /* preview styles to mimic your app classes */
  .bigButton{display:inline-block;padding:10px 14px;border-radius:8px;border:none;color:#fff;margin:6px 6px 0 0;cursor:default}
  .orangeButton{background:var(--warn)}
  .blueButton{background:var(--blue)}
  .greyButton{background:var(--grey)}
  .greenButton{background:var(--ok)}
  .redButton{background:var(--err)}
  .group{margin:8px 0 14px}
  .group h4{margin:0 0 6px;font-weight:600;font-size:13px;color:var(--muted)}
  .kbd{font:600 12px/1.2 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#0c0f15;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
  .hint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <header class="panel">
    <h1>KPI Button CSV Builder</h1>
    <span class="badge">group,label,cssClass,logName</span>
    <div class="toolbar">
      <button id="newBtn" class="ghost">New</button>
      <label class="btn ghost" for="file">Import CSV<input id="file" type="file" accept=".csv" hidden></label>
      <button id="addRowBtn">Add row</button>
      <button id="dupBtn" title="Duplicate selected">Duplicate</button>
      <button id="delBtn" class="danger" title="Delete selected">Delete</button>
      <button id="downloadBtn" class="primary">Export CSV</button>
    </div>
  </header>

  <main class="pane">
    <div class="two">
      <section class="panel" style="padding:14px">
        <div class="grid" style="font-weight:600;margin:0 0 6px 0">
          <div>Group</div>
          <div>Label</div>
          <div>CSS class</div>
          <div>Log name <span class="hint">(optional)</span></div>
          <div></div>
        </div>
        <div id="rows"></div>
        <div class="hint" style="margin-top:8px">Tip: CSS class accepts any of your app classes (e.g. <span class="kbd">redButton</span>, <span class="kbd">blueButton</span>, plus <span class="kbd">bigButton</span> is implied in preview).</div>
      </section>

      <section class="panel" style="padding:14px">
        <h3 style="margin:0 0 8px 0">Live preview</h3>
        <div id="preview"></div>
        <p class="muted" style="margin-top:8px">This preview mimics your app’s look for quick checks. The exported CSV is what your app consumes.</p>
      </section>
    </div>
  </main>

  <footer>
    Works offline · Saves to CSV · Drag reordering via ▲▼ buttons
  </footer>

<script>
  // Minimal CSV parser/unparser that handles quotes and commas
  const CSV = {
    parse(text){
      const out=[]; let field='', row=[], inQ=false; for(let i=0;i<text.length;i++){
        const c=text[i], n=text[i+1];
        if(inQ){
          if(c==='"' && n==='"'){field+='"'; i++;}
          else if(c==='"'){inQ=false;}
          else field+=c;
        } else {
          if(c==='"') inQ=true;
          else if(c===','){row.push(field); field='';}
          else if(c==='\n'){row.push(field); out.push(row); row=[]; field='';}
          else if(c==='\r'){/* ignore */}
          else field+=c;
        }
      }
      if(field.length||row.length) {row.push(field); out.push(row);} 
      return out;
    },
    unparse(rows){
      return rows.map(r=>r.map(v=>{
        const s = (v==null?'' : String(v));
        return /[",\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
      }).join(",")).join("\n");
    }
  };

  const rowsEl = document.getElementById('rows');
  const previewEl = document.getElementById('preview');
  const fileEl = document.getElementById('file');

  const cssChoices = [
    'blueButton','redButton','greenButton','orangeButton','greyButton'
  ];

  let data = [
    { group:'Basic', label:'Example blue', cssClass:'blueButton', logName:'Example blue' },
    { group:'Basic', label:'Example red',  cssClass:'redButton',  logName:'Example red' }
  ];
  let selectedIndex = -1;

  function rowTpl(item, idx){
    const id = x=>`${x}-${idx}`;
    return `
      <div class="row grid" data-idx="${idx}">
        <input id="${id('g')}" value="${esc(item.group)}" placeholder="e.g. LKAS" />
        <input id="${id('l')}" value="${esc(item.label)}" placeholder="Button label" />
        <select id="${id('c')}">
          ${cssChoices.map(cls=>`<option ${item.cssClass===cls?'selected':''} value="${cls}">${cls}</option>`).join('')}
        </select>
        <input id="${id('n')}" value="${esc(item.logName||'')}" placeholder="Default = label" />
        <div class="controls">
          <button type="button" onclick="dup(${idx})" title="Duplicate">⧉</button>
          <button type="button" onclick="move(${idx},-1)" title="Move up">▲</button>
          <button type="button" onclick="move(${idx},+1)" title="Move down">▼</button>
          <button type="button" class="danger" onclick="delRow(${idx})" title="Delete">✕</button>
          <input type="radio" name="sel" ${selectedIndex===idx?'checked':''} onclick="selectRow(${idx})" title="Select" />
        </div>
      </div>`
  }
  function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

  function render(){
    rowsEl.innerHTML = data.map(rowTpl).join('');
    // bind changes
    data.forEach((_, idx)=>{
      const g=document.getElementById(`g-${idx}`);
      const l=document.getElementById(`l-${idx}`);
      const c=document.getElementById(`c-${idx}`);
      const n=document.getElementById(`n-${idx}`);
      g.addEventListener('input',()=>{data[idx].group=g.value; drawPreview()});
      l.addEventListener('input',()=>{data[idx].label=l.value; drawPreview()});
      c.addEventListener('change',()=>{data[idx].cssClass=c.value; drawPreview()});
      n.addEventListener('input',()=>{data[idx].logName=n.value});
    });
    drawPreview();
  }

  function drawPreview(){
    // group by group name
    const groups = {};
    data.forEach(r=>{
      const g = r.group || 'Ungrouped';
      (groups[g] ||= []).push(r);
    });
    previewEl.innerHTML = Object.entries(groups).map(([g,rows])=>{
      const buttons = rows.map(r=>`<button class="bigButton ${r.cssClass}">${esc(r.label||'')}</button>`).join('');
      return `<div class="group"><h4>${esc(g)}</h4>${buttons}</div>`
    }).join('') || '<p class="muted">Nothing to preview yet. Add a row.</p>';
  }

  function addRow(){ data.push({group:'',label:'',cssClass:'blueButton',logName:''}); render(); scrollToBottom(); }
  function dup(idx){ data.splice(idx+1,0,{...data[idx]}); render(); }
  function delRow(idx){ data.splice(idx,1); if(selectedIndex===idx) selectedIndex=-1; render(); }
  function move(idx,dir){ const j=idx+dir; if(j<0||j>=data.length) return; const t=data[idx]; data[idx]=data[j]; data[j]=t; selectedIndex=j; render(); }
  function selectRow(i){ selectedIndex=i; }
  function scrollToBottom(){ requestAnimationFrame(()=>window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'})); }

  function toCsv(){
    const rows = [["group","label","cssClass","logName"]];
    data.forEach(r=>rows.push([r.group||'', r.label||'', r.cssClass||'', (r.logName||r.label||'') ]));
    return CSV.unparse(rows);
  }

  function downloadCsv(){
    const csv = toCsv();
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const ts = new Date().toISOString().slice(0,10);
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `kpi_buttons_${ts}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
  }

  function importCsv(text){
    const rows = CSV.parse(text).filter(r=>r.length && r.some(c=>c!==''));
    if(!rows.length) return;
    // detect header
    const headers = rows[0].map(h=>h.trim().toLowerCase());
    let start = 0;
    const expected = ['group','label','cssclass','logname'];
    if(expected.every(h=>headers.includes(h))) start = 1;

    const colIndex = (name)=>{
      const i = rows[0].findIndex(h=>h.trim().toLowerCase()===name);
      return i>=0?i:expected.indexOf(name);
    };

    const gi = colIndex('group');
    const li = colIndex('label');
    const ci = colIndex('cssclass');
    const ni = colIndex('logname');

    const next = [];
    for(let r=start; r<rows.length; r++){
      const row = rows[r]; if(!row) continue;
      const rec = {
        group: (row[gi]||'').trim(),
        label: (row[li]||'').trim(),
        cssClass: (row[ci]||'blueButton').trim() || 'blueButton',
        logName: (row[ni]||'').trim()
      };
      next.push(rec);
    }
    data = next.length? next : data;
    render();
  }

  // Wire UI
  document.getElementById('newBtn').onclick = ()=>{ data=[]; render(); };
  document.getElementById('addRowBtn').onclick = addRow;
  document.getElementById('dupBtn').onclick = ()=>{ if(selectedIndex>=0) dup(selectedIndex); };
  document.getElementById('delBtn').onclick = ()=>{ if(selectedIndex>=0) delRow(selectedIndex); };
  document.getElementById('downloadBtn').onclick = downloadCsv;
  fileEl.addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=()=>importCsv(reader.result);
    reader.readAsText(f);
    fileEl.value='';
  });

  render();
</script>
</body>
</html>
