<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KPI Button Builder — Column Layout</title>
<style>
  :root{
    --bg:#0f1115;--ink:#e7eaf0;--muted:#9aa4b2;--panel:#141925;--panel2:#0e121a;--border:#23293a;--brand:#4f7cff;
    --red:#ef4444;--blue:#2563eb;--green:#16a34a;--orange:#f59e0b;--grey:#6b7280
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}

  .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
  aside{background:var(--panel);border-right:1px solid var(--border);padding:16px;position:sticky;top:0;height:100vh}
  main{padding:18px}

  h1{font-size:16px;margin:0 0 12px}
  h2{font-size:12px;color:var(--muted);margin:16px 0 8px}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}

  input,select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--panel2);color:var(--ink)}
  input:focus,select:focus,textarea:focus{outline:2px solid #2a56ff33}
  button{border:1px solid var(--border);background:#1b2133;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  button:hover{border-color:#2a3144}
  .primary{background:var(--brand);border-color:transparent}
  .danger{background:var(--red)}
  .ghost{background:transparent}

  /* Sidebar palette */
  .palette{display:grid;grid-template-columns:1fr;gap:8px}
  .swatch{display:flex;gap:8px}

  .bigButton{display:inline-flex;align-items:center;justify-content:center;min-width:120px;padding:10px 14px;border-radius:8px;border:none;color:#fff;user-select:none}
  .blueButton{background:var(--blue)}
  .redButton{background:var(--red)}
  .greenButton{background:var(--green)}
  .orangeButton{background:var(--orange)}
  .greyButton{background:var(--grey)}

  /* Stage (card) */
  .stageWrap{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px}
  .stageHeader{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px}
  .stage{min-height:560px;border:1px dashed #2a3144;border-radius:12px;padding:16px;overflow:auto;display:flex;gap:16px;align-items:flex-start}

  /* Lane (column) */
  .lane{min-width:220px;max-width:260px;background:#0f141f;border:1px solid var(--border);border-radius:12px;display:flex;flex-direction:column;gap:10px;padding:10px}
  .laneHeader{background:#6c7079;color:#111;font-weight:600;border-radius:8px;padding:8px 10px;display:flex;align-items:center;justify-content:space-between;cursor:grab}
  .laneHeader:active{cursor:grabbing}
  .laneTitle[contenteditable="true"]{outline:none}
  .laneBody{display:flex;flex-direction:column;gap:10px;min-height:40px}
  .laneBody.dropping{outline:2px dashed #7aa2ff;outline-offset:4px}

  /* Node in lane */
  .node{display:flex;align-items:center;gap:8px}
  .node.dragging{opacity:.6}
  .node .handle{width:10px;height:10px;border-radius:50%;background:#9aa6bf;opacity:.5}
  .node .meta{color:var(--muted);font-size:12px}

  dialog{border:1px solid var(--border);background:var(--panel);color:var(--ink);border-radius:12px;padding:14px;max-width:440px}
  dialog::backdrop{background:rgba(0,0,0,.45)}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  .right{display:flex;gap:8px;justify-content:flex-end}

  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}

  .ghostLane{background:#0c111b;border:1px dashed #2a3144}
</style>
</head>
<body>
<div class="app">
  <aside>
    <h1>KPI Palette</h1>
    <div class="pill">Drag from here → to the card</div>

    <h2>Columns</h2>
    <div class="palette">
      <button id="addLane" class="primary">Add empty column</button>
    </div>

    <h2>Buttons</h2>
    <div class="palette" id="btnPalette">
      <button class="bigButton redButton"   draggable="true" data-css="redButton">Red (KPI)</button>
      <button class="bigButton blueButton"  draggable="true" data-css="blueButton">Blue</button>
      <button class="bigButton orangeButton"draggable="true" data-css="orangeButton">Orange</button>
      <button class="bigButton greenButton" draggable="true" data-css="greenButton">Green</button>
      <button class="bigButton greyButton"  draggable="true" data-css="greyButton">Grey</button>
    </div>

    <h2>Import / Export</h2>
    <div class="palette">
      <div class="swatch">
        <button id="importBtn" class="ghost">Import CSV</button>
        <input id="file" type="file" accept=".csv" hidden>
      </div>
      <button id="exportBtn" class="primary">Download CSV</button>
      <button id="clearBtn" class="danger">Clear all</button>
    </div>

    <h2>Group name</h2>
    <input id="groupName" placeholder="e.g. ADAS KPI" value="ADAS KPI" />
  </aside>

  <main>
    <div class="toolbar">
      <span class="pill" id="laneCount">0 columns</span>
      <span class="pill" id="btnCount">0 buttons</span>
      <span class="pill">Tip: double‑click a button to edit</span>
    </div>

    <section class="stageWrap">
      <div class="stageHeader">
        <div class="pill">Card preview (columns + buttons)</div>
        <div class="pill">Drag columns by header • Drag buttons inside/between columns</div>
      </div>
      <div id="stage" class="stage" aria-label="Columns stage"></div>
    </section>
  </main>
</div>

<!-- Editor dialog -->
<dialog id="editor">
  <form method="dialog" class="grid">
    <h3 style="margin:0">Edit Button</h3>
    <div>
      <label class="pill">Label (what user sees)</label>
      <input id="editLabel" placeholder="Button label">
    </div>
    <div>
      <label class="pill">Annotation string (logName)</label>
      <input id="editLog" placeholder="Defaults to label if empty">
    </div>
    <div>
      <label class="pill">Color</label>
      <select id="editCss">
        <option value="redButton">redButton</option>
        <option value="blueButton">blueButton</option>
        <option value="orangeButton">orangeButton</option>
        <option value="greenButton">greenButton</option>
        <option value="greyButton">greyButton</option>
      </select>
    </div>
    <div class="right">
      <button value="delete" class="danger">Delete</button>
      <button value="cancel" class="ghost">Cancel</button>
      <button value="ok" class="primary">Save</button>
    </div>
  </form>
</dialog>

<script>
// ================= Model =================
// Lanes = array of { id, title, items: [ {id, label, logName, cssClass} ] }
let lanes = [];

// ================= DOM refs =================
const stage = document.getElementById('stage');
const laneCountEl = document.getElementById('laneCount');
const btnCountEl  = document.getElementById('btnCount');
const groupNameEl = document.getElementById('groupName');

// ================= Helpers =================
function uid(prefix='id'){return prefix+Math.random().toString(36).slice(2,9)}
function totalButtons(){return lanes.reduce((n,l)=>n+l.items.length,0)}
function refreshCounters(){
  laneCountEl.textContent = `${lanes.length} column${lanes.length===1?'':'s'}`;
  btnCountEl.textContent  = `${totalButtons()} button${totalButtons()===1?'':'s'}`;
}

// CSV stringify — robust (no regex literals)
function csvStringify(rows){
  return rows.map(row =>
    row.map(cell => {
      const s = String(cell ?? '');
      const needsQuote = s.includes('"') || s.includes(',') || s.includes('\n');
      return needsQuote ? '"' + s.replace(/"/g,'""') + '"' : s;
    }).join(',')
  ).join('\n');
}

// CSV parse (simple and resilient)
function csvParse(text){
  const lines = text.split(/\r?\n/).filter(l=>l.length);
  return lines.map(line => {
    const out=[]; let s='', q=false; for(let i=0;i<line.length;i++){
      const c=line[i], n=line[i+1];
      if(q){ if(c==='"'&&n==='"'){ s+='"'; i++; } else if(c==='"'){ q=false; } else s+=c; }
      else { if(c==='"'){ q=true; } else if(c===','){ out.push(s); s=''; } else s+=c; }
    }
    out.push(s); return out;
  });
}

// ================= Rendering =================
function render(){
  stage.innerHTML = '';
  lanes.forEach((lane, laneIdx) => {
    const laneEl = document.createElement('div');
    laneEl.className = 'lane';
    laneEl.dataset.lane = lane.id;

    // Header (draggable)
    const head = document.createElement('div');
    head.className = 'laneHeader';
    head.draggable = true;

    const title = document.createElement('div');
    title.className = 'laneTitle';
    title.textContent = lane.title || 'Untitled';
    title.contentEditable = true;
    title.addEventListener('input', () => lane.title = title.textContent.trim());

    const del = document.createElement('button');
    del.className = 'ghost';
    del.textContent = '×';
    del.title = 'Remove column';
    del.addEventListener('click', ()=>{ lanes.splice(laneIdx,1); render(); });

    head.appendChild(title); head.appendChild(del);

    // Dragging lanes horizontally
    head.addEventListener('dragstart', (e)=>{
      e.dataTransfer.setData('text/x-lane', lane.id);
      e.dataTransfer.effectAllowed = 'move';
      laneEl.classList.add('ghostLane');
    });
    head.addEventListener('dragend', ()=> laneEl.classList.remove('ghostLane'));

    laneEl.addEventListener('dragover', (e)=>{
      const data = e.dataTransfer.getData('text/x-lane') || e.dataTransfer.getData('text/x-node') || e.dataTransfer.getData('text/x-palette');
      if(data){ e.preventDefault(); }
    });
    laneEl.addEventListener('drop', (e)=>{
      e.preventDefault();
      const asLane = e.dataTransfer.getData('text/x-lane');
      const asNode = e.dataTransfer.getData('text/x-node');
      const asPal  = e.dataTransfer.getData('text/x-palette');
      if(asLane){
        const from = lanes.findIndex(l=>l.id===asLane);
        const to   = lanes.findIndex(l=>l.id===lane.id);
        if(from>=0 && to>=0 && from!==to){
          const [m] = lanes.splice(from,1);
          lanes.splice(to,0,m);
          render();
        }
        return;
      }
      if(asNode){
        // handled in body drop so ordering is correct
        return;
      }
      if(asPal){
        // handled in body drop as well
        return;
      }
    });

    const body = document.createElement('div');
    body.className = 'laneBody';
    body.dataset.lane = lane.id;

    // Allow dropping nodes from palette or other lanes
    body.addEventListener('dragover', (e)=>{ e.preventDefault(); body.classList.add('dropping'); });
    body.addEventListener('dragleave', ()=> body.classList.remove('dropping'));
    body.addEventListener('drop', (e)=>{
      e.preventDefault(); body.classList.remove('dropping');
      const pal = e.dataTransfer.getData('text/x-palette');
      const nodeId = e.dataTransfer.getData('text/x-node');

      if(pal){
        const {cssClass} = JSON.parse(pal);
        const label = cssClass==='redButton' ? 'No function' : 'New';
        lane.items.push({ id: uid('node_'), label, logName: '', cssClass });
        render();
        return;
      }

      if(nodeId){
        // Move node across lanes; find its lane+index
        for(const l of lanes){
          const idx = l.items.findIndex(n=>n.id===nodeId);
          if(idx>=0){
            const [moved] = l.items.splice(idx,1);
            // Insert at end for simplicity; could compute position under cursor
            lane.items.push(moved);
            render();
            return;
          }
        }
      }
    });

    // Render nodes
    lane.items.forEach((node, idx)=>{
      const row = document.createElement('div');
      row.className = 'node';
      row.draggable = true;
      row.dataset.id = node.id;

      row.addEventListener('dragstart', (e)=>{
        e.dataTransfer.setData('text/x-node', node.id);
        e.dataTransfer.effectAllowed = 'move';
        row.classList.add('dragging');
      });
      row.addEventListener('dragend', ()=> row.classList.remove('dragging'));

      // Allow reordering within same lane by dropping before/after
      row.addEventListener('dragover', (e)=>{ e.preventDefault(); });
      row.addEventListener('drop', (e)=>{
        e.preventDefault();
        const nodeId = e.dataTransfer.getData('text/x-node');
        if(!nodeId) return;
        // find source
        let srcLane = null, srcIdx=-1;
        for(const l of lanes){
          const i = l.items.findIndex(n=>n.id===nodeId); if(i>=0){ srcLane=l; srcIdx=i; break; }
        }
        if(!srcLane) return;
        const [moved] = srcLane.items.splice(srcIdx,1);
        // find target lane/index again (DOM may have reflowed)
        const trgLane = lanes.find(l=>l.id===lane.id);
        const trgIdx  = trgLane.items.findIndex(n=>n.id===node.id);
        trgLane.items.splice(trgIdx,0,moved);
        render();
      });

      const handle = document.createElement('div'); handle.className='handle'; handle.title='Drag to reorder';
      const btn = document.createElement('button');
      btn.className = `bigButton ${node.cssClass}`;
      btn.textContent = node.label;
      btn.title = node.logName ? `logName: ${node.logName}` : 'Double‑click to edit';
      btn.addEventListener('dblclick', ()=> openEditor(lane.id, node.id));

      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = node.cssClass==='redButton' ? 'KPI' : 'Note';

      row.appendChild(handle); row.appendChild(btn); row.appendChild(meta);
      body.appendChild(row);
    });

    laneEl.appendChild(head);
    laneEl.appendChild(body);
    stage.appendChild(laneEl);
  });
  refreshCounters();
}

// Add lane button
document.getElementById('addLane').addEventListener('click', ()=>{
  lanes.push({ id: uid('lane_'), title: 'New Column', items: [] });
  render();
});

// Palette drag
const btnPalette = document.getElementById('btnPalette');
btnPalette.addEventListener('dragstart', (e)=>{
  const css = e.target?.dataset?.css; if(!css) return;
  e.dataTransfer.setData('text/x-palette', JSON.stringify({cssClass: css}));
  e.dataTransfer.effectAllowed = 'copy';
});

// ============ Editor ============
const dlg = document.getElementById('editor');
const editLabel = document.getElementById('editLabel');
const editLog   = document.getElementById('editLog');
const editCss   = document.getElementById('editCss');
let editing = { laneId:null, nodeId:null };

function openEditor(laneId, nodeId){
  editing = { laneId, nodeId };
  const lane = lanes.find(l=>l.id===laneId);
  const node = lane.items.find(n=>n.id===nodeId);
  editLabel.value = node.label;
  editLog.value   = node.logName || '';
  editCss.value   = node.cssClass;
  dlg.showModal();
}

dlg.addEventListener('close', ()=>{
  const action = dlg.returnValue; // ok | cancel | delete
  const lane = lanes.find(l=>l.id===editing.laneId);
  if(!lane){ editing={laneId:null,nodeId:null}; return; }
  const idx = lane.items.findIndex(n=>n.id===editing.nodeId);
  if(idx<0){ editing={laneId:null,nodeId:null}; return; }

  if(action === 'delete'){
    lane.items.splice(idx,1); render(); editing={laneId:null,nodeId:null}; return;
  }
  if(action !== 'ok'){ editing={laneId:null,nodeId:null}; return; }

  const node = lane.items[idx];
  node.label    = editLabel.value.trim() || 'Button';
  node.logName  = (editLog.value.trim() || node.label).trim();
  node.cssClass = editCss.value;
  render();
  editing={laneId:null,nodeId:null};
});

// ============ CSV I/O ============
// Columns: group,label,cssClass,logName,order
function exportCSV(){
  const rows = [["group","label","cssClass","logName","order"]];
  const g = groupNameEl.value.trim() || 'Default';
  lanes.forEach(lane => {
    lane.items.forEach((n, i) => {
      rows.push([lane.title||g, n.label, n.cssClass, (n.logName||n.label), String(i)]);
    });
  });
  return csvStringify(rows);
}

function importCSV(text){
  const rows = csvParse(text);
  if(!rows.length) return;
  // header?
  const hdr = rows[0].map(x=>x.toLowerCase());
  let start = 0;
  const HAS_HEADER = hdr.includes('group') && hdr.includes('label');
  if(HAS_HEADER) start = 1;

  const byGroup = new Map();
  for(let i=start;i<rows.length;i++){
    const [group,label,cssClass,logName,order] = rows[i];
    const g = (group||'Group');
    if(!byGroup.has(g)) byGroup.set(g, []);
    byGroup.get(g).push({ label: label||'', cssClass: cssClass||'redButton', logName: logName||label||'', order: Number(order)||0 });
  }

  lanes = [];
  for(const [g, arr] of byGroup){
    arr.sort((a,b)=>a.order-b.order);
    lanes.push({ id: uid('lane_'), title: g, items: arr.map(x=>({ id: uid('node_'), label:x.label, logName:x.logName, cssClass:x.cssClass })) });
  }
  render();
}

// Buttons
const file = document.getElementById('file');
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const csv = exportCSV();
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const ts = new Date().toISOString().slice(0,10);
  a.download = `kpi_buttons_${ts}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 3000);
});

document.getElementById('importBtn').addEventListener('click', ()=> file.click());
file.addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=> importCSV(r.result);
  r.readAsText(f);
  file.value='';
});

document.getElementById('clearBtn').addEventListener('click', ()=>{ lanes = []; render(); });

// Seed with sample lanes (optional)
lanes = [
  { id: uid('lane_'), title: 'TSI Speed', items: [
    { id: uid('node_'), label:'No function', cssClass:'redButton', logName:'No function' },
    { id: uid('node_'), label:'Explicit incorrect speed', cssClass:'redButton', logName:'Explicit incorrect speed' },
    { id: uid('node_'), label:'Implicit incorrect speed', cssClass:'redButton', logName:'Implicit incorrect speed' },
    { id: uid('node_'), label:'Conditional incorrect speed', cssClass:'redButton', logName:'Conditional incorrect speed' },
    { id: uid('node_'), label:'Dynamic incorrect speed', cssClass:'redButton', logName:'Dynamic incorrect speed' }
  ]},
  { id: uid('lane_'), title: 'DMS', items: [
    { id: uid('node_'), label:'No function', cssClass:'redButton', logName:'No function' },
    { id: uid('node_'), label:'Unnecessary DMS warning', cssClass:'redButton', logName:'Unnecessary DMS warning' },
    { id: uid('node_'), label:'False DMS warning', cssClass:'redButton', logName:'False DMS warning' },
    { id: uid('node_'), label:'No DMS warning', cssClass:'redButton', logName:'No DMS warning' }
  ]},
  { id: uid('lane_'), title: 'iACC', items: [
    { id: uid('node_'), label:'No function', cssClass:'redButton', logName:'No function' },
    { id: uid('node_'), label:'False brake Road feature', cssClass:'redButton', logName:'False brake Road feature' },
    { id: uid('node_'), label:'No brake for Road feature', cssClass:'redButton', logName:'No brake for Road feature' }
  ]},
  { id: uid('lane_'), title: 'ACC', items: [
    { id: uid('node_'), label:'No function', cssClass:'redButton', logName:'No function' },
    { id: uid('node_'), label:'False brake', cssClass:'redButton', logName:'False brake' },
    { id: uid('node_'), label:'False acceleration', cssClass:'redButton', logName:'False acceleration' }
  ]}
];
render();
</script>
</body>
</html>
