<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Annotator ‚Äî Button Builder (Import/Export CSV)</title>
<style>
  :root{ --bg:#0b0d12; --panel:#121622; --ink:#eef2ff; --red:#ef4444; --green:#22c55e; --orange:#f59e0b; --blue:#3b82f6; --shadow:0 10px 30px rgba(0,0,0,.35); }
  *{ box-sizing:border-box; }
  body{ margin:0; background:linear-gradient(180deg,#0a0c12,#0d1120 60%); color:#eef2ff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  header{ display:flex; align-items:center; gap:8px; padding:10px 14px; border-bottom:1px solid #1a2033; position:sticky; top:0; background:rgba(10,12,18,.7); backdrop-filter: blur(10px); z-index:10;}
  h1{ font-size:15px; margin:0; font-weight:700; color:#dbeafe; }
  .row{ display:grid; grid-template-columns: 240px 1fr; gap:12px; padding:12px; }
  .panel{ background:#121622; border:1px solid #1a2033; border-radius:14px; box-shadow:var(--shadow); }
  .panel header{ padding:10px 12px; font-size:12px; font-weight:700; color:#c7d2fe; border-bottom:1px solid #1a2033; }
  .panel .body{ padding:10px; }

  /* Sidebar ‚Äî 4 color buttons with descriptions */
  .color-btn{ display:flex; gap:10px; padding:12px; margin-bottom:10px; background:#0f1422; border:1px solid #1f2944; border-radius:12px; cursor:grab; user-select:none; }
  .color-btn:hover{ background:#121a2e; border-color:#2b375d; }
  .dot{ width:16px; height:16px; border-radius:3px; margin-top:2px; flex:0 0 16px; }
  .dot.red{background:var(--red);} .dot.green{background:var(--green);} .dot.orange{background:var(--orange);} .dot.blue{background:var(--blue);}
  .btn-text{ display:flex; flex-direction:column; gap:4px; }
  .name{ font-weight:800; line-height:1; }
  .desc{ font-size:11px; color:#aab4e0; line-height:1.2; }

  /* Board + columns */
  .card{ display:flex; gap:10px; padding:10px; min-height:520px; overflow:auto; }
  .empty-board{ display:flex; align-items:center; justify-content:center; width:100%; min-height:420px; background:linear-gradient(180deg, rgba(31,41,80,.18), rgba(14,18,40,.28)); border:1px dashed #405088; border-radius:16px; color:#cfe4ff; padding:28px; }
  .empty-inner{ text-align:center; max-width:560px; padding:24px 20px; }
  .empty-icon{ width:56px; height:56px; margin:0 auto 12px; border-radius:14px; display:grid; place-items:center; background:rgba(124,58,237,.12); border:1px solid rgba(124,58,237,.35); }
  .empty-title{ font-size:18px; font-weight:800; letter-spacing:.2px; margin:8px 0 6px; color:#e6eeff; }
  .empty-sub{ font-size:13px; color:#a8b7e8; margin:0 0 14px; }
  .empty-colors{ display:flex; gap:8px; justify-content:center; margin:6px 0 16px; }
  .pill-dot{ width:14px; height:14px; border-radius:3px; box-shadow:inset 0 0 0 2px rgba(255,255,255,.08); }
  .pill-red{ background:#ef4444 } .pill-green{ background:#22c55e } .pill-orange{ background:#f59e0b } .pill-blue{ background:#3b82f6 }
  .empty-actions{ display:flex; justify-content:center; gap:10px; }
  .empty-cta{ padding:10px 14px; font-weight:700; font-size:13px; color:#e9e7ff; background:#1a1f3a; border:1px solid #3b3f6a; border-radius:10px; cursor:pointer; }
  .empty-cta:hover{ background:#202753; border-color:#4b5092; }
  .empty-hint{ font-size:12px; color:#9fb2ff; margin-top:8px; }

  .col{ background:#0c1222; border:1px solid #1e2740; border-radius:12px; width:300px; flex:0 0 300px; display:flex; flex-direction:column; }
  .col-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-bottom:1px solid #1e2740; cursor:grab; }
  .col-title{ font-weight:800; color:#e5e7eb; font-size:13px; outline:none; }
  .col-actions button{ background:#121a2e; border:1px solid #27304a; color:#c7d2fe; border-radius:8px; font-size:11px; padding:4px 8px; cursor:pointer; }
  .col-actions button:hover{ background:#131f3b; }
  .drop{ flex:1; padding:10px; }
  .placeholder{ border:2px dashed #33406a; border-radius:12px; padding:18px; color:#93c5fd; text-align:center; font-size:12px; }

  /* Items: vertical list only */
  ul.items{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px; }
  li.item{ display:flex; align-items:center; gap:10px; padding:10px; border:1px solid #223055; border-radius:10px; background:#0f1a33; cursor:grab; }
  .badge{ width:18px; height:18px; border-radius:4px; }
  .b.red{background:var(--red);} .b.green{background:var(--green);} .b.orange{background:var(--orange);} .b.blue{background:var(--blue);}
  .label{ flex:1; font-size:13px; font-weight:700; color:#e2e8f0; outline:none; }
  .btn{ padding:8px 10px; border-radius:10px; border:1px solid #2a3963; background:#0f1628; color:#dbeafe; cursor:pointer; }
  .btn:hover{ background:#111c34; }
  .ghost{ opacity:.6; }
</style>
</head>
<body>
<header>
  <h1>Annotator ‚Äî Button Builder</h1>
  <div style="margin-left:auto; display:flex; gap:8px;">
    <button class="btn" id="addColumnBtn">‚ûï Add column</button>
    <button class="btn" id="importBtn">üì• Import CSV</button>
    <button class="btn" id="downloadBtn">‚¨áÔ∏è Export CSV</button>
    <button class="btn" id="saveBtn">üíæ Save</button>
    <button class="btn" id="loadBtn">‚§¥Ô∏è Load (local)</button>
    <button class="btn" id="clearBtn">üßπ Clear</button>
  </div>
  <input id="fileInput" type="file" accept=".csv,text/csv" style="display:none" />
</header>

<div class="row">
  <!-- Sidebar -->
  <section class="panel">
    <header>Buttons ‚Äî drag into the layout</header>
    <div class="body" id="sidebar">
      <div class="color-btn" draggable="true" data-color="red">
        <div class="dot red"></div>
        <div class="btn-text"><div class="name">Red (KPI)</div><div class="desc">Populates the KPI table. Problems / failures: no function, incorrect behavior, false warnings.</div></div>
      </div>
      <div class="color-btn" draggable="true" data-color="green">
        <div class="dot green"></div>
        <div class="btn-text"><div class="name">Green</div><div class="desc">Correct / positive outcomes: OK, excellent, recovered.</div></div>
      </div>
      <div class="color-btn" draggable="true" data-color="orange">
        <div class="dot orange"></div>
        <div class="btn-text"><div class="name">Orange</div><div class="desc">Ambiguous / edge cases ‚Äî needs human review.</div></div>
      </div>
      <div class="color-btn" draggable="true" data-color="blue">
        <div class="dot blue"></div>
        <div class="btn-text"><div class="name">Blue</div><div class="desc">Neutral info / notes and context.</div></div>
      </div>
    </div>
  </section>

  <!-- Board -->
  <section class="panel">
    <header>Button layout</header>
    <div class="body"><div id="card" class="card"></div></div>
  </section>
</div>

<script>
/* ===== Storage keys (migration-aware) ===== */
const STORAGE_KEYS = ['cardLayout_v6','cardLayout_v5','cardLayout_v4','cardLayout_v3','cardLayout_v2','cardLayout'];
const STORAGE_KEY  = 'cardLayout_v6';

/* ===== State ===== */
let columns = []; // {id, name}
let items   = []; // {id, colId, color, label}

/* ===== Helpers ===== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const card = $('#card');
const csvEscape = (v) => { const s = String(v ?? ''); return (/[",\n]/.test(s)) ? `"${s.replace(/"/g,'""')}"` : s; };
function toast(msg, isError=false){
  let el = document.getElementById('toast');
  if (!el){ el = document.createElement('div'); el.id='toast';
    Object.assign(el.style,{position:'fixed',bottom:'16px',right:'16px',padding:'10px 12px',borderRadius:'10px',fontSize:'12px',zIndex:'9999',border:'1px solid rgba(255,255,255,.15)',background:'#0f1628',color:'#dbeafe',transition:'opacity .25s'});
    document.body.appendChild(el);
  }
  el.style.borderColor = isError ? 'rgba(239,68,68,.5)' : 'rgba(124,58,237,.5)';
  el.textContent = msg; el.style.opacity = '1'; setTimeout(()=> el.style.opacity='0', 1800);
}

/* ===== Init (empty unless saved) ===== */
document.addEventListener('DOMContentLoaded', () => {
  loadFromLocal(true);
  renderAll();
  wireSidebar();
});

/* ===== Sidebar (4 colors) ===== */
let dragColor = null;
function wireSidebar(){
  $$('#sidebar .color-btn').forEach(btn=>{
    btn.addEventListener('dragstart', e=>{
      dragColor = btn.dataset.color;
      e.dataTransfer.setData('text/color', dragColor);
      e.dataTransfer.effectAllowed = 'copy';
      btn.classList.add('ghost');
    });
    btn.addEventListener('dragend', ()=> btn.classList.remove('ghost'));
  });
}

/* ===== Columns ===== */
function addColumn(name){
  columns.push({ id:'col_'+crypto.randomUUID().slice(0,8), name: (name||'').trim() || 'Unnamed' });
  saveToLocal(); renderAll();
}
function renderAll(){ renderColumns(); renderItems(); }

let draggingColId = null;
function renderColumns(){
  card.innerHTML = '';

  if (columns.length === 0){
    const empty = document.createElement('div');
    empty.className = 'empty-board';
    empty.innerHTML = `
      <div class="empty-inner">
        <div class="empty-icon">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="3" width="18" height="18" rx="4" stroke="rgb(124 58 237)" opacity=".65"/>
            <path d="M12 7v10M7 12h10" stroke="rgb(124 58 237)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="empty-title">No groups yet</div>
        <p class="empty-sub">Create your first column, then drag a color from the sidebar to add items.</p>
        <div class="empty-colors" aria-hidden="true">
          <div class="pill-dot pill-red"  title="Red ‚Äî problems"></div>
          <div class="pill-dot pill-green" title="Green ‚Äî correct"></div>
          <div class="pill-dot pill-orange" title="Orange ‚Äî review"></div>
          <div class="pill-dot pill-blue"  title="Blue ‚Äî info"></div>
        </div>
        <div class="empty-actions"><button class="empty-cta" id="emptyAddBtn">‚ûï Add column</button></div>
        <div class="empty-hint">Tip: column name becomes the CSV <code>group</code> and prefixes <code>logName</code>.</div>
      </div>`;
    card.appendChild(empty);
    empty.addEventListener('click', (e)=>{
      if (e.target.id === 'emptyAddBtn' || e.currentTarget === e.target || e.target.closest('.empty-inner')) {
        const nm = prompt('Column name:', ''); if (nm !== null) addColumn(nm);
      }
    });
    return;
  }

  columns.forEach((c)=>{
    const col = document.createElement('div'); col.className='col'; col.dataset.id=c.id;

    const head = document.createElement('div'); head.className='col-header'; head.draggable=true;
    head.innerHTML = `
      <div class="col-title" contenteditable="true" spellcheck="false">${c.name}</div>
      <div class="col-actions">
        <button data-act="add">Add</button>
        <button data-act="del">Delete</button>
      </div>`;
    head.querySelector('.col-title').addEventListener('blur', e=>{ c.name=(e.target.textContent.trim()||'Unnamed'); renderItems(); saveToLocal(); });
    head.querySelector('[data-act="add"]').addEventListener('click', ()=>{ const nm=prompt('New column name:',''); if(nm!==null) addColumn(nm); });
    head.querySelector('[data-act="del"]').addEventListener('click', ()=>{ if(!confirm('Delete this column and its items?'))return; items=items.filter(it=>it.colId!==c.id); columns=columns.filter(x=>x.id!==c.id); saveToLocal(); renderAll(); });

    head.addEventListener('dragstart', e=>{ draggingColId=c.id; e.dataTransfer.setData('text/col', c.id); e.dataTransfer.effectAllowed='move'; col.classList.add('ghost'); });
    head.addEventListener('dragend', ()=>{ draggingColId=null; col.classList.remove('ghost'); });

    col.addEventListener('dragover', e=>{ if(!draggingColId)return; e.preventDefault(); e.dataTransfer.dropEffect='move'; });
    col.addEventListener('drop', e=>{
      if(!draggingColId)return; e.preventDefault();
      const fromIdx=columns.findIndex(x=>x.id===draggingColId), toIdx=columns.findIndex(x=>x.id===c.id);
      if(fromIdx===-1||toIdx===-1||fromIdx===toIdx)return;
      const [moved]=columns.splice(fromIdx,1);
      const rect=col.getBoundingClientRect(); const insertAfter=e.clientX>rect.left+rect.width/2;
      columns.splice(insertAfter?toIdx+1:toIdx,0,moved); saveToLocal(); renderAll();
    });

    const drop = document.createElement('div'); drop.className='drop'; drop.dataset.id=c.id;
    drop.addEventListener('dragover', e=>{ if(dragColor){ e.preventDefault(); e.dataTransfer.dropEffect='copy'; } });
    drop.addEventListener('drop', e=>{
      if(!dragColor)return; e.preventDefault();
      const label = prompt(`Label for ${dragColor} in "${c.name}"`, '');
      createItem(c.id, dragColor, (label||'Unnamed').trim()); dragColor=null;
    });

    const ul=document.createElement('ul'); ul.className='items'; ul.dataset.colId=c.id;
    drop.appendChild(ul); col.appendChild(head); col.appendChild(drop); card.appendChild(col);
  });
}

/* ===== Items (vertical reorder) ===== */
function createItem(colId, color, label){ items.push({ id:'it_'+crypto.randomUUID().slice(0,8), colId, color, label }); saveToLocal(); renderItems(); }
function renderItems(){
  $$('.items').forEach(ul=>ul.innerHTML='');
  for(const c of columns){
    const ul=document.querySelector(`.items[data-col-id="${c.id}"]`);
    const colItems=items.filter(it=>it.colId===c.id); if(!ul) continue;

    const phOld = ul.parentElement.querySelector('.placeholder');
    if(colItems.length===0){ if(!phOld){ const ph=document.createElement('div'); ph.className='placeholder'; ph.textContent='Drag Red/Green/Orange/Blue here'; ul.parentElement.appendChild(ph);} }
    else if(phOld) phOld.remove();

    colItems.forEach((it)=>{
      const li=document.createElement('li'); li.className='item'; li.draggable=true; li.dataset.id=it.id;
      li.innerHTML=`<div class="badge b ${it.color}"></div><div class="label" contenteditable="true" spellcheck="false">${it.label}</div><button class="btn btn-del" title="Delete">üóëÔ∏è</button>`;
      li.querySelector('.label').addEventListener('blur', e=>{ it.label=(e.target.textContent.trim()||'Unnamed'); saveToLocal(); });
      li.querySelector('.btn-del').addEventListener('click', ()=>{ items=items.filter(x=>x.id!==it.id); saveToLocal(); renderItems(); });

      li.addEventListener('dragstart', e=>{ e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/item', it.id); li.classList.add('ghost'); });
      li.addEventListener('dragend', ()=> li.classList.remove('ghost'));

      ul.addEventListener('dragover', e=>{
        if(!e.dataTransfer.types.includes('text/item')) return; e.preventDefault(); e.dataTransfer.dropEffect='move';
        const draggingId=e.dataTransfer.getData('text/item'); const dragging=items.find(x=>x.id===draggingId); if(!dragging||dragging.colId!==c.id) return;
        const after=getItemAfter(ul,e.clientY); const siblings=items.filter(x=>x.colId===c.id); const toIdx=after?siblings.findIndex(x=>x.id===after.dataset.id):0;
        if(siblings[toIdx]?.id!==dragging.id){ const others=items.filter(x=>x.colId!==c.id); const reordered=siblings.filter(x=>x.id!==dragging.id); reordered.splice(toIdx,0,dragging); items=others.concat(reordered); saveToLocal(); renderItems(); }
      });

      ul.appendChild(li);
    });
  }
}
function getItemAfter(ul,y){
  const els=[...ul.querySelectorAll('.item')]; let closest={offset:Number.NEGATIVE_INFINITY,element:null};
  for(const el of els){ const box=el.getBoundingClientRect(); const offset=y-(box.top+box.height/2); if(offset<0&&offset>closest.offset){ closest={offset,element:el}; } }
  return closest.element;
}

/* ===== Export CSV (exact format) ===== */
function exportCSV(){
  const rows=[['group','label','cssClass','logName','isRed']];
  const cssMap={ red:'redButton', green:'greenButton', orange:'orangeButton', blue:'blueButton' };
  columns.forEach(c=>{
    rows.push([c.name, c.name, 'greyButton', c.name, false]);
    const colItems=items.filter(it=>it.colId===c.id);
    colItems.forEach(it=>{
      const cssClass=cssMap[it.color]||'blueButton';
      const logName=`${c.name} ${it.label}`.trim();
      rows.push([c.name, it.label, cssClass, logName, it.color==='red']);
    });
  });
  const csv=rows.map(r=>r.map(csvEscape).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='buttons_layout.csv'; document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
}

/* ===== Import CSV (build columns/items from file) ===== */
function parseCSV(text){
  // small, robust CSV parser for quotes/commas/newlines
  const rows=[]; let cur=''; let inQ=false; let row=[];
  for(let i=0;i<text.length;i++){
    const ch=text[i], next=text[i+1];
    if(inQ){
      if(ch==='"' && next==='"'){ cur+='"'; i++; }
      else if(ch==='"'){ inQ=false; }
      else cur+=ch;
    }else{
      if(ch===','){ row.push(cur); cur=''; }
      else if(ch==='"'){ inQ=true; }
      else if(ch==='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
      else if(ch==='\r'){ /* skip */ }
      else cur+=ch;
    }
  }
  if(cur.length>0 || row.length>0){ row.push(cur); rows.push(row); }
  return rows;
}
function importCSVFile(file){
  const reader=new FileReader();
  reader.onload=()=> {
    try{
      const rows=parseCSV(reader.result);
      if(!rows.length){ toast('CSV is empty', true); return; }
      const header=rows[0].map(s=>s.trim());
      const expected=['group','label','cssClass','logName','isRed'];
      const okHeader=expected.every((h,i)=> (header[i]||'').toLowerCase()===h.toLowerCase());
      if(!okHeader){ toast('CSV header must be: group,label,cssClass,logName,isRed', true); return; }

      // reset board
      columns=[]; items=[];
      const colorFromCss = (css) => {
        const k=String(css||'').toLowerCase();
        if(k==='redbutton') return 'red';
        if(k==='greenbutton') return 'green';
        if(k==='orangebutton') return 'orange';
        if(k==='bluebutton') return 'blue';
        return 'blue';
      };

      // preserve group order as it appears
      const groupToColId=new Map();
      for(let r=1;r<rows.length;r++){
        const [group,label,cssClass,logName,isRed] = rows[r];
        if(!group) continue;
        if(!groupToColId.has(group)){
          const id='col_'+crypto.randomUUID().slice(0,8);
          columns.push({id, name:group});
          groupToColId.set(group,id);
        }
        // skip grey header rows (cssClass=greyButton or label==group)
        const css = (cssClass||'').toLowerCase();
        const isHeader = css==='greybutton' || (label||'')===group;
        if(isHeader) continue;

        const colId=groupToColId.get(group);
        const color=colorFromCss(cssClass);
        const finalLabel = (label||'').trim() || 'Unnamed';
        items.push({ id:'it_'+crypto.randomUUID().slice(0,8), colId, color, label: finalLabel });
      }

      saveToLocal(); renderAll(); toast('CSV imported');
    }catch(err){
      console.error(err); toast('Failed to import CSV', true);
    }
  };
  reader.onerror=()=> toast('Could not read file', true);
  reader.readAsText(file);
}

/* ===== Save / Load (localStorage) ===== */
function saveToLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({columns, items})); toast('Layout saved'); }
function loadFromLocal(init=false){
  let raw=localStorage.getItem(STORAGE_KEY), usedKey=STORAGE_KEY;
  if(!raw){ for(const k of STORAGE_KEYS){ if(k===STORAGE_KEY) continue; const r=localStorage.getItem(k); if(r){ raw=r; usedKey=k; break; } } }
  if(!raw){ if(!init) toast('No saved layout found', true); return false; }
  try{
    const obj=JSON.parse(raw);
    if(obj?.columns && obj?.items){ columns=obj.columns; items=obj.items; if(usedKey!==STORAGE_KEY){ localStorage.setItem(STORAGE_KEY, JSON.stringify({columns,items})); } if(!init) toast('Layout loaded'); return true; }
  }catch(e){ console.warn('Load error:', e); }
  if(!init) toast('Saved data was invalid', true); return false;
}
function clearAll(){ if(!confirm('Clear layout and local storage?')) return; for(const k of STORAGE_KEYS) localStorage.removeItem(k); columns=[]; items=[]; renderAll(); toast('Cleared'); }

/* ===== Header buttons ===== */
$('#addColumnBtn').addEventListener('click', ()=>{ const nm=prompt('Column name:',''); if(nm!==null) addColumn(nm); });
$('#downloadBtn').addEventListener('click', exportCSV);
$('#importBtn').addEventListener('click', ()=> $('#fileInput').click());
$('#fileInput').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(f) importCSVFile(f); e.target.value=''; });
$('#saveBtn').addEventListener('click', saveToLocal);
$('#loadBtn').addEventListener('click', ()=>{ const ok=loadFromLocal(); if(ok) renderAll(); });
$('#clearBtn').addEventListener('click', clearAll);
</script>
</body>
</html>
