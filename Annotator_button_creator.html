<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Annotator ‚Äî Card Builder (Columns, Sidebar, Inherited logName)</title>
<style>
  :root{
    --bg:#0b0d12; --panel:#121622; --muted:#20263a; --ink:#eef2ff;
    --sub:#c7d2fe; --soft:#94a3b8; --accent:#7c3aed;
    --red:#ef4444; --green:#22c55e; --orange:#f59e0b; --blue:#3b82f6;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  *{ box-sizing:border-box; }
  body{ margin:0; background:linear-gradient(180deg,#0a0c12,#0d1120 60%); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  header{ display:flex; align-items:center; gap:12px; padding:10px 14px; border-bottom:1px solid #1a2033; position:sticky; top:0; background:rgba(10,12,18,.7); backdrop-filter: blur(10px); z-index:10;}
  h1{ font-size:15px; margin:0; letter-spacing:.2px; font-weight:700; color:#dbeafe; }
  .row{ display:grid; grid-template-columns: 260px 1fr 320px; gap:12px; padding:12px; }
  .panel{ background:var(--panel); border:1px solid #1a2033; border-radius:14px; box-shadow:var(--shadow); min-height:120px; }
  .panel header{ padding:10px 12px; font-size:12px; font-weight:700; color:#c7d2fe; border-bottom:1px solid #1a2033; }
  .panel .body{ padding:10px; }
  .sidebar .group{ border:1px dashed #27304a; border-radius:12px; margin-bottom:10px; }
  .sidebar .group h3{ margin:0; padding:8px 10px; font-size:12px; letter-spacing:.2px; border-bottom:1px dashed #27304a; color:#e5e7eb; display:flex; align-items:center; gap:8px;}
  .dot{ width:10px; height:10px; border-radius:2px; display:inline-block; }
  .palette-red{ background:var(--red); } .palette-green{ background:var(--green); }
  .palette-orange{ background:var(--orange);} .palette-blue{ background:var(--blue); }
  .tool{ background:#0f1422; border:1px solid #1f2944; border-radius:10px; padding:8px; margin:8px; cursor:grab; user-select:none; }
  .tool:hover{ border-color:#2b375d; background:#121a2e; }
  .tool .name{ font-weight:700; font-size:13px; color:#e2e8f0; }
  .tool .desc{ color:#a5b4fc; font-size:11px; margin-top:3px; }
  .card{ display:flex; gap:10px; padding:10px; min-height:520px; position:relative; overflow:auto; }
  .col{ background:#0c1222; border:1px solid #1e2740; border-radius:12px; min-width:260px; flex:0 0 260px; padding-bottom:12px; position:relative; }
  .col-header{ display:flex; align-items:center; gap:8px; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #1e2740; cursor:grab; }
  .col-title{ font-weight:800; letter-spacing:.2px; color:#e5e7eb; font-size:13px; }
  .col-actions button{ background:#121a2e; border:1px solid #27304a; color:#c7d2fe; border-radius:8px; font-size:11px; padding:4px 8px; cursor:pointer; }
  .col-actions button:hover{ background:#131f3b; }
  .col-drop{ position:relative; min-height:360px; padding:10px; }
  .placeholder{ border:2px dashed #33406a; border-radius:12px; padding:18px; color:#93c5fd; text-align:center; font-size:12px; }
  .placed{ position:absolute; padding:6px 8px; border-radius:10px; border:1px solid #223055; background:#0f1a33; color:#e2e8f0; cursor:grab; min-width:120px; }
  .placed .label{ font-size:12px; font-weight:700; outline:none; }
  .placed .meta{ font-size:10px; color:#9fb0dd; margin-top:2px; }
  .placed .chip{ display:inline-block; padding:2px 6px; font-size:10px; border-radius:999px; border:1px solid #2a3963; background:#0d1730; margin-right:6px; }
  .placed .edit{ position:absolute; top:-10px; right:-10px; width:22px; height:22px; border-radius:50%; background:#0d1730; border:1px solid #2a3963; color:#c7d2fe; display:flex; align-items:center; justify-content:center; cursor:pointer; }
  .color-red{ box-shadow:0 0 0 2px rgba(239,68,68,.3) inset; }
  .color-green{ box-shadow:0 0 0 2px rgba(34,197,94,.35) inset; }
  .color-orange{ box-shadow:0 0 0 2px rgba(245,158,11,.35) inset; }
  .color-blue{ box-shadow:0 0 0 2px rgba(59,130,246,.35) inset; }
  .props .field{ margin:10px 0; }
  .props label{ display:block; font-size:11px; color:#a5b4fc; margin-bottom:4px; }
  .props input, .props select, .props textarea{
    width:100%; padding:8px; border-radius:10px; border:1px solid #27304a; background:#0f1628; color:#e5e7eb; font:inherit;
  }
  .props .row2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .tip{ font-size:11px; color:#9db2ff; background:#0f1628; border:1px dashed #2b375d; padding:8px; border-radius:10px; }
  .footer-actions{ display:flex; gap:8px; }
  .btn{ padding:8px 10px; border-radius:10px; border:1px solid #2a3963; background:#0f1628; color:#dbeafe; cursor:pointer; }
  .btn:hover{ background:#111c34; }
  .drag-ghost{ opacity:.65; }
</style>
</head>
<body>
<header>
  <h1>Annotator ‚Äî Card Builder</h1>
  <div class="footer-actions" style="margin-left:auto;">
    <button class="btn" id="addColumnBtn">‚ûï Add column</button>
    <button class="btn" id="saveBtn">üíæ Save</button>
    <button class="btn" id="loadBtn">üìÇ Load (local)</button>
    <button class="btn" id="clearBtn">üßπ Clear</button>
  </div>
</header>

<div class="row">
  <!-- SIDEBAR -->
  <section class="panel sidebar">
    <header>Sidebar tools (drag into a column) ‚Äî ordered Red ‚Üí Green ‚Üí Orange ‚Üí Blue</header>
    <div class="body" id="sidebar">
      <!-- groups will be injected -->
    </div>
  </section>

  <!-- CARD -->
  <section class="panel">
    <header>Card (columns are draggable left/right; items move freely within a column)</header>
    <div class="body">
      <div id="card" class="card" data-reorder-cols="true"></div>
    </div>
  </section>

  <!-- PROPERTIES -->
  <section class="panel">
    <header>Details</header>
    <div class="body props" id="props">
      <div class="tip">Select a placed item (or click ‚úèÔ∏è) to edit its properties.  
      <br/>logName is <b>&lt;ColumnName&gt; + space + &lt;ButtonLabel&gt;</b> (auto).</div>
      <div class="field">
        <label>Selected item ID</label>
        <input id="p_id" readonly />
      </div>
      <div class="row2">
        <div class="field">
          <label>Column</label>
          <select id="p_column"></select>
        </div>
        <div class="field">
          <label>Color</label>
          <select id="p_color">
            <option value="red">Red</option>
            <option value="green">Green</option>
            <option value="orange">Orange</option>
            <option value="blue">Blue</option>
          </select>
        </div>
      </div>
      <div class="field">
        <label>Label (editable in place too)</label>
        <input id="p_label" />
      </div>
      <div class="field">
        <label>Inherited Annotation (logName)</label>
        <input id="p_logname" readonly />
      </div>
      <div class="row2">
        <div class="field">
          <label>X (px within column)</label>
          <input id="p_x" type="number" step="1" />
        </div>
        <div class="field">
          <label>Y (px within column)</label>
          <input id="p_y" type="number" step="1" />
        </div>
      </div>
      <div class="field">
        <button class="btn" id="p_delete">üóëÔ∏è Delete item</button>
      </div>
    </div>
  </section>
</div>

<script>
/* ---------- DATA: Sidebar definitions (ordered by Red, Green, Orange, Blue) ---------- */
const TOOL_GROUPS = [
  { key:'red',    title:'Red',    color:'red',    items:[
    {label:'No function',           desc:'Feature missing / not active'},
    {label:'Explicit incorrect',    desc:'Clearly wrong behavior'},
    {label:'Implicit incorrect',    desc:'Inferred wrong behavior'},
    {label:'Conditional incorrect', desc:'Wrong under specific conditions'},
    {label:'Dynamic incorrect',     desc:'Wrong over time / oscillation'},
  ]},
  { key:'green',  title:'Green',  color:'green',  items:[
    {label:'OK',            desc:'Meets expectation'},
    {label:'Excellent',     desc:'Exceeds expectation'},
    {label:'Recovered',     desc:'Recovered from fault'},
  ]},
  { key:'orange', title:'Orange', color:'orange', items:[
    {label:'Edge case',     desc:'Ambiguous scenario'},
    {label:'Questionable',  desc:'Needs review'},
  ]},
  { key:'blue',   title:'Blue',   color:'blue',   items:[
    {label:'Info',          desc:'Neutral annotation'},
    {label:'Note',          desc:'Operator note'},
  ]},
];

/* ---------- STATE ---------- */
let columns = [];  // {id, name}
let items = [];    // {id, colId, color, label, x, y}   // logName is derived: colName + ' ' + label
let dragSrcTool = null;   // sidebar drag
let dragColReorder = null;// column reorder
let selectedId = null;

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const cardEl = $('#card');
const sidebarEl = $('#sidebar');
const props = {
  id: $('#p_id'),
  column: $('#p_column'),
  color: $('#p_color'),
  label: $('#p_label'),
  logname: $('#p_logname'),
  x: $('#p_x'),
  y: $('#p_y'),
  del: $('#p_delete'),
};

/* ---------- INIT UI ---------- */
function init(){
  buildSidebar();
  // initial columns
  if (!loadFromLocal(true)) {
    addColumn('TSI Speed');
    addColumn('ACC');
    addColumn('LCC');
  }
  renderColumns();
  renderItems();
  refreshPropsList();
  attachGlobalHandlers();
}
document.addEventListener('DOMContentLoaded', init);

/* ---------- SIDEBAR ---------- */
function buildSidebar(){
  sidebarEl.innerHTML = '';
  for (const g of TOOL_GROUPS){
    const group = document.createElement('div');
    group.className = 'group';
    group.innerHTML = `<h3><span class="dot palette-${g.color}"></span>${g.title}</h3>`;
    for (const it of g.items){
      const el = document.createElement('div');
      el.className = 'tool';
      el.draggable = true;
      el.dataset.color = g.color;
      el.dataset.label = it.label;
      el.innerHTML = `<div class="name">${it.label}</div><div class="desc">${it.desc}</div>`;
      el.addEventListener('dragstart', e=>{
        dragSrcTool = {color:g.color, label:it.label};
        e.dataTransfer.setData('text/plain', JSON.stringify(dragSrcTool));
        e.dataTransfer.effectAllowed = 'copy';
        el.classList.add('drag-ghost');
      });
      el.addEventListener('dragend', ()=> el.classList.remove('drag-ghost'));
      group.appendChild(el);
    }
    sidebarEl.appendChild(group);
  }
}

/* ---------- COLUMNS ---------- */
function addColumn(name){
  const id = 'col_' + crypto.randomUUID().slice(0,8);
  columns.push({id, name});
  renderColumns();
  refreshPropsList();
  saveToLocal();
}
function renameColumn(colId, newName){
  const c = columns.find(c=>c.id===colId);
  if (c){ c.name = newName; renderColumns(); renderItems(); if (selectedId) syncPropsFromSelected(); saveToLocal(); }
}
function deleteColumn(colId){
  // move items out
  items = items.filter(it => it.colId !== colId);
  columns = columns.filter(c => c.id !== colId);
  renderColumns();
  renderItems();
  refreshPropsList();
  saveToLocal();
}

function renderColumns(){
  cardEl.innerHTML = '';
  for (const c of columns){
    const col = document.createElement('div');
    col.className = 'col';
    col.dataset.id = c.id;

    const head = document.createElement('div');
    head.className = 'col-header';
    head.draggable = true;
    head.innerHTML = `
      <div class="col-title" contenteditable="true" spellcheck="false">${c.name}</div>
      <div class="col-actions">
        <button data-act="add">Add</button>
        <button data-act="del">Delete</button>
      </div>`;
    // rename on blur
    head.querySelector('.col-title').addEventListener('blur', e=>{
      renameColumn(c.id, e.target.textContent.trim() || 'Unnamed');
    });
    // actions
    head.querySelector('[data-act="add"]').addEventListener('click', ()=>{
      const nm = prompt('New column name:', 'New Column');
      if (nm) addColumn(nm);
    });
    head.querySelector('[data-act="del"]').addEventListener('click', ()=>{
      if (confirm('Delete this column (items inside will be removed)?')) deleteColumn(c.id);
    });

    // drag to reorder columns
    head.addEventListener('dragstart', e=>{
      dragColReorder = {colId:c.id};
      e.dataTransfer.setData('text/plain', c.id);
      e.dataTransfer.effectAllowed = 'move';
      col.classList.add('drag-ghost');
    });
    head.addEventListener('dragend', ()=>{
      dragColReorder = null;
      col.classList.remove('drag-ghost');
      saveToLocal();
    });
    col.addEventListener('dragover', e=>{
      if (!dragColReorder) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    });
    col.addEventListener('drop', e=>{
      if (!dragColReorder) return;
      e.preventDefault();
      const fromId = dragColReorder.colId;
      const toId = col.dataset.id;
      if (fromId === toId) return;
      const fromIdx = columns.findIndex(x=>x.id===fromId);
      const toIdx = columns.findIndex(x=>x.id===toId);
      const moved = columns.splice(fromIdx,1)[0];
      columns.splice(toIdx,0,moved);
      renderColumns();
      renderItems();
    });

    const drop = document.createElement('div');
    drop.className = 'col-drop';
    drop.dataset.id = c.id;

    // droppable area for tools
    drop.addEventListener('dragover', e=>{
      if (dragSrcTool){ e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; }
    });
    drop.addEventListener('drop', e=>{
      if (!dragSrcTool) return;
      e.preventDefault();
      const rect = drop.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      createPlacedItem(c.id, dragSrcTool.color, dragSrcTool.label, x, y);
      dragSrcTool = null;
    });

    // click to deselect
    drop.addEventListener('pointerdown', e=>{
      if (e.target === drop) selectItem(null);
    });

    col.appendChild(head);
    col.appendChild(drop);
    // placeholder if empty
    if (items.filter(it=>it.colId===c.id).length === 0){
      const ph = document.createElement('div');
      ph.className = 'placeholder';
      ph.textContent = 'Drag buttons from the sidebar into this column';
      drop.appendChild(ph);
    }
    cardEl.appendChild(col);
  }
}

/* ---------- ITEMS (placed buttons) ---------- */
function createPlacedItem(colId, color, label, x, y){
  const id = 'it_' + crypto.randomUUID().slice(0,8);
  items.push({id, colId, color, label, x, y});
  renderItems();
  selectItem(id);
  saveToLocal();
}
function renderItems(){
  // clear drops
  $$('.col-drop').forEach(d=>d.innerHTML='');

  // draw per column
  for (const it of items){
    const drop = $(`.col-drop[data-id="${it.colId}"]`);
    if (!drop) continue;

    const el = document.createElement('div');
    el.className = `placed color-${it.color}`;
    el.dataset.id = it.id;
    el.style.left = (it.x|0) + 'px';
    el.style.top  = (it.y|0) + 'px';

    const colName = (columns.find(c=>c.id===it.colId)?.name) || '';
    const logName = `${colName} ${it.label}`.trim();

    el.innerHTML = `
      <div class="edit" title="Edit details">‚úèÔ∏è</div>
      <div class="chip">${colName}</div>
      <div class="chip">${it.color}</div>
      <div class="label" contenteditable="true" spellcheck="false">${it.label}</div>
      <div class="meta">${logName}</div>
    `;

    // edit click
    el.querySelector('.edit').addEventListener('click', e=>{
      e.stopPropagation();
      selectItem(it.id);
    });

    // inline rename
    const labelEl = el.querySelector('.label');
    labelEl.addEventListener('blur', ()=>{
      const text = labelEl.textContent.trim() || 'Unnamed';
      it.label = text;
      // update meta/log
      const colName2 = (columns.find(c=>c.id===it.colId)?.name) || '';
      el.querySelector('.meta').textContent = `${colName2} ${it.label}`.trim();
      if (selectedId===it.id) syncPropsFromSelected();
      saveToLocal();
    });

    // select on click
    el.addEventListener('pointerdown', e=>{
      if (e.button!==0) return; // left only
      selectItem(it.id);
    });

    // drag within column (free positioning)
    let dragging = false, startX=0, startY=0, baseX=0, baseY=0;
    el.addEventListener('pointerdown', e=>{
      if (e.target.closest('.label') || e.target.classList.contains('edit')) return;
      dragging = true;
      el.setPointerCapture(e.pointerId);
      startX = e.clientX; startY = e.clientY;
      baseX = it.x; baseY = it.y;
      el.style.transition='none';
    });
    el.addEventListener('pointermove', e=>{
      if (!dragging) return;
      const dx = e.clientX - startX; const dy = e.clientY - startY;
      it.x = Math.max(6, baseX + dx);
      it.y = Math.max(6, baseY + dy);
      el.style.left = it.x + 'px';
      el.style.top  = it.y + 'px';
      if (selectedId===it.id) syncPropsFromSelected(/* live */true);
    });
    el.addEventListener('pointerup', e=>{
      if (!dragging) return;
      dragging = false;
      el.releasePointerCapture(e.pointerId);
      el.style.transition='';
      saveToLocal();
    });

    drop.appendChild(el);
  }

  // placeholders for empty columns
  for (const c of columns){
    const drop = $(`.col-drop[data-id="${c.id}"]`);
    if (!drop) continue;
    if (drop.children.length===0){
      const ph = document.createElement('div');
      ph.className = 'placeholder';
      ph.textContent = 'Drag buttons from the sidebar into this column';
      drop.appendChild(ph);
    }
  }

  // update selected highlight
  highlightSelected();
}

/* ---------- SELECTION + PROPS ---------- */
function selectItem(id){
  selectedId = id;
  highlightSelected();
  syncPropsFromSelected();
}
function highlightSelected(){
  $$('.placed').forEach(el=>{
    if (el.dataset.id === selectedId) {
      el.style.outline = '2px solid #7c3aed';
    } else {
      el.style.outline = 'none';
    }
  });
}
function refreshPropsList(){
  props.column.innerHTML = '';
  for (const c of columns){
    const opt = document.createElement('option');
    opt.value = c.id; opt.textContent = c.name;
    props.column.appendChild(opt);
  }
}
function syncPropsFromSelected(live=false){
  const it = items.find(x=>x.id===selectedId);
  if (!it){
    // clear
    props.id.value=''; props.label.value=''; props.logname.value='';
    props.x.value=''; props.y.value='';
    return;
  }
  const colName = (columns.find(c=>c.id===it.colId)?.name) || '';
  props.id.value = it.id;
  props.column.value = it.colId;
  props.color.value = it.color;
  props.label.value = it.label;
  props.logname.value = `${colName} ${it.label}`.trim();
  props.x.value = Math.round(it.x);
  props.y.value = Math.round(it.y);
  if (!live) {
    // also update the visible meta (in case column name changed)
    const el = $(`.placed[data-id="${it.id}"]`);
    if (el){
      el.querySelector('.meta').textContent = `${colName} ${it.label}`.trim();
      const chips = el.querySelectorAll('.chip');
      if (chips[0]) chips[0].textContent = colName;
      if (chips[1]) chips[1].textContent = it.color;
      el.className = `placed color-${it.color}`;
    }
  }
}

/* props events */
props.column.addEventListener('change', ()=>{
  const it = items.find(x=>x.id===selectedId); if (!it) return;
  it.colId = props.column.value;
  renderItems();
  syncPropsFromSelected();
  saveToLocal();
});
props.color.addEventListener('change', ()=>{
  const it = items.find(x=>x.id===selectedId); if (!it) return;
  it.color = props.color.value;
  renderItems(); syncPropsFromSelected(); saveToLocal();
});
props.label.addEventListener('input', ()=>{
  const it = items.find(x=>x.id===selectedId); if (!it) return;
  it.label = props.label.value;
  const el = $(`.placed[data-id="${it.id}"]`);
  if (el){
    el.querySelector('.label').textContent = it.label;
    const colName = (columns.find(c=>c.id===it.colId)?.name) || '';
    el.querySelector('.meta').textContent = `${colName} ${it.label}`.trim();
  }
  props.logname.value = `${(columns.find(c=>c.id===it.colId)?.name)||''} ${it.label}`.trim();
});
props.x.addEventListener('input', ()=>{
  const it = items.find(x=>x.id===selectedId); if (!it) return;
  it.x = parseInt(props.x.value)||0;
  const el = $(`.placed[data-id="${it.id}"]`);
  if (el) el.style.left = it.x + 'px';
});
props.y.addEventListener('input', ()=>{
  const it = items.find(x=>x.id===selectedId); if (!it) return;
  it.y = parseInt(props.y.value)||0;
  const el = $(`.placed[data-id="${it.id}"]`);
  if (el) el.style.top = it.y + 'px';
});
props.del.addEventListener('click', ()=>{
  const it = items.find(x=>x.id===selectedId); if (!it) return;
  if (!confirm('Delete this item?')) return;
  items = items.filter(x=>x.id!==it.id);
  renderItems(); selectItem(null); saveToLocal();
});

/* ---------- SAVE / LOAD ---------- */
function saveToLocal(){
  const obj = {columns, items, v:1};
  localStorage.setItem('cardLayout', JSON.stringify(obj));
}
function loadFromLocal(init=false){
  const raw = localStorage.getItem('cardLayout');
  if (!raw) return false;
  try{
    const obj = JSON.parse(raw);
    if (!obj || !obj.columns || !obj.items) return false;
    columns = obj.columns;
    items = obj.items;
    if (!init){ renderColumns(); renderItems(); refreshPropsList(); }
    return true;
  }catch(e){ console.warn('load error', e); return false; }
}
$('#saveBtn').addEventListener('click', saveToLocal);
$('#clearBtn').addEventListener('click', ()=>{
  if (confirm('Clear layout and local storage?')){
    localStorage.removeItem('cardLayout');
    columns=[]; items=[];
    addColumn('TSI Speed'); addColumn('ACC'); addColumn('LCC');
    renderColumns(); renderItems(); refreshPropsList();
  }
});
$('#loadBtn').addEventListener('click', ()=>{ loadFromLocal(); });

/* ---------- Add Column button ---------- */
$('#addColumnBtn').addEventListener('click', ()=>{
  const nm = prompt('Column name:', 'New Column');
  if (nm) addColumn(nm);
});

/* ---------- Global handlers ---------- */
function attachGlobalHandlers(){
  // deselect when clicking outside placed items
  document.addEventListener('pointerdown', e=>{
    if (!e.target.closest('.placed') && !e.target.closest('.props')) selectItem(null);
  });
  // keyboard delete
  document.addEventListener('keydown', e=>{
    if (e.key==='Delete' && selectedId){
      const it = items.find(x=>x.id===selectedId);
      if (it){ items = items.filter(x=>x.id!==it.id); renderItems(); selectItem(null); saveToLocal(); }
    }
  });
}
</script>
</body>
</html>
