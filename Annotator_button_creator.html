<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Annotator ‚Äî Button Builder (Empty start, Sidebar descriptions, Exact CSV)</title>
<style>
  :root{
    --bg:#0b0d12; --panel:#121622; --ink:#eef2ff;
    --red:#ef4444; --green:#22c55e; --orange:#f59e0b; --blue:#3b82f6;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  *{ box-sizing:border-box; }
  body{ margin:0; background:linear-gradient(180deg,#0a0c12,#0d1120 60%); color:#eef2ff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  header{ display:flex; align-items:center; gap:8px; padding:10px 14px; border-bottom:1px solid #1a2033; position:sticky; top:0; background:rgba(10,12,18,.7); backdrop-filter: blur(10px); z-index:10;}
  h1{ font-size:15px; margin:0; font-weight:700; color:#dbeafe; }

  .row{ display:grid; grid-template-columns: 240px 1fr; gap:12px; padding:12px; }
  .panel{ background:#121622; border:1px solid #1a2033; border-radius:14px; box-shadow:var(--shadow); }
  .panel header{ padding:10px 12px; font-size:12px; font-weight:700; color:#c7d2fe; border-bottom:1px solid #1a2033; }
  .panel .body{ padding:10px; }

  /* Sidebar ‚Äî 4 color buttons with descriptions */
  .color-btn{
    display:flex; gap:10px; padding:12px; margin-bottom:10px;
    background:#0f1422; border:1px solid #1f2944; border-radius:12px; cursor:grab; user-select:none;
  }
  .color-btn:hover{ background:#121a2e; border-color:#2b375d; }
  .dot{ width:16px; height:16px; border-radius:3px; margin-top:2px; flex:0 0 16px; }
  .dot.red{background:var(--red);} .dot.green{background:var(--green);}
  .dot.orange{background:var(--orange);} .dot.blue{background:var(--blue);}
  .btn-text{ display:flex; flex-direction:column; gap:4px; }
  .name{ font-weight:800; line-height:1; }
  .desc{ font-size:11px; color:#aab4e0; line-height:1.2; }

  /* Board + columns */
  .card{ display:flex; gap:10px; padding:10px; min-height:520px; overflow:auto; }
  .empty-board{
    display:flex; align-items:center; justify-content:center; width:100%; min-height:380px;
    border:2px dashed #33406a; border-radius:12px; color:#93c5fd; font-size:13px; text-align:center; padding:24px;
  }
  .col{ background:#0c1222; border:1px solid #1e2740; border-radius:12px; width:300px; flex:0 0 300px; display:flex; flex-direction:column; }
  .col-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-bottom:1px solid #1e2740; cursor:grab; }
  .col-title{ font-weight:800; color:#e5e7eb; font-size:13px; outline:none; }
  .col-actions button{ background:#121a2e; border:1px solid #27304a; color:#c7d2fe; border-radius:8px; font-size:11px; padding:4px 8px; cursor:pointer; }
  .col-actions button:hover{ background:#131f3b; }
  .drop{ flex:1; padding:10px; }
  .placeholder{ border:2px dashed #33406a; border-radius:12px; padding:18px; color:#93c5fd; text-align:center; font-size:12px; }

  /* Items: vertical list only (reorder within column) */
  ul.items{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px; }
  li.item{
    display:flex; align-items:center; gap:10px; padding:10px;
    border:1px solid #223055; border-radius:10px; background:#0f1a33; cursor:grab;
  }
  .badge{ width:18px; height:18px; border-radius:4px; }
  .b.red{background:var(--red);} .b.green{background:var(--green);}
  .b.orange{background:var(--orange);} .b.blue{background:var(--blue);}
  .label{ flex:1; font-size:13px; font-weight:700; color:#e2e8f0; outline:none; }
  .btn{ padding:8px 10px; border-radius:10px; border:1px solid #2a3963; background:#0f1628; color:#dbeafe; cursor:pointer; }
  .btn:hover{ background:#111c34; }
  .ghost{ opacity:.6; }
</style>
</head>
<body>
<header>
  <h1>Annotator ‚Äî Button Builder</h1>
  <div style="margin-left:auto; display:flex; gap:8px;">
    <button class="btn" id="addColumnBtn">‚ûï Add column</button>
    <button class="btn" id="downloadBtn">‚¨áÔ∏è Download CSV</button>
    <button class="btn" id="saveBtn">üíæ Save</button>
    <button class="btn" id="loadBtn">üìÇ Load (local)</button>
    <button class="btn" id="clearBtn">üßπ Clear</button>
  </div>
</header>

<div class="row">
  <!-- Sidebar -->
  <section class="panel">
    <header>Buttons ‚Äî drag into the layout</header>
    <div class="body" id="sidebar">
      <div class="color-btn" draggable="true" data-color="red">
        <div class="dot red"></div>
        <div class="btn-text">
          <div class="name">Red</div>
          <div class="desc">Problems / failures: no function, incorrect behavior, false warnings.</div>
        </div>
      </div>
      <div class="color-btn" draggable="true" data-color="green">
        <div class="dot green"></div>
        <div class="btn-text">
          <div class="name">Green</div>
          <div class="desc">Correct / positive outcomes: OK, excellent, recovered.</div>
        </div>
      </div>
      <div class="color-btn" draggable="true" data-color="orange">
        <div class="dot orange"></div>
        <div class="btn-text">
          <div class="name">Orange</div>
          <div class="desc">Ambiguous / edge cases ‚Äî needs human review.</div>
        </div>
      </div>
      <div class="color-btn" draggable="true" data-color="blue">
        <div class="dot blue"></div>
        <div class="btn-text">
          <div class="name">Blue</div>
          <div class="desc">Neutral info / notes and context.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Board -->
  <section class="panel">
    <header>Button Layout</header>
    <div class="body"><div id="card" class="card"></div></div>
  </section>
</div>

<script>
/* ---------- State ---------- */
let columns = []; // {id, name}
let items = [];   // {id, colId, color, label}

/* ---------- Helpers ---------- */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const card = $('#card');
const csvEscape = (v) => {
  const s = String(v ?? '');
  return (/[",\n]/.test(s)) ? `"${s.replace(/"/g,'""')}"` : s;
};

/* ---------- Init (start empty if no saved layout) ---------- */
document.addEventListener('DOMContentLoaded', () => {
  loadFromLocal(true);   // if present, loads; otherwise keep empty
  renderAll();
  wireSidebar();
});

/* ---------- Sidebar: exactly 4 colors (with descriptions) ---------- */
let dragColor = null;
function wireSidebar(){
  $$('#sidebar .color-btn').forEach(btn=>{
    btn.addEventListener('dragstart', e=>{
      dragColor = btn.dataset.color;
      e.dataTransfer.setData('text/color', dragColor);
      e.dataTransfer.effectAllowed = 'copy';
      btn.classList.add('ghost');
    });
    btn.addEventListener('dragend', ()=> btn.classList.remove('ghost'));
  });
}

/* ---------- Columns ---------- */
function addColumn(name){
  columns.push({ id:'col_'+crypto.randomUUID().slice(0,8), name: name.trim() || 'Unnamed' });
  saveToLocal(); renderAll();
}
function renderAll(){ renderColumns(); renderItems(); }

/* Column reorder: drag header onto another column to insert before/after */
let draggingColId = null;
function renderColumns(){
  card.innerHTML = '';

  if (columns.length === 0){
    const empty = document.createElement('div');
    empty.className = 'empty-board';
    empty.innerHTML = `
      The board is empty.<br><br>
      Click <b>‚Äú‚ûï Add column‚Äù</b> to create your first group,<br>
      then drag a color from the sidebar into the new column.`;
    card.appendChild(empty);
    return;
  }

  columns.forEach((c)=>{
    const col = document.createElement('div');
    col.className = 'col';
    col.dataset.id = c.id;

    const head = document.createElement('div');
    head.className = 'col-header';
    head.draggable = true;
    head.innerHTML = `
      <div class="col-title" contenteditable="true" spellcheck="false">${c.name}</div>
      <div class="col-actions">
        <button data-act="add">Add</button>
        <button data-act="del">Delete</button>
      </div>`;

    head.querySelector('.col-title').addEventListener('blur', e=>{
      c.name = e.target.textContent.trim() || 'Unnamed';
      renderItems(); saveToLocal();
    });
    head.querySelector('[data-act="add"]').addEventListener('click', ()=>{
      const nm = prompt('New column name:', '');
      if (nm !== null) addColumn(nm);
    });
    head.querySelector('[data-act="del"]').addEventListener('click', ()=>{
      if (!confirm('Delete this column and its items?')) return;
      items = items.filter(it=>it.colId!==c.id);
      columns = columns.filter(x=>x.id!==c.id);
      saveToLocal(); renderAll();
    });

    head.addEventListener('dragstart', e=>{
      draggingColId = c.id;
      e.dataTransfer.setData('text/col', c.id);
      e.dataTransfer.effectAllowed = 'move';
      col.classList.add('ghost');
    });
    head.addEventListener('dragend', ()=>{ draggingColId=null; col.classList.remove('ghost'); });

    col.addEventListener('dragover', e=>{
      if (!draggingColId) return;
      e.preventDefault();
      e.dataTransfer.dropEffect='move';
    });
    col.addEventListener('drop', e=>{
      if (!draggingColId) return;
      e.preventDefault();
      const fromIdx = columns.findIndex(x=>x.id===draggingColId);
      const toIdx   = columns.findIndex(x=>x.id===c.id);
      if (fromIdx === -1 || toIdx === -1 || fromIdx === toIdx) return;
      const [moved] = columns.splice(fromIdx,1);
      const rect = col.getBoundingClientRect();
      const insertAfter = e.clientX > rect.left + rect.width/2;
      columns.splice(insertAfter ? toIdx+1 : toIdx, 0, moved);
      saveToLocal(); renderAll();
    });

    const drop = document.createElement('div');
    drop.className = 'drop';
    drop.dataset.id = c.id;

    drop.addEventListener('dragover', e=>{
      if (dragColor) { e.preventDefault(); e.dataTransfer.dropEffect='copy'; }
    });
    drop.addEventListener('drop', e=>{
      if (!dragColor) return;
      e.preventDefault();
      const label = prompt(`Label for ${dragColor} in "${c.name}"`, '');
      createItem(c.id, dragColor, (label||'Unnamed').trim());
      dragColor = null;
    });

    const ul = document.createElement('ul');
    ul.className = 'items';
    ul.dataset.colId = c.id;

    drop.appendChild(ul);
    col.appendChild(head);
    col.appendChild(drop);
    card.appendChild(col);
  });
}

/* ---------- Items (vertical list, reorder within column) ---------- */
function createItem(colId, color, label){
  items.push({ id:'it_'+crypto.randomUUID().slice(0,8), colId, color, label });
  saveToLocal(); renderItems();
}
function renderItems(){
  $$('.items').forEach(ul => { ul.innerHTML=''; });

  for (const c of columns){
    const ul = document.querySelector(`.items[data-col-id="${c.id}"]`);
    const colItems = items.filter(it=>it.colId===c.id);
    if (!ul) continue;

    const phOld = ul.parentElement.querySelector('.placeholder');
    if (colItems.length===0){
      if (!phOld){
        const ph = document.createElement('div');
        ph.className = 'placeholder';
        ph.textContent = 'Drag Red/Green/Orange/Blue here';
        ul.parentElement.appendChild(ph);
      }
    } else if (phOld) phOld.remove();

    colItems.forEach((it)=>{
      const li = document.createElement('li');
      li.className = 'item';
      li.draggable = true;
      li.dataset.id = it.id;
      li.innerHTML = `
        <div class="badge b ${it.color}"></div>
        <div class="label" contenteditable="true" spellcheck="false">${it.label}</div>
        <button class="btn btn-del" title="Delete">üóëÔ∏è</button>
      `;
      li.querySelector('.label').addEventListener('blur', e=>{
        it.label = e.target.textContent.trim() || 'Unnamed';
        saveToLocal();
      });
      li.querySelector('.btn-del').addEventListener('click', ()=>{
        items = items.filter(x=>x.id!==it.id);
        saveToLocal(); renderItems();
      });

      // reorder within same column
      li.addEventListener('dragstart', e=>{
        e.dataTransfer.effectAllowed='move';
        e.dataTransfer.setData('text/item', it.id);
        li.classList.add('ghost');
      });
      li.addEventListener('dragend', ()=> li.classList.remove('ghost'));

      ul.addEventListener('dragover', e=>{
        if (!e.dataTransfer.types.includes('text/item')) return;
        e.preventDefault(); e.dataTransfer.dropEffect='move';
        const draggingId = e.dataTransfer.getData('text/item');
        const dragging = items.find(x=>x.id===draggingId);
        if (!dragging || dragging.colId !== c.id) return;
        const after = getItemAfter(ul, e.clientY);
        const siblings = items.filter(x=>x.colId===c.id);
        const toIdx = after ? siblings.findIndex(x=>x.id===after.dataset.id) : 0;
        if (siblings[toIdx]?.id !== dragging.id){
          const others = items.filter(x=>x.colId!==c.id);
          const reordered = siblings.filter(x=>x.id!==dragging.id);
          reordered.splice(toIdx, 0, dragging);
          items = others.concat(reordered);
          saveToLocal(); renderItems();
        }
      });

      ul.appendChild(li);
    });
  }
}
function getItemAfter(ul, y){
  const els = [...ul.querySelectorAll('.item')];
  let closest = {offset: Number.NEGATIVE_INFINITY, element: null};
  for (const el of els){
    const box = el.getBoundingClientRect();
    const offset = y - (box.top + box.height/2);
    if (offset < 0 && offset > closest.offset){ closest = {offset, element: el}; }
  }
  return closest.element;
}

/* ---------- CSV (exact header & rows) ---------- */
function downloadCSV(){
  const rows = [];
  rows.push(['group','label','cssClass','logName','isRed']);

  const cssMap = { red:'redButton', green:'greenButton', orange:'orangeButton', blue:'blueButton' };

  columns.forEach((c)=>{
    // Column header row
    rows.push([c.name, c.name, 'greyButton', c.name, false]);
    // Items
    const colItems = items.filter(it=>it.colId===c.id);
    colItems.forEach((it)=>{
      const cssClass = cssMap[it.color] || 'blueButton';
      const logName = `${c.name} ${it.label}`.trim();
      const isRed = (it.color === 'red');
      rows.push([c.name, it.label, cssClass, logName, isRed]);
    });
  });

  const csv = rows.map(r => r.map(csvEscape).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'KPI_buttons.csv';
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(a.href);
  a.remove();
}

/* ---------- Save / Load / Controls ---------- */
function saveToLocal(){ localStorage.setItem('cardLayout_v6', JSON.stringify({columns, items})); }
function loadFromLocal(init=false){
  const raw = localStorage.getItem('cardLayout_v6');
  if (!raw) return false;
  try{
    const obj = JSON.parse(raw);
    if (obj?.columns && obj?.items){ columns = obj.columns; items = obj.items; return true; }
  }catch(e){}
  return false;
}
function clearAll(){
  if (!confirm('Clear layout and local storage?')) return;
  localStorage.removeItem('cardLayout_v6');
  columns=[]; items=[];
  renderAll();
}

/* ---------- Header buttons ---------- */
$('#addColumnBtn').addEventListener('click', ()=>{
  const nm = prompt('Column name:', '');
  if (nm !== null) addColumn(nm);
});
$('#downloadBtn').addEventListener('click', downloadCSV);
$('#saveBtn').addEventListener('click', saveToLocal);
$('#loadBtn').addEventListener('click', ()=>{ loadFromLocal(); renderAll(); });
$('#clearBtn').addEventListener('click', clearAll);
</script>
</body>
</html>
