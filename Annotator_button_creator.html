<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Drag‑and‑Drop KPI Builder (Free Placement)</title>
<style>
  :root{
    --bg:#0f1115;--ink:#e6e7eb;--muted:#9aa4b2;--panel:#151922;--panel2:#0e121a;--border:#232836;--brand:#4f7cff;
    --red:#ef4444;--blue:#2563eb;--green:#16a34a;--orange:#f59e0b;--grey:#6b7280
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
  aside{background:var(--panel);border-right:1px solid var(--border);padding:14px;position:sticky;top:0;height:100vh}
  main{padding:18px}
  h1{font-size:16px;margin:0 0 14px 0}
  h2{font-size:13px;margin:14px 0 8px;color:var(--muted)}
  .badge{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center}
  input,select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--panel2);color:var(--ink)}
  input:focus,select:focus,textarea:focus{outline:2px solid #2a56ff33}
  .toolbar{display:flex;gap:12px;flex-wrap:wrap;margin:0 0 12px}
  button{border:1px solid var(--border);background:#1b2030;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  button:hover{border-color:#2a3144}
  .primary{background:var(--brand);border-color:transparent}
  .ghost{background:transparent}
  .danger{background:var(--red)}
  .switch{display:flex;gap:8px;align-items:center}

  /* Sidebar palette */
  .palette{display:grid;grid-template-columns:1fr;gap:8px}

  /* Card (stage) */
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px;min-height:360px;position:relative}
  .cardHeader{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px}
  .stage{position:relative;min-height:300px;border:1px dashed #2a3144;border-radius:12px;overflow:hidden;background:linear-gradient( to bottom right, #101521, #0f131d)}
  .dropHint{color:var(--muted);font-size:13px;padding:8px}

  /* KPI button look */
  .bigButton{display:inline-flex;align-items:center;justify-content:center;min-width:80px;padding:10px 14px;border-radius:8px;border:none;color:#fff;user-select:none}
  .blueButton{background:var(--blue)}
  .redButton{background:var(--red)}
  .greenButton{background:var(--green)}
  .orangeButton{background:var(--orange)}
  .greyButton{background:var(--grey)}

  /* Draggable instance on stage */
  .node{position:absolute;cursor:grab;touch-action:none}
  .node:active{cursor:grabbing}
  .selected{outline:2px solid #7aa2ff}

  /* Drag from palette visuals */
  .dropping{outline:2px dashed #7aa2ff;outline-offset:6px}

  dialog{border:1px solid var(--border);background:var(--panel);color:var(--ink);border-radius:12px;padding:14px;max-width:420px}
  dialog::backdrop{background:rgba(0,0,0,.45)}
  .grid2{display:grid;grid-template-columns:1fr;gap:10px}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="app">
  <aside>
    <h1>Palette</h1>
    <p class="badge">Drag a color into the card</p>

    <h2>Buttons</h2>
    <div class="palette" id="palette">
      <button class="bigButton blueButton"   draggable="true" data-css="blueButton">Blue</button>
      <button class="bigButton redButton"    draggable="true" data-css="redButton">Red</button>
      <button class="bigButton greenButton"  draggable="true" data-css="greenButton">Green</button>
      <button class="bigButton orangeButton" draggable="true" data-css="orangeButton">Orange</button>
      <button class="bigButton greyButton"   draggable="true" data-css="greyButton">Grey</button>
    </div>

    <h2>CSV</h2>
    <div class="row">
      <button id="importBtn" class="ghost">Import CSV</button>
      <input id="file" type="file" accept=".csv" hidden>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="exportBtn" class="primary">Download CSV</button>
    </div>

    <h2>Actions</h2>
    <div class="row" style="margin-bottom:8px">
      <button id="clearBtn" class="danger">Clear card</button>
    </div>
    <div class="switch">
      <input type="checkbox" id="snapChk">
      <label for="snapChk">Snap to 8 px grid</label>
    </div>
  </aside>

  <main>
    <div class="toolbar">
      <label class="pill">Group</label>
      <input id="groupName" placeholder="e.g. ADAS KPI" value="Default" style="max-width:260px">
      <span class="pill" id="countPill">0 buttons</span>
      <span class="pill" id="sizePill">Canvas: – × –</span>
    </div>

    <section class="card" id="card">
      <div class="cardHeader">
        <div class="dropHint">Drop buttons anywhere. Drag to move. Click to edit.</div>
      </div>
      <div class="stage" id="stage" tabindex="0"></div>
    </section>
  </main>
</div>

<!-- Editor dialog -->
<dialog id="editor">
  <form method="dialog" class="grid2">
    <h3 style="margin:0">Edit Button</h3>
    <div>
      <label class="badge">Label (what user sees)</label>
      <input id="editLabel" placeholder="Button label">
    </div>
    <div>
      <label class="badge">Annotation string (logName)</label>
      <input id="editLog" placeholder="Defaults to label if empty">
    </div>
    <div>
      <label class="badge">Color</label>
      <select id="editCss">
        <option value="blueButton">blueButton</option>
        <option value="redButton">redButton</option>
        <option value="greenButton">greenButton</option>
        <option value="orangeButton">orangeButton</option>
        <option value="greyButton">greyButton</option>
      </select>
    </div>
    <div class="right">
      <button value="delete" class="danger">Delete</button>
      <button value="cancel" class="ghost">Cancel</button>
      <button value="ok" class="primary">Save</button>
    </div>
  </form>
</dialog>

<script>
  // ===== Model =====
  // Now each item carries x,y (px) absolute coordinates within stage.
  // CSV adds optional x,y columns at the end. Your existing app will ignore them,
  // but this tool keeps them for visual layouts.
  let items = []; // {label, logName, cssClass, x, y}

  const palette = document.getElementById('palette');
  const stage   = document.getElementById('stage');
  const card    = document.getElementById('card');
  const countPill   = document.getElementById('countPill');
  const sizePill    = document.getElementById('sizePill');
  const groupNameEl = document.getElementById('groupName');
  const snapChk     = document.getElementById('snapChk');

  // --- Utilities
  const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
  const snap  = (n)=> snapChk.checked ? Math.round(n/8)*8 : n;

  // --- Update canvas size pill
  const obs = new ResizeObserver(()=>{
    const r = stage.getBoundingClientRect();
    sizePill.textContent = `Canvas: ${Math.round(r.width)} × ${Math.round(r.height)}`;
  });
  obs.observe(stage);

  // --- Drag from palette into stage
  palette.addEventListener('dragstart', (e)=>{
    const css = e.target?.dataset?.css;
    if(!css) return;
    e.dataTransfer.setData('text/plain', JSON.stringify({ cssClass: css }));
    e.dataTransfer.effectAllowed = 'copy';
  });

  ;[stage,card].forEach(el=>{
    el.addEventListener('dragover', (e)=>{ e.preventDefault(); stage.classList.add('dropping'); });
    el.addEventListener('dragleave', ()=> stage.classList.remove('dropping'));
    el.addEventListener('drop', (e)=>{
      e.preventDefault(); stage.classList.remove('dropping');
      const data = JSON.parse(e.dataTransfer.getData('text/plain')||'{}');
      if(!data.cssClass) return;
      const rect = stage.getBoundingClientRect();
      const x = snap(e.clientX - rect.left - 40); // center-ish
      const y = snap(e.clientY - rect.top  - 16);
      items.push({ label:'New Button', logName:'', cssClass:data.cssClass, x, y });
      render();
    });
  });

  // --- Render nodes
  function render(){
    stage.innerHTML = '';
    items.forEach((it, idx)=>{
      const node = document.createElement('div');
      node.className = 'node';
      node.style.left = (it.x||0)+ 'px';
      node.style.top  = (it.y||0)+ 'px';
      node.dataset.idx = idx;

      const btn = document.createElement('button');
      btn.className = `bigButton ${it.cssClass||'blueButton'}`;
      btn.textContent = it.label || '';
      btn.title = it.logName ? `logName: ${it.logName}` : 'Click to edit';

      // interactions
      btn.addEventListener('dblclick', ()=> edit(idx));
      btn.addEventListener('click',  ()=> select(node));

      // pointer drag move
      node.addEventListener('pointerdown', (ev)=> startDrag(ev, idx));

      node.appendChild(btn);
      stage.appendChild(node);
    });
    countPill.textContent = `${items.length} button${items.length===1?'':'s'}`;
  }

  // Selection highlight
  function select(node){
    stage.querySelectorAll('.selected').forEach(n=> n.classList.remove('selected'));
    node.classList.add('selected');
  }

  // Drag within stage
  let drag = null; // {idx, offX, offY}
  function startDrag(ev, idx){
    ev.preventDefault();
    const node = ev.currentTarget;
    select(node);
    node.setPointerCapture(ev.pointerId);
    const r = node.getBoundingClientRect();
    const stageR = stage.getBoundingClientRect();
    drag = { idx, offX: ev.clientX - r.left, offY: ev.clientY - r.top, stageR };
    node.addEventListener('pointermove', onMove);
    node.addEventListener('pointerup', onUp, { once:true });
  }
  function onMove(ev){
    if(!drag) return;
    const { idx, offX, offY, stageR } = drag;
    const nx = snap(ev.clientX - stageR.left - offX);
    const ny = snap(ev.clientY - stageR.top  - offY);
    // bounds (keep node fully in stage)
    const nodeW = 100, nodeH = 40; // approx; buttons vary, but decent clamp
    const x = clamp(nx, 0, stageR.width - nodeW);
    const y = clamp(ny, 0, stageR.height - nodeH);
    items[idx].x = x; items[idx].y = y;
    // apply live without full re-render for smoothness
    const node = stage.querySelector(`.node[data-idx="${idx}"]`);
    if(node){ node.style.left = x+'px'; node.style.top = y+'px'; }
  }
  function onUp(ev){
    const node = ev.currentTarget;
    node.removeEventListener('pointermove', onMove);
    drag = null;
  }

  // Editor dialog
  const dialog = document.getElementById('editor');
  const editLabel = document.getElementById('editLabel');
  const editLog = document.getElementById('editLog');
  const editCss = document.getElementById('editCss');
  let editing = -1;

  function edit(idx){
    editing = idx;
    const it = items[idx];
    editLabel.value = it.label || '';
    editLog.value = it.logName || '';
    editCss.value = it.cssClass || 'blueButton';
    dialog.showModal();
  }
  dialog.addEventListener('close', ()=>{
    const action = dialog.returnValue; // ok | cancel | delete
    if(action === 'delete' && editing>=0){ items.splice(editing,1); editing=-1; render(); return; }
    if(action !== 'ok' || editing<0) { editing=-1; return; }
    const it = items[editing];
    it.label = editLabel.value.trim() || 'Button';
    it.logName = editLog.value.trim();
    it.cssClass = editCss.value;
    editing = -1; render();
  });

  // CSV helpers (group,label,cssClass,logName,x,y)
  function toCSV(){
    const rows = [["group","label","cssClass","logName","x","y"]];
    const g = groupNameEl.value.trim() || 'Default';
    for(const it of items){ rows.push([g, it.label||'', it.cssClass||'blueButton', (it.logName||it.label||''), String(Math.round(it.x||0)), String(Math.round(it.y||0)) ]); }
    return rows.map(r=>r.map(cell=>/[",
]/.test(cell)?'"'+cell.replace(/"/g,'""')+'"':cell).join(',')).join('
');
  }

  function fromCSV(text){
    const rows = text.split(/
?
/).map(l=>l.trim()).filter(Boolean).map(line=>{
      const out=[]; let s='', q=false; for(let i=0;i<line.length;i++){ const c=line[i],n=line[i+1]; if(q){ if(c==='"'&&n==='"'){s+='"'; i++;} else if(c==='"'){q=false;} else s+=c; } else { if(c==='"'){q=true;} else if(c===','){out.push(s); s='';} else s+=c; } } out.push(s); return out; });
    if(!rows.length) return;
    let start=0; const hdr = rows[0].map(x=>x.toLowerCase());
    const hasHeader = hdr.includes('group') && hdr.includes('label');
    if(hasHeader) start=1;
    items = [];
    for(let i=start;i<rows.length;i++){
      const [g,l,c,n,x,y] = rows[i];
      if(!l && !c) continue;
      if(i===start && g) groupNameEl.value = g;
      items.push({ label:l||'', cssClass:(c||'blueButton'), logName:(n||''), x: Number(x)||0, y: Number(y)||0 });
    }
    render();
  }

  // Wire import/export/clear
  document.getElementById('exportBtn').onclick = ()=>{
    const csv = toCSV();
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const ts = new Date().toISOString().slice(0,10);
    a.download = `kpi_buttons_${ts}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 3000);
  };

  const file = document.getElementById('file');
  document.getElementById('importBtn').onclick = ()=> file.click();
  file.addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=> fromCSV(reader.result);
    reader.readAsText(f);
    file.value='';
  });

  document.getElementById('clearBtn').onclick = ()=>{ items = []; render(); };

  // Seed empty
  render();
</script>
</body>
</html>
