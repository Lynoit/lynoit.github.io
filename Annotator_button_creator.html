<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KPI Button CSV Maker</title>

<!-- (Optional) PapaParse for robust CSV import; export we do manually -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root {
    --bg: #111;
    --panel: #1b1b1b;
    --text: #eee;
    --muted: #aaa;
    --accent: #3b82f6;
    --danger: #ef4444;
    --ok: #22c55e;
    --border: #2a2a2a;
  }
  html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, Arial, sans-serif; }
  h1 { font-size: 18px; margin: 16px 0; }
  .wrap { display: grid; grid-template-columns: 320px 1fr; gap: 16px; padding: 16px; height: 100%; box-sizing: border-box; }
  .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 12px; overflow: auto; }
  .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .row + .row { margin-top: 8px; }
  label { font-size: 12px; color: var(--muted); }
  input[type="text"], select, textarea {
    background: #121212; color: var(--text); border: 1px solid var(--border);
    border-radius: 8px; padding: 8px 10px; outline: none; width: 100%;
  }
  button {
    background: var(--accent); color: white; border: 0; border-radius: 8px; padding: 8px 12px; cursor: pointer;
  }
  button.secondary { background: #444; }
  button.ghost { background: transparent; border: 1px solid var(--border); }
  button.danger { background: var(--danger); }
  button.ok { background: var(--ok); }
  .hint { color: var(--muted); font-size: 12px; }
  .inline { display: inline-flex; gap: 6px; align-items: center; }
  .split { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .groupCard {
    border: 1px dashed var(--border); border-radius: 10px; padding: 10px; margin-top: 10px;
  }
  .groupHeader { display: flex; align-items: center; gap: 8px; justify-content: space-between; margin-bottom: 8px; }
  .groupHeader .left { display: flex; gap: 8px; align-items: center; }
  .groupHeader input { width: 220px; }
  .btnRow { display: grid; grid-template-columns: 1fr auto auto auto; gap: 8px; align-items: center; }
  .btnRow + .btnRow { margin-top: 8px; }
  .previewWrap { border-top: 1px solid var(--border); margin-top: 8px; padding-top: 8px; }
  .btnPreview .bigButton { display: inline-block; min-width: 80px; padding: 12px; margin: 6px 6px 0 0; border-radius: 6px; font-size: 14px; }
  /* mimic your app classes */
  .bigButton { background: #555; color: #fff; }
  .redButton { background: red; color: #fff; }
  .greenButton { background: green; color: #fff; }
  .blueButton { background: blue; color: #fff; }
  .orangeButton { background: orange; color: #fff; }
  .greyButton { background: grey; color: #fff; }
  .footer { display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top: 8px; }
  .stickyFooter { position: sticky; bottom: 0; background: var(--panel); padding-top: 8px; }
  .fileInput { display:none; }
  .small { font-size: 12px; }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Left: Controls -->
    <div class="panel">
      <h1>KPI Button CSV Maker</h1>

      <div class="row">
        <button id="addGroupBtn">+ Add group</button>
        <button id="importBtn" class="secondary">Import CSV</button>
        <input id="filePick" type="file" accept=".csv,text/csv" class="fileInput">
      </div>
      <div class="row">
        <button id="exportBtn" class="ok">Export CSV</button>
        <button id="clearAllBtn" class="danger">Clear all</button>
      </div>
      <p class="hint">CSV columns: <code>group,label,cssClass,logName</code>. Matches your <em>buildButtons()</em> parser.</p>

      <hr style="border: 1px solid var(--border); border-bottom:0; margin:12px 0">

      <div id="groupList"></div>

      <div class="stickyFooter footer">
        <span class="hint small">Tip: use “Preview” to see how buttons will look.</span>
        <div class="inline">
          <button id="expandAllBtn" class="ghost">Expand all</button>
          <button id="collapseAllBtn" class="ghost">Collapse all</button>
        </div>
      </div>
    </div>

    <!-- Right: Live Preview & CSV -->
    <div class="panel">
      <h1>Preview</h1>
      <div id="preview"></div>

      <h1 style="margin-top:16px;">CSV (read-only)</h1>
      <textarea id="csvView" rows="16" readonly spellcheck="false"></textarea>
      <p class="hint">This is exactly what will be saved.</p>
    </div>
  </div>

<script>
/** Data model ***********************************************************/
let groups = []; // [{id, name, buttons: [{id,label,cssClass,logName}]}]
let groupSeq = 1;
let btnSeq = 1;

const DEFAULT_CLASSES = ["redButton","greenButton","blueButton","orangeButton","greyButton"];
const CSV_HEADERS = ["group","label","cssClass","logName"];

/** DOM refs *************************************************************/
const listEl = document.getElementById('groupList');
const previewEl = document.getElementById('preview');
const csvView = document.getElementById('csvView');
const addGroupBtn = document.getElementById('addGroupBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const filePick = document.getElementById('filePick');
const clearAllBtn = document.getElementById('clearAllBtn');
const expandAllBtn = document.getElementById('expandAllBtn');
const collapseAllBtn = document.getElementById('collapseAllBtn');

/** Helpers **************************************************************/
function makeGroup(name="New group") {
  return { id: `g${groupSeq++}`, name, buttons: [] };
}
function makeButton() {
  return { id: `b${btnSeq++}`, label: "New button", cssClass: "greyButton", logName: "New button" };
}

function toCSV() {
  const rows = [CSV_HEADERS.join(",")];
  groups.forEach(g => {
    g.buttons.forEach(b => {
      // Escape double quotes
      const vals = [
        g.name, b.label, (b.cssClass||"").trim(), (b.logName||b.label||"").trim()
      ].map(v => `"${String(v).replace(/"/g,'""')}"`);
      rows.push(vals.join(","));
    });
  });
  return rows.join("\n");
}

function download(filename, text) {
  const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), { href: url, download: filename });
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function render() {
  // left editor
  listEl.innerHTML = "";
  groups.forEach((g, gi) => {
    const card = document.createElement('div');
    card.className = 'groupCard';

    const header = document.createElement('div');
    header.className = 'groupHeader';

    const left = document.createElement('div');
    left.className = 'left';

    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = g.name;
    nameInput.placeholder = "Group name";
    nameInput.addEventListener('input', () => { g.name = nameInput.value; sync(); });

    const moveUp = document.createElement('button');
    moveUp.className = 'ghost';
    moveUp.textContent = '↑';
    moveUp.title = 'Move group up';
    moveUp.disabled = gi === 0;
    moveUp.onclick = () => {
      if (gi>0) { [groups[gi-1], groups[gi]] = [groups[gi], groups[gi-1]]; sync(); }
    };

    const moveDown = document.createElement('button');
    moveDown.className = 'ghost';
    moveDown.textContent = '↓';
    moveDown.title = 'Move group down';
    moveDown.disabled = gi === groups.length-1;
    moveDown.onclick = () => {
      if (gi<groups.length-1) { [groups[gi+1], groups[gi]] = [groups[gi], groups[gi+1]]; sync(); }
    };

    left.append(nameInput, moveUp, moveDown);

    const right = document.createElement('div');
    right.className = 'inline';
    const addBtn = document.createElement('button');
    addBtn.textContent = '+ Add button';
    addBtn.onclick = () => { g.buttons.push(makeButton()); sync(); };

    const delBtn = document.createElement('button');
    delBtn.className = 'danger';
    delBtn.textContent = 'Delete group';
    delBtn.onclick = () => {
      if (confirm(`Delete group "${g.name}" and its ${g.buttons.length} button(s)?`)) {
        groups.splice(gi,1); sync();
      }
    };

    // collapse/expand
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'ghost';
    toggleBtn.textContent = 'Collapse';
    toggleBtn.onclick = () => {
      const body = card.querySelector('.groupBody');
      const collapsed = body.style.display === 'none';
      body.style.display = collapsed ? '' : 'none';
      toggleBtn.textContent = collapsed ? 'Collapse' : 'Expand';
    };

    right.append(addBtn, toggleBtn, delBtn);

    header.append(left, right);

    const body = document.createElement('div');
    body.className = 'groupBody';

    // each button row
    g.buttons.forEach((b, bi) => {
      const row = document.createElement('div');
      row.className = 'btnRow';

      const inputs = document.createElement('div');
      const grid = document.createElement('div');
      grid.className = 'split';

      const labelWrap = document.createElement('div');
      const labelLbl = document.createElement('label'); labelLbl.textContent = 'Label';
      const labelInp = document.createElement('input'); labelInp.type='text'; labelInp.value=b.label;
      labelInp.oninput = () => { b.label = labelInp.value; if (!b.logName) b.logName=labelInp.value; sync(); };
      labelWrap.append(labelLbl, labelInp);

      const logWrap = document.createElement('div');
      const logLbl = document.createElement('label'); logLbl.textContent = 'logName (optional)';
      const logInp = document.createElement('input'); logInp.type='text'; logInp.placeholder='Defaults to Label'; logInp.value=b.logName||"";
      logInp.oninput = () => { b.logName = logInp.value; sync(); };
      logWrap.append(logLbl, logInp);

      const clsWrap = document.createElement('div');
      const clsLbl = document.createElement('label'); clsLbl.textContent = 'cssClass';
      const clsSel = document.createElement('select');
      [...DEFAULT_CLASSES, ""].forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c || "(custom)";
        clsSel.appendChild(opt);
      });
      clsSel.value = DEFAULT_CLASSES.includes(b.cssClass) ? b.cssClass : "";
      clsSel.onchange = () => {
        if (clsSel.value) { b.cssClass = clsSel.value; customClsInp.value = ""; }
        sync();
      };

      const customClsInp = document.createElement('input');
      customClsInp.type='text';
      customClsInp.placeholder='custom classes (space-separated)';
      customClsInp.value = DEFAULT_CLASSES.includes(b.cssClass) ? "" : (b.cssClass||"");
      customClsInp.oninput = () => { b.cssClass = customClsInp.value; clsSel.value=""; sync(); };

      clsWrap.append(clsLbl, clsSel, customClsInp);

      grid.append(labelWrap, logWrap);
      inputs.append(grid, clsWrap);

      // controls
      const up = document.createElement('button'); up.className='ghost'; up.textContent='↑'; up.title='Move up';
      up.disabled = bi===0;
      up.onclick = () => { if (bi>0){ [g.buttons[bi-1], g.buttons[bi]] = [g.buttons[bi], g.buttons[bi-1]]; sync(); } };

      const down = document.createElement('button'); down.className='ghost'; down.textContent='↓'; down.title='Move down';
      down.disabled = bi===g.buttons.length-1;
      down.onclick = () => { if (bi<g.buttons.length-1){ [g.buttons[bi+1], g.buttons[bi]] = [g.buttons[bi], g.buttons[bi+1]]; sync(); } };

      const remove = document.createElement('button'); remove.className='danger'; remove.textContent='Delete';
      remove.onclick = () => { g.buttons.splice(bi,1); sync(); };

      row.append(inputs, up, down, remove);
      body.appendChild(row);
    });

    // preview for this group
    const preview = document.createElement('div');
    preview.className = 'previewWrap';
    const pLabel = document.createElement('div');
    pLabel.className = 'hint';
    pLabel.textContent = 'Preview';
    const pBtns = document.createElement('div');
    pBtns.className = 'btnPreview';
    g.buttons.forEach(b => {
      const btn = document.createElement('button');
      btn.className = `bigButton ${b.cssClass||''}`.trim();
      btn.type='button';
      btn.textContent = b.label || '(empty)';
      pBtns.appendChild(btn);
    });
    preview.append(pLabel, pBtns);

    card.append(header, body, preview);
    listEl.appendChild(card);
  });

  // right preview = how it will look when your app groups render
  previewEl.innerHTML = "";
  const groupsFrag = document.createDocumentFragment();
  groups.forEach(g => {
    const title = document.createElement('div');
    title.className = 'hint';
    title.textContent = g.name;
    const lane = document.createElement('div');
    lane.style.display='flex'; lane.style.flexWrap='wrap'; lane.style.gap='8px';
    g.buttons.forEach(b => {
      const k = document.createElement('button');
      k.className = `bigButton ${b.cssClass||''}`.trim();
      k.textContent = b.label || '(empty)';
      lane.appendChild(k);
    });
    groupsFrag.append(title, lane, document.createElement('div'));
  });
  previewEl.appendChild(groupsFrag);

  // CSV view
  csvView.value = toCSV();
}

function sync() { render(); }

/** Events ***************************************************************/
addGroupBtn.onclick = () => { groups.push(makeGroup()); sync(); };

clearAllBtn.onclick = () => {
  if (confirm("Clear all groups and buttons?")) {
    groups = []; groupSeq = 1; btnSeq = 1; sync();
  }
};

expandAllBtn.onclick = () => {
  document.querySelectorAll('.groupBody').forEach(b => b.style.display = '');
};
collapseAllBtn.onclick = () => {
  document.querySelectorAll('.groupBody').forEach(b => b.style.display = 'none');
};

exportBtn.onclick = () => {
  const name = prompt("File name", "KPI_buttons.csv") || "KPI_buttons.csv";
  download(name, toCSV());
};

importBtn.onclick = () => filePick.click();
filePick.onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;

  // Robust parse via Papa if available
  const parseFile = (text) => {
    let rows = [];
    if (window.Papa) {
      const res = Papa.parse(text, { header: true, skipEmptyLines: true });
      rows = res.data;
    } else {
      // quick fallback
      const lines = text.split(/\r?\n/).filter(Boolean);
      const headers = lines.shift().split(",");
      rows = lines.map(line => {
        const cols = line.split(",");
        const row = {};
        headers.forEach((h,i)=> row[h.trim()] = (cols[i]||"").replace(/^"|"$/g,''));
        return row;
      });
    }
    // Convert to groups model
    const map = new Map();
    rows.forEach(r => {
      const g = (r.group||"").trim() || "Group";
      const btn = {
        id: `b${btnSeq++}`,
        label: (r.label||"").trim(),
        cssClass: (r.cssClass||"").trim(),
        logName: (r.logName||r.label||"").trim()
      };
      if (!map.has(g)) map.set(g, []);
      map.get(g).push(btn);
    });
    groups = [];
    groupSeq = 1;
    map.forEach((buttons, name) => {
      groups.push({ id:`g${groupSeq++}`, name, buttons });
    });
    sync();
  };

  const reader = new FileReader();
  reader.onload = () => parseFile(reader.result);
  reader.readAsText(file);
};

/** Init *****************************************************************/
groups = [
  { id:"g0", name: "Example: Lane Keeping", buttons: [
    { id:"b0", label:"Weaving", cssClass:"redButton", logName:"LK Weaving" },
    { id:"b1", label:"Drift Right", cssClass:"orangeButton", logName:"LK Drift Right" },
    { id:"b2", label:"OK Segment", cssClass:"greenButton", logName:"OK Segment" },
  ]},
  { id:"g1", name: "Example: Cut-ins", buttons: [
    { id:"b3", label:"Cut-in Close", cssClass:"redButton", logName:"Cut-in Close" },
    { id:"b4", label:"Cut-in Far", cssClass:"blueButton", logName:"Cut-in Far" }
  ]}
];
render();
</script>
</body>
</html>
