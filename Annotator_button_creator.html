<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Annotator ‚Äî Card Builder (CSV format: group,label,cssClass,logName,isRed)</title>
<style>
  :root{
    --bg:#0b0d12; --panel:#121622; --ink:#eef2ff;
    --red:#ef4444; --green:#22c55e; --orange:#f59e0b; --blue:#3b82f6;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  *{ box-sizing:border-box; }
  body{ margin:0; background:linear-gradient(180deg,#0a0c12,#0d1120 60%); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  header{ display:flex; align-items:center; gap:8px; padding:10px 14px; border-bottom:1px solid #1a2033; position:sticky; top:0; background:rgba(10,12,18,.7); backdrop-filter: blur(10px); z-index:10;}
  h1{ font-size:15px; margin:0; font-weight:700; color:#dbeafe; }
  .row{ display:grid; grid-template-columns: 220px 1fr 280px; gap:12px; padding:12px; }
  .panel{ background:#121622; border:1px solid #1a2033; border-radius:14px; box-shadow:var(--shadow); }
  .panel header{ padding:10px 12px; font-size:12px; font-weight:700; color:#c7d2fe; border-bottom:1px solid #1a2033; }
  .panel .body{ padding:10px; }

  /* Sidebar (only 4 color buttons) */
  .color-btn{ display:flex; align-items:center; gap:10px; padding:12px;
    background:#0f1422; border:1px solid #1f2944; border-radius:12px; cursor:grab; user-select:none; margin-bottom:10px;}
  .color-btn:hover{ background:#121a2e; border-color:#2b375d; }
  .dot{ width:16px; height:16px; border-radius:3px; }
  .dot.red{background:var(--red);} .dot.green{background:var(--green);}
  .dot.orange{background:var(--orange);} .dot.blue{background:var(--blue);}
  .name{ font-weight:800; }

  /* Card + columns */
  .card{ display:flex; gap:10px; padding:10px; min-height:520px; overflow:auto; }
  .col{ background:#0c1222; border:1px solid #1e2740; border-radius:12px; width:300px; flex:0 0 300px; display:flex; flex-direction:column; }
  .col-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-bottom:1px solid #1e2740; cursor:grab; }
  .col-title{ font-weight:800; color:#e5e7eb; font-size:13px; outline:none; }
  .col-actions button{ background:#121a2e; border:1px solid #27304a; color:#c7d2fe; border-radius:8px; font-size:11px; padding:4px 8px; cursor:pointer; }
  .col-actions button:hover{ background:#131f3b; }
  .drop{ flex:1; padding:10px; }
  .placeholder{ border:2px dashed #33406a; border-radius:12px; padding:18px; color:#93c5fd; text-align:center; font-size:12px; }

  /* Items: vertical list only */
  ul.items{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px; }
  li.item{ display:flex; align-items:center; gap:10px; padding:10px; border:1px solid #223055; border-radius:10px; background:#0f1a33; cursor:grab; }
  .badge{ width:18px; height:18px; border-radius:4px; }
  .b.red{background:var(--red);} .b.green{background:var(--green);}
  .b.orange{background:var(--orange);} .b.blue{background:var(--blue);}
  .label{ flex:1; font-size:13px; font-weight:700; color:#e2e8f0; outline:none; }
  .btn{ padding:8px 10px; border-radius:10px; border:1px solid #2a3963; background:#0f1628; color:#dbeafe; cursor:pointer; }
  .btn:hover{ background:#111c34; }
  .ghost{ opacity:.6; }
</style>
</head>
<body>
<header>
  <h1>Annotator ‚Äî Card Builder</h1>
  <div style="margin-left:auto; display:flex; gap:8px;">
    <button class="btn" id="addColumnBtn">‚ûï Add column</button>
    <button class="btn" id="downloadBtn">‚¨áÔ∏è Download CSV</button>
    <button class="btn" id="saveBtn">üíæ Save</button>
    <button class="btn" id="loadBtn">üìÇ Load (local)</button>
    <button class="btn" id="clearBtn">üßπ Clear</button>
  </div>
</header>

<div class="row">
  <!-- Sidebar -->
  <section class="panel">
    <header>Sidebar ‚Äî drag a color into a column</header>
    <div class="body" id="sidebar">
      <div class="color-btn" draggable="true" data-color="red"><div class="dot red"></div><div class="name">Red</div></div>
      <div class="color-btn" draggable="true" data-color="green"><div class="dot green"></div><div class="name">Green</div></div>
      <div class="color-btn" draggable="true" data-color="orange"><div class="dot orange"></div><div class="name">Orange</div></div>
      <div class="color-btn" draggable="true" data-color="blue"><div class="dot blue"></div><div class="name">Blue</div></div>
    </div>
  </section>

  <!-- Card -->
  <section class="panel">
    <header>Card ‚Äî drag column headers to reorder; items are stacked vertically</header>
    <div class="body"><div id="card" class="card"></div></div>
  </section>

  <!-- Details -->
  <section class="panel">
    <header>Details</header>
    <div class="body">
      <div style="font-size:12px; color:#9fb0dd">
        Annotation string (logName) is always <b>&lt;ColumnName&gt; + space + &lt;Label&gt;</b>.<br>
        CSV columns: <code>group,label,cssClass,logName,isRed</code>
      </div>
    </div>
  </section>
</div>

<script>
/* ---------- State ---------- */
let columns = []; // {id, name}
let items = [];   // {id, colId, color, label}

/* ---------- Helpers ---------- */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const card = $('#card');
const csvEscape = (v) => {
  const s = String(v ?? '');
  return (/[",\n]/.test(s)) ? `"${s.replace(/"/g,'""')}"` : s;
};

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded', () => {
  if (!loadFromLocal(true)) { addColumn('TSI Speed'); addColumn('ACC'); addColumn('LCC'); }
  renderAll();
  wireSidebar();
  wireGlobal();
});

/* ---------- Sidebar: exactly 4 colors ---------- */
let dragColor = null;
function wireSidebar(){
  $$('#sidebar .color-btn').forEach(btn=>{
    btn.addEventListener('dragstart', e=>{
      dragColor = btn.dataset.color;
      e.dataTransfer.setData('text/color', dragColor);
      e.dataTransfer.effectAllowed = 'copy';
      btn.classList.add('ghost');
    });
    btn.addEventListener('dragend', ()=> btn.classList.remove('ghost'));
  });
}

/* ---------- Columns ---------- */
function addColumn(name){
  columns.push({ id:'col_'+crypto.randomUUID().slice(0,8), name });
  saveToLocal();
}
function renderAll(){ renderColumns(); renderItems(); }

/* Column reorder (robust): drag any header onto another column to insert before/after */
let draggingColId = null;
function renderColumns(){
  card.innerHTML = '';
  columns.forEach((c)=>{
    const col = document.createElement('div');
    col.className = 'col';
    col.dataset.id = c.id;

    const head = document.createElement('div');
    head.className = 'col-header';
    head.draggable = true;
    head.innerHTML = `
      <div class="col-title" contenteditable="true" spellcheck="false">${c.name}</div>
      <div class="col-actions">
        <button data-act="add">Add</button>
        <button data-act="del">Delete</button>
      </div>`;

    head.querySelector('.col-title').addEventListener('blur', e=>{
      c.name = e.target.textContent.trim() || 'Unnamed';
      renderItems(); saveToLocal();
    });
    head.querySelector('[data-act="add"]').addEventListener('click', ()=>{
      const nm = prompt('New column name:', 'New Column');
      if (nm) { addColumn(nm.trim()||'Unnamed'); renderAll(); }
    });
    head.querySelector('[data-act="del"]').addEventListener('click', ()=>{
      if (!confirm('Delete this column and its items?')) return;
      items = items.filter(it=>it.colId!==c.id);
      columns = columns.filter(x=>x.id!==c.id);
      renderAll(); saveToLocal();
    });

    head.addEventListener('dragstart', e=>{
      draggingColId = c.id;
      e.dataTransfer.setData('text/col', c.id);
      e.dataTransfer.effectAllowed = 'move';
      col.classList.add('ghost');
    });
    head.addEventListener('dragend', ()=>{ draggingColId=null; col.classList.remove('ghost'); });

    // Allow dropping a column before/after this column
    col.addEventListener('dragover', e=>{
      if (!draggingColId) return;
      e.preventDefault();
      e.dataTransfer.dropEffect='move';
    });
    col.addEventListener('drop', e=>{
      if (!draggingColId) return;
      e.preventDefault();
      const fromIdx = columns.findIndex(x=>x.id===draggingColId);
      const toIdx   = columns.findIndex(x=>x.id===c.id);
      if (fromIdx === -1 || toIdx === -1 || fromIdx === toIdx) return;
      const [moved] = columns.splice(fromIdx,1);
      // insert before or after depending on pointer X
      const rect = col.getBoundingClientRect();
      const insertAfter = e.clientX > rect.left + rect.width/2;
      columns.splice(insertAfter ? toIdx+1 : toIdx, 0, moved);
      renderAll(); saveToLocal();
    });

    const drop = document.createElement('div');
    drop.className = 'drop';
    drop.dataset.id = c.id;

    // Accept color drops from sidebar
    drop.addEventListener('dragover', e=>{
      if (dragColor) { e.preventDefault(); e.dataTransfer.dropEffect='copy'; }
    });
    drop.addEventListener('drop', e=>{
      if (!dragColor) return;
      e.preventDefault();
      const label = prompt(`Label for ${dragColor} in "${c.name}"`, '');
      createItem(c.id, dragColor, (label||'Unnamed').trim());
      dragColor = null;
    });

    const ul = document.createElement('ul');
    ul.className = 'items';
    ul.dataset.colId = c.id;

    drop.appendChild(ul);
    col.appendChild(head);
    col.appendChild(drop);
    card.appendChild(col);
  });
}

/* ---------- Items (vertical list, reorder within column) ---------- */
function createItem(colId, color, label){
  items.push({ id:'it_'+crypto.randomUUID().slice(0,8), colId, color, label });
  renderItems(); saveToLocal();
}
function renderItems(){
  $$('.items').forEach(ul => { ul.innerHTML=''; });

  for (const c of columns){
    const ul = document.querySelector(`.items[data-col-id="${c.id}"]`);
    const colItems = items.filter(it=>it.colId===c.id);
    if (!ul) continue;

    // placeholder
    const phOld = ul.parentElement.querySelector('.placeholder');
    if (colItems.length===0){
      if (!phOld){
        const ph = document.createElement('div');
        ph.className = 'placeholder';
        ph.textContent = 'Drag Red/Green/Orange/Blue here';
        ul.parentElement.appendChild(ph);
      }
    } else if (phOld) phOld.remove();

    colItems.forEach((it)=>{
      const li = document.createElement('li');
      li.className = 'item';
      li.draggable = true;
      li.dataset.id = it.id;
      li.innerHTML = `
        <div class="badge b ${it.color}"></div>
        <div class="label" contenteditable="true" spellcheck="false">${it.label}</div>
        <button class="btn btn-del" title="Delete">üóëÔ∏è</button>
      `;
      // rename
      li.querySelector('.label').addEventListener('blur', e=>{
        it.label = e.target.textContent.trim() || 'Unnamed';
        saveToLocal();
      });
      // delete
      li.querySelector('.btn-del').addEventListener('click', ()=>{
        items = items.filter(x=>x.id!==it.id);
        renderItems(); saveToLocal();
      });

      // reorder within same column
      li.addEventListener('dragstart', e=>{
        e.dataTransfer.effectAllowed='move';
        e.dataTransfer.setData('text/item', it.id);
        li.classList.add('ghost');
      });
      li.addEventListener('dragend', ()=> li.classList.remove('ghost'));

      ul.addEventListener('dragover', e=>{
        if (!e.dataTransfer.types.includes('text/item')) return;
        e.preventDefault(); e.dataTransfer.dropEffect='move';
        const draggingId = e.dataTransfer.getData('text/item');
        const draggingIdx = items.findIndex(x=>x.id===draggingId);
        const dragging = items[draggingIdx];
        if (!dragging || dragging.colId !== c.id) return;
        const after = getItemAfter(ul, e.clientY);
        const siblings = items.filter(x=>x.colId===c.id);
        const toIdx = after ? siblings.findIndex(x=>x.id===after.dataset.id) : 0;
        if (siblings[toIdx]?.id !== dragging.id){
          const others = items.filter(x=>x.colId!==c.id);
          const reordered = siblings.filter(x=>x.id!==dragging.id);
          reordered.splice(toIdx, 0, dragging);
          items = others.concat(reordered);
          renderItems();
        }
      });

      ul.appendChild(li);
    });
  }
}
function getItemAfter(ul, y){
  const els = [...ul.querySelectorAll('.item')];
  let closest = {offset: Number.NEGATIVE_INFINITY, element: null};
  for (const el of els){
    const box = el.getBoundingClientRect();
    const offset = y - (box.top + box.height/2);
    if (offset < 0 && offset > closest.offset){ closest = {offset, element: el}; }
  }
  return closest.element;
}

/* ---------- CSV (exact format) ---------- */
function downloadCSV(){
  const rows = [];
  rows.push(['group','label','cssClass','logName','isRed']);

  columns.forEach((c)=>{
    // grey group header (like your sample)
    rows.push([c.name, c.name, 'greyButton', c.name, false]);

    const colItems = items.filter(it=>it.colId===c.id);
    colItems.forEach((it)=>{
      const cssMap = { red:'redButton', green:'greenButton', orange:'orangeButton', blue:'blueButton' };
      const cssClass = cssMap[it.color] || 'blueButton';
      const logName = `${c.name} ${it.label}`.trim();
      const isRed = (it.color === 'red');
      rows.push([c.name, it.label, cssClass, logName, isRed]);
    });
  });

  const csv = rows.map(r => r.map(csvEscape).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'KPI_buttons.csv';
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(a.href);
  a.remove();
}

/* ---------- Save / Load / Controls ---------- */
function saveToLocal(){ localStorage.setItem('cardLayout_v3', JSON.stringify({columns, items})); }
function loadFromLocal(init=false){
  const raw = localStorage.getItem('cardLayout_v3');
  if (!raw) return false;
  try{
    const obj = JSON.parse(raw);
    if (obj?.columns && obj?.items){ columns = obj.columns; items = obj.items; return true; }
  }catch(e){}
  return false;
}
function clearAll(){
  if (!confirm('Clear layout and local storage?')) return;
  localStorage.removeItem('cardLayout_v3');
  columns=[]; items=[];
  addColumn('TSI Speed'); addColumn('ACC'); addColumn('LCC');
  renderAll();
}

/* ---------- Buttons ---------- */
$('#addColumnBtn').addEventListener('click', ()=>{
  const nm = prompt('Column name:', 'New Column');
  if (nm) { addColumn(nm.trim()||'Unnamed'); renderAll(); }
});
$('#downloadBtn').addEventListener('click', downloadCSV);
$('#saveBtn').addEventListener('click', saveToLocal);
$('#loadBtn').addEventListener('click', ()=>{ loadFromLocal(); renderAll(); });
$('#clearBtn').addEventListener('click', clearAll);

/* ---------- Misc ---------- */
function wireGlobal(){ /* reserved */ }
</script>
</body>
</html>
