<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expedition KPI Explorer (Auto-load)</title>

  <!-- SheetJS (read .xlsx in-browser) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js"></script>

  <!-- Chart.js (plots) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b0e14; --card:#121826; --muted:#9aa4b2; --text:#e6e8ee;
      --border:#1f2937; --warn:#fbbf24;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:linear-gradient(180deg,#070a10, #0b0e14 30%, #0b0e14); color:var(--text);}
    header{padding:24px 16px; border-bottom:1px solid var(--border); position:sticky; top:0;
      background:rgba(11,14,20,.92); backdrop-filter: blur(10px); z-index:10;}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.4}
    main{padding:18px 16px 40px; max-width:1200px; margin:0 auto;}
    .row{display:grid; gap:14px;}
    @media(min-width: 960px){
      .row.cols-3{grid-template-columns: 1.2fr 1fr 1fr;}
      .row.cols-2{grid-template-columns: 1fr 1fr;}
    }
    .card{background:rgba(18,24,38,.85); border:1px solid var(--border); border-radius:16px; padding:14px;}
    .card h2{margin:0 0 10px; font-size:14px; color:#d9deea; font-weight:650}
    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    input[type="file"]{padding:10px;border:1px dashed var(--border);border-radius:12px;background:rgba(255,255,255,.02);color:var(--text);width:100%;}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.02);font-size:13px}
    .pill b{color:#fff}
    .muted{color:var(--muted)}
    .kpi-meta{display:flex; flex-wrap:wrap; gap:10px; margin-top:6px}
    .table-wrap{overflow:auto; border-radius:12px; border:1px solid var(--border)}
    table{width:100%; border-collapse:collapse; min-width:720px; background:rgba(255,255,255,.01)}
    th, td{padding:10px 10px; border-bottom:1px solid var(--border); font-size:13px; text-align:left; white-space:nowrap;}
    th{position:sticky; top:0; background:rgba(18,24,38,.95); cursor:pointer; user-select:none;}
    tr:hover td{background:rgba(255,255,255,.03)}
    .right{text-align:right}
    .search{display:flex; gap:10px; align-items:center}
    .search input{flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:rgba(255,255,255,.02); color:var(--text); outline:none;}
    .btn{padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:rgba(255,255,255,.04); color:var(--text); cursor:pointer;}
    .btn:hover{background:rgba(255,255,255,.06)}
    .warn{color:var(--warn)}
    .note{font-size:12px; color:var(--muted); line-height:1.4}
    canvas{max-height:340px;}
    .two{display:grid; gap:14px;}
    @media(min-width: 960px){ .two{grid-template-columns: 1fr 1fr;} }
  </style>
</head>

<body>
<header>
  <h1>Expedition KPI Explorer</h1>
  <div class="sub">
    Auto-loads <b id="autoName"></b> from the same folder as this HTML (via fetch). If it fails, use manual upload.
  </div>
</header>

<main>
  <section class="card">
    <h2>Load Excel</h2>
    <div class="controls">
      <input id="file" type="file" accept=".xlsx,.xls" />
      <button class="btn" id="btnReload">Reload auto file</button>
    </div>
    <div id="status" class="note" style="margin-top:10px;">Starting…</div>
    <div class="note" style="margin-top:8px;">
      <span class="warn">Tip:</span> For auto-load, serve this folder with a web server (not <code>file://</code>).
      Example: <code>python -m http.server</code>, then open <code>http://localhost:8000/</code>.
    </div>
  </section>

  <section class="row cols-3" style="margin-top:14px;">
    <div class="card">
      <h2>Overview</h2>
      <div class="kpi-meta" id="overviewPills"></div>
      <div class="note" style="margin-top:10px;">
        <span class="warn">Note:</span> The original workbook does not contain “per KPI per road/country/weather/phase”
        event tagging—those category tables are totals for <b>all KPIs combined</b>.
      </div>
    </div>

    <div class="card">
      <h2>Top KPIs (Events / 1000 km)</h2>
      <canvas id="chartTopKpis"></canvas>
    </div>

    <div class="card">
      <h2>Top KPIs (Total Events)</h2>
      <canvas id="chartTopKpisAbs"></canvas>
    </div>
  </section>

  <section class="card" style="margin-top:14px;">
    <h2>KPI List</h2>
    <div class="search" style="margin:10px 0;">
      <input id="search" placeholder="Search KPI / Issue name…" />
      <button class="btn" id="btnExportCsv">Export KPI table as CSV</button>
    </div>
    <div class="table-wrap">
      <table id="kpiTable">
        <thead>
          <tr>
            <th data-key="Issue">Issue (KPI)</th>
            <th class="right" data-key="Events">Total events</th>
            <th class="right" data-key="Events_per_1000km">Events / 1000 km</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="note" style="margin-top:10px;">Click a column header to sort.</div>
  </section>

  <section class="two" style="margin-top:14px;">
    <div class="card">
      <h2>Road class (City / Country / Highway)</h2>
      <canvas id="chartRoadClass"></canvas>
      <div class="note" id="roadNote" style="margin-top:10px;"></div>
    </div>
    <div class="card">
      <h2>Country (all KPIs combined)</h2>
      <canvas id="chartCountry"></canvas>
    </div>
  </section>

  <section class="two" style="margin-top:14px;">
    <div class="card">
      <h2>Weather type (all KPIs combined)</h2>
      <canvas id="chartWeather"></canvas>
    </div>
    <div class="card">
      <h2>Phase (all KPIs combined)</h2>
      <canvas id="chartPhase"></canvas>
    </div>
  </section>
</main>

<script>
  // ===== Config: auto-load file name from same folder =====
  const AUTO_XLSX_NAME = "2025w49_Winter_expedition_total_kpi.xlsx";
  document.getElementById("autoName").textContent = AUTO_XLSX_NAME;

  // -----------------------------
  // Utilities
  // -----------------------------
  const $ = (sel) => document.querySelector(sel);
  const fmt = (n, d=1) => (n===null||n===undefined||Number.isNaN(n)) ? "—" :
    Number(n).toLocaleString(undefined, {maximumFractionDigits:d, minimumFractionDigits:d});
  const fmtInt = (n) => (n===null||n===undefined||Number.isNaN(n)) ? "—" :
    Number(n).toLocaleString(undefined, {maximumFractionDigits:0});
  function parseKm(v){
    if (v === null || v === undefined) return NaN;
    if (typeof v === "number") return v;
    const s = String(v).replace(",", ".");
    const m = s.match(/[-+]?\d*\.?\d+/);
    return m ? Number(m[0]) : NaN;
  }
  function normalizeKey(s){ return String(s ?? "").trim().toLowerCase(); }
  function downloadText(filename, text){
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([text], {type:"text/plain"}));
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // -----------------------------
  // Charts
  // -----------------------------
  const charts = {};
  function setChart(id, labels, data, label){
    const ctx = document.getElementById(id);
    if (!ctx) return;
    if (charts[id]) charts[id].destroy();
    charts[id] = new Chart(ctx, {
      type: "bar",
      data: { labels, datasets: [{ label, data }] },
      options: {
        responsive:true,
        plugins: {
          legend:{ display:false },
          tooltip:{ callbacks:{ label: (c)=> `${c.dataset.label}: ${fmt(c.parsed.y, 2)}` } }
        },
        scales: {
          x: { ticks: { color:"#cfd6e6" }, grid:{ color:"rgba(255,255,255,.06)"} },
          y: { ticks: { color:"#cfd6e6" }, grid:{ color:"rgba(255,255,255,.06)"} }
        }
      }
    });
  }

  // -----------------------------
  // Data extraction (original workbook)
  // -----------------------------
  function sheetToRows(wb, sheetName){
    const ws = wb.Sheets[sheetName];
    if (!ws) return [];
    return XLSX.utils.sheet_to_json(ws, {defval: null});
  }

  function roadClassFromOsmType(rt){
    const t = normalizeKey(rt);
    if (["motorway","motorway_link","trunk","trunk_link"].includes(t)) return "Highway";
    if (["primary","secondary","tertiary","unclassified"].includes(t)) return "Country road";
    if (["residential","service","living_street","road","construction"].includes(t)) return "City";
    if (t.includes("unknown")) return "Unknown";
    return "Other";
  }

  function computeFromOriginal(rows){
    if (!rows.length) return null;

    const keyset = new Set(Object.keys(rows[0] || {}).map(normalizeKey));
    const colMetric = [...keyset].includes("metric") ? "Metric" : null;
    const colValue  = [...keyset].includes("value") ? "Value" : null;

    let distanceKm = 0;
    if (colMetric && colValue){
      const dist = rows
        .filter(r => normalizeKey(r[colMetric]) === "total test distance")
        .map(r => parseKm(r[colValue]))
        .filter(x => Number.isFinite(x) && x>0);
      distanceKm = dist.reduce((a,b)=>a+b,0);
    }

    const issueCol = Object.keys(rows[0]||{}).find(c => normalizeKey(c) === "issue") || "Issue";
    const eventsCol = Object.keys(rows[0]||{}).find(c => normalizeKey(c) === "total no of events") || "Total No of events";

    const kpiMap = new Map();
    for (const r of rows){
      const issue = r[issueCol];
      if (!issue || normalizeKey(issue) === "issue") continue;
      const ev = Number(r[eventsCol]);
      if (!Number.isFinite(ev)) continue;
      kpiMap.set(issue, (kpiMap.get(issue) || 0) + ev);
    }

    const kpis = [...kpiMap.entries()]
      .map(([Issue, Events]) => ({
        Issue,
        Events,
        Events_per_1000km: distanceKm>0 ? (Events/distanceKm*1000) : NaN
      }))
      .sort((a,b)=> b.Events - a.Events);

    const totalEvents = kpis.reduce((a,b)=>a+b.Events,0);

    function aggregate3(groupColName, distColName, issuesColName){
      const groupCol = Object.keys(rows[0]||{}).find(c => normalizeKey(c) === normalizeKey(groupColName));
      const distCol  = Object.keys(rows[0]||{}).find(c => normalizeKey(c) === normalizeKey(distColName));
      const issCol   = Object.keys(rows[0]||{}).find(c => normalizeKey(c) === normalizeKey(issuesColName));
      if (!groupCol || !distCol || !issCol) return null;

      const m = new Map();
      for (const r of rows){
        const g = r[groupCol];
        if (!g || normalizeKey(g) === normalizeKey(groupColName)) continue;
        const dk = parseKm(r[distCol]);
        const iss = Number(r[issCol]);
        if (!Number.isFinite(dk) || dk<=0 || !Number.isFinite(iss)) continue;
        const cur = m.get(g) || {Distance_km:0, Issues:0};
        cur.Distance_km += dk;
        cur.Issues += iss;
        m.set(g, cur);
      }
      return [...m.entries()].map(([Group, v])=>({
        Group,
        Distance_km: v.Distance_km,
        Issues: v.Issues,
        Issues_per_1000km: v.Distance_km>0 ? (v.Issues/v.Distance_km*1000): NaN
      })).sort((a,b)=> b.Distance_km - a.Distance_km);
    }

    const roadType = aggregate3("Road type","Distance (km)","No of issues");
    let roadClass = null;
    if (roadType){
      const m = new Map();
      for (const r of roadType){
        const cls = roadClassFromOsmType(r.Group);
        const cur = m.get(cls) || {Distance_km:0, Issues:0};
        cur.Distance_km += r.Distance_km;
        cur.Issues += r.Issues;
        m.set(cls, cur);
      }
      roadClass = [...m.entries()].map(([RoadClass,v])=>({
        RoadClass, Distance_km:v.Distance_km, Issues:v.Issues,
        Issues_per_1000km: v.Distance_km>0 ? (v.Issues/v.Distance_km*1000) : NaN
      })).sort((a,b)=> b.Distance_km - a.Distance_km);
    }

    const country = aggregate3("Country","Distance (km).1","No of issues.1");
    const weather = aggregate3("Condition","Distance (km).2","No of issues.2");
    const phase   = aggregate3("Phase","Distance (km).3","No of issues.3");

    return { distanceKm, totalEvents, kpis, roadClass, country, weather, phase };
  }

  // -----------------------------
  // UI render
  // -----------------------------
  let state = { distanceKm: NaN, totalEvents: NaN, kpis: [], roadClass:null, country:null, weather:null, phase:null };
  let sortKey = "Events";
  let sortDir = "desc";

  function renderOverview(){
    const el = $("#overviewPills");
    el.innerHTML = "";
    const pills = [
      ["Total distance (km)", fmt(state.distanceKm, 1)],
      ["Total KPI events", fmtInt(state.totalEvents)],
      ["Events / 1000 km", fmt(state.distanceKm>0 ? (state.totalEvents/state.distanceKm*1000) : NaN, 2)],
      ["# KPIs", fmtInt(state.kpis.length)]
    ];
    for (const [k,v] of pills){
      const d = document.createElement("div");
      d.className = "pill";
      d.innerHTML = `<span class="muted">${k}</span> <b>${v}</b>`;
      el.appendChild(d);
    }
  }

  function applySortAndFilter(){
    const q = normalizeKey($("#search").value);
    let rows = state.kpis.slice();
    if (q) rows = rows.filter(r => normalizeKey(r.Issue).includes(q));

    rows.sort((a,b)=>{
      const va = a[sortKey], vb = b[sortKey];
      const na = (typeof va === "number") ? va : String(va||"");
      const nb = (typeof vb === "number") ? vb : String(vb||"");
      if (typeof na === "number" && typeof nb === "number"){
        return sortDir==="asc" ? (na-nb) : (nb-na);
      }
      return sortDir==="asc" ? String(na).localeCompare(String(nb)) : String(nb).localeCompare(String(na));
    });
    return rows;
  }

  function renderTable(){
    const tbody = $("#kpiTable tbody");
    tbody.innerHTML = "";
    const rows = applySortAndFilter();
    for (const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.Issue}</td>
        <td class="right">${fmtInt(r.Events)}</td>
        <td class="right">${fmt(r.Events_per_1000km, 2)}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function renderTopKpiCharts(){
    const top = state.kpis.slice().sort((a,b)=>b.Events - a.Events).slice(0, 12);
    setChart("chartTopKpis",
      top.map(x=>x.Issue),
      top.map(x=>x.Events_per_1000km),
      "Events / 1000 km"
    );
    setChart("chartTopKpisAbs",
      top.map(x=>x.Issue),
      top.map(x=>x.Events),
      "Total events"
    );
  }

  function renderBreakdownCharts(){
    const rn = $("#roadNote");
    rn.textContent = "";

    if (state.roadClass && state.roadClass.length){
      const rows = state.roadClass.slice().sort((a,b)=>b.Distance_km - a.Distance_km);
      setChart("chartRoadClass",
        rows.map(r=>r.RoadClass),
        rows.map(r=>r.Issues_per_1000km),
        "Issues / 1000 km"
      );
      const sumDist = rows.reduce((a,b)=>a+b.Distance_km,0);
      if (Number.isFinite(state.distanceKm) && state.distanceKm>0 && sumDist < state.distanceKm*0.95){
        rn.innerHTML = `Road breakdown distance covers <b>${fmt(sumDist,1)} km</b> of <b>${fmt(state.distanceKm,1)} km</b> in the file (some distance not classified).`;
      }
    } else {
      setChart("chartRoadClass", ["No road-class data found"], [0], "Issues / 1000 km");
      rn.textContent = "No road-class or road-type table found in this workbook.";
    }

    if (state.country && state.country.length){
      const rows = state.country.slice().sort((a,b)=>b.Distance_km - a.Distance_km).slice(0, 12);
      setChart("chartCountry", rows.map(r=>r.Group ?? r.Country), rows.map(r=>r.Issues_per_1000km), "Issues / 1000 km");
    } else setChart("chartCountry", ["No country data found"], [0], "Issues / 1000 km");

    if (state.weather && state.weather.length){
      const rows = state.weather.slice().sort((a,b)=>b.Distance_km - a.Distance_km).slice(0, 12);
      setChart("chartWeather", rows.map(r=>r.Group ?? r.Condition), rows.map(r=>r.Issues_per_1000km), "Issues / 1000 km");
    } else setChart("chartWeather", ["No weather data found"], [0], "Issues / 1000 km");

    if (state.phase && state.phase.length){
      const rows = state.phase.slice().sort((a,b)=>b.Distance_km - a.Distance_km);
      setChart("chartPhase", rows.map(r=>r.Group ?? r.Phase), rows.map(r=>r.Issues_per_1000km), "Issues / 1000 km");
    } else setChart("chartPhase", ["No phase data found"], [0], "Issues / 1000 km");
  }

  function renderAll(){
    renderOverview();
    renderTopKpiCharts();
    renderTable();
    renderBreakdownCharts();
  }

  // -----------------------------
  // Loaders
  // -----------------------------
  async function loadWorkbookFromArrayBuffer(buf, sourceLabel){
    const wb = XLSX.read(buf, {type:"array"});
    const firstSheet = wb.SheetNames[0];
    const rows = sheetToRows(wb, firstSheet);

    const computed = computeFromOriginal(rows);
    if (!computed){
      $("#status").innerHTML = `<span class="warn">Error:</span> Could not parse workbook (${sourceLabel}).`;
      return;
    }

    state = computed;
    $("#status").innerHTML = `Loaded workbook from <b>${sourceLabel}</b> (sheet: <b>${firstSheet}</b>).`;
    if (!Number.isFinite(state.distanceKm) || state.distanceKm <= 0){
      $("#status").innerHTML += `<br><span class="warn">Warning:</span> Could not compute total distance reliably.`;
    }
    renderAll();
  }

  async function tryAutoLoad(){
    $("#status").textContent = `Auto-loading ${AUTO_XLSX_NAME}…`;
    try{
      const resp = await fetch(`./${encodeURIComponent(AUTO_XLSX_NAME)}`, { cache: "no-store" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const buf = await resp.arrayBuffer();
      await loadWorkbookFromArrayBuffer(buf, AUTO_XLSX_NAME);
    }catch(err){
      $("#status").innerHTML =
        `<span class="warn">Auto-load failed:</span> ${String(err.message || err)}<br>` +
        `Place <b>${AUTO_XLSX_NAME}</b> next to this HTML on the same web server, or choose a file manually above.`;
    }
  }

  // Manual upload fallback
  $("#file").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    $("#status").textContent = "Loading uploaded file…";
    const buf = await f.arrayBuffer();
    await loadWorkbookFromArrayBuffer(buf, f.name);
  });

  $("#search").addEventListener("input", renderTable);

  document.querySelectorAll("#kpiTable thead th").forEach(th=>{
    th.addEventListener("click", ()=>{
      const key = th.dataset.key;
      if (!key) return;
      if (sortKey === key) sortDir = (sortDir === "asc") ? "desc" : "asc";
      else { sortKey = key; sortDir = "desc"; }
      renderTable();
    });
  });

  $("#btnExportCsv").addEventListener("click", ()=>{
    const rows = applySortAndFilter();
    const header = ["Issue","Events","Events_per_1000km"];
    const lines = [header.join(",")].concat(
      rows.map(r => [
        `"${String(r.Issue).replaceAll('"','""')}"`,
        r.Events,
        (Number.isFinite(r.Events_per_1000km) ? r.Events_per_1000km : "")
      ].join(","))
    );
    downloadText("kpi_totals.csv", lines.join("\n"));
  });

  $("#btnReload").addEventListener("click", tryAutoLoad);

  // Auto-load on page open
  tryAutoLoad();
</script>
</body>
</html>
