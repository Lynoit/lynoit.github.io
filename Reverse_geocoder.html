<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reverse Geocode Road Features Live Plots</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    #info { margin-bottom: 1em; font-size: 1em; }
    #currentFeatures {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      margin-bottom: 1em;
    }
    .feature {
      display: flex;
      align-items: center;
      font-size: 1em;
    }
    .feature .icon {
      font-size: 1.5em;
      margin-right: 0.3em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
    }
    #map { height: 300px; width: 100%; margin-bottom: 2em; border: 1px solid #ccc; }
    .chart-container { width: 100%; max-width: 600px; margin-bottom: 2em; }
  </style>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Live Road Feature Tracking</h1>
  <div id="info">Locating‚Ä¶</div>

  <!-- Current features display -->
  <div id="currentFeatures">
    <div class="feature">
      <span class="icon" id="icon-roadType">‚ùì</span>
      <span class="label" id="label-roadType">Unknown</span>
    </div>
    <div class="feature">
      <span class="icon" id="icon-speed"></span>
      <span class="label" id="label-speed">N/A</span>
    </div>
    <div class="feature">
      <span class="icon" id="icon-roundabout">üîÑ</span>
      <span class="label" id="label-roundabout">No</span>
    </div>
    <div class="feature">
      <span class="icon" id="icon-stopSign">üõë</span>
      <span class="label" id="label-stopSign">No</span>
    </div>
    <div class="feature">
      <span class="icon" id="icon-trafficLight">üö¶</span>
      <span class="label" id="label-trafficLight">No</span>
    </div>
    <div class="feature">
      <span class="icon" id="icon-bridge">üåâ</span>
      <span class="label" id="label-bridge">No</span>
    </div>
    <div class="feature">
      <span class="icon" id="icon-tunnel">üï≥Ô∏è</span>
      <span class="label" id="label-tunnel">No</span>
    </div>
    <div class="feature">
      <span class="icon" id="icon-toll">üí∞</span>
      <span class="label" id="label-toll">No</span>
    </div>
    <div class="feature">
      <span class="icon" id="icon-lanes">üõ£Ô∏è</span>
      <span class="label" id="label-lanes">N/A</span>
    </div>
    <div class="feature">
      <span class="icon" id="icon-surface">‚ùì</span>
      <span class="label" id="label-surface">Unknown</span>
    </div>
  </div>

  <div id="map"></div>

  <div id="charts">
    <div class="chart-container"><canvas id="speedChart"></canvas></div>
    <div class="chart-container"><canvas id="roundaboutChart"></canvas></div>
    <div class="chart-container"><canvas id="stopSignChart"></canvas></div>
    <div class="chart-container"><canvas id="trafficLightChart"></canvas></div>
    <div class="chart-container"><canvas id="bridgeChart"></canvas></div>
    <div class="chart-container"><canvas id="tunnelChart"></canvas></div>
    <div class="chart-container"><canvas id="roadTypeChart"></canvas></div>
    <div class="chart-container"><canvas id="cityChart"></canvas></div>
    <div class="chart-container"><canvas id="countryChart"></canvas></div>
    <div class="chart-container"><canvas id="tollChart"></canvas></div>
    <div class="chart-container"><canvas id="laneChart"></canvas></div>
    <div class="chart-container"><canvas id="surfaceChart"></canvas></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Data arrays
    let lastPos = null, totalDistance = 0;
    const distances     = [],
          speeds        = [],
          roundabouts   = [],
          stopSigns     = [],
          trafficLights = [],
          bridges       = [],
          tunnels       = [],
          roadTypes     = [],
          cities        = [],
          countries     = [],
          tolls         = [],
          lanesArr      = [],
          surfacesArr   = [];

    // Icon maps
    const roadTypeIcons = {
      motorway: 'üõ£Ô∏è', motorway_link: 'üõ£Ô∏è',
      trunk: 'üõ§Ô∏è', trunk_link: 'üõ§Ô∏è',
      primary: 'üöß', primary_link: 'üöß',
      secondary: 'üõ£Ô∏è', secondary_link: 'üõ£Ô∏è',
      tertiary: 'üöó', tertiary_link: 'üöó',
      residential: 'üè†', service: '‚öôÔ∏è',
      cycleway: 'üö≤', footway: 'üö∂',
      unknown: '‚ùì'
    };
    const surfaceIcons = {
      asphalt: 'üõ£Ô∏è', paved: 'üõ£Ô∏è', concrete: 'üöß',
      gravel: 'ü™®', dirt: 'üü´', ground: 'üü´',
      grass: 'üå±', sand: 'üèñÔ∏è', cobblestone: 'üß±',
      unknown: '‚ùì'
    };

    // Grab display elements
    const iconRoadType    = document.getElementById('icon-roadType');
    const labelRoadType   = document.getElementById('label-roadType');
    const iconSpeed       = document.getElementById('icon-speed');
    const labelSpeed      = document.getElementById('label-speed');
    const iconRoundabout  = document.getElementById('icon-roundabout');
    const labelRoundabout = document.getElementById('label-roundabout');
    const iconStopSign    = document.getElementById('icon-stopSign');
    const labelStopSign   = document.getElementById('label-stopSign');
    const iconTrafficLight= document.getElementById('icon-trafficLight');
    const labelTrafficLight= document.getElementById('label-trafficLight');
    const iconBridge      = document.getElementById('icon-bridge');
    const labelBridge     = document.getElementById('label-bridge');
    const iconTunnel      = document.getElementById('icon-tunnel');
    const labelTunnel     = document.getElementById('label-tunnel');
    const iconToll        = document.getElementById('icon-toll');
    const labelToll       = document.getElementById('label-toll');
    const iconLanes       = document.getElementById('icon-lanes');
    const labelLanes      = document.getElementById('label-lanes');
    const iconSurface     = document.getElementById('icon-surface');
    const labelSurface    = document.getElementById('label-surface');

    const info    = document.getElementById('info');
    const mapElem = document.getElementById('map');

    // Setup map
    const map = L.map(mapElem).setView([0,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; OSM contributors'
    }).addTo(map);
    const marker    = L.marker([0,0]).addTo(map);
    const routeLine = L.polyline([], { color:'blue', weight:3 }).addTo(map);

    // Haversine formula
    function haversine([lat1,lon1],[lat2,lon2]) {
      const R=6371000, toRad=x=>x*Math.PI/180;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
              Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    // Chart factory
    const makeChart=(ctx,label,yLabel,yType='linear')=>new Chart(ctx,{
      type:'scatter',
      data:{datasets:[{label,data:[]}]},
      options:{
        scales:{
          x:{title:{display:true,text:'Distance (m)'}},
          y:{type:yType,title:{display:true,text:yLabel}}
        }
      }
    });

    // Init charts
    const speedChart        = makeChart(document.getElementById('speedChart'),      'Legal Speed',     'Speed (km/h)');
    const roundaboutChart   = makeChart(document.getElementById('roundaboutChart'),'Roundabout',      'Presence (1/0)');
    const stopSignChart     = makeChart(document.getElementById('stopSignChart'),  'Stop Sign',       'Presence (1/0)');
    const trafficLightChart = makeChart(document.getElementById('trafficLightChart'),'Traffic Light',   'Presence (1/0)');
    const bridgeChart       = makeChart(document.getElementById('bridgeChart'),    'Bridge',          'Presence (1/0)');
    const tunnelChart       = makeChart(document.getElementById('tunnelChart'),    'Tunnel',          'Presence (1/0)');
    const roadTypeChart     = makeChart(document.getElementById('roadTypeChart'),  'Road Type',       'Category','category');
    const cityChart         = makeChart(document.getElementById('cityChart'),      'City',            'Category','category');
    const countryChart      = makeChart(document.getElementById('countryChart'),   'Country',         'Category','category');
    const tollChart         = makeChart(document.getElementById('tollChart'),      'Toll Station',    'Presence (1/0)');
    const laneChart         = makeChart(document.getElementById('laneChart'),      'Number of Lanes', 'Lanes');
    const surfaceChart      = makeChart(document.getElementById('surfaceChart'),   'Surface',         'Category','category');

    // Update charts
    function updateCharts() {
      const upd=(c,arr)=>{
        c.data.datasets[0].data = distances.map((d,i)=>({x:d,y:arr[i]}));
        if(c.options.scales.y.type==='category'){
          c.options.scales.y.labels = [...new Set(arr)];
        }
        c.update();
      };
      upd(speedChart,        speeds);
      upd(roundaboutChart,   roundabouts);
      upd(stopSignChart,     stopSigns);
      upd(trafficLightChart, trafficLights);
      upd(bridgeChart,       bridges);
      upd(tunnelChart,       tunnels);
      upd(roadTypeChart,     roadTypes);
      upd(cityChart,         cities);
      upd(countryChart,      countries);
      upd(tollChart,         tolls);
      upd(laneChart,         lanesArr);
      upd(surfaceChart,      surfacesArr);
    }

    // Reverse‚Äêgeocode + UI update
    let lastTime=0, minInterval=1000;
    function reverseGeocode(lat,lon){
      const now=Date.now();
      if(now-lastTime<minInterval) return;
      lastTime=now;

      fetch(
        `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}`
        + `&format=jsonv2&extratags=1&zoom=16`
      )
      .then(r=>r.json())
      .then(data=>{
        const tags = data.extratags||{};
        const addr = data.address   || {};

        // road type
        const rt = data.category==='highway' ? data.type : 'unknown';

        // feature flags
        const f = {
          roadType:     rt,
          legalSpeed:   tags.maxspeed   || 'N/A',
          roundabout:   tags.junction   === 'roundabout',
          stopSign:     tags.highway    === 'stop',
          trafficLight: tags.highway    === 'traffic_signals',
          bridge:       tags.bridge     === 'yes',
          tunnel:       tags.tunnel     === 'yes',
          city:         addr.city||addr.town||addr.village||'Unknown',
          country:      addr.country    || 'Unknown'
        };
        const hasToll  = tags.toll=== 'yes';
        const numLanes = parseInt(tags.lanes,10)||NaN;
        const surf     = tags.surface||'unknown';

        // roadType icon/label
        iconRoadType.textContent  = roadTypeIcons[rt]||roadTypeIcons.unknown;
        labelRoadType.textContent = rt.charAt(0).toUpperCase()+rt.slice(1);

        // **legal speed: speed-limit sign**
        const maxSpeed = parseInt(tags.maxspeed,10);
        if (!isNaN(maxSpeed)) {
          iconSpeed.innerHTML = `<img src="/icons/speed-${maxSpeed}.svg" alt="${maxSpeed} km/h" style="width:24px;height:auto">`;
          labelSpeed.textContent = `${maxSpeed} km/h`;
        } else {
          iconSpeed.textContent   = 'üö´';
          labelSpeed.textContent  = 'N/A';
        }

        // other feature icons/labels
        iconRoundabout.textContent    = f.roundabout    ? 'üîÑ' : '‚≠ï';
        labelRoundabout.textContent   = f.roundabout    ? 'Yes' : 'No';
        iconStopSign.textContent      = f.stopSign      ? 'üõë' : '‚≠ï';
        labelStopSign.textContent     = f.stopSign      ? 'Yes' : 'No';
        iconTrafficLight.textContent  = f.trafficLight  ? 'üö¶' : '‚≠ï';
        labelTrafficLight.textContent = f.trafficLight  ? 'Yes' : 'No';
        iconBridge.textContent        = f.bridge        ? 'üåâ' : '‚≠ï';
        labelBridge.textContent       = f.bridge        ? 'Yes' : 'No';
        iconTunnel.textContent        = f.tunnel        ? 'üï≥Ô∏è' : '‚≠ï';
        labelTunnel.textContent       = f.tunnel        ? 'Yes' : 'No';
        iconToll.textContent          = hasToll         ? 'üí∞' : '‚≠ï';
        labelToll.textContent         = hasToll         ? 'Yes' : 'No';
        iconLanes.textContent         = 'üõ£Ô∏è';
        labelLanes.textContent        = isNaN(numLanes) ? 'N/A' : numLanes;
        iconSurface.textContent       = surfaceIcons[surf]||surfaceIcons.unknown;
        labelSurface.textContent      = surf.charAt(0).toUpperCase()+surf.slice(1);

        // push data
        distances.push(totalDistance);
        speeds.push(parseFloat(tags.maxspeed)||NaN);
        roundabouts.push(+f.roundabout);
        stopSigns.push(+f.stopSign);
        trafficLights.push(+f.trafficLight);
        bridges.push(+f.bridge);
        tunnels.push(+f.tunnel);
        roadTypes.push(f.roadType);
        cities.push(f.city);
        countries.push(f.country);
        tolls.push(+hasToll);
        lanesArr.push(numLanes);
        surfacesArr.push(surf);

        // update info & charts
        info.innerHTML = `<strong>Distance:</strong> ${totalDistance.toFixed(1)} m`;
        updateCharts();

        // popup marker
        const pop = { ...f, tollStation:hasToll, lanes:numLanes, surface:surf };
        const html = Object.entries(pop)
                          .map(([k,v])=>`<strong>${k}:</strong> ${v}`)
                          .join('<br>');
        L.marker([lat,lon]).bindPopup(html).addTo(map);
      })
      .catch(console.error);
    }

    // watchPosition
    function updatePosition(p){
      const [lat,lon] = [p.coords.latitude,p.coords.longitude];
      if(lastPos) totalDistance += haversine(lastPos,[lat,lon]);
      lastPos=[lat,lon];
      map.setView([lat,lon],16);
      marker.setLatLng([lat,lon]);
      routeLine.addLatLng([lat,lon]);
      reverseGeocode(lat,lon);
    }
    function handleError(e){ info.textContent = `Geolocation error: ${e.message}`; }
    if(navigator.geolocation){
      navigator.geolocation.watchPosition(updatePosition,handleError,{
        enableHighAccuracy:true,maximumAge:0,timeout:5000
      });
    } else {
      info.textContent = 'Geolocation not supported.';
    }
  </script>
</body>
</html>
