<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>4-Cam Session Viewer</title>
<style>
  body { margin:0; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; background:#111; color:#eee; display:flex; height:100vh; overflow:hidden; }
  #sidebar { width:260px; background:#1b1b1b; border-right:1px solid #333; display:flex; flex-direction:column; }
  #sessionList { flex:1; overflow-y:auto; padding:8px; }
  .session { padding:8px 10px; border-radius:6px; margin-bottom:4px; background:#222; cursor:pointer; }
  .session:hover { background:#2c2c2c; }
  .session.active { background:#2c7be5; color:#fff; }
  #main { flex:1; display:flex; flex-direction:column; overflow:hidden; }
  #toolbar { padding:8px 12px; border-bottom:1px solid #333; background:#141414; display:flex; align-items:center; gap:8px; }
  #videos { flex:1; display:grid; grid-template-columns:repeat(2,1fr); grid-template-rows:repeat(2,1fr); gap:6px; padding:6px; }
  video { width:100%; height:100%; object-fit:contain; background:#000; }
  .vwrap { position:relative; }
  .vwrap header { position:absolute; top:4px; left:4px; background:rgba(0,0,0,0.5); padding:2px 6px; border-radius:4px; font-size:12px; }
  #timeline { width:100%; }
  #currentTime { width:90px; text-align:right; font-variant-numeric:tabular-nums; }
  button { background:#2c7be5; border:none; color:#fff; padding:6px 10px; border-radius:6px; cursor:pointer; }
  button:hover { background:#3d8af0; }
</style>
</head>
<body>
  <div id="sidebar">
    <div style="padding:8px;border-bottom:1px solid #333;">
      <button id="pickFolder">Open Folder</button>
    </div>
    <div id="sessionList"></div>
  </div>
  <div id="main">
    <div id="toolbar">
      <button id="playPause" disabled>▶️ Play</button>
      <input id="timeline" type="range" min="0" max="100" value="0" step="0.01" disabled />
      <span id="currentTime">00:00</span>
      <div style="flex:1"></div>
      <span id="sessionName"></span>
    </div>
    <div id="videos">
      <div class="vwrap"><header>Front</header><video id="vidFront"></video></div>
      <div class="vwrap"><header>Back</header><video id="vidBack"></video></div>
      <div class="vwrap"><header>Left</header><video id="vidLeft"></video></div>
      <div class="vwrap"><header>Right</header><video id="vidRight"></video></div>
    </div>
  </div>

<script>
(async () => {
  const pickBtn = document.getElementById('pickFolder');
  const sessionList = document.getElementById('sessionList');
  const playPause = document.getElementById('playPause');
  const timeline = document.getElementById('timeline');
  const currentTime = document.getElementById('currentTime');
  const sessionNameEl = document.getElementById('sessionName');
  const vids = {
    Front: document.getElementById('vidFront'),
    Back:  document.getElementById('vidBack'),
    Left:  document.getElementById('vidLeft'),
    Right: document.getElementById('vidRight')
  };

  let sessions = {};     // { timestamp: {Front:File,Back:File,Left:File,Right:File} }
  let currentSession = null;
  let syncing = false;
  let timelineSyncInterval = null;

  // Utility
  function fmtTime(sec){
    sec = Math.max(0,sec);
    const m=Math.floor(sec/60), s=Math.floor(sec%60);
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  async function pickFolder() {
    let files = [];
    if (window.showDirectoryPicker) {
      const dir = await window.showDirectoryPicker();
      for await (const entry of dir.values()) {
        if (entry.kind==='file' && entry.name.endsWith('.webm')) {
          files.push(await entry.getFile());
        }
      }
    } else {
      const input = document.createElement('input');
      input.type='file';
      input.multiple=true;
      input.accept='.webm';
      input.click();
      files = await new Promise(res=>{
        input.onchange=()=>res([...input.files]);
      });
    }
    parseSessions(files);
  }

  function parseSessions(files){
    sessions={};
    for(const f of files){
      const m = f.name.match(/^(\d{8}_\d{6})_(Front|Back|Left|Right)\.webm$/i);
      if(!m) continue;
      const [,stamp,pos] = m;
      sessions[stamp] ||= {};
      sessions[stamp][pos] = f;
    }
    renderSidebar();
  }

  function renderSidebar(){
    sessionList.innerHTML='';
    const stamps = Object.keys(sessions).sort().reverse();
    for(const stamp of stamps){
      const div=document.createElement('div');
      div.className='session';
      div.textContent=stamp;
      div.onclick=()=>loadSession(stamp,div);
      sessionList.appendChild(div);
    }
  }

  async function loadSession(stamp,elem){
    [...sessionList.children].forEach(c=>c.classList.remove('active'));
    elem.classList.add('active');
    currentSession=stamp;
    sessionNameEl.textContent=stamp;
    playPause.disabled=false;
    timeline.disabled=false;

    // Load each existing video
    for(const pos of ['Front','Back','Left','Right']){
      const file = sessions[stamp][pos];
      const v = vids[pos];
      if(file){
        v.src = URL.createObjectURL(file);
        await v.play().catch(()=>{});
        v.pause();
        v.currentTime=0;
      } else {
        v.removeAttribute('src');
      }
    }

    // Wait a bit for metadata
    await Promise.all(Object.values(vids).map(v=> new Promise(r=>{
      v.onloadedmetadata=()=>r();
      setTimeout(r,500);
    })));

    // Set timeline range to 0–max duration found
    const maxDur = Math.max(...Object.values(vids).map(v=>v.duration||0));
    timeline.max = maxDur || 0;
    timeline.value=0;
    currentTime.textContent = fmtTime(0);
  }

  // --- playback sync ---
  playPause.addEventListener('click', ()=>{
    if(!currentSession) return;
    const playing = playPause.dataset.state==='playing';
    if(playing){
      pauseAll();
    } else {
      playAll();
    }
  });

  function playAll(){
    playPause.textContent='⏸ Pause';
    playPause.dataset.state='playing';
    for(const v of Object.values(vids)){ v.play().catch(()=>{}); }
    syncing=true;
    timelineSyncInterval=setInterval(()=>{
      const t = Object.values(vids).reduce((acc,v)=>acc+v.currentTime,0)/4;
      timeline.value=t;
      currentTime.textContent=fmtTime(t);
    },100);
  }

  function pauseAll(){
    playPause.textContent='▶️ Play';
    playPause.dataset.state='paused';
    for(const v of Object.values(vids)){ v.pause(); }
    clearInterval(timelineSyncInterval);
    syncing=false;
  }

  timeline.addEventListener('input',()=>{
    if(!syncing){
      const t=parseFloat(timeline.value);
      for(const v of Object.values(vids)){
        try{ v.currentTime=t; }catch{}
      }
      currentTime.textContent=fmtTime(t);
    }
  });

  pickBtn.onclick=pickFolder;
})();
</script>
</body>
</html>
