<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Annotator Reports Viewer</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo="> <!-- Tiny favicon -->
  <!-- Leaflet CSS (no SRI) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: sans-serif; background: #fff; color: #000; }
    #sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 240px; background: #f5f5f5; overflow-y: auto; }
    #content { margin-left: 240px; padding: 20px; }
    .day-header { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #ddd; }
    .day-header:hover { background: #e0e0e0; }
    .session-list { display: none; list-style: none; margin: 0; padding: 0; }
    .session-item { padding: 8px 32px; cursor: pointer; border-bottom: 1px solid #eee; }
    .session-item:hover { background: #f0f0f0; }
    h1 { margin-top: 0; }
    h2 { margin-top: 1.5em; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 2em; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #f0f0f0; }
    .error { color: #d00; padding: 16px; }
    #issue-map { width: 100%; height: 400px; margin: 20px 0; border: 1px solid #aaa; }
  </style>
</head>
<body>
  <div id="sidebar"></div>
  <div id="content"><h1>Select a session to view</h1></div>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <!-- Leaflet JS (no SRI) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    (async function(){
      const ACCOUNT   = 'annotationcsv';
      const CONTAINER = 'csv';
      const SAS_TOKEN = 'sv=2024-11-04&ss=bfqt&srt=co&sp=rwdlacupiytfx&se=2025-12-30T14:44:25Z&st=2025-05-30T05:44:25Z&spr=https&sig=QriUtSG3IFzzE3cz7vpcXpE7Ed6QDwSYSZ6YvT2kM%2B0%3D';
      const BASE_URL  = `https://${ACCOUNT}.blob.core.windows.net/${CONTAINER}`;
      let issueCoords = [];

      document.addEventListener('DOMContentLoaded', listBlobs);

      async function listBlobs() {
        try {
          const res = await fetch(`${BASE_URL}?restype=container&comp=list&${SAS_TOKEN}`);
          const xml = await res.text();
          const doc = new DOMParser().parseFromString(xml, 'application/xml');
          const blobs = Array.from(doc.getElementsByTagName('Blob'))
            .map(b => b.getElementsByTagName('Name')[0].textContent)
            .filter(n => n.endsWith('.xlsx'));
          if (!blobs.length) return showError('No .xlsx files found.');
          buildSidebar(blobs);
        } catch(e) {
          showError('Failed to list blobs: ' + e.message);
        }
      }

      function buildSidebar(files) {
        const sb = document.getElementById('sidebar'); sb.innerHTML = '';
        const groups = {};
        files.forEach(f => {
          const d = (f.match(/(\d{4}-\d{2}-\d{2})/)||[])[1]; if (!d) return;
          (groups[d] = groups[d]||[]).push(f);
        });
        Object.keys(groups).sort().reverse().forEach(day => {
          const hdr = document.createElement('div'); hdr.className = 'day-header'; hdr.textContent = day;
          const lst = document.createElement('ul'); lst.className = 'session-list';
          groups[day].sort().forEach(file => {
            const li = document.createElement('li'); li.className = 'session-item';
            li.textContent = file.replace(`${day}_`, '').replace('.xlsx','');
            li.onclick = () => loadFile(file);
            lst.appendChild(li);
          });
          hdr.onclick = () => lst.style.display = lst.style.display==='block' ? 'none' : 'block';
          sb.append(hdr, lst);
        });
      }

      async function loadFile(filename) {
        const content = document.getElementById('content');
        content.innerHTML = `<h1>${filename}</h1>`;
        issueCoords = [];

        try {
          const res = await fetch(`${BASE_URL}/${filename}?${SAS_TOKEN}`);
          const buf = await res.arrayBuffer();
          const wb = XLSX.read(new Uint8Array(buf), { type:'array' });
          wb.SheetNames.forEach(name => {
            const html = XLSX.utils.sheet_to_html(wb.Sheets[name], { id: name });
            content.insertAdjacentHTML('beforeend', `<h2>${name}</h2>${html}`);
            parseIssues(name);
          });
        } catch(e) {
          content.innerHTML += `<div class="error">Failed to load ${filename}: ${e.message}</div>`;
          return;
        }

        if (issueCoords.length > 2) {
          insertMap();
          initMap();
        } else {
          content.insertAdjacentHTML('beforeend',
            `<div class="error">Need at least 3 issues to plot a map (found ${issueCoords.length}).</div>`
          );
        }
      }

      function parseIssues(sheetId) {
        const tbl = document.getElementById(sheetId);
        if (!tbl) return;
        const rows = tbl.querySelectorAll('tr');
        if (rows.length < 2) return;
        const headerCells = Array.from(rows[0].querySelectorAll('th, td'));
        const headers = headerCells.map(cell => cell.textContent.trim().toLowerCase());
        const latIdx = headers.findIndex(h => h.includes('lat'));
        const lonIdx = headers.findIndex(h => h.includes('lon'));
        const issueIdx = headers.findIndex(h => h.includes('issue'));
        if (latIdx < 0 || lonIdx < 0) return;
        Array.from(rows).slice(1).forEach((row, i) => {
          const cells = Array.from(row.querySelectorAll('td'));
          const issueNo = issueIdx >= 0 ? cells[issueIdx]?.textContent.trim() : `row ${i+1}`;
          const lat = parseFloat(cells[latIdx]?.textContent.trim());
          const lon = parseFloat(cells[lonIdx]?.textContent.trim());
          if (!isNaN(lat) && !isNaN(lon)) {
            issueCoords.push({ issueNo, lat, lon });
          }
        });
      }

      function insertMap() {
        const old = document.getElementById('issue-map'); if (old) old.remove();
        const content = document.getElementById('content');
        const mapDiv = document.createElement('div');
        mapDiv.id = 'issue-map'; mapDiv.style.width='100%'; mapDiv.style.height='400px';
        content.appendChild(mapDiv);
      }

      function initMap() {
        const map = L.map('issue-map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
        map.fitBounds(issueCoords.map(c => [c.lat, c.lon]));
        issueCoords.forEach(c => {
          L.circleMarker([c.lat, c.lon], { radius:6, color:'red', fillOpacity:0.8 })
           .bindPopup(`Issue ${c.issueNo}`)
           .addTo(map);
        });
        map.whenReady(() => map.invalidateSize());
      }

      function showError(msg) {
        document.getElementById('sidebar').innerHTML = `<div class="error">${msg}</div>`;
      }
    })();
  </script>
</body>
</html>
