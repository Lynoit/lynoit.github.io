<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Annotator Reports Viewer</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    body { margin:0; font-family:sans-serif; background:#fff; color:#000; }
    #sidebar { position:fixed; left:0; top:0; bottom:0; width:240px; background:#f5f5f5; overflow-y:auto; }
    #content { margin-left:240px; padding:20px; }
    .day-header { padding:12px 16px; cursor:pointer; border-bottom:1px solid #ddd; }
    .day-header:hover { background:#e0e0e0; }
    .session-list { display:none; list-style:none; margin:0; padding:0; }
    .session-item { padding:8px 32px; cursor:pointer; border-bottom:1px solid #eee; }
    .session-item:hover { background:#f0f0f0; }
    h1 { margin-top:0; }
    h2 { margin-top:1.5em; border-bottom:1px solid #ddd; padding-bottom:4px; }
    table { width:100%; border-collapse:collapse; margin-bottom:2em; }
    th, td { border:1px solid #ccc; padding:8px; }
    th { background:#f0f0f0; }
    .error { color:#d00; padding:16px; }
    #issue-map { width:100%; height:400px; margin:20px 0; border:1px solid #aaa; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2 style="padding:16px 16px; margin:0; border-bottom:1px solid #ddd;">Test sessions</h2>
  </div>
  <div id="content"><h1>Select a session to view</h1></div>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const ACCOUNT = 'annotationcsv';
    const CONTAINER = 'csv';
    const SAS_TOKEN = 'sv=2024-11-04&ss=bfqt&srt=co&sp=rwdlacupiytfx&se=2025-12-30T14:44:25Z&st=2025-05-30T05:44:25Z&spr=https&sig=QriUtSG3IFzzE3cz7vpcXpE7Ed6QDwSYSZ6YvT2kM%2B0%3D';
    const BASE_URL = `https://${ACCOUNT}.blob.core.windows.net/${CONTAINER}`;
    let issueCoords = [];

    document.addEventListener('DOMContentLoaded', listBlobs);

    function listBlobs() {
      fetch(`${BASE_URL}?restype=container&comp=list&${SAS_TOKEN}`)
        .then(response => response.text())
        .then(xml => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(xml, 'application/xml');
          const blobs = Array.from(doc.getElementsByTagName('Name'))
            .map(el => el.textContent)
            .filter(name => name.endsWith('.xlsx'));
          if (blobs.length === 0) {
            showError('No .xlsx files found.');
            return;
          }
          buildSidebar(blobs);
        })
        .catch(error => showError('Failed to list blobs: ' + error));
    }

    function buildSidebar(files) {
  const sb = document.getElementById('sidebar');
  // clear out old items
  sb.innerHTML = '';
  // recreate static header
  const header = document.createElement('h2');
  header.textContent = 'Test sessions';
  header.style.padding = '16px';
  header.style.margin = '0';
  header.style.borderBottom = '1px solid #ddd';
  sb.appendChild(header);

  // group files by date
  const groups = files.reduce((acc, f) => {
    const match = f.match(/(\d{4}-\d{2}-\d{2})/);
    if (!match) return acc;
    const day = match[1];
    acc[day] = acc[day] || [];
    acc[day].push(f);
    return acc;
  }, {});

  Object.keys(groups).sort().reverse().forEach(day => {
    const hdr = document.createElement('div');
    hdr.className = 'day-header';
    hdr.textContent = day;
    const lst = document.createElement('ul');
    lst.className = 'session-list';
    groups[day].sort().forEach(f => {
      const li = document.createElement('li');
      li.className = 'session-item';
      li.textContent = f.replace(`${day}_`, '').replace('.xlsx','');
      li.onclick = () => loadFile(f);
      lst.appendChild(li);
    });
    hdr.onclick = () => lst.style.display = lst.style.display === 'block' ? 'none' : 'block';
    sb.appendChild(hdr);
    sb.appendChild(lst);
  });
}


    function loadFile(filename) {
      const content = document.getElementById('content');
      // clear previous content (remove file header)
      content.innerHTML = '';
      issueCoords = [];
      fetch(`${BASE_URL}/${filename}?${SAS_TOKEN}`)
        .then(response => response.arrayBuffer())
        .then(buffer => {
          const data = new Uint8Array(buffer);
          const wb = XLSX.read(data, { type: 'array' });
          wb.SheetNames.forEach(sheet => {
            const html = XLSX.utils.sheet_to_html(wb.Sheets[sheet], { id: sheet });
            content.insertAdjacentHTML('beforeend', `<h2>${sheet}</h2>${html}`);
            parseIssues(sheet);
          });
        })
        .then(() => {
          if (issueCoords.length >= 3) {
            insertMap();
            initMap();
          } else {
            content.insertAdjacentHTML('beforeend',
              `<div class="error">Need at least 3 issues to plot a map (found ${issueCoords.length}).</div>`
            );
          }
        })
        .catch(error => {
          content.innerHTML += `<div class="error">Failed to load ${filename}: ${error}</div>`;
        });
    }

    function parseIssues(sheetId) {
      const table = document.getElementById(sheetId);
      if (!table) return;
      const rows = Array.from(table.querySelectorAll('tr'));
      if (rows.length < 2) return;
      const headerCells = Array.from(rows[0].querySelectorAll('th, td'));
      const headers = headerCells.map(cell => cell.textContent.trim().toLowerCase());
      const latIdx = headers.findIndex(h => h.includes('lat'));
      const lonIdx = headers.findIndex(h => h.includes('lon'));
      if (latIdx < 0 || lonIdx < 0) return;
      rows.slice(1).forEach((row, i) => {
        const cells = Array.from(row.querySelectorAll('td'));
        const issueNo = cells[0].textContent.trim();
        const lat = parseFloat(cells[latIdx].textContent.trim());
        const lon = parseFloat(cells[lonIdx].textContent.trim());
        console.log(`Row ${i+1}: issueNo=${issueNo}, lat=${lat}, lon=${lon}`);
        if (!isNaN(lat) && !isNaN(lon)) {
          issueCoords.push({ issueNo, lat, lon });
        }
      });
      console.log('Collected coords:', issueCoords);
    }

    function insertMap() {
      // remove existing map if present
      const existing = document.getElementById('issue-map');
      if (existing) existing.remove();
      // create map container
      const mapDiv = document.createElement('div');
      mapDiv.id = 'issue-map';
      mapDiv.style.width = '100%';
      mapDiv.style.height = '400px';
      mapDiv.style.margin = '20px 0';
      mapDiv.style.border = '1px solid #aaa';
      // find the 'Issue' section header and its table
      const content = document.getElementById('content');
      let issueTable = null;
      content.querySelectorAll('h2').forEach(h2 => {
        if (h2.textContent.trim().toLowerCase().includes('issue')) {
          const next = h2.nextElementSibling;
          if (next && next.tagName.toLowerCase() === 'table') {
            issueTable = next;
          }
        }
      });
      if (issueTable && issueTable.parentNode) {
        // insert directly after the issue table
        issueTable.parentNode.insertBefore(mapDiv, issueTable.nextSibling);
      } else {
        // fallback to bottom
        content.appendChild(mapDiv);
      }
    }
    function initMap() {
      const map = L.map('issue-map').setView([0,0],2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      map.fitBounds(issueCoords.map(c => [c.lat,c.lon]));
      issueCoords.forEach(c => {
        const icon = L.divIcon({
          className: 'issue-label',
          html: `<div class="issue-badge">${c.issueNo}</div>`,
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        });
        L.marker([c.lat, c.lon], { icon }).addTo(map);
      });
      map.whenReady(() => map.invalidateSize());
    }

    /* add CSS for badge */
    const style = document.createElement('style');
    style.innerHTML = `
      .issue-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        background: red;
        color: white;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        pointer-events: none;
      }
    `;
    document.head.appendChild(style);

    function showError(message) {
      document.getElementById('sidebar').innerHTML = `<div class="error">${message}</div>`;
    }
  </script>
</body>
</html>
