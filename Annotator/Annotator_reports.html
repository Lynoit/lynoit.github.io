<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Annotator Reports Viewer</title>
  <!-- favicon -->
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+ehoY2dQSb9oEdZ3MEyqlMV2rQb6P5hYh6t8a+6Lk="
    crossorigin=""
  />
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #fff;
      color: #000;
    }
    #sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 240px;
      background: #f5f5f5;
      overflow-y: auto;
    }
    #content {
      margin-left: 240px;
      padding: 20px;
    }
    .day-header {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #ddd;
    }
    .day-header:hover { background: #e0e0e0; }
    .session-list {
      display: none;
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .session-item {
      padding: 8px 32px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .session-item:hover { background: #f0f0f0; }
    h1 { margin-top: 0; }
    h2 {
      margin-top: 1.5em;
      border-bottom: 1px solid #ddd;
      padding-bottom: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2em;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background: #f0f0f0;
    }
    .error {
      color: #d00;
      padding: 16px;
    }
    /* map container */
    #issue-map {
      width: 100%;
      height: 400px;
      margin: 20px 0;
      border: 1px solid #aaa;
    }
  </style>
</head>
<body>
  <div id="sidebar"></div>
  <div id="content">
    <h1>Select a session to view</h1>
    <!-- always show the map even before loading a file -->
    <div id="issue-map"></div>
  </div>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kCyBtoY4H10tgAbPZnFef0bF8HjvGU+2drjfk="
    crossorigin=""
  ></script>
  <script>
  (async function(){
    const ACCOUNT   = 'annotationcsv';
    const CONTAINER = 'csv';
    const SAS_TOKEN = 'sv=2024-11-04&ss=bfqt&srt=co&sp=rwdlacupiytfx&se=2025-05-30T04:50:50Z&st=2025-05-29T20:50:50Z&spr=https&sig=Ny142dmI2gwNB%2BjCgI%2Fm1n6iLtBtTNXgTPMlVhbnmQA%3D';
    const BASE_URL  = `https://${ACCOUNT}.blob.core.windows.net/${CONTAINER}`;
    let issueCoords = [];

    // create the base map once
    const map = L.map('issue-map').setView([0,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    // ensure Leaflet knows container size
    map.whenReady(() => map.invalidateSize());

    document.addEventListener('DOMContentLoaded', listBlobs);

    async function listBlobs() {
      try {
        const res = await fetch(`${BASE_URL}?restype=container&comp=list&${SAS_TOKEN}`);
        const xml = await res.text();
        const doc = new DOMParser().parseFromString(xml, 'application/xml');
        const blobs = Array.from(doc.getElementsByTagName('Blob'))
          .map(b => b.getElementsByTagName('Name')[0].textContent)
          .filter(n => n.endsWith('.xlsx'));
        if (!blobs.length) return showError('No .xlsx files found.');
        buildSidebar(blobs);
      } catch(e) {
        showError('Failed to list blobs: ' + e.message);
      }
    }

    function buildSidebar(files) {
      const sb = document.getElementById('sidebar');
      sb.innerHTML = '';
      const groups = {};
      files.forEach(f => {
        const d = (f.match(/(\d{4}-\d{2}-\d{2})/)||[])[1];
        if (!d) return;
        (groups[d] = groups[d]||[]).push(f);
      });
      Object.keys(groups).sort().reverse().forEach(day => {
        const hdr = document.createElement('div');
        hdr.className = 'day-header';
        hdr.textContent = day;
        const lst = document.createElement('ul');
        lst.className = 'session-list';
        groups[day].sort().forEach(file => {
          const li = document.createElement('li');
          li.className = 'session-item';
          li.textContent = file.replace(`${day}_`, '').replace('.xlsx','');
          li.onclick = () => loadFile(file);
          lst.appendChild(li);
        });
        hdr.onclick = () => {
          lst.style.display = lst.style.display === 'block' ? 'none' : 'block';
        };
        sb.append(hdr, lst);
      });
    }

    async function loadFile(filename) {
      const content = document.getElementById('content');
      content.innerHTML = `<h1>${filename}</h1><div id="issue-map"></div>`;
      issueCoords = [];

      // re-bind map to the fresh div
      map.remove(); // destroy old instance
      const newMap = L.map('issue-map').setView([0,0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(newMap);
      newMap.whenReady(() => newMap.invalidateSize());

      try {
        const res = await fetch(`${BASE_URL}/${filename}?${SAS_TOKEN}`);
        const buf = await res.arrayBuffer();
        const wb = XLSX.read(new Uint8Array(buf), { type:'array' });
        wb.SheetNames.forEach(name => {
          const html = XLSX.utils.sheet_to_html(wb.Sheets[name], { id: name });
          content.insertAdjacentHTML('beforeend', `<h2>${name}</h2>${html}`);
          if (name.toLowerCase() === 'issue') parseIssues(name);
        });

        // if we found coords, fit to them and draw markers
        if (issueCoords.length) {
          newMap.fitBounds(issueCoords.map(c => [c.lat, c.lng]));
          issueCoords.forEach(c => {
            L.circleMarker([c.lat, c.lng], {
              radius: 6,
              color: 'red',
              fillOpacity: 0.8
            })
            .bindPopup(`Issue ${c.issueNo}`)
            .addTo(newMap);
          });
        }
      } catch(e) {
        content.innerHTML += `<div class="error">Failed to load ${filename}: ${e.message}</div>`;
      }
    }

    function parseIssues(sheetId) {
      const tbl = document.getElementById(sheetId);
      if (!tbl) return;
      Array.from(tbl.querySelectorAll('tr')).slice(1).forEach(r => {
        const cells = r.querySelectorAll('td');
        const issueNo = cells[0]?.textContent.trim();
        const coord = Array.from(cells).find(td =>
          /-?\d+(\.\d+)?,\s*-?\d+(\.\d+)?/.test(td.textContent)
        );
        if (coord) {
          const [lat, lng] = coord.textContent.split(',').map(s => parseFloat(s));
          if (!isNaN(lat) && !isNaN(lng)) {
            issueCoords.push({ issueNo, lat, lng });
          }
        }
      });
    }

    function showError(msg) {
      document.getElementById('sidebar').innerHTML =
        `<div class="error">${msg}</div>`;
    }
  })();
  </script>
</body>
</html>
