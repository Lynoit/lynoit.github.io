<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KPI JSON Editor</title>
<style>
  :root{
    --bg:#0f1220; --panel:#161a2b; --ink:#e8ecff; --muted:#a9b0d5; --accent:#7aa2ff; --danger:#ff6584; --ok:#39d98a;
    --gap:14px; --rad:14px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{display:grid;grid-template-columns: 300px 1fr;gap:var(--gap);padding:var(--gap);box-sizing:border-box}
  .card{background:var(--panel);border-radius:var(--rad);box-shadow:0 10px 30px rgba(0,0,0,.35);padding:14px}
  h2,h3{margin:.2rem 0 .8rem 0}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  input[type="file"]{color:var(--muted)}
  button{background:#222844;border:1px solid #2a335a;color:var(--ink);border-radius:12px;padding:8px 12px;cursor:pointer}
  button:hover{background:#283156}
  button.ghost{background:transparent;border-color:#39426e;color:var(--muted)}
  button.danger{border-color:var(--danger);color:#ffd7df}
  button.ok{border-color:var(--ok);color:#d7ffef}
  button.small{padding:4px 8px;border-radius:10px;font-size:.9rem}
  .sidebar .cat{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:10px;cursor:pointer}
  .sidebar .cat:hover{background:#1a2040}
  .sidebar .cat.active{background:#222a54}
  .sidebar .addcat{display:flex;gap:8px;margin-top:10px}
  .sidebar input[type="text"], .main input[type="text"]{width:100%;padding:8px;border-radius:10px;border:1px solid #36406f;background:#12162a;color:var(--ink)}
  .muted{color:var(--muted);font-size:.92rem}
  .row{display:flex;gap:10px;align-items:center}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th{color:var(--muted);font-weight:600;text-align:left;padding:0 10px}
  td{background:#11162d;padding:10px;border-top:1px solid #2a2f5a;border-bottom:1px solid #2a2f5a}
  tr td:first-child{border-radius:10px 0 0 10px}
  tr td:last-child{border-radius:0 10px 10px 0}
  td input[type="text"]{width:100%;padding:8px;border-radius:8px;border:1px solid #36406f;background:#0e1330;color:var(--ink)}
  td .actions{display:flex;gap:6px;justify-content:flex-end}
  .grid{display:grid;gap:10px}
  .two{grid-template-columns:1fr auto}
  .sticky{position:sticky;top:0;background:var(--panel);z-index:2}
  .pill{display:inline-block;font-size:.8rem;padding:2px 8px;border:1px solid #3a426e;border-radius:999px;color:var(--muted)}
  .spacer{height:6px}
  .hint{font-size:.9rem;color:var(--muted)}
  .hr{height:1px;background:#2a2f5a;margin:10px 0}
  .right-tools{display:flex;gap:8px;flex-wrap:wrap}
  .checkbox{display:inline-flex;gap:6px;align-items:center}
  .grow{flex:1}
</style>
</head>
<body>
  <div class="wrap">
    <!-- SIDEBAR -->
    <aside class="sidebar card">
      <h3>Data</h3>
      <div class="toolbar">
        <label>
          <input id="fileInput" type="file" accept=".json,application/json" />
        </label>
        <button id="btnNew" class="ghost small" title="Start fresh">New</button>
        <button id="btnExport" class="small">Download JSON</button>
      </div>
      <div class="toolbar">
        <button id="btnLoadSample" class="ghost small" title="Load from localStorage">Load autosave</button>
        <button id="btnClearAutosave" class="danger small" title="Clear localStorage autosave">Clear autosave</button>
      </div>

      <h3 style="margin-top:12px;">Categories</h3>
      <div id="catList" class="grid"></div>

      <div class="addcat">
        <input id="newCatName" type="text" placeholder="New category name"/>
        <button id="btnAddCat">Add</button>
      </div>
      <div class="spacer"></div>
      <div class="hint">Tip: Click a category to edit its items. Changes are auto-saved locally. Use “Download JSON” to export.</div>
    </aside>

    <!-- MAIN -->
    <main class="main card">
      <div id="catHeader" class="grid two sticky" style="padding-bottom:8px;">
        <div class="row">
          <span id="currentCat" class="pill">No category selected</span>
        </div>
        <div class="right-tools">
          <input id="renameCatInput" type="text" placeholder="Rename category" style="width:220px"/>
          <button id="btnRenameCat" class="small">Rename</button>
          <button id="btnDeleteCat" class="danger small">Delete</button>
        </div>
      </div>

      <div class="hr"></div>

      <section id="addEntryBox" class="grid two">
        <div class="row grow">
          <input id="newText" class="grow" type="text" placeholder="New entry text…"/>
        </div>
        <div class="row">
          <label class="checkbox"><input id="newEnabled" type="checkbox" checked/> Enabled</label>
          <label class="checkbox"><input id="newKpi" type="checkbox" checked/> KPI</label>
          <button id="btnAddEntry">Add entry</button>
        </div>
      </section>

      <div class="spacer"></div>

      <section>
        <table>
          <thead>
            <tr>
              <th style="width:54px;">#</th>
              <th>Text</th>
              <th style="width:110px;">Enabled</th>
              <th style="width:90px;">KPI</th>
              <th style="width:220px;">Actions</th>
            </tr>
          </thead>
        </table>
        <div id="entriesHost"></div>
      </section>
    </main>
  </div>

<script>
(() => {
  let data = {};           // { category: [ {text, enabled, kpi}, ... ] }
  let activeCat = null;    // string | null
  let dirty = false;

  // ---- DOM ----
  const el = id => document.getElementById(id);
  const fileInput = el('fileInput');
  const btnNew = el('btnNew');
  const btnExport = el('btnExport');
  const btnLoadSample = el('btnLoadSample');
  const btnClearAutosave = el('btnClearAutosave');

  const catList = el('catList');
  const newCatName = el('newCatName');
  const btnAddCat = el('btnAddCat');

  const currentCat = el('currentCat');
  const renameCatInput = el('renameCatInput');
  const btnRenameCat = el('btnRenameCat');
  const btnDeleteCat = el('btnDeleteCat');

  const newText = el('newText');
  const newEnabled = el('newEnabled');
  const newKpi = el('newKpi');
  const btnAddEntry = el('btnAddEntry');

  const entriesHost = el('entriesHost');

  // ---- Persistence ----
  const LS_KEY = 'kpi_editor_data_v1';
  function autosave() {
    try {
      localStorage.setItem(LS_KEY, JSON.stringify(data));
      dirty = false;
    } catch(e) { console.warn('Autosave failed', e); }
  }
  function autoload() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return false;
      const obj = JSON.parse(raw);
      if (obj && typeof obj === 'object') {
        data = normalize(obj);
        activeCat = firstKey(data);
        renderAll();
        return true;
      }
    } catch(e) { console.warn('Autoload failed', e); }
    return false;
  }

  window.addEventListener('beforeunload', (e) => {
    if (dirty) {
      e.preventDefault();
      e.returnValue = '';
    }
  });

  // ---- Utils ----
  function firstKey(o){ return Object.keys(o).at(0) || null; }
  function clone(x){ return JSON.parse(JSON.stringify(x)); }
  function normalize(obj){
    // Ensure format: {cat: [ {text,enabled,kpi}, ... ]}
    const out = {};
    for (const [cat, arr] of Object.entries(obj || {})) {
      if (!Array.isArray(arr)) continue;
      out[String(cat)] = arr.map(item => ({
        text: String(item?.text ?? ''),
        enabled: Boolean(item?.enabled),
        kpi: Boolean(item?.kpi)
      }));
    }
    return out;
  }
  function setDirty(){ dirty = true; autosave(); }

  function download(filename, text){
    const blob = new Blob([text], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  }

  // ---- Renderers ----
  function renderCategories(){
    catList.innerHTML = '';
    const cats = Object.keys(data).sort((a,b)=>a.localeCompare(b));
    if (cats.length===0) {
      const div = document.createElement('div');
      div.className = 'muted';
      div.textContent = 'No categories yet.';
      catList.appendChild(div);
      return;
    }
    cats.forEach(cat=>{
      const row = document.createElement('div');
      row.className = 'cat';
      if (cat === activeCat) row.classList.add('active');

      const name = document.createElement('div');
      name.textContent = cat;

      const count = document.createElement('div');
      count.className = 'muted';
      count.textContent = (data[cat]?.length ?? 0);

      row.appendChild(name);
      row.appendChild(count);
      row.addEventListener('click', ()=>{ activeCat = cat; renderMainHeader(); renderEntries(); });
      catList.appendChild(row);
    });
  }

  function renderMainHeader(){
    if (!activeCat) {
      currentCat.textContent = 'No category selected';
      renameCatInput.value = '';
      return;
    }
    currentCat.textContent = activeCat;
    renameCatInput.value = activeCat;
  }

  function renderEntries(){
    entriesHost.innerHTML = '';
    if (!activeCat) {
      const div = document.createElement('div');
      div.className = 'muted';
      div.textContent = 'Pick or create a category to start editing.';
      entriesHost.appendChild(div);
      return;
    }
    const list = data[activeCat] || [];
    // Build table body
    const table = document.createElement('table');
    const tbody = document.createElement('tbody');

    list.forEach((item, idx)=>{
      const tr = document.createElement('tr');

      // #
      const tdIdx = document.createElement('td');
      tdIdx.style.width = '54px';
      tdIdx.textContent = String(idx+1);

      // Text
      const tdText = document.createElement('td');
      const inputText = document.createElement('input');
      inputText.type = 'text';
      inputText.value = item.text ?? '';
      inputText.addEventListener('input', ()=>{
        data[activeCat][idx].text = inputText.value;
        setDirty();
      });
      tdText.appendChild(inputText);

      // Enabled
      const tdEn = document.createElement('td');
      tdEn.style.width = '110px';
      const chkEn = document.createElement('input');
      chkEn.type = 'checkbox';
      chkEn.checked = Boolean(item.enabled);
      chkEn.addEventListener('change', ()=>{
        data[activeCat][idx].enabled = chkEn.checked;
        setDirty();
      });
      tdEn.appendChild(chkEn);

      // KPI
      const tdKpi = document.createElement('td');
      tdKpi.style.width = '90px';
      const chkK = document.createElement('input');
      chkK.type = 'checkbox';
      chkK.checked = Boolean(item.kpi);
      chkK.addEventListener('change', ()=>{
        data[activeCat][idx].kpi = chkK.checked;
        setDirty();
      });
      tdKpi.appendChild(chkK);

      // Actions
      const tdAct = document.createElement('td');
      tdAct.style.width = '220px';
      const box = document.createElement('div');
      box.className = 'actions';

      const btnUp = document.createElement('button');
      btnUp.className = 'small ghost';
      btnUp.textContent = '↑';
      btnUp.title = 'Move up';
      btnUp.disabled = (idx===0);
      btnUp.addEventListener('click', ()=>{
        const arr = data[activeCat];
        [arr[idx-1], arr[idx]] = [arr[idx], arr[idx-1]];
        setDirty(); renderEntries(); renderCategories();
      });

      const btnDown = document.createElement('button');
      btnDown.className = 'small ghost';
      btnDown.textContent = '↓';
      btnDown.title = 'Move down';
      btnDown.disabled = (idx===list.length-1);
      btnDown.addEventListener('click', ()=>{
        const arr = data[activeCat];
        [arr[idx], arr[idx+1]] = [arr[idx+1], arr[idx]];
        setDirty(); renderEntries(); renderCategories();
      });

      const btnDup = document.createElement('button');
      btnDup.className = 'small';
      btnDup.textContent = 'Duplicate';
      btnDup.title = 'Duplicate entry';
      btnDup.addEventListener('click', ()=>{
        const copy = clone(item);
        data[activeCat].splice(idx+1, 0, copy);
        setDirty(); renderEntries(); renderCategories();
      });

      const btnDel = document.createElement('button');
      btnDel.className = 'small danger';
      btnDel.textContent = 'Delete';
      btnDel.addEventListener('click', ()=>{
        if (!confirm('Delete this entry?')) return;
        data[activeCat].splice(idx,1);
        setDirty(); renderEntries(); renderCategories();
      });

      box.append(btnUp, btnDown, btnDup, btnDel);
      tdAct.appendChild(box);

      tr.append(tdIdx, tdText, tdEn, tdKpi, tdAct);
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    entriesHost.appendChild(table);
  }

  function renderAll(){
    renderCategories();
    renderMainHeader();
    renderEntries();
  }

  // ---- Actions ----
  btnAddCat.addEventListener('click', ()=>{
    const name = (newCatName.value || '').trim();
    if (!name) return;
    if (data[name]) { alert('Category already exists.'); return; }
    data[name] = [];
    activeCat = name;
    newCatName.value = '';
    setDirty();
    renderAll();
  });

  btnRenameCat.addEventListener('click', ()=>{
    if (!activeCat) return;
    const newName = (renameCatInput.value || '').trim();
    if (!newName || newName === activeCat) return;
    if (data[newName]) { alert('A category with that name already exists.'); return; }
    data[newName] = data[activeCat];
    delete data[activeCat];
    activeCat = newName;
    setDirty(); renderAll();
  });

  btnDeleteCat.addEventListener('click', ()=>{
    if (!activeCat) return;
    if (!confirm(`Delete category "${activeCat}" and all its entries?`)) return;
    delete data[activeCat];
    activeCat = firstKey(data);
    setDirty(); renderAll();
  });

  btnAddEntry.addEventListener('click', ()=>{
    if (!activeCat) { alert('Create or select a category first.'); return; }
    const txt = (newText.value || '').trim();
    if (!txt) { newText.focus(); return; }
    const item = { text: txt, enabled: !!newEnabled.checked, kpi: !!newKpi.checked };
    data[activeCat].push(item);
    newText.value=''; newEnabled.checked=true; newKpi.checked=true;
    setDirty(); renderEntries(); renderCategories();
  });

  newText.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); btnAddEntry.click(); } });

  btnExport.addEventListener('click', ()=>{
    const fileName = `custom_functions_${new Date().toISOString().slice(0,10)}.json`;
    download(fileName, JSON.stringify(data, null, 2));
  });

  btnNew.addEventListener('click', ()=>{
    if (!confirm('Start a new empty dataset? (Unsaved changes are stored in autosave anyway)')) return;
    data = {}; activeCat = null; setDirty(); renderAll();
  });

  btnLoadSample.addEventListener('click', ()=>{
    const ok = autoload();
    if (!ok) alert('No autosave found.');
  });

  btnClearAutosave.addEventListener('click', ()=>{
    localStorage.removeItem(LS_KEY);
    alert('Autosave cleared.');
  });

  fileInput.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      const text = await file.text();
      const obj = JSON.parse(text);
      data = normalize(obj);
      activeCat = firstKey(data);
      setDirty(); renderAll();
    } catch(err) {
      console.error(err);
      alert('Failed to read JSON file. Make sure the format is correct.');
    } finally {
      fileInput.value = '';
    }
  });

  // ---- Boot ----
  // If you want to start empty, comment autoload() line:
  autoload() || (()=>{ data={}; activeCat=null; renderAll(); })();

})();
</script>
</body>
</html>
