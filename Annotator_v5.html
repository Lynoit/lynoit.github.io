<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annotator</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Chart.js core + Luxon adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>

  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <style>
    html, body { height:100%; margin:0; padding:0; font-family:Arial,sans-serif; }
    #sidebar {
      position:fixed; top:0; left:0; height:100%; width:260px;
      transform:translateX(-230px); transition:transform .3s ease;
      background:#fff; box-shadow:2px 0 5px rgba(0,0,0,0.1);
      overflow-y:auto; padding:50px 10px 10px; z-index:1000;
    }
    #sidebar.expanded { transform:translateX(0); }
    #toggleSidebar {
      position:fixed; top:10px; left:10px;
      background:#007bff; border:none; color:#fff;
      font-size:1.5em; padding:4px 8px; cursor:pointer; border-radius:4px; z-index:1100;
    }

    .spinner {
      border:2px solid rgba(0,0,0,0.1);
      border-left-color:#333; border-radius:50%;
      width:16px; height:16px; animation:spin .8s linear infinite;
      display:inline-block; vertical-align:middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .bigButton {
      display:block; width:80%; min-width:80px;
      padding:12px; font-size:14px; border-radius:4px;
      cursor:pointer; margin:8px auto;
    }
    .orangeButton { background:orange; color:#fff; }
    .blueButton   { background:blue;   color:#fff; }
    .greyButton   { background:grey;   color:#fff; }
    .greenButton  { background:green;  color:#fff; }
    .redButton    { background:red;    color:#fff; }

    #mainContent { margin-left:280px; padding:20px; box-sizing:border-box; }

    /* Manual Annotation */
    #manualAnnotation {
      display:flex; gap:10px; align-items:flex-start; margin-bottom:20px;
    }
    #manualAnnotation textarea {
      flex:1; resize:vertical; font-size:14px; padding:8px;
    }
    #manualAnnotation button {
      display:inline-block; width:auto; padding:6px 10px;
      font-size:12px; margin:0; white-space:nowrap;
    }

    /* Right‑column ACC/AEB/etc buttons */
    #autoButtonGroups {
      display:flex; flex-wrap:wrap; gap:8px; margin-bottom:20px;
    }

    table { width:100%; margin:10px 0; border-collapse:collapse; }
    td, th { text-align:center; padding:10px; }
    .section { margin-bottom:30px; }
    .page-break { page-break-after:always; }

    @media print {
      #sidebar, #toggleSidebar { display:none !important; }
      .page-break { display:block; }
    }
  </style>
</head>
<body>
  <button id="toggleSidebar" aria-expanded="false">☰</button>
  <div id="sidebar" class="collapsed">
    <p id="dateTime"></p>
    <div class="weatherSection">
      <img id="weatherIcon" src="" alt="Weather">
      <p id="temperature">Temp: N/A</p>
    </div>
    <p id="streetCity">Street: N/A<br>City: N/A</p>
    <p id="location"></p>
    <p id="roadType">Road type: N/A</p>
    <p id="speed">Speed: N/A</p>
    <div class="distanceContainer">
      <p id="totalDistance">Distance: 0.0 km</p>
      <button class="bigButton orangeButton" onclick="resetDistance()">Reset distance</button>
    </div>
    <button class="bigButton greenButton" onclick="saveAndPrint()">Save report to PDF</button>
    <!-- Sidebar buttons from CSV (minus ACC/AEB/etc) -->
    <div id="buttonGroups" class="center-groups"></div>
  </div>

  <div id="mainContent">
    <!-- Manual annotation -->
    <div id="manualAnnotation" class="section">
      <textarea id="textBox" rows="2" placeholder="Enter your annotation here…"></textarea>
      <button class="blueButton" onclick="logButton('Manual annotation', false)">
        Manual annotation
      </button>
    </div>

    <!-- ACC, AEB, ALCA, TSI buttons -->
    <div id="autoButtonGroups" class="section"></div>

    <!-- Rest of content -->
    <div id="logTableContainer" class="section"></div>
    <div class="page-break"></div>

    <div id="mapContainer" class="section">
      <h3>Route</h3>
      <div id="map" style="height:300px;width:100%;"></div>
    </div>
    <div class="page-break"></div>

    <div id="countContainer" class="section">
      <h3>KPI Calculation</h3>
      <table id="countTable">
        <tr><th>Issue</th><th>Total No of events</th><th>Events per 1000 km</th></tr>
        <tr><td colspan="3">&nbsp;</td></tr>
      </table>
    </div>
    <div class="page-break"></div>

    <div id="chartsContainer" class="section" style="display:flex; gap:10px;">
      <div class="chartBox" style="flex:1;">
        <h3>Distance vs Time</h3>
        <canvas id="distanceChart"></canvas>
      </div>
      <div class="chartBox" style="flex:1;">
        <h3>Speed vs Distance</h3>
        <canvas id="speedChart"></canvas>
      </div>
    </div>
    <div class="page-break"></div>

    <div id="streetsContainer" class="section">
      <h3>Road Types Encountered</h3>
      <table id="streetTable"><tr><th>Road type</th></tr></table>
    </div>

    <footer style="text-align:center; padding:10px; font-size:12px; color:#666;">
      © Lynoit Tech 2025
    </footer>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const toggleBtn        = document.getElementById('toggleSidebar');
    const sidebar          = document.getElementById('sidebar');
    const locEl            = document.getElementById('location');
    const roadTypeEl       = document.getElementById('roadType');
    const streetCityEl     = document.getElementById('streetCity');
    const tempEl           = document.getElementById('temperature');
    const iconEl           = document.getElementById('weatherIcon');
    const distEl           = document.getElementById('totalDistance');
    const speedEl          = document.getElementById('speed');
    const countTbl         = document.getElementById('countTable');
    const streetTbl        = document.getElementById('streetTable');
    const logContainer     = document.getElementById('logTableContainer');
    const sidebarContainer = document.getElementById('buttonGroups');
    const autoContainer    = document.getElementById('autoButtonGroups');

    let logTable = [], redCounts = {}, lastPos = null, totalDist = 0;
    let positions = [], timeData = [], distData = [], speedData = [];
    let map, trackLine, distanceChart, speedChart;
    let roadTypes = new Set(), lastChartTs = 0, posCount = 0, lastCity = null;

    toggleBtn.onclick = () => {
      const expanded = sidebar.classList.toggle('expanded');
      sidebar.classList.toggle('collapsed', !expanded);
      toggleBtn.setAttribute('aria-expanded', expanded);
    };

    window.onload = () => {
      initMap();
      initCharts();
      updateDateTime();
      setInterval(updateDateTime, 1000);
      navigator.geolocation.watchPosition(showPosition, showError, {
        enableHighAccuracy: true,
        maximumAge: 5000,
        timeout: 10000
      });
      buildButtons();
    };

    function buildButtons() {
      fetch('buttons.csv')
        .then(r => {
          if (!r.ok) throw new Error('Failed to load buttons.csv');
          return r.text();
        })
        .then(csv => {
          const { data, errors } = Papa.parse(csv, { header: true, skipEmptyLines: true });
          if (errors.length) console.error('CSV parse errors', errors);
          const autoLabels = ['ACC','AEB','ALCA','TSI'];
          data.forEach(({ label, cssClass, logName, isRed }) => {
            if (!label) return;
            const btn = document.createElement('button');
            btn.textContent = label;
            btn.classList.add('bigButton', cssClass);
            btn.onclick = () => logButton(logName, isRed === 'true');
            // Move ACC/AEB/ALCA/TSI to right column
            if (autoLabels.includes(label)) {
              autoContainer.appendChild(btn);
            } else {
              sidebarContainer.appendChild(btn);
            }
          });
        })
        .catch(console.error);
    }

    // ... the rest of your functions: initMap, initCharts, showPosition, calculateDistance,
    //     updateStreetTable, resetDistance, saveAndPrint, showError, getWeather,
    //     logButton, displayLogTable, updateCountTable, updateDateTime ...
  </script>
</body>
</html>
