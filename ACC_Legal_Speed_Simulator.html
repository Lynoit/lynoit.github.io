<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ACC Speed‑Limit Adaption Simulator</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#9ca3af;
      --accent:#38bdf8; --ok:#22c55e; --warn:#fbbf24; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:14px 18px;border-bottom:1px solid #1f2937;background:#0b1222}
    header h1{margin:0;font-size:20px;font-weight:600}
    .container{display:grid;grid-template-columns:340px 640px 640px;gap:14px;padding:14px}
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #1f2937;font-size:15px;font-weight:600;background:#0d1528}
    .card .content{padding:12px 14px}
    label{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:6px 0;font-size:13px}
    input[type="number"], input[type="range"]{width:140px;background:#0b1222;border:1px solid #1f2937;color:#e5e7eb;border-radius:10px;padding:6px 8px}
    .btns{display:flex;gap:8px;margin-top:8px}
    button{appearance:none;border:1px solid #1f2937;background:#0b1222;color:#e5e7eb;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#0ea5e9,#0284c7);border-color:#0369a1}
    button.warn{background:linear-gradient(180deg,#f59e0b,#d97706);border-color:#b45309}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
    .kpi{background:#0b1222;border:1px solid #1f2937;border-radius:10px;padding:8px}
    .kpi .u{font-size:11px;color:var(--muted)}
    .kpi .v{font-size:20px;font-weight:700}
    /* Fixed-size charts */
    canvas.chart{display:block;margin:8px auto;background:#0b1222;border:1px solid #1f2937;border-radius:12px}
    /* Birdview */
    #bird{display:block;margin:8px auto;background:#0b1222;border:1px solid #1f2937;border-radius:12px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border:1px solid #1f2937;padding:6px 8px;text-align:left}
    thead tr{background:#0d1528}
  </style>
</head>
<body>
  <header>
    <h1>ACC Speed‑Limit Adaption Simulator</h1>
  </header>
  <div class="container">
    <!-- Column 1: Inputs & Controls -->
    <section class="card">
      <h2>Parameters & Controls</h2>
      <div class="content">
        <label>ACC set speed (km/h)
          <input id="vSet" type="number" min="0" max="180" step="1" value="90" />
        </label>
        <label>Legal speed after sign (km/h)
          <input id="vLimit" type="number" min="0" max="180" step="1" value="70" />
        </label>
        <label>Accel magnitude (m/s²)
          <input id="accMag" type="number" min="0.1" max="4" step="0.1" value="1.0" />
        </label>
        <label>Distance Start (m)
          <input id="distStart" type="number" min="-500" max="600" step="10" value="200" />
        </label>
        <div class="btns">
          <button class="primary" id="btnStart">Start</button>
          <button id="btnPause">Pause</button>
          <button class="warn" id="btnReset">Reset</button>
        </div>
        <div class="kpis">
          <div class="kpi"><div class="u">Sim time</div><div id="rdTime" class="v">0.0 s</div></div>
          <div class="kpi"><div class="u">Dist to sign</div><div id="rdDist" class="v">— m</div></div>
          <div class="kpi"><div class="u">Speed</div><div id="rdSpd" class="v">— km/h</div></div>
          <div class="kpi"><div class="u">Long. accel</div><div id="rdAcc" class="v">— m/s²</div></div>
        </div>
      </div>
    </section>

    <!-- Column 2: Plots -->
    <section class="card">
      <h2>Time Plots</h2>
      <div class="content">
        <canvas id="speedChart" class="chart" width="600" height="220"></canvas>
        <canvas id="accChart" class="chart" width="600" height="220"></canvas>
      </div>
    </section>

    <!-- Column 3: Birdview & Milestones -->
    <section class="card">
      <h2>Birdview & Milestones</h2>
      <div class="content">
        <canvas id="bird" width="600" height="220"></canvas>
        <h3 style="margin:10px 0 6px 0">Milestones</h3>
        <table>
          <thead>
            <tr><th style="width:110px">Time (s)</th><th>Event</th></tr>
          </thead>
          <tbody id="milestoneBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
  'use strict';
    // --- Utilities ---
    const kph2mps = v=> v/3.6;
    const mps2kph = v=> v*3.6;
    const fmt1 = n=> (Math.round(n*10)/10).toFixed(1);

    // --- DOM ---
    const els = {
      vSet: document.getElementById('vSet'),
      vLimit: document.getElementById('vLimit'),
      accMag: document.getElementById('accMag'),
      distStart: document.getElementById('distStart'),
      btnStart: document.getElementById('btnStart'),
      btnPause: document.getElementById('btnPause'),
      btnReset: document.getElementById('btnReset'),
      rdTime: document.getElementById('rdTime'),
      rdDist: document.getElementById('rdDist'),
      rdSpd: document.getElementById('rdSpd'),
      rdAcc: document.getElementById('rdAcc'),
      bird: document.getElementById('bird'),
      speedCanvas: document.getElementById('speedChart'),
      accCanvas: document.getElementById('accChart'),
      milestoneBody: document.getElementById('milestoneBody')
    };

    function getParams(){
      return {
        vSetKph: +els.vSet.value,
        vLimitKph: +els.vLimit.value,
        accMag: +els.accMag.value,
        distStart: +els.distStart.value
      };
    }

    // --- State ---
    const signDistAhead = 300; // m
    let state, logs, flags, running=false, lastT=0, chartTick=0;

    function addMilestone(name, t){
      logs.milestones.push({ t, name });
      logs.milestones.sort((a,b)=>a.t-b.t);
      renderMilestones();
    }
    function renderMilestones(){
      els.milestoneBody.innerHTML = logs.milestones
        .map(m=>`<tr><td>${fmt1(m.t)}</td><td>${m.name}</td></tr>`)
        .join('');
    }

    function resetSim(){
      const p=getParams();
      state={ t:0, x:-signDistAhead, v:kph2mps(p.vSetKph), a:0, phase:'cruise' };
      logs={ t:[0], v:[p.vSetKph], a:[0], milestones:[] };
      flags={ startedAdjust:false, reached:false, passed:false };
      addMilestone('Simulation start', 0);
      updateCharts(true);
      drawBird();
      updateReadout();
    }

    function startSim(){ if(!running){ running=true; lastT=performance.now(); requestAnimationFrame(loop);} }
    function pauseSim(){ running=false; }

    function loop(now){
      if(!running) return;
      const dt=Math.min(0.05,(now-lastT)/1000); lastT=now;
      step(dt);
      chartTick+=dt;
      if(chartTick>0.1){ updateCharts(false); chartTick=0; }
      drawBird();
      requestAnimationFrame(loop);
    }

    function step(dt){
      const p=getParams();
      const xStart  = -p.distStart;          // world x where adjustment should start
      const vTarget = kph2mps(p.vLimitKph);
      let aCmd = 0;

      if(state.x >= xStart){
        if(!flags.startedAdjust){ flags.startedAdjust=true; addMilestone('start of speed adjustment', state.t); }
        const eps=0.05; // m/s ~ 0.18 km/h
        if(state.v > vTarget + eps)      aCmd = -p.accMag;
        else if(state.v < vTarget - eps) aCmd = +p.accMag;
        else {
          aCmd = 0;
          if(!flags.reached){ flags.reached=true; addMilestone('new speed reached', state.t); }
        }
        state.phase = (aCmd===0? 'hold' : 'adjusting');
      } else {
        aCmd = 0; state.phase = 'cruise';
      }

      // sign passed?
      if(!flags.passed && state.x >= 0){ flags.passed=true; addMilestone('legal speed sign passed', state.t); }

      // Integrate
      state.a = aCmd;
      state.v = Math.max(0, state.v + state.a * dt);
      state.x = state.x + state.v * dt; // toward sign at x=0
      state.t += dt;

      // exact-hit checks after integration
      if(flags.startedAdjust && !flags.reached){
        const eps2=0.05; if(Math.abs(state.v - vTarget)<=eps2){ flags.reached=true; addMilestone('new speed reached', state.t); }
      }
      if(!flags.passed && state.x >= 0){ flags.passed=true; addMilestone('legal speed sign passed', state.t); }

      // Log
      logs.t.push(state.t);
      logs.v.push(mps2kph(state.v));
      logs.a.push(state.a);

      updateReadout();
    }

    // --- Readouts ---
    function updateReadout(){
      els.rdTime.textContent = fmt1(state.t) + ' s';
      const d = 0 - state.x;
      els.rdDist.textContent = (d>0 ? fmt1(d)+' m' : '+'+fmt1(-d)+' m (after)');
      els.rdSpd.textContent  = fmt1(mps2kph(state.v)) + ' km/h';
      els.rdAcc.textContent  = (state.a>=0?'+':'') + fmt1(state.a) + ' m/s²';
    }

    // --- Charts ---
    const commonOpts = {
      responsive:false, maintainAspectRatio:false, animation:false,
      scales:{
        x:{ type:'linear', ticks:{color:'#93a3b8'}, grid:{color:'rgba(148,163,184,0.15)'}, title:{display:true,text:'Time (s)',color:'#9ca3af'} },
        y:{ ticks:{color:'#93a3b8'}, grid:{color:'rgba(148,163,184,0.12)'} }
      },
      plugins:{ legend:{display:false} }
    };

    const speedChart = new Chart(els.speedCanvas.getContext('2d'),{
      type:'line',
      data:{ datasets:[{ label:'Speed (km/h)', data:[], borderColor:'#38bdf8', borderWidth:2, pointRadius:0 }] },
      options: (()=>{
        const o = JSON.parse(JSON.stringify(commonOpts));
        o.scales = JSON.parse(JSON.stringify(commonOpts.scales));
        o.scales.y = JSON.parse(JSON.stringify(commonOpts.scales.y));
        o.scales.y.title = {display:true,text:'Speed (km/h)',color:'#9ca3af'};
        o.scales.y.suggestedMin = 0; o.scales.y.suggestedMax = 140;
        return o;
      })()
    });

    const accChart = new Chart(els.accCanvas.getContext('2d'),{
      type:'line',
      data:{ datasets:[{ label:'Long. Accel (m/s²)', data:[], borderColor:'#22c55e', borderWidth:2, pointRadius:0 }] },
      options: (()=>{
        const o = JSON.parse(JSON.stringify(commonOpts));
        o.scales = JSON.parse(JSON.stringify(commonOpts.scales));
        o.scales.y = JSON.parse(JSON.stringify(commonOpts.scales.y));
        o.scales.y.title = {display:true,text:'Accel (m/s²)',color:'#9ca3af'};
        o.scales.y.suggestedMin = -4; o.scales.y.suggestedMax = 4;
        return o;
      })()
    });

    function updateCharts(){
      const dataSpeed = logs.t.map((t,i)=>({x:t,y:logs.v[i]}));
      const dataAcc   = logs.t.map((t,i)=>({x:t,y:logs.a[i]}));
      speedChart.data.datasets[0].data = dataSpeed;
      accChart.data.datasets[0].data   = dataAcc;
      speedChart.options.scales.x.suggestedMax = Math.max(10, state.t);
      accChart.options.scales.x.suggestedMax   = Math.max(10, state.t);
      speedChart.update('none');
      accChart.update('none');
    }

    // --- Birdview ---
    function drawBird(){
      const p=getParams();
      const c=els.bird, ctx=c.getContext('2d');
      const W=c.width, H=c.height;
      ctx.clearRect(0,0,W,H);

      const worldMin = -signDistAhead - 100;
      const worldMax =  200;
      const scale = W / (worldMax - worldMin);
      const toX = wx => (wx - worldMin) * scale;
      const roadY = H*0.6, roadH=90;

      // road surface
      ctx.fillStyle = '#0e162a';
      ctx.fillRect(0, roadY-roadH/2, W, roadH);
      // lane dashed
      ctx.strokeStyle='#475569';
      ctx.lineWidth=2; ctx.setLineDash([14,12]);
      ctx.beginPath(); ctx.moveTo(0, roadY); ctx.lineTo(W, roadY); ctx.stroke(); ctx.setLineDash([]);

      // speed sign at x=0
      const sx = toX(0);
      ctx.strokeStyle='#9ca3af'; ctx.lineWidth=3;
      ctx.beginPath(); ctx.moveTo(sx, roadY-roadH/2); ctx.lineTo(sx, roadY-roadH-25); ctx.stroke();
      ctx.beginPath(); ctx.fillStyle='#ef4444'; ctx.arc(sx, roadY-roadH-50, 20, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.fillStyle='#ffffff'; ctx.arc(sx, roadY-roadH-50, 16, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle='#ef4444'; ctx.font='bold 14px system-ui, sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(String(p.vLimitKph), sx, roadY-roadH-50);

      // start-of-adjustment marker at x = -DistanceStart
      const startX = toX(-p.distStart);
      ctx.strokeStyle='#94a3b8'; ctx.lineWidth=2; ctx.setLineDash([6,6]);
      ctx.beginPath(); ctx.moveTo(startX, roadY-roadH/2-18); ctx.lineTo(startX, roadY+roadH/2+18); ctx.stroke(); ctx.setLineDash([]);

      // car rectangle
      const carX = toX(state.x);
      const carW=40, carH=20, carY = roadY-10;
      ctx.fillStyle='#38bdf8';
      roundRect(ctx, carX-carW/2, carY-carH/2, carW, carH, 6, true);

      // overlays
      ctx.fillStyle='#9ca3af'; ctx.font='12px system-ui, sans-serif'; ctx.textAlign='left';
      ctx.fillText('Old legal: '+Math.round(+els.vSet.value)+' km/h', 8, 16);
      ctx.fillText('New legal: '+Math.round(+els.vLimit.value)+' km/h', 8, 34);
      ctx.fillText('Distance Start: '+p.distStart+' m ('+(p.distStart>=0?'before':'after')+')', 8, 52);

      // x=0 vertical line
      ctx.strokeStyle='rgba(148,163,184,0.35)'; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(sx, 8); ctx.lineTo(sx, H-8); ctx.stroke();
    }

    function roundRect(ctx, x, y, w, h, r, fill){
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      if(fill) ctx.fill(); else ctx.stroke();
    }

    // --- Buttons ---
    els.btnStart.addEventListener('click', ()=> startSim());
    els.btnPause.addEventListener('click', ()=> pauseSim());
    els.btnReset.addEventListener('click', ()=> { pauseSim(); resetSim(); renderMilestones(); });

    // --- Init ---
    const speedCtx = els.speedCanvas.getContext('2d'); // touch to ensure canvas ready
    resetSim();
    drawBird();
    renderMilestones();
  </script>
</body>
</html>
