<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ACC Speed‑Limit Adaption Simulator</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827; /* gray-900 */
      --muted:#9ca3af; /* gray-400 */
      --accent:#38bdf8; /* sky-400 */
      --ok:#22c55e; /* green-500 */
      --warn:#fbbf24; /* amber-400 */
      --danger:#ef4444; /* red-500 */
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',sans-serif}
    header{padding:14px 18px;border-bottom:1px solid #1f2937;background:#0b1222;position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:20px;font-weight:600;letter-spacing:.2px}
    .container{display:grid;grid-template-columns:340px 640px 640px;gap:14px;padding:14px}
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:14px;box-shadow:0 10px 20px rgba(0,0,0,.25);overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #1f2937;font-size:15px;font-weight:600;color:#e2e8f0;background:#0d1528}
    .card .content{padding:12px 14px}
    .grid{display:grid;gap:8px}
    .row{display:grid;grid-template-columns:1fr 80px;gap:10px;align-items:center}
    label{font-size:12px;color:var(--muted)}
    input[type="range"]{width:100%}
    input[type="number"]{width:100%;background:#0b1222;border:1px solid #1f2937;color:#e5e7eb;border-radius:10px;padding:8px 10px}
    .btns{display:flex;gap:8px;margin-top:8px}
    button{appearance:none;border:1px solid #1f2937;background:#0b1222;color:#e5e7eb;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer}
    button:hover{border-color:#334155}
    button.primary{background:linear-gradient(180deg,#0ea5e9,#0284c7);border-color:#0369a1}
    button.warn{background:linear-gradient(180deg,#f59e0b,#d97706);border-color:#b45309}
    .readout{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
    .kpi{background:#0b1222;border:1px solid #1f2937;border-radius:10px;padding:10px}
    .kpi .v{font-size:20px;font-weight:700}
    .kpi .u{font-size:11px;color:var(--muted)}

    /* Fixed plot sizes */
    .plot-wrap{padding:10px}
    canvas.chart{background:#0b1222;border:1px solid #1f2937;border-radius:12px;display:block;margin:0 auto}

    /* Birdview */
    #bird{display:block;margin:10px auto;background:#0b1222;border:1px solid #1f2937;border-radius:12px}
    .legend{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:var(--muted);margin-top:6px}
    .dot{width:10px;height:10px;border-radius:50%}
  </style>
</head>
<body>
  <header>
    <h1>ACC Speed‑Limit Adaption Simulator</h1>
  </header>
  <div class="container">
    <!-- Column 1: Inputs & Controls -->
    <section class="card" id="controls">
      <h2>Parameters & Controls</h2>
      <div class="content grid">
        <div class="row">
          <label>Car initial speed / ACC set speed (km/h)</label>
          <input id="vSetNum" type="number" min="0" max="180" step="1" value="90" />
        </div>
        <input id="vSet" type="range" min="0" max="180" step="1" value="90" />

        <div class="row">
          <label>Legal speed after sign (km/h)</label>
          <input id="vLimitNum" type="number" min="0" max="180" step="1" value="70" />
        </div>
        <input id="vLimit" type="range" min="0" max="180" step="1" value="70" />

        <div class="row">
          <label>Longitudinal accel magnitude (m/s²)
            <div style="font-size:11px;color:var(--muted)">Used for both decel/accel</div>
          </label>
          <input id="accMagNum" type="number" min="0.1" max="4" step="0.1" value="1.0" />
        </div>
        <input id="accMag" type="range" min="0.1" max="4" step="0.1" value="1.0" />

        <div class="row">
          <label>Distance Start (m)
            <div style="font-size:11px;color:var(--muted)">+ = before sign, − = after sign</div>
          </label>
          <input id="distStartNum" type="number" min="-500" max="600" step="10" value="200" />
        </div>
        <input id="distStart" type="range" min="-500" max="600" step="10" value="200" />

        <div class="btns">
          <button class="primary" id="btnStart">Start</button>
          <button id="btnPause">Pause</button>
          <button class="warn" id="btnReset">Reset</button>
        </div>

        <div class="readout">
          <div class="kpi"><div class="u">Sim time</div><div class="v" id="rdTime">0.0 s</div></div>
          <div class="kpi"><div class="u">Distance to sign</div><div class="v" id="rdDist">— m</div></div>
          <div class="kpi"><div class="u">Speed</div><div class="v" id="rdSpd">— km/h</div></div>
          <div class="kpi"><div class="u">Long. accel</div><div class="v" id="rdAcc">— m/s²</div></div>
        </div>
      </div>
    </section>

    <!-- Column 2: Plots -->
    <section class="card">
      <h2>Time Plots (fixed size)</h2>
      <div class="plot-wrap">
        <canvas id="speedChart" class="chart" width="600" height="220"></canvas>
      </div>
      <div class="plot-wrap">
        <canvas id="accChart" class="chart" width="600" height="220"></canvas>
      </div>
    </section>

    <!-- Column 3: Birdview -->
    <section class="card">
      <h2>Birdview</h2>
      <div class="content">
        <canvas id="bird" width="600" height="300"></canvas>
        <div class="legend">
          <div class="dot" style="background:var(--accent)"></div> Car
          <div class="dot" style="background:var(--danger)"></div> Speed‑limit sign (new legal speed)
          <div class="dot" style="background:#94a3b8"></div> Start of adjustment (Distance Start)
        </div>
      </div>
    </section>
  </div>

  <script>
    // ------- Utilities -------
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const kph2mps = v=> v/3.6;
    const mps2kph = v=> v*3.6;
    const format1 = n=> (Math.round(n*10)/10).toFixed(1);

    function linkRangeNumber(rangeEl, numberEl){
      const sync = v=>{ rangeEl.value=v; numberEl.value=v; };
      rangeEl.addEventListener('input',()=>{ numberEl.value=rangeEl.value; onParamChange(); });
      numberEl.addEventListener('input',()=>{ rangeEl.value=numberEl.value; onParamChange(); });
      return { sync };
    }

    // ------- Parameters (DOM) -------
    const els={
      vSet: document.getElementById('vSet'),
      vSetNum: document.getElementById('vSetNum'),
      vLimit: document.getElementById('vLimit'),
      vLimitNum: document.getElementById('vLimitNum'),
      accMag: document.getElementById('accMag'),
      accMagNum: document.getElementById('accMagNum'),
      distStart: document.getElementById('distStart'),
      distStartNum: document.getElementById('distStartNum'),
      btnStart: document.getElementById('btnStart'),
      btnPause: document.getElementById('btnPause'),
      btnReset: document.getElementById('btnReset'),
      rdTime: document.getElementById('rdTime'),
      rdDist: document.getElementById('rdDist'),
      rdSpd: document.getElementById('rdSpd'),
      rdAcc: document.getElementById('rdAcc'),
      bird: document.getElementById('bird')
    };

    linkRangeNumber(els.vSet, els.vSetNum);
    linkRangeNumber(els.vLimit, els.vLimitNum);
    linkRangeNumber(els.accMag, els.accMagNum);
    linkRangeNumber(els.distStart, els.distStartNum);

    function getParams(){
      return {
        vSetKph: +els.vSet.value,
        vLimitKph: +els.vLimit.value,
        accMag: +els.accMag.value,
        distStart: +els.distStart.value
      };
    }

    function onParamChange(){
      // Nothing heavy; values will be read during the next sim tick.
    }

    // ------- Simulation state -------
    const signDistAhead = 300; // m; car starts this far before the sign
    let state, logs, running=false, lastT=0, chartTick=0;

    function resetSim(){
      const p=getParams();
      state={
        t:0,
        x:-signDistAhead, // position relative to the sign at x=0 (m)
        v:kph2mps(p.vSetKph),
        a:0,
        phase:"cruise" // cruise -> adjusting -> hold
      };
      logs={ t:[], v:[], a:[] };
      // Seed logs with t=0
      logs.t.push(0);
      logs.v.push(mps2kph(state.v));
      logs.a.push(state.a);
      updateCharts(true);
      drawBird();
      updateReadout();
    }

    function startSim(){
      if(!running){
        running=true; lastT=performance.now();
        requestAnimationFrame(loop);
      }
    }

    function pauseSim(){ running=false; }

    function loop(now){
      if(!running) return;
      const dt=Math.min(0.05,(now-lastT)/1000); // clamp to 50ms per frame max
      lastT=now;
      step(dt);
      chartTick+=dt;
      if(chartTick>0.1){ // update plots at 10Hz
        updateCharts(false); chartTick=0;
      }
      drawBird();
      requestAnimationFrame(loop);
    }

    function step(dt){
      const p=getParams();
      // Decide acceleration based on Distance Start and target speed
      const xStart = -p.distStart; // world x when adjustment should start
      const vTarget = kph2mps(p.vLimitKph);
      let aCmd = 0;

      if(state.x >= xStart){
        const eps=0.05; // m/s
        if(state.v > vTarget + eps) aCmd = -p.accMag; else if(state.v < vTarget - eps) aCmd = +p.accMag; else aCmd=0;
        state.phase = (aCmd===0?"hold":"adjusting");
      } else {
        aCmd = 0; state.phase = "cruise";
      }

      // Integrate kinematics (semi-implicit Euler)
      state.a = aCmd;
      state.v = Math.max(0, state.v + state.a * dt);
      state.x = state.x + state.v * dt; // forward positive toward sign at x=0
      state.t += dt;

      // Log
      logs.t.push(state.t);
      logs.v.push(mps2kph(state.v));
      logs.a.push(state.a);

      updateReadout();
    }

    // ------- Readouts -------
    function updateReadout(){
      els.rdTime.textContent = format1(state.t)+" s";
      const distToSign = 0 - state.x; // m
      els.rdDist.textContent = (distToSign>0? format1(distToSign)+" m" : ("+"+format1(-distToSign)+" m (after)"));
      els.rdSpd.textContent = format1(mps2kph(state.v))+" km/h";
      els.rdAcc.textContent = (state.a>=0?"+":"")+format1(state.a)+" m/s²";
    }

    // ------- Charts (fixed size) -------
    const speedCtx = document.getElementById('speedChart').getContext('2d');
    const accCtx = document.getElementById('accChart').getContext('2d');

    const commonOpts = {
      responsive:false,
      maintainAspectRatio:false,
      animation:false,
      scales:{
        x:{ type:'linear', ticks:{color:'#93a3b8'}, grid:{color:'rgba(148,163,184,0.15)'}, title:{display:true,text:'Time (s)',color:'#9ca3af'} },
        y:{ ticks:{color:'#93a3b8'}, grid:{color:'rgba(148,163,184,0.12)'} }
      },
      plugins:{ legend:{display:false} }
    };

    const speedChart = new Chart(speedCtx,{
      type:'line',
      data:{ datasets:[{ label:'Speed (km/h)', data:[], borderColor:'#38bdf8', borderWidth:2, pointRadius:0 }] },
      options:{ ...commonOpts, scales:{...commonOpts.scales, y:{ ...commonOpts.scales.y, title:{display:true,text:'Speed (km/h)',color:'#9ca3af'}, suggestedMin:0, suggestedMax:130 }}}
    );

    const accChart = new Chart(accCtx,{
      type:'line',
      data:{ datasets:[{ label:'Long. Accel (m/s²)', data:[], borderColor:'#22c55e', borderWidth:2, pointRadius:0 }] },
      options:{ ...commonOpts, scales:{...commonOpts.scales, y:{ ...commonOpts.scales.y, title:{display:true,text:'Accel (m/s²)',color:'#9ca3af'}, suggestedMin:-4, suggestedMax:4 }}}
    );

    function updateCharts(force){
      // Feed full history to charts ("include historical points")
      const dataSpeed = logs.t.map((t,i)=>({x:t,y:logs.v[i]}));
      const dataAcc = logs.t.map((t,i)=>({x:t,y:logs.a[i]}));
      speedChart.data.datasets[0].data = dataSpeed;
      accChart.data.datasets[0].data = dataAcc;
      // Keep x-axis window reasonably tight but include all by default
      speedChart.options.scales.x.suggestedMax = Math.max(10, state.t);
      accChart.options.scales.x.suggestedMax = Math.max(10, state.t);
      speedChart.update('none');
      accChart.update('none');
    }

    // ------- Birdview -------
    function drawBird(){
      const p=getParams();
      const c=els.bird, ctx=c.getContext('2d');
      const W=c.width, H=c.height;
      ctx.clearRect(0,0,W,H);

      // World → screen mapping
      const worldMin = -signDistAhead - 100; // show a bit before start position
      const worldMax =  200;                 // and some after the sign
      const scale = W / (worldMax - worldMin);
      const toX = wx => (wx - worldMin) * scale;
      const roadY = H*0.6, roadH=90;

      // Road
      ctx.fillStyle = '#0e162a';
      ctx.fillRect(0, roadY-roadH/2, W, roadH);
      // lane markings
      ctx.strokeStyle='#475569';
      ctx.lineWidth=2; ctx.setLineDash([14,12]);
      ctx.beginPath();
      ctx.moveTo(0, roadY);
      ctx.lineTo(W, roadY);
      ctx.stroke();
      ctx.setLineDash([]);

      // Speed‑limit sign at x=0 (new legal speed)
      const sx = toX(0);
      // post
      ctx.strokeStyle='#9ca3af'; ctx.lineWidth=3;
      ctx.beginPath(); ctx.moveTo(sx, roadY-roadH/2); ctx.lineTo(sx, roadY-roadH-25); ctx.stroke();
      // circle
      ctx.beginPath(); ctx.fillStyle='#ef4444'; ctx.arc(sx, roadY-roadH-50, 20, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.fillStyle='#ffffff'; ctx.arc(sx, roadY-roadH-50, 16, 0, Math.PI*2); ctx.fill();
      // text (new limit)
      ctx.fillStyle='#ef4444'; ctx.font='bold 14px system-ui, sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(String(p.vLimitKph), sx, roadY-roadH-50);

      // Start‑of‑adjustment marker at x = -DistanceStart
      const startX = toX(-p.distStart);
      ctx.strokeStyle='#94a3b8'; ctx.lineWidth=2; ctx.setLineDash([6,6]);
      ctx.beginPath(); ctx.moveTo(startX, roadY-roadH/2-20); ctx.lineTo(startX, roadY+roadH/2+20); ctx.stroke();
      ctx.setLineDash([]);

      // Car (blue rounded rectangle), centered on road
      const carX = toX(state.x);
      const carW=40, carH=20;
      const carY = roadY-10;
      ctx.fillStyle='#38bdf8';
      roundRect(ctx, carX-carW/2, carY-carH/2, carW, carH, 6, true);

      // Text overlays
      ctx.fillStyle='#9ca3af'; ctx.font='12px system-ui, sans-serif'; ctx.textAlign='left'; ctx.textBaseline='alphabetic';
      ctx.fillText(`Old legal: ${Math.round(+els.vSet.value)} km/h`, 8, 16);
      ctx.fillText(`New legal: ${Math.round(+els.vLimit.value)} km/h`, 8, 34);
      ctx.fillText(`Distance Start: ${p.distStart} m (${p.distStart>=0?'before':'after'})`, 8, 52);

      // Axis baseline for reference (x=0 at sign)
      ctx.strokeStyle='rgba(148,163,184,0.35)'; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(sx, 8); ctx.lineTo(sx, H-8); ctx.stroke();
    }

    function roundRect(ctx, x, y, w, h, r, fill){
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      if(fill) ctx.fill(); else ctx.stroke();
    }

    // ------- Buttons -------
    els.btnStart.addEventListener('click', ()=>{ startSim(); });
    els.btnPause.addEventListener('click', ()=>{ pauseSim(); });
    els.btnReset.addEventListener('click', ()=>{ pauseSim(); resetSim(); });

    // ------- Init -------
    resetSim();
  </script>
</body>
</html>
